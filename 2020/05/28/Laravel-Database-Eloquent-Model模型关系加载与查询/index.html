<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="思考并回答以下问题：">
<meta name="keywords" content="Laravel">
<meta property="og:type" content="article">
<meta property="og:title" content="Laravel Database-Eloquent Model模型关系加载与查询">
<meta property="og:url" content="http://yoursite.com/2020/05/28/Laravel-Database-Eloquent-Model模型关系加载与查询/index.html">
<meta property="og:site_name" content="车斌的技术博客">
<meta property="og:description" content="思考并回答以下问题：">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-12-21T07:47:16.485Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Laravel Database-Eloquent Model模型关系加载与查询">
<meta name="twitter:description" content="思考并回答以下问题：">






  <link rel="canonical" href="http://yoursite.com/2020/05/28/Laravel-Database-Eloquent-Model模型关系加载与查询/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Laravel Database-Eloquent Model模型关系加载与查询 | 车斌的技术博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">放弃会成为一种习惯</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/28/Laravel-Database-Eloquent-Model模型关系加载与查询/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CheBin">
      <meta itemprop="description" content="看视频才能学会，看文字学不会的">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Laravel Database-Eloquent Model模型关系加载与查询

              
            
          </h1>
        

        <div class="post-meta">

          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-05-28 17:18:57" itemprop="dateCreated datePublished" datetime="2020-05-28T17:18:57+08:00">2020-05-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-12-21 15:47:16" itemprop="dateModified" datetime="2020-12-21T15:47:16+08:00">2020-12-21</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/PHP/" itemprop="url" rel="index"><span itemprop="name">PHP</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">31k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">28 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考并回答以下问题：</p>
<a id="more"></a>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a><span style="color:#339AFF;">前言</span></h1><p>我们在上一篇文章中介绍了模型关系的定义初始化，我们可以看到，在初始化的过程中Laravel已经为各种关联关系的模型预先插入了初始的where条件。本文将会进一步介绍如何添加自定义的查询条件，如何加载、预加载关联模型。</p>
<h1 id="关联模型的加载"><a href="#关联模型的加载" class="headerlink" title="关联模型的加载"></a><span style="color:#339AFF;">关联模型的加载</span></h1><p>当我们定义关联模型后：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获得与用户关联的电话记录。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">phone</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hasOne(<span class="string">'App\Phone'</span>, <span class="string">'user_id'</span>, <span class="string">'id'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以像成员变量一样来获取与之关联的模型：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$user = App\User::find(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($user-&gt;posts <span class="keyword">as</span> $post) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实际上，模型的属性获取函数的确可以加载关联模型：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttribute</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (! $key) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getRelationValue($key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>getRelationValue函数专用于加载我们之前定义的关联模型：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get a relationship.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelationValue</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// If the key already exists in the relationships array, it just means the</span></span><br><span class="line">    <span class="comment">// relationship has already been loaded, so we'll just return it out of</span></span><br><span class="line">    <span class="comment">// here because there is no need to query within the relations twice.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;relationLoaded($key)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relations[$key];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the "attribute" exists as a method on the model, we will just assume</span></span><br><span class="line">    <span class="comment">// it is a relationship and will load and return results from the query</span></span><br><span class="line">    <span class="comment">// and hydrate the relationship's value on the "relationships" array.</span></span><br><span class="line">    <span class="keyword">if</span> (method_exists(<span class="keyword">$this</span>, $key)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getRelationshipFromMethod($key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Determine if the given relation is loaded.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">relationLoaded</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> array_key_exists($key, <span class="keyword">$this</span>-&gt;relations);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，关联的加载带有缓存，Laravel首先会验证当前关联关系是否已经被加载，如果加载过，那么直接返回缓存结果。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get a relationship value from a method.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $method</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> \LogicException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelationshipFromMethod</span><span class="params">($method)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $relation = <span class="keyword">$this</span>-&gt;$method();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! $relation <span class="keyword">instanceof</span> Relation) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null($relation)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LogicException(sprintf(</span><br><span class="line">                <span class="string">'%s::%s must return a relationship instance, but "null" was returned. Was the "return" keyword used?'</span>, <span class="keyword">static</span>::class, $method</span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> LogicException(sprintf(</span><br><span class="line">            <span class="string">'%s::%s must return a relationship instance.'</span>, <span class="keyword">static</span>::class, $method</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tap($relation-&gt;getResults(), <span class="function"><span class="keyword">function</span> <span class="params">($results)</span> <span class="title">use</span> <span class="params">($method)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setRelation($method, $results);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当我们调用$user-&gt;posts语句的时候，Laravel会调用posts函数，该函数开始定义关联关系，并且返回hasOne对象，在这里将会调用getResults函数来加载关联模型：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get the results of the relationship.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResults</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null(<span class="keyword">$this</span>-&gt;getParentKey())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getDefaultFor(<span class="keyword">$this</span>-&gt;parent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;query-&gt;first() ?: <span class="keyword">$this</span>-&gt;getDefaultFor(<span class="keyword">$this</span>-&gt;parent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>getDefaultFor函数用于在未查询到任何关联模型时的情况。我们在定义关联的时候，可以提供默认的方法来控制返回的结果：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsTo(<span class="string">'App\User'</span>)-&gt;withDefault();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsTo(<span class="string">'App\User'</span>)-&gt;withDefault([<span class="string">'name'</span> =&gt; <span class="string">'游客'</span>,]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsTo(<span class="string">'App\User'</span>)-&gt;withDefault(<span class="function"><span class="keyword">function</span> <span class="params">($user)</span> </span>&#123;</span><br><span class="line">        $user-&gt;name = <span class="string">'游客'</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>withDefault可以提供空值、数组、闭包函数等等选项，getDefaultFor函数在关联没有查询到结果的时候，按要求返回一个模型：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return a new model instance in case the relationship does not exist.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  \Closure|array|bool  $callback</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">withDefault</span><span class="params">($callback = true)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;withDefault = $callback;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get the default value for this relation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  \Illuminate\Database\Eloquent\Model  $parent</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> \Illuminate\Database\Eloquent\Model|null</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getDefaultFor</span><span class="params">(Model $parent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;withDefault) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $instance = <span class="keyword">$this</span>-&gt;newRelatedInstanceFor($parent);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_callable(<span class="keyword">$this</span>-&gt;withDefault)) &#123;</span><br><span class="line">        <span class="keyword">return</span> call_user_func(<span class="keyword">$this</span>-&gt;withDefault, $instance, $parent) ?: $instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_array(<span class="keyword">$this</span>-&gt;withDefault)) &#123;</span><br><span class="line">        $instance-&gt;forceFill(<span class="keyword">$this</span>-&gt;withDefault);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>获取到关联模型后，就要放入缓存当中，以备后续情况使用：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set the given relationship on the model.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $relation</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  mixed  $value</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setRelation</span><span class="params">($relation, $value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;relations[$relation] = $value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="多对多关系的加载"><a href="#多对多关系的加载" class="headerlink" title="多对多关系的加载"></a><span style="color:#339AFF;">多对多关系的加载</span></h1><p>多对多关系的加载与一对多等关系的加载有所不同，原因是不仅要加载related模型，还要加载中间表模型：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get the results of the relationship.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResults</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ! is_null(<span class="keyword">$this</span>-&gt;parent-&gt;&#123;<span class="keyword">$this</span>-&gt;parentKey&#125;)</span><br><span class="line">            ? <span class="keyword">$this</span>-&gt;get()</span><br><span class="line">            : <span class="keyword">$this</span>-&gt;related-&gt;newCollection();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Execute the query as a "select" statement.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  array  $columns</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> \Illuminate\Database\Eloquent\Collection</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($columns = [<span class="string">'*'</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// First we'll add the proper select columns onto the query so it is run with</span></span><br><span class="line">    <span class="comment">// the proper columns. Then, we will get the results and hydrate out pivot</span></span><br><span class="line">    <span class="comment">// models with the result of those columns as a separate model relation.</span></span><br><span class="line">    $builder = <span class="keyword">$this</span>-&gt;query-&gt;applyScopes();</span><br><span class="line"></span><br><span class="line">    $columns = $builder-&gt;getQuery()-&gt;columns ? [] : $columns;</span><br><span class="line"></span><br><span class="line">    $models = $builder-&gt;addSelect(</span><br><span class="line">        <span class="keyword">$this</span>-&gt;shouldSelect($columns)</span><br><span class="line">    )-&gt;getModels();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;hydratePivotRelation($models);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If we actually found models we will also eager load any relationships that</span></span><br><span class="line">    <span class="comment">// have been specified as needing to be eager loaded. This will solve the</span></span><br><span class="line">    <span class="comment">// n + 1 query problem for the developer and also increase performance.</span></span><br><span class="line">    <span class="keyword">if</span> (count($models) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        $models = $builder-&gt;eagerLoadRelations($models);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;related-&gt;newCollection($models);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>shouldSelect函数加载了中间表的字段属性：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set the select clause for the relation query.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  array  $columns</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">shouldSelect</span><span class="params">(array $columns = [<span class="string">'*'</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($columns == [<span class="string">'*'</span>]) &#123;</span><br><span class="line">        $columns = [<span class="keyword">$this</span>-&gt;related-&gt;getTable().<span class="string">'.*'</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> array_merge($columns, [<span class="keyword">$this</span>-&gt;getQualifiedFirstKeyName().<span class="string">' as laravel_through_key'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get the pivot columns for the relation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * "pivot_" is prefixed ot each column for easy removal later.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">aliasedPivotColumns</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $defaults = [<span class="keyword">$this</span>-&gt;foreignPivotKey, <span class="keyword">$this</span>-&gt;relatedPivotKey];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> collect(array_merge($defaults, <span class="keyword">$this</span>-&gt;pivotColumns))-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($column)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;table.<span class="string">'.'</span>.$column.<span class="string">' as pivot_'</span>.$column;</span><br><span class="line">    &#125;)-&gt;unique()-&gt;all();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，这个时候，中间表的属性会被放入related模型中，并且会被赋予别名前缀pivot_。</p>
<p>接着hydratePivotRelation会将这些中间表属性加载到中间表模型中：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hydrate the pivot table relationship on the models.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  array  $models</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">hydratePivotRelation</span><span class="params">(array $models)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// To hydrate the pivot relationship, we will just gather the pivot attributes</span></span><br><span class="line">    <span class="comment">// and create a new Pivot model, which is basically a dynamic model that we</span></span><br><span class="line">    <span class="comment">// will set the attributes, table, and connections on it so it will work.</span></span><br><span class="line">    <span class="keyword">foreach</span> ($models <span class="keyword">as</span> $model) &#123;</span><br><span class="line">        $model-&gt;setRelation(<span class="keyword">$this</span>-&gt;accessor, <span class="keyword">$this</span>-&gt;newExistingPivot(</span><br><span class="line">            <span class="keyword">$this</span>-&gt;migratePivotAttributes($model)</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get the pivot attributes from a model.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  \Illuminate\Database\Eloquent\Model  $model</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">migratePivotAttributes</span><span class="params">(Model $model)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $values = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($model-&gt;getAttributes() <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">        <span class="comment">// To get the pivots attributes we will just take any of the attributes which</span></span><br><span class="line">        <span class="comment">// begin with "pivot_" and add those to this arrays, as well as unsetting</span></span><br><span class="line">        <span class="comment">// them from the parent's models since they exist in a different table.</span></span><br><span class="line">        <span class="keyword">if</span> (strpos($key, <span class="string">'pivot_'</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">            $values[substr($key, <span class="number">6</span>)] = $value;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">unset</span>($model-&gt;$key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $values;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>accessor默认值为pivot，我们也可以在定义多对多的时候使用as函数为它取别名：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsToMany(<span class="string">'App\Role'</span>)-&gt;as(‘role_user’);</span><br></pre></td></tr></table></figure></p>
<p>源码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Specify the custom pivot accessor to use for the relationship.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $accessor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">as</span><span class="params">($accessor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;accessor = $accessor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="关联模型的预加载"><a href="#关联模型的预加载" class="headerlink" title="关联模型的预加载"></a><span style="color:#339AFF;">关联模型的预加载</span></h1><h2 id="with函数"><a href="#with函数" class="headerlink" title="with函数"></a><span style="color:#00ACC1;">with函数</span></h2><p>当作为属性访问Eloquent关联时，关联数据是「懒加载」的。意味着在你第一次访问该属性时，才会加载关联数据。不过，当你查询父模型时，Eloquent还可以进行「预加载」关联数据。预加载避免了N + 1查询问题。</p>
<p>预加载可以一次操作中预加载关联模型并且自定义用于select的列，可以预加载几个不同的关联，还可以预加载嵌套关联，预加载关联数据的时候，为查询指定额外的约束条件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$books = App\Book::with([<span class="string">'author:id,name'</span>])-&gt;get();</span><br><span class="line">$books = App\Book::with([<span class="string">'author'</span>, <span class="string">'publisher'</span>])-&gt;get();</span><br><span class="line">$books = App\Book::with(<span class="string">'author.contacts'</span>)-&gt;get();</span><br><span class="line"></span><br><span class="line">$users = App\User::with([<span class="string">'posts'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</span><br><span class="line">    $query-&gt;where(<span class="string">'title'</span>, <span class="string">'like'</span>, <span class="string">'%first%'</span>);</span><br><span class="line">&#125;])-&gt;get();</span><br></pre></td></tr></table></figure>
<p>我们来看看with函数：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Begin querying a model with eager loading.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  array|string  $relations</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> \Illuminate\Database\Eloquent\Builder</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">with</span><span class="params">($relations)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">static</span>::query()-&gt;with(</span><br><span class="line">        is_string($relations) ? func_get_args() : $relations</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>预加载调用Eloquent/builder的with函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set the relationships that should be eager loaded.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  mixed  $relations</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">with</span><span class="params">($relations)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $eagerLoad = <span class="keyword">$this</span>-&gt;parseWithRelations(is_string($relations) ? func_get_args() : $relations);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;eagerLoad = array_merge(<span class="keyword">$this</span>-&gt;eagerLoad, $eagerLoad);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>eagerLoad成员变量用于存放预加载的关联关系，parseWithRelations用于解析关联关系：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Parse a list of relations into individuals.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  array  $relations</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseWithRelations</span><span class="params">(array $relations)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $results = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($relations <span class="keyword">as</span> $name =&gt; $constraints) &#123;</span><br><span class="line">        <span class="comment">// If the "name" value is a numeric key, we can assume that no constraints</span></span><br><span class="line">        <span class="comment">// have been specified. We will just put an empty Closure there so that</span></span><br><span class="line">        <span class="comment">// we can treat these all the same while we are looping through them.</span></span><br><span class="line">        <span class="keyword">if</span> (is_numeric($name)) &#123;</span><br><span class="line">            $name = $constraints;</span><br><span class="line"></span><br><span class="line">            [$name, $constraints] = Str::contains($name, <span class="string">':'</span>)</span><br><span class="line">                        ? <span class="keyword">$this</span>-&gt;createSelectWithConstraint($name)</span><br><span class="line">                        : [$name, <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">                            <span class="comment">//</span></span><br><span class="line">                        &#125;];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We need to separate out any nested includes, which allows the developers</span></span><br><span class="line">        <span class="comment">// to load deep relationships using "dots" without stating each level of</span></span><br><span class="line">        <span class="comment">// the relationship with its own key in the array of eager-load names.</span></span><br><span class="line">        $results = <span class="keyword">$this</span>-&gt;addNestedWiths($name, $results);</span><br><span class="line"></span><br><span class="line">        $results[$name] = $constraints;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $results;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当我们在模型关系中写入:符合的时候，说明我们不想select *，而是想要只查询特定的字段，createSelectWithConstraint：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a constraint to select the given columns for the relation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $name</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createSelectWithConstraint</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [explode(<span class="string">':'</span>, $name)[<span class="number">0</span>], <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> <span class="title">use</span> <span class="params">($name)</span> </span>&#123;</span><br><span class="line">        $query-&gt;select(explode(<span class="string">','</span>, explode(<span class="string">':'</span>, $name)[<span class="number">1</span>]));</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>也就是为关联关系添加select条件。</p>
<p>当我们想要进行嵌套查询的时候，需要在关联关系中写下“.”，addNestedWiths：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Parse the nested relationships in a relation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $name</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  array  $results</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addNestedWiths</span><span class="params">($name, $results)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $progress = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the relation has already been set on the result array, we will not set it</span></span><br><span class="line">    <span class="comment">// again, since that would override any constraints that were already placed</span></span><br><span class="line">    <span class="comment">// on the relationships. We will only set the ones that are not specified.</span></span><br><span class="line">    <span class="keyword">foreach</span> (explode(<span class="string">'.'</span>, $name) <span class="keyword">as</span> $segment) &#123;</span><br><span class="line">        $progress[] = $segment;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">isset</span>($results[$last = implode(<span class="string">'.'</span>, $progress)])) &#123;</span><br><span class="line">            $results[$last] = <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $results;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，addNestedWiths为嵌套的模型关系赋予默认的空闭包函数，例如a.b.c，addNestedWiths返回的results数组中会有三个成员:<br>a、a.b、a.b.c，这三个变量的闭包函数都是空。</p>
<p>接下来，parseWithRelations为a.b.c的闭包函数重新赋值，将用户定义的约束条件赋予给a.b.c。</p>
<h2 id="get函数预加载"><a href="#get函数预加载" class="headerlink" title="get函数预加载"></a><span style="color:#00ACC1;">get函数预加载</span></h2><p>with函数为Laravel提供了需要预加载的关联关系，get函数在从数据库中获取父模型的数据后，会将需要预加载的模型也一并取出来：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($columns = [<span class="string">'*'</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $builder = <span class="keyword">$this</span>-&gt;applyScopes();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count($models = $builder-&gt;getModels($columns)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        $models = $builder-&gt;eagerLoadRelations($models);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $builder-&gt;getModel()-&gt;newCollection($models);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>顾名思义eagerLoadRelations函数就是获取预加载模型的的函数：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">eagerLoadRelations</span><span class="params">(array $models)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;eagerLoad <span class="keyword">as</span> $name =&gt; $constraints) &#123;</span><br><span class="line">        <span class="comment">// For nested eager loads we'll skip loading them here and they will be set as an</span></span><br><span class="line">        <span class="comment">// eager load on the query to retrieve the relation so that they will be eager</span></span><br><span class="line">        <span class="comment">// loaded on that query, because that is where they gethydrated as models.</span></span><br><span class="line">        <span class="keyword">if</span> (strpos($name, <span class="string">'.'</span>) === <span class="keyword">false</span>) &#123;</span><br><span class="line">            $models = <span class="keyword">$this</span>-&gt;eagerLoadRelation($models, $name, $constraints);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $models;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在这里，很让人费解的是if条件，这个条件语句看起来排除了嵌套预加载关系。例如上面的a.b.c，eagerLoadRelations  只会加载a这个关联关系。</p>
<p>其实原因是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// For nested eager loads we&apos;ll skip loading them here and they will be set as an eager load on the query to retrieve the relation so that they will be eager loaded on that query, because that is where they get hydrated as models.</span><br></pre></td></tr></table></figure>
<p>翻译过来就是说，嵌套预加载要一步一步的来，第一次只加载a，获得了a的关联模型之后，第二次再加载b，最后加载c。这里看不懂没关系，答案在下面的代码中：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">eagerLoadRelation</span><span class="params">(array $models, $name, Closure $constraints)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $relation = <span class="keyword">$this</span>-&gt;getRelation($name);</span><br><span class="line">    $relation-&gt;addEagerConstraints($models);</span><br><span class="line">    $constraints($relation);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $relation-&gt;match(</span><br><span class="line">        $relation-&gt;initRelation($models, $name),</span><br><span class="line">        $relation-&gt;getEager(), $name</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>eagerLoadRelation 是预加载关联关系的核心，我们可以看到加载关联模型关系主要有四个步骤：</p>
<ul>
<li>通过关系名来调用hasOne等函数来加载模型关系relation</li>
<li>利用models来为模型关系添加约束条件</li>
<li>调用with函数附带的约束条件</li>
<li>从数据库获取关联模型并匹配到各个父模型中，作为父模型的属性</li>
</ul>
<p>我们先从调用关联函数getRelation来说：</p>
<p>getRelation<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelation</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $relation = Relation::noConstraints(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getModel()-&gt;&#123;$name&#125;();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BadMethodCallException $e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> RelationNotFoundException::make(<span class="keyword">$this</span>-&gt;getModel(), $name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    $nested = <span class="keyword">$this</span>-&gt;relationsNestedUnder($name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count($nested) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        $relation-&gt;getQuery()-&gt;with($nested);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $relation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们在上一个文章说过， hasOne  等函数会自动加约束条件例如：<br>select phone where phone.user_id = user.id<br>但是这个约束条件并不适用于预加载，因为预加载的父模型通常不只只一个。因此需要调用函数  noConstraints  来避免加载约束条件:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">noConstraints</span><span class="params">(Closure $callback)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $previous = <span class="keyword">static</span>::$constraints;</span><br><span class="line">    <span class="keyword">static</span>::$constraints = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> call_user_func($callback);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">static</span>::$constraints = $previous;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来，就要调用定义关联的函数：<br>return $this-&gt;getModel()-&gt;{$name}();<br>下面的  relationsNestedUnder  函数用于加载嵌套的预加载关联关系：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">relationsNestedUnder</span><span class="params">($relation)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $nested = [];</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;eagerLoad <span class="keyword">as</span> $name =&gt; $constraints) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isNestedUnder($relation, $name)) &#123;</span><br><span class="line">            $nested[substr($name, strlen($relation.<span class="string">'.'</span>))] = $constraints;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $nested;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">isNestedUnder</span><span class="params">($relation, $name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Str::contains($name, <span class="string">'.'</span>) &amp;&amp; Str::startsWith($name, $relation.<span class="string">'.'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从代码上可以看出来，如果当前的模型关系是  a  ， relationsNestedUnder函数会把其嵌套的关系都检测出来： a.b  、 a.b.c  ，并且放入  nested  数组中： nested[b]、nested[b.c]  。<br>接下来：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (count($nested) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    $relation-&gt;getQuery()-&gt;with($nested);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>就会继续递归预加载关联关系。<br>关联关系预加载约束条件<br>获得关联关系之后，就要加载各个关联关系自己的预加载约束条件：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addEagerConstraints</span><span class="params">(array $models)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;query-&gt;whereIn(</span><br><span class="line">        <span class="keyword">$this</span>-&gt;foreignKey, <span class="keyword">$this</span>-&gt;getKeys($models, <span class="keyword">$this</span>-&gt;localKey)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>也就是从父模型的外键来为关联模型添加  where  条件。当然各个关联关系不同，这个函数也有一定的区别。<br>with 预加载约束条件<br>接下来还有加载  with  函数的约束条件 ：<br>$constraints($relation);<br>匹配父模型<br>当关联关系的约束条件都设置完毕后，就要从数据库中来获取关联模型：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$relation-&gt;match(</span><br><span class="line">    $relation-&gt;initRelation($models, $name),</span><br><span class="line">    $relation-&gt;getEager(), $name</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getEager</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>initRelation  会为父模型设置默认的关联模型：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">initRelation</span><span class="params">(array $models, $relation)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">foreach</span> ($models <span class="keyword">as</span> $model) &#123;</span><br><span class="line">$model-&gt;setRelation($relation, <span class="keyword">$this</span>-&gt;getDefaultFor($model));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $models;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>两步都做好了，接下来就要为父模型和子模型进行匹配了：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">match</span><span class="params">(array $models, Collection $results, $relation)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;matchOne($models, $results, $relation);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">matchOne</span><span class="params">(array $models, Collection $results, $relation)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;matchOneOrMany($models, $results, $relation, <span class="string">'one'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">matchOneOrMany</span><span class="params">(array $models, Collection $results, $relation, $type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $dictionary = <span class="keyword">$this</span>-&gt;buildDictionary($results);</span><br><span class="line">    <span class="keyword">foreach</span> ($models <span class="keyword">as</span> $model) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($dictionary[$key = $model-&gt;getAttribute(<span class="keyword">$this</span>-&gt;localKey)])) &#123;</span><br><span class="line">            $model-&gt;setRelation(</span><br><span class="line">            $relation, <span class="keyword">$this</span>-&gt;getRelationValue($dictionary,</span><br><span class="line">            $key, $type)</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $models;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>匹配的过程分为两步：创建目录  buildDictionary  和设置子模型<br>setRelation  ：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">buildDictionary</span><span class="params">(Collection $results)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $dictionary = [];</span><br><span class="line">    $foreign = <span class="keyword">$this</span>-&gt;getForeignKeyName();</span><br><span class="line">    <span class="keyword">foreach</span> ($results <span class="keyword">as</span> $result) &#123;</span><br><span class="line">        $dictionary[$result-&gt;&#123;$foreign&#125;][] = $result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $dictionary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>创建目录buildDictionary函数根据子模型的外键foreign将子模型进行分类，拥有同一外键的子模型放入同一个数组中。<br>接下来，为父模型设置子模型：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> ($models <span class="keyword">as</span> $model) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($dictionary[$key = $model-&gt;getAttribute(<span class="keyword">$this</span>-&gt;localKey)])) &#123;</span><br><span class="line">        $model-&gt;setRelation(</span><br><span class="line">            $relation, <span class="keyword">$this</span>-&gt;getRelationValue($dictionary, $key, $type)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelationValue</span><span class="params">(array $dictionary, $key, $type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $value = $dictionary[$key];</span><br><span class="line">    <span class="keyword">return</span> $type == <span class="string">'one'</span> ? reset($value) : <span class="keyword">$this</span>-&gt;related-&gt;newCollection($value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果目录dictionary中存在父模型的主键，就会从目录中取出对应的子模型数组，并利用setRelation来为父模型设置关联模型。</p>
<h1 id="关联模型的关联查询"><a href="#关联模型的关联查询" class="headerlink" title="关联模型的关联查询"></a>关联模型的关联查询</h1><h2 id="基于存在的关联查询"><a href="#基于存在的关联查询" class="headerlink" title="基于存在的关联查询"></a>基于存在的关联查询</h2><p>官方样例：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获得所有至少有一条评论的文章...</span></span><br><span class="line">$posts = App\Post::has(<span class="string">'comments'</span>)-&gt;get();</span><br><span class="line"><span class="comment">// 获得所有有三条或三条以上评论的文章...</span></span><br><span class="line">$posts = Post::has(<span class="string">'comments'</span>, <span class="string">'&gt;='</span>, <span class="number">3</span>)-&gt;get();</span><br><span class="line"><span class="comment">// 获得所有至少有一条获赞评论的文章...</span></span><br><span class="line">$posts = Post::has(<span class="string">'comments.votes'</span>)-&gt;get();</span><br><span class="line"><span class="comment">// 获得所有至少有一条评论内容满足 foo% 条件的文章</span></span><br><span class="line">$posts = Post::whereHas(<span class="string">'comments'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</span><br><span class="line">$query-&gt;where(<span class="string">'content'</span>, <span class="string">'like'</span>, <span class="string">'foo%'</span>);</span><br><span class="line">&#125;)-&gt;get();</span><br></pre></td></tr></table></figure></p>
<p>has  函数用于基于存在的关联查询：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">has</span><span class="params">($relation, $operator = <span class="string">'&gt;='</span>, $count = <span class="number">1</span>, $boolean = <span class="string">'and'</span>, Closure $callback = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (strpos($relation, <span class="string">'.'</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasNested($relation, $operator, $count, $boolean, $callback);</span><br><span class="line">&#125;</span><br><span class="line">$relation = <span class="keyword">$this</span>-&gt;getRelationWithoutConstraints($relation);</span><br><span class="line">$method = <span class="keyword">$this</span>-&gt;canUseExistsForExistenceCheck($operator, $count)</span><br><span class="line">? <span class="string">'getRelationExistenceQuery'</span></span><br><span class="line">: <span class="string">'getRelationExistenceCountQuery'</span>;</span><br><span class="line">$hasQuery = $relation-&gt;&#123;$method&#125;(</span><br><span class="line">$relation-&gt;getRelated()-&gt;newQuery(), <span class="keyword">$this</span>);</span><br><span class="line"><span class="keyword">if</span> ($callback) &#123;</span><br><span class="line">$hasQuery-&gt;callScope($callback);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;addHasWhere(</span><br><span class="line">$hasQuery, $relation, $operator, $count, $boolean</span><br><span class="line">);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>has函数的步骤：</p>
<ul>
<li>获取无约束的关联关系</li>
<li>为关联关系添加existence约束</li>
<li>为关联关系添加has外部约束</li>
<li>将关联关系添加到where条件中</li>
</ul>
<h2 id="无约束的关联关系"><a href="#无约束的关联关系" class="headerlink" title="无约束的关联关系"></a>无约束的关联关系</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelationWithoutConstraints</span><span class="params">($relation)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> Relation::noConstraints(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($relation)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getModel()-&gt;&#123;$relation&#125;();</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个不用多说，和预加载的原理一样。<br>existence 约束<br>关系模型的  existence  约束条件很简单：<br>select * from post where user.id = post.user_id<br>Laravel  还考虑一种特殊情况，那就是自己关联自己，这个时候就会为模型命名一个新的  hash  ：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">as</span> wedfklk <span class="keyword">where</span> user.id = wedfklk.foreignKey</span><br></pre></td></tr></table></figure></p>
<p>源代码比较简单：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelationExistenceQuery</span><span class="params">(Builder $query, Builder $parentQuery, $columns = [<span class="string">'*'</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> ($query-&gt;getQuery()-&gt;from == $parentQuery-&gt;getQuery()-&gt;from) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getRelationExistenceQueryForSelfRelation($query, $parentQuery, $columns);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">parent</span>::getRelationExistenceQuery($query, $parentQuery, $columns);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelationExistenceQueryForSelfRelation</span><span class="params">(Builder</span></span></span><br><span class="line"><span class="function"><span class="params">$query, Builder $parentQuery, $columns = [<span class="string">'*'</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$query-&gt;from($query-&gt;getModel()-&gt;getTable().<span class="string">' as '</span>.$hash = <span class="keyword">$this</span>-&gt;getRelationCountHash());</span><br><span class="line">$query-&gt;getModel()-&gt;setTable($hash);</span><br><span class="line"><span class="keyword">return</span> $query-&gt;select($columns)-&gt;whereColumn(</span><br><span class="line"><span class="keyword">$this</span>-&gt;getQualifiedParentKeyName(), <span class="string">'='</span>, $hash.<span class="string">'.'</span>.<span class="keyword">$this</span></span><br><span class="line">-&gt;getForeignKeyName()</span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelationExistenceQuery</span><span class="params">(Builder $query, Builder $parentQuery, $columns = [<span class="string">'*'</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> $query-&gt;select($columns)-&gt;whereColumn(</span><br><span class="line"><span class="keyword">$this</span>-&gt;getQualifiedParentKeyName(), <span class="string">'='</span>, <span class="keyword">$this</span>-&gt;getExistenceCompareKey()</span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getExistenceCompareKey</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getQualifiedForeignKeyName();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ExistenceCount 约束<br>ExistenceCount  约束只是  select <em>  变成了  select count(\</em>)  :<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(\*) <span class="keyword">from</span> post <span class="keyword">where</span> user.id = post.user_id</span><br><span class="line">源代码：</span><br><span class="line"><span class="string">``</span><span class="string">`php</span></span><br><span class="line"><span class="string">public function getRelationExistenceCountQuery(Builder $query, Builder $parentQuery)</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    return $this-&gt;getRelationExistenceQuery($query, $parentQuery, new Expression('count(*)'));</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>关联关系添加到  where  条件<br>当关联关系的  存在  约束设置完毕后，就要加载到父模型的  where  条件中，一般会作为父模型的子查询：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addHasWhere</span><span class="params">(Builder $hasQuery, Relation $relation, $operator, $count, $boolean)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $hasQuery-&gt;mergeConstraintsFrom($relation-&gt;getQuery());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;canUseExistsForExistenceCheck($operator, $count)</span><br><span class="line">        ? <span class="keyword">$this</span>-&gt;addWhereExistsQuery($hasQuery-&gt;toBase(), $boolean, $operator === <span class="string">'&lt;'</span> &amp;&amp; $count === <span class="number">1</span>)</span><br><span class="line">        : <span class="keyword">$this</span>-&gt;addWhereCountQuery($hasQuery-&gt;toBase(), $operator, $count, $boolean);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addWhereExistsQuery</span><span class="params">(Builder $query, $boolean = <span class="string">'and'</span>, $not = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $type = $not ? <span class="string">'NotExists'</span> : <span class="string">'Exists'</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;wheres[] = compact(<span class="string">'type'</span>, <span class="string">'operator'</span>, <span class="string">'query'</span>, <span class="string">'boolean'</span>);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;addBinding($query-&gt;getBindings(), <span class="string">'where'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addWhereCountQuery</span><span class="params">(QueryBuilder $query, $operator = <span class="string">'&gt;='</span>, $count = <span class="number">1</span>, $boolean = <span class="string">'and'</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;query-&gt;addBinding($query-&gt;getBindings(), <span class="string">'where'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;where(<span class="keyword">new</span> Expression(<span class="string">'('</span>.$query-&gt;toSql().<span class="string">')'</span>),$operator,is_numeric($count) </span><br><span class="line">        ? <span class="keyword">new</span> Expression($count) </span><br><span class="line">        : $count,$boolean</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>existence  约束最后条件：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> <span class="keyword">exists</span> (<span class="keyword">select</span> * <span class="keyword">from</span> phone <span class="keyword">where</span> phone.user_id=user.id)</span><br></pre></td></tr></table></figure></p>
<p>ExistenceCount  约束:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> (<span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> phone <span class="keyword">where</span> phone.user_id=user.id) &gt;= <span class="number">3</span></span><br></pre></td></tr></table></figure></p>
<p>嵌套查询<br>嵌套查询需要进行递归来调用has函数：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">hasNested</span><span class="params">($relations, $operator = <span class="string">'&gt;='</span>, $count = <span class="number">1</span>, $boolean = <span class="string">'and'</span>, $callback = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$relations = explode(<span class="string">'.'</span>, $relations);</span><br><span class="line">$closure = <span class="function"><span class="keyword">function</span> <span class="params">($q)</span> <span class="title">use</span> <span class="params">(&amp;$closure, &amp;$relations, $operator, $count, $callback)</span> </span>&#123;</span><br><span class="line">count($relations) &gt; <span class="number">1</span></span><br><span class="line">? $q-&gt;whereHas(array_shift($relations), $closure)</span><br><span class="line">: $q-&gt;has(array_shift($relations), $operator, $count</span><br><span class="line">, <span class="string">'and'</span>, $callback);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;has(array_shift($relations), <span class="string">'&gt;='</span>, <span class="number">1</span>, $boolean</span><br><span class="line">, $closure);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">whereHas</span><span class="params">($relation, Closure $callback = null, $operator = <span class="string">'&gt;='</span>, $count = <span class="number">1</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;has($relation, $operator, $count, <span class="string">'and'</span>, $callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>例如<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$posts = Post::has(<span class="string">'comments.votes'</span>)-&gt;get();</span><br></pre></td></tr></table></figure></p>
<p>首先  hasNested  会返回：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;has(<span class="string">'comments'</span>, <span class="string">'&gt;='</span>, <span class="number">1</span>, <span class="string">'and'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($q)</span> <span class="title">use</span> <span class="params">(&amp;$closure, ‘votes’, <span class="string">'&gt;='</span>, <span class="number">1</span>, $callback)</span> </span>&#123;</span><br><span class="line">$q-&gt;has(‘votes’, <span class="string">'&gt;='</span>, <span class="number">1</span>, <span class="string">'and'</span>, $callback);</span><br><span class="line">&#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>生成的sql：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> post <span class="keyword">where</span> exist (<span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">comment</span> <span class="keyword">where</span> comment.post_id=post.id <span class="keyword">and</span> <span class="keyword">where</span> exist (<span class="keyword">select</span> * <span class="keyword">from</span> vote <span class="keyword">where</span> vote.comment_id=comment.id))</span><br></pre></td></tr></table></figure></p>
<h2 id="基于不存在的关联查询"><a href="#基于不存在的关联查询" class="headerlink" title="基于不存在的关联查询"></a>基于不存在的关联查询</h2><p>基于不存在的关联查询只是基于存在的关联查询<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add a relationship count / exists condition to the query.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $relation</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $boolean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  \Closure|null  $callback</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> \Illuminate\Database\Eloquent\Builder|static</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">doesntHave</span><span class="params">($relation, $boolean = <span class="string">'and'</span>, Closure $callback = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;has($relation, <span class="string">'&lt;'</span>, <span class="number">1</span>, $boolean, $callback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add a relationship count / exists condition to the query with where clauses.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $relation</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  \Closure|null  $callback</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> \Illuminate\Database\Eloquent\Builder|static</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">whereDoesntHave</span><span class="params">($relation, Closure $callback = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;doesntHave($relation, <span class="string">'and'</span>, $callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关联数据计数</p>
<p>如果您只想统计结果数而不需要加载实际数据，那么可以使用 withCount 方法，此方法会在您的结果集模型中添加一个 {关联名}_count 字段。例如：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$posts = App\Post::withCount(<span class="string">'comments'</span>)-&gt;get();</span><br><span class="line"><span class="comment">//select *,(select count(*) from comment where comment.post_id=post.id) as comments_count from post</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($posts <span class="keyword">as</span> $post) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $post-&gt;comments_count;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//多个关联数据「计数」，并为其查询添加约束条件：</span></span><br><span class="line">$posts = Post::withCount([<span class="string">'votes'</span>, <span class="string">'comments'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</span><br><span class="line">    $query-&gt;where(<span class="string">'content'</span>, <span class="string">'like'</span>, <span class="string">'foo%'</span>);</span><br><span class="line">&#125;])-&gt;get();</span><br><span class="line"><span class="comment">//select *,(select count(*) from comment where comment.post_id=post.id and content like 'foo%') as comments_count,(select count(*) from votes where vote.post_id=post.id) as votes_count from post</span></span><br><span class="line"><span class="keyword">echo</span> $posts[<span class="number">0</span>]-&gt;votes_count;</span><br><span class="line"><span class="keyword">echo</span> $posts[<span class="number">0</span>]-&gt;comments_count;</span><br><span class="line"><span class="comment">//可以为关联数据计数结果起别名，允许在同一个关联上多次计数：</span></span><br><span class="line">$posts = Post::withCount([</span><br><span class="line"><span class="string">'comments'</span>,</span><br><span class="line"><span class="string">'comments as pending_comments_count'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</span><br><span class="line">    $query-&gt;where(<span class="string">'approved'</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line">])-&gt;get();</span><br><span class="line"><span class="comment">//select *,(select count(*) from comment where comment.post_id=post.id) as comments_count,(select count(*) from comment where comment.post_id=post.id and approved=false) as pending_comments_count from post</span></span><br><span class="line"><span class="keyword">echo</span> $posts[<span class="number">0</span>]-&gt;comments_count;</span><br><span class="line"><span class="keyword">echo</span> $posts[<span class="number">0</span>]-&gt;pending_comments_count;</span><br></pre></td></tr></table></figure></p>
<p>withCount的源代码与has的代码高度相似：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add subselect queries to count the relations.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  mixed  $relations</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">withCount</span><span class="params">($relations)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($relations)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_null(<span class="keyword">$this</span>-&gt;query-&gt;columns)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;query-&gt;select([<span class="keyword">$this</span>-&gt;query-&gt;from.<span class="string">'.*'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $relations = is_array($relations) ? $relations : func_get_args();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;parseWithRelations($relations) <span class="keyword">as</span> $name =&gt; $constraints) &#123;</span><br><span class="line">        <span class="comment">// First we will determine if the name has been aliased using an "as" clause on the name</span></span><br><span class="line">        <span class="comment">// and if it has we will extract the actual relationship name and the desired name of</span></span><br><span class="line">        <span class="comment">// the resulting column. This allows multiple counts on the same relationship name.</span></span><br><span class="line">        $segments = explode(<span class="string">' '</span>, $name);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">unset</span>($alias);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count($segments) === <span class="number">3</span> &amp;&amp; Str::lower($segments[<span class="number">1</span>]) === <span class="string">'as'</span>) &#123;</span><br><span class="line">            [$name, $alias] = [$segments[<span class="number">0</span>], $segments[<span class="number">2</span>]];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $relation = <span class="keyword">$this</span>-&gt;getRelationWithoutConstraints($name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Here we will get the relationship count query and prepare to add it to the main query</span></span><br><span class="line">        <span class="comment">// as a sub-select. First, we'll get the "has" query and use that to get the relation</span></span><br><span class="line">        <span class="comment">// count query. We will normalize the relation name then append _count as the name.</span></span><br><span class="line">        $query = $relation-&gt;getRelationExistenceCountQuery(</span><br><span class="line">            $relation-&gt;getRelated()-&gt;newQuery(), <span class="keyword">$this</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        $query-&gt;callScope($constraints);</span><br><span class="line"></span><br><span class="line">        $query = $query-&gt;mergeConstraintsFrom($relation-&gt;getQuery())-&gt;toBase();</span><br><span class="line"></span><br><span class="line">        $query-&gt;orders = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        $query-&gt;setBindings([], <span class="string">'order'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count($query-&gt;columns) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            $query-&gt;columns = [$query-&gt;columns[<span class="number">0</span>]];</span><br><span class="line"></span><br><span class="line">            $query-&gt;bindings[<span class="string">'select'</span>] = [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Finally we will add the proper result column alias to the query and run the subselect</span></span><br><span class="line">        <span class="comment">// statement against the query builder. Then we will return the builder instance back</span></span><br><span class="line">        <span class="comment">// to the developer for further constraint chaining that needs to take place on it.</span></span><br><span class="line">        $column = $alias ?? Str::snake($name.<span class="string">'_count'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;selectSub($query, $column);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>解析关联关系名称</li>
<li>获取无约束的关联关系</li>
<li>为关联关系添加existenceCount约束</li>
<li>为关联关系添加with外部约束</li>
<li>将关联关系添加到where条件中</li>
<li>设置alias别名</li>
<li>创建select子查询</li>
</ul>
<h2 id="多对多关系的中间表查询"><a href="#多对多关系的中间表查询" class="headerlink" title="多对多关系的中间表查询"></a>多对多关系的中间表查询</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsToMany(<span class="string">'App\Role'</span>)-&gt;wherePivot(<span class="string">'approved'</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsToMany(<span class="string">'App\Role'</span>)-&gt;wherePivotIn(<span class="string">'priority'</span>, [<span class="number">1</span>, <span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set a where clause for a pivot table column.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $column</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string|null  $operator</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  mixed  $value</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $boolean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">wherePivot</span><span class="params">($column, $operator = null, $value = null, $boolean = <span class="string">'and'</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;pivotWheres[] = func_get_args();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;where(<span class="keyword">$this</span>-&gt;table.<span class="string">'.'</span>.$column, $operator, $value, $boolean);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set a "where in" clause for a pivot table column.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $column</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  mixed  $values</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $boolean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  bool  $not</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> $this</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">wherePivotIn</span><span class="params">($column, $values, $boolean = <span class="string">'and'</span>, $not = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;pivotWhereIns[] = func_get_args();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;whereIn(<span class="keyword">$this</span>-&gt;table.<span class="string">'.'</span>.$column, $values, $boolean, $not);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意这里的pivotWheres与pivotWheres变量，这个变量在对中间表的加载中会被使用：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a new query builder for the pivot table.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> \Illuminate\Database\Query\Builder</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">newPivotQuery</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $query = <span class="keyword">$this</span>-&gt;newPivotStatement();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;pivotWheres <span class="keyword">as</span> $arguments) &#123;</span><br><span class="line">        call_user_func_array([$query, <span class="string">'where'</span>], $arguments);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;pivotWhereIns <span class="keyword">as</span> $arguments) &#123;</span><br><span class="line">        call_user_func_array([$query, <span class="string">'whereIn'</span>], $arguments);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $query-&gt;where(<span class="keyword">$this</span>-&gt;foreignPivotKey, <span class="keyword">$this</span>-&gt;parent-&gt;&#123;<span class="keyword">$this</span>-&gt;parentKey&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Laravel/" rel="tag"># Laravel</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/05/28/MySQL的B-树索引的概念、使用、优化及使用场景/" rel="next" title="MySQL的B+树索引的概念、使用、优化及使用场景">
                <i class="fa fa-chevron-left"></i> MySQL的B+树索引的概念、使用、优化及使用场景
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/05/28/Laravel-Kernel/" rel="prev" title="Laravel-Kernel">
                Laravel-Kernel <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="CheBin">
            
              <p class="site-author-name" itemprop="name">CheBin</p>
              <div class="site-description motion-element" itemprop="description">看视频才能学会，看文字学不会的</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">1084</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">77</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          


          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/2023/07/06/JSON-Web-Token/" title="JSON Web Token" target="_blank">JSON Web Token</a>
                  </li>
                
                  <li>
                    <a href="/2023/07/04/11-FAQ/" title="11-FAQ" target="_blank">11-FAQ</a>
                  </li>
                
                  <li>
                    <a href="/2023/07/04/10-beego实用库/" title="10-beego实用库" target="_blank">10-beego实用库</a>
                  </li>
                
                  <li>
                    <a href="/2023/07/04/9-应用例子/" title="9-应用例子" target="_blank">9-应用例子</a>
                  </li>
                
                  <li>
                    <a href="/2023/07/04/8-beego第三方库/" title="8-beego第三方库" target="_blank">8-beego第三方库</a>
                  </li>
                
              </ul>
            </div>
        

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#关联模型的加载"><span class="nav-number">2.</span> <span class="nav-text">关联模型的加载</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#多对多关系的加载"><span class="nav-number">3.</span> <span class="nav-text">多对多关系的加载</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#关联模型的预加载"><span class="nav-number">4.</span> <span class="nav-text">关联模型的预加载</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#with函数"><span class="nav-number">4.1.</span> <span class="nav-text">with函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#get函数预加载"><span class="nav-number">4.2.</span> <span class="nav-text">get函数预加载</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#关联模型的关联查询"><span class="nav-number">5.</span> <span class="nav-text">关联模型的关联查询</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#基于存在的关联查询"><span class="nav-number">5.1.</span> <span class="nav-text">基于存在的关联查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#无约束的关联关系"><span class="nav-number">5.2.</span> <span class="nav-text">无约束的关联关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基于不存在的关联查询"><span class="nav-number">5.3.</span> <span class="nav-text">基于不存在的关联查询</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多对多关系的中间表查询"><span class="nav-number">5.4.</span> <span class="nav-text">多对多关系的中间表查询</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CheBin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">8.2m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">124:51</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
