<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="思考并回答以下问题：  闭包是个Closure类吗？ 闭包在创建时就会为传入的参数、use中的变量创建新的内存，相当于clone一份。怎么理解？ Closure的bind方法是什么意思？ 可以在匿名函数中使用$this关键字吗？">
<meta name="keywords" content="函数式编程">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP中的闭包">
<meta property="og:url" content="http://yoursite.com/2020/03/12/PHP中的闭包/index.html">
<meta property="og:site_name" content="车斌的技术博客">
<meta property="og:description" content="思考并回答以下问题：  闭包是个Closure类吗？ 闭包在创建时就会为传入的参数、use中的变量创建新的内存，相当于clone一份。怎么理解？ Closure的bind方法是什么意思？ 可以在匿名函数中使用$this关键字吗？">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-06-12T06:29:16.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PHP中的闭包">
<meta name="twitter:description" content="思考并回答以下问题：  闭包是个Closure类吗？ 闭包在创建时就会为传入的参数、use中的变量创建新的内存，相当于clone一份。怎么理解？ Closure的bind方法是什么意思？ 可以在匿名函数中使用$this关键字吗？">






  <link rel="canonical" href="http://yoursite.com/2020/03/12/PHP中的闭包/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>PHP中的闭包 | 车斌的技术博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">放弃会成为一种习惯</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/12/PHP中的闭包/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CheBin">
      <meta itemprop="description" content="看视频才能学会，看文字学不会的">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">PHP中的闭包

              
            
          </h1>
        

        <div class="post-meta">

          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-03-12 08:47:24" itemprop="dateCreated datePublished" datetime="2020-03-12T08:47:24+08:00">2020-03-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-06-12 14:29:16" itemprop="dateModified" datetime="2020-06-12T14:29:16+08:00">2020-06-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/PHP/" itemprop="url" rel="index"><span itemprop="name">PHP</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">32k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">29 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考并回答以下问题：</p>
<ul>
<li>闭包是个Closure类吗？</li>
<li>闭包在创建时就会为传入的参数、use中的变量创建新的内存，相当于clone一份。怎么理解？</li>
<li>Closure的bind方法是什么意思？</li>
<li>可以在匿名函数中使用$this关键字吗？</li>
</ul>
<a id="more"></a>
<p>在PHP中闭包与匿名函数是一个概念：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$sayHello = <span class="function"><span class="keyword">function</span><span class="params">($name)</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">"Hello $name"</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>在PHP中闭包是像函数的对象，是个Closure类，只是能够像函数一样调用：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sayHello(<span class="string">"world"</span>);</span><br></pre></td></tr></table></figure></p>
<p>输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello world</span><br></pre></td></tr></table></figure></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var_dump($sayHello <span class="keyword">instanceof</span> Closure);</span><br></pre></td></tr></table></figure>
<p>输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">boolean(true)</span><br></pre></td></tr></table></figure></p>
<p>闭包在创建时就会为传入的参数、use中的变量创建新的内存，相当于clone一份，因此与函数外部的变量变化无关；<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$name = <span class="string">'world'</span>;</span><br><span class="line"> </span><br><span class="line">$sayHello = <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="title">use</span><span class="params">($name)</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">"Hello $name"</span>);</span><br><span class="line">&#125;; <span class="comment">// 这里不要忘记结束的;号</span></span><br><span class="line"> </span><br><span class="line">$sayHello(); <span class="comment">// 必须函数方式调用，即用(), 输出Hello world</span></span><br><span class="line"> </span><br><span class="line">$name = <span class="string">'zj'</span>;</span><br><span class="line"> </span><br><span class="line">$sayHello();<span class="comment">// 输出Hello world</span></span><br></pre></td></tr></table></figure></p>
<p>如果想使闭包内和外部的变量同步，则use中传入引用即可，就是加个&amp;：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$name = <span class="string">'world'</span>;</span><br><span class="line"> </span><br><span class="line">$sayHello = <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="title">use</span><span class="params">(&amp;$name)</span></span>&#123; <span class="comment">// 传入了引用</span></span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">"Hello $name"</span>);</span><br><span class="line">&#125;;<span class="comment">//这里不要忘记结束的;号</span></span><br><span class="line"> </span><br><span class="line">$sayHello(); <span class="comment">// 必须函数方式调用，即用(), 输出Hello world</span></span><br><span class="line"> </span><br><span class="line">$name = <span class="string">'zj'</span>;</span><br><span class="line"> </span><br><span class="line">$sayHello();<span class="comment">// 输出Hello zj</span></span><br></pre></td></tr></table></figure></p>
<p>Closure类有两个方法：bind()和bindTo()</p>
<ul>
<li>Closure::bind — 复制一个闭包，绑定指定的$this对象和类作用域。</li>
<li>Closure::bindTo — 复制当前闭包对象，绑定指定的$this对象和类作用域。</li>
</ul>
<p>通过这两个方法可以给类扩展复杂功能，类似策略模式，将实际操作与类定义解耦。比如通过bing为用户类增加行为：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name = <span class="string">'Tom'</span>;</span><br><span class="line">    <span class="keyword">public</span> $age = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> $action = [];</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$sayHello = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">"Hello &#123;$this-&gt;name&#125;\n"</span>);</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">$swimming = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">"&#123;$this-&gt;name&#125; is swimming\n"</span>);</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">$bindSayHello = Closure::bind($sayHello, <span class="keyword">new</span> User());</span><br><span class="line">$bindSwimming = Closure::bind($swimming, <span class="keyword">new</span> User());</span><br><span class="line">$bindSayHello();</span><br><span class="line">$bindSwimming();</span><br></pre></td></tr></table></figure></p>
<p>输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Hello Tom </span><br><span class="line">Tom is swimming</span><br></pre></td></tr></table></figure></p>
<p>可以把类写的更优雅点：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name = <span class="string">'Tom'</span>;</span><br><span class="line">    <span class="keyword">public</span> $age = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> $action = [];</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addAction</span><span class="params">($actionName, $actionFunction)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;action[$actionName] = Closure::bind($actionFunction, <span class="keyword">$this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">doAction</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;action <span class="keyword">as</span> $actionFunction) &#123;</span><br><span class="line">            $actionFunction(<span class="keyword">$this</span>-&gt;name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">$sayHello = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">"Hello &#123;$this-&gt;name&#125;\n"</span>);</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">$swimming = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">"&#123;$this-&gt;name&#125; is swimming\n"</span>);</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">$bindSayHello = Closure::bind($sayHello, <span class="keyword">new</span> user());</span><br><span class="line">$bindSayHello();</span><br><span class="line"> </span><br><span class="line">$user = <span class="keyword">new</span> user();</span><br><span class="line"> </span><br><span class="line">$user-&gt;addAction(<span class="string">'sayHello'</span>, $sayHello);</span><br><span class="line">$user-&gt;addAction(<span class="string">'swimming'</span>, $swimming);</span><br><span class="line">$user-&gt;doAction();</span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="comment">// Hello Tom </span></span><br><span class="line"><span class="comment">// Hello Tom </span></span><br><span class="line"><span class="comment">// Tom is swimming</span></span><br></pre></td></tr></table></figure></p>
<p>bindTo方法与bind类似，只是通过闭包调用的，将自身绑定到对象或类上。</p>
<p>bind及bindTo方法都有第三个参数，确定绑定的作用域。</p>
<p>发现一个闭包实现中间件的例子，搬来作为补充学习：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 框架核心应用层</span></span><br><span class="line">$application = <span class="function"><span class="keyword">function</span><span class="params">($name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"this is a &#123;$name&#125; application\n"</span>;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 前置校验中间件</span></span><br><span class="line">$auth = <span class="function"><span class="keyword">function</span><span class="params">($handler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">($name)</span> <span class="title">use</span> <span class="params">($handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&#123;$name&#125; need a auth middleware\n"</span>;</span><br><span class="line">        <span class="keyword">return</span> $handler($name);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 前置过滤中间件</span></span><br><span class="line">$filter = <span class="function"><span class="keyword">function</span><span class="params">($handler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">($name)</span> <span class="title">use</span> <span class="params">($handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&#123;$name&#125; need a filter middleware\n"</span>;</span><br><span class="line">        <span class="keyword">return</span> $handler($name);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 后置日志中间件</span></span><br><span class="line">$log = <span class="function"><span class="keyword">function</span><span class="params">($handler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">($name)</span> <span class="title">use</span> <span class="params">($handler)</span> </span>&#123;</span><br><span class="line">        $return = $handler($name);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&#123;$name&#125; need a log middleware\n"</span>;</span><br><span class="line">        <span class="keyword">return</span> $return;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 中间件栈</span></span><br><span class="line">$stack = [];</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 打包</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pack_middleware</span><span class="params">($handler, $stack)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (array_reverse($stack) <span class="keyword">as</span> $key =&gt; $middleware) </span><br><span class="line">    &#123;</span><br><span class="line">        $handler = $middleware($handler);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $handler;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 注册中间件</span></span><br><span class="line"><span class="comment">// 这里用的都是全局中间件，实际应用时还可以为指定路由注册局部中间件</span></span><br><span class="line">$stack[<span class="string">'log'</span>] = $log;</span><br><span class="line">$stack[<span class="string">'filter'</span>] = $filter;</span><br><span class="line">$stack[<span class="string">'auth'</span>] = $auth;</span><br><span class="line"> </span><br><span class="line">$run = pack_middleware($application, $stack);</span><br></pre></td></tr></table></figure>
<p>输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Laravle need a filter middleware</span><br><span class="line">Laravle need a auth middleware</span><br><span class="line">this is a Laravle application</span><br><span class="line">Laravle need a log middleware</span><br></pre></td></tr></table></figure></p>
<p>打包程序</p>
<p>中间件的执行顺序是由打包函数(pack_middleware)决定，这里返回的闭包实际上相当于:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$run = $log($filter($auth($application)));</span><br><span class="line">$run(<span class="string">'Laravle'</span>);</span><br></pre></td></tr></table></figure></p>
<p>编写规范<br>中间件要要满足一定的规范：总是返回一个闭包，闭包中总是传入相同的参数（由主要逻辑决定）， 闭包总是返回句柄(handler)的执行结果；</p>
<p>如果中间件的逻辑在返回句柄return $handler($name)前完成，就是前置中间件，否则为后置中间件。</p>
<p>一、什么是闭包</p>
<p>理论上讲，闭包和匿名函数是不同的概念，不过，php将其视作相同的概念。</p>
<p>闭包和匿名函数其实是伪装成函数的对象，如果审查php闭包和匿名函数，会发现他们是Closure类的实例，闭包和字符串或整数一样，也是一等值类型。  </p>
<p>二、创建一个闭包<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$closure = <span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sprintf(<span class="string">'Hello %s'</span>, $name);</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">echo</span> $closure(<span class="string">'Yee Jason'</span>);</span><br></pre></td></tr></table></figure></p>
<p> 输出 Hello Yee Jason.</p>
<p>之所以能调用$closure变量，是因为这个变量的值是一个闭包，而且闭包对象实现了__invoke()魔术方法，只要变量名后面有()，php就会查并调用__invoke() 方法。 </p>
<p>我通常把闭包当做函数和方法的回调使用，很多php函数都会用到回调函数，例如array_map和preg_replace_callback()是使用匿名函数的绝佳时机，记住，闭包和其他值一样，可以作为参数传入其他php函数。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$numberPlusOne = array_map(<span class="function"><span class="keyword">function</span><span class="params">($number)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $number + <span class="number">1</span>;</span><br><span class="line">&#125;, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"> </span><br><span class="line">print_r($numberPlusOne);</span><br></pre></td></tr></table></figure></p>
<p>在PHP闭包之前, php开发者无法选择，只能单独创建具名函数，然后引用那个函数，这么做，代码执行的稍微慢一点， 而且把回调的实现和使用场所隔离开了，传统的php代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">incrementNumber</span><span class="params">($number)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $number + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">$numberPlusOne = array_map(<span class="string">'incrementNumber'</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">print_r($numberPlusOne);</span><br></pre></td></tr></table></figure></p>
<p>以上两个例子输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Array ( [0] =&gt; 2 [1] =&gt; 3 [2] =&gt; 4 )</span><br></pre></td></tr></table></figure></p>
<p>三、附加状态</p>
<p>前面演示了如何把匿名函数当成回调使用，下面探讨如何为php闭包附加并封装状态，javascript开发者可能对php的闭包感到奇怪，因为php闭包不会像真正的javascript闭包那样自动封装应用的状态，在php中，必须手动调用闭包对象的bindTo()方法或者使用use关键字，把状态附加到php闭包上。</p>
<p>使用use关键字附加闭包状态常见的多，因此我们先看这种方式，使用use关键字把变量附加到闭包上时，附加的变量会记住附件时付给他的值。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enclosePerson</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($doCommand)</span> <span class="title">use</span> <span class="params">($name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sprintf(<span class="string">'%s, %s'</span>, $name, $doCommand);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">$clay = enclosePerson(<span class="string">'Clay'</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">echo</span> $clay(<span class="string">'get me sweet tea!'</span>);</span><br></pre></td></tr></table></figure></p>
<p>以上代码输出：Clay get me sweet tea </p>
<p>使用use关键字，把多个参数传入闭包时，需要还是用，号分隔开。</p>
<p>具名函数enclosePerson()有个名为$name的参数，这个函数返回一个闭包对象，而且这个闭包对象封装了 $name参数，  即便 返回的闭包对象跳出了enclosePerson()函数的作用域，它也会记住$name参数的值，因为$name变量仍在闭包中。</p>
<p>使用bindTo方法附加闭包的状态</p>
<p>别忘了php 闭包是对象，与任何其他的php对象类似，每个闭包实例都可以使用$this关键字获取闭包的内部状态。<br>闭包对象的默认状态没什么用，不过有一个 __invoke()魔术方法和bindTo()方法，仅此而已。<br>但是bindTo() 方法为闭包增加了一些有趣的潜力，我们可以使用这个方法把Closure对象的内部状态绑定到其他的对象上，<br>bindTo() 方法的第二个参数很重要，其作用是指定绑定闭包的那个对象所属的php类，因此闭包可以访问绑定闭包的对象中<br>受保护和私有的成员变量。</p>
<p>你会发现，php框架经常使用bindTo()方法把路由URL映射到匿名回调函数上，框架会把匿名函数绑定到应用对象上，这么做可以在这个匿名函数中使用$this关键字引用重要的对象。</p>
<p>例子：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APP</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $routes = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">protected</span> $responseStatus = <span class="string">'200 ok'</span>;</span><br><span class="line">    <span class="keyword">protected</span> $responseContentType = <span class="string">'text/html'</span>;</span><br><span class="line">    <span class="keyword">protected</span> $responseBody = <span class="string">'hello world'</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addRoute</span><span class="params">($routePath, $routeCallback)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;routes[$routePath] = $routeCallback-&gt;bindTo(<span class="keyword">$this</span>, <span class="keyword">__CLASS__</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispath</span><span class="params">($currentPath)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;routes <span class="keyword">as</span> $routePath =&gt; $callback) &#123;</span><br><span class="line">            <span class="keyword">if</span> ($routePath == $currentPath) &#123;</span><br><span class="line">                $callback();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        header(<span class="string">'HTTP/1.1'</span>. <span class="keyword">$this</span>-&gt;responseStatus);</span><br><span class="line">        header(<span class="string">'Content-type'</span> . <span class="keyword">$this</span>-&gt;responseContentType);</span><br><span class="line">        header(<span class="string">'Content-length'</span> . <span class="keyword">$this</span>-&gt;responseBody);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;responseBody;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们要特别注意addRoute方法，这个方法的参数分别是一个路由路径和路由回调，dispatch() 方法的参数是当前的HTTP请 求的  路径，它会调用匹配的路由回调，我们把路由绑定到当前的App实例上，这么做就能再回调函数中处理App实例的状态 。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$app = <span class="keyword">new</span> App();</span><br><span class="line">$app-&gt;addRoute(<span class="string">'/users/josh'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;responseContentType = <span class="string">'application/json; charset=utf8'</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;responseBody = <span class="string">'&#123;"name" : "yee Jason"&#125;'</span>;</span><br><span class="line">&#125;);</span><br><span class="line">$app-&gt;dispatch(<span class="string">'/users/josh'</span>);</span><br></pre></td></tr></table></figure></p>
<p>匿名函数<br>提到闭包就不得不想起匿名函数，也叫闭包函数（closures），貌似PHP闭包实现主要就是靠它。声明一个匿名函数是这样：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$func = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">&#125;; <span class="comment">//带结束符</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到，匿名函数因为没有名字，如果要使用它，需要将其返回给一个变量。匿名函数也像普通函数一样可以声明参数，调用方法也相同：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$func = <span class="function"><span class="keyword">function</span><span class="params">( $param )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $param;</span><br><span class="line">&#125;;</span><br><span class="line">$func( <span class="string">'some string'</span> );</span><br><span class="line"><span class="comment">//输出：</span></span><br><span class="line"><span class="comment">//some string</span></span><br></pre></td></tr></table></figure></p>
<p>顺便提一下，PHP在引入闭包之前，也有一个可以创建匿名函数的函数：create function，但是代码逻辑只能写成字符串，这样看起来很晦涩并且不好维护，所以很少有人用。 </p>
<p>实现闭包<br>将匿名函数在普通函数中当做参数传入，也可以被返回。这就实现了一个简单的闭包。</p>
<p>下边有三个例子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//例一</span></span><br><span class="line"><span class="comment">//在函数里定义一个匿名函数，并且调用它</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printStr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $func = <span class="function"><span class="keyword">function</span><span class="params">( $str )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $str;</span><br><span class="line">    &#125;;</span><br><span class="line">    $func( <span class="string">'some string'</span> );</span><br><span class="line">&#125;</span><br><span class="line">printStr();</span><br><span class="line"></span><br><span class="line"><span class="comment">//例二</span></span><br><span class="line"><span class="comment">//在函数中把匿名函数返回，并且调用它</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPrintStrFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $func = <span class="function"><span class="keyword">function</span><span class="params">( $str )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $str;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> $func;</span><br><span class="line">&#125;</span><br><span class="line">$printStrFunc = getPrintStrFunc();</span><br><span class="line">$printStrFunc( <span class="string">'some string'</span> );</span><br><span class="line"></span><br><span class="line"><span class="comment">//例三</span></span><br><span class="line"><span class="comment">//把匿名函数当做参数传递，并且调用它</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callFunc</span><span class="params">( $func )</span> </span>&#123;</span><br><span class="line">    $func( <span class="string">'some string'</span> );</span><br><span class="line">&#125;</span><br><span class="line">$printStrFunc = <span class="function"><span class="keyword">function</span><span class="params">( $str )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $str;</span><br><span class="line">&#125;;</span><br><span class="line">callFunc( $printStrFunc );</span><br><span class="line"><span class="comment">//也可以直接将匿名函数进行传递。如果你了解js，这种写法可能会很熟悉</span></span><br><span class="line">callFunc( <span class="function"><span class="keyword">function</span><span class="params">( $str )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $str;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>连接闭包和外界变量的关键字：USE<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMoney</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $rmb = <span class="number">1</span>;</span><br><span class="line">    $dollar = <span class="number">6</span>;</span><br><span class="line">    $func = <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="title">use</span> <span class="params">( $rmb )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $rmb;</span><br><span class="line">        <span class="keyword">echo</span> $dollar;</span><br><span class="line">    &#125;;</span><br><span class="line">    $func();</span><br><span class="line">&#125;</span><br><span class="line">getMoney();</span><br><span class="line"><span class="comment">//输出：</span></span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">//报错，找不到dorllar变量</span></span><br></pre></td></tr></table></figure></p>
<p>闭包可以保存所在代码块上下文的一些变量和值。PHP在默认情况下，匿名函数不能调用所在代码块的上下文变量，而需要通过使用use关键字。 换一个例子看看：</p>
<p>可以看到，dollar没有在use关键字中声明，在这个匿名函数里也就不能获取到它，所以开发中要注意这个问题。<br>  有人可能会想到，是否可以在匿名函数中改变上下文的变量，但我发现是不可以的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMoney</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $rmb = <span class="number">1</span>;</span><br><span class="line">    $func = <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="title">use</span> <span class="params">( $rmb )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $rmb;</span><br><span class="line">        <span class="comment">//把$rmb的值加1</span></span><br><span class="line">        $rmb++;</span><br><span class="line">    &#125;;</span><br><span class="line">    $func();</span><br><span class="line">    <span class="keyword">echo</span> $rmb;</span><br><span class="line">&#125;</span><br><span class="line">getMoney();</span><br><span class="line"><span class="comment">//输出：</span></span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">//1</span></span><br></pre></td></tr></table></figure>
<p>啊，原来use所引用的也只不过是变量的一个副本而已。但是我想要完全引用变量，而不是复制。 要达到这种效果，其实在变量前加一个 &amp; 符号就可以了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMoney</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $rmb = <span class="number">1</span>;</span><br><span class="line">    $func = <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="title">use</span> <span class="params">( &amp;$rmb )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $rmb;</span><br><span class="line">        <span class="comment">//把$rmb的值加1</span></span><br><span class="line">        $rmb++;</span><br><span class="line">    &#125;;</span><br><span class="line">    $func();</span><br><span class="line">    <span class="keyword">echo</span> $rmb;</span><br><span class="line">&#125;</span><br><span class="line">getMoney();</span><br><span class="line"><span class="comment">//输出：</span></span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">//2</span></span><br></pre></td></tr></table></figure>
<p>好，这样匿名函数就可以引用上下文的变量了。如果将匿名函数返回给外界，匿名函数会保存use所引用的变量，而外界则不能得到这些变量，这样形成‘闭包’这个概念可能会更清晰一些。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMoneyFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $rmb = <span class="number">1</span>;</span><br><span class="line">    $func = <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="title">use</span> <span class="params">( &amp;$rmb )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $rmb;</span><br><span class="line">        <span class="comment">//把$rmb的值加1</span></span><br><span class="line">        $rmb++;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> $func;</span><br><span class="line">&#125;$getMoney = getMoneyFunc();</span><br><span class="line">$getMoney();</span><br><span class="line">$getMoney();</span><br><span class="line">$getMoney();</span><br><span class="line"><span class="comment">//输出：</span></span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">//3</span></span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>PHP闭包的特性并没有太大惊喜，其实用CLASS就可以实现类似甚至强大得多的功能，更不能和js的闭包相提并论，只能期待PHP以后对闭包支持的改进。不过匿名函数还是挺有用的，比如在使用preg_replace_callback等之类的函数可以不用在外部声明回调函数了。</p>
<p>一、闭包总结<br>把一个闭包转换为某个类的方法(只是这个方法不需要通过对象调用), 这样闭包中的$this、static、self就转换成了对应的对象或类</p>
<p>把闭包当成对象的成员方法或者静态成员方法.<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Closure::bind($cl1, <span class="keyword">null</span>, <span class="string">'A'</span>); <span class="comment">//就相当于在类里面加了个静态成员方法</span></span><br><span class="line">Closure::bind($cl2, <span class="keyword">new</span> A(), <span class="string">'A'</span>); <span class="comment">//相当于在类里面加了个成员方法</span></span><br></pre></td></tr></table></figure></p>
<p>成员方法中使用$this访问对象, 静态成员方法直接使用类名::成员的方法.<br>但是因为是匿名函数, 没有函数名, 所以返回一个已经绑定$this对象和类作用域的闭包给你使用.</p>
<p>二、闭包基本用法<br>闭包（Closure）又叫做匿名函数，也就是没有定义名字的函数。比如下面的例子：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义一个闭包，并把它赋给变量 $f</span></span><br><span class="line">$f = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用闭包也很简单</span></span><br><span class="line">$f(); <span class="comment">//这样就调用了闭包，输出 7</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 当然更多的时候是把闭包作为参数(回调函数)传递给函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">testClosure</span> <span class="params">(Closure $callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $callback();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// $f 作为参数传递给函数 testClosure，如果是普遍函数是没有办法作为testClosure的参数的</span></span><br><span class="line">testClosure($f);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可以直接将定义的闭包作为参数传递，而不用提前赋给变量</span></span><br><span class="line">testClosure (<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 闭包不止可以做函数的参数，也可以作为函数的返回值</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getClosure</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">7</span>; &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$c = getClosure(); <span class="comment">// 函数返回的闭包就复制给 $c 了</span></span><br><span class="line">$c(); <span class="comment">// 调用闭包，返回 7</span></span><br></pre></td></tr></table></figure></p>
<p>三、闭包类（Closure）<br>定义一个闭包函数，其实是产生了一个闭包类（Closure）的对象，Closure 类摘要如下<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Closure &#123;   </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Closure bind (Closure $closure , object $newthis [, mixed $newscope = <span class="string">'static'</span> ])  </span><br><span class="line">    <span class="keyword">public</span> Closure bindTo (object $newthis [, mixed $newscope = <span class="string">'static'</span> ])  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方法说明：<br>Closure::bind： 复制一个闭包，绑定指定的 $this 对象和类作用域。<br>Closure::bindTo： 复制当前闭包对象，绑定指定的 $this 对象和类作用域。<br>下面将介绍<br><strong>Closure::bind</strong>和Closure::bindTo<br>参数和返回值说明：<br>closure：表示需要绑定的闭包对象。<br>newthis：表示需要绑定到闭包对象的对象，或者 NULL 创建未绑定的闭包。<br>newscope：表示想要绑定给闭包的类作用域，可以传入类名或类的示例，默认值是’static’， 表示不改变。<br>该方法成功时返回一个新的 Closure 对象，失败时返回 FALSE。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $cat = <span class="string">"cat"</span>;  </span><br><span class="line">    <span class="keyword">private</span> $dog = <span class="string">"dog"</span>;  </span><br><span class="line">    <span class="keyword">public</span> $pig = <span class="string">"pig"</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment"> * 获取Animal类静态私有成员属性 </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line">$cat = <span class="keyword">static</span> <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> Animal::$cat;  </span><br><span class="line">&#125;;  </span><br><span class="line"></span><br><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment"> * 获取Animal实例私有成员属性 </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line">$dog = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dog;  </span><br><span class="line">&#125;;  </span><br><span class="line"></span><br><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment"> * 获取Animal实例公有成员属性 </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line">$pig = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;pig;  </span><br><span class="line">&#125;;  </span><br><span class="line"></span><br><span class="line">$bindCat = Closure::bind($cat, <span class="keyword">null</span>, <span class="keyword">new</span> Animal());<span class="comment">// 给闭包绑定了Animal实例的作用域，但未给闭包绑定$this对象  </span></span><br><span class="line">$bindDog = Closure::bind($dog, <span class="keyword">new</span> Animal(), <span class="string">'Animal'</span>);<span class="comment">// 给闭包绑定了Animal类的作用域，同时将Animal实例对象作为$this对象绑定给闭包  </span></span><br><span class="line">$bindPig = Closure::bind($pig, <span class="keyword">new</span> Animal());<span class="comment">// 将Animal实例对象作为$this对象绑定给闭包,保留闭包原有作用域  </span></span><br><span class="line"><span class="keyword">echo</span> $bindCat(),<span class="string">'&lt;br&gt;'</span>;<span class="comment">// 根据绑定规则，允许闭包通过作用域限定操作符获取Animal类静态私有成员属性  </span></span><br><span class="line"><span class="keyword">echo</span> $bindDog(),<span class="string">'&lt;br&gt;'</span>;<span class="comment">// 根据绑定规则，允许闭包通过绑定的$this对象(Animal实例对象)获取Animal实例私有成员属性  </span></span><br><span class="line"><span class="keyword">echo</span> $bindPig(),<span class="string">'&lt;br&gt;'</span>;<span class="comment">// 根据绑定规则，允许闭包通过绑定的$this对象获取Animal实例公有成员属性</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// bindTo与bind类似，是面向对象的调用方式，这里只举一个，其他类比就可以</span></span><br><span class="line">$bindCat = $cat-&gt;bindTo(<span class="keyword">null</span>, <span class="string">'Animal'</span>);</span><br></pre></td></tr></table></figure></p>
<p>以上示例输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat</span><br><span class="line">dog</span><br><span class="line">pig</span><br></pre></td></tr></table></figure></p>
<p>四、连接闭包和外界变量的关键字：USE</p>
<p>闭包可以保存所在代码块上下文的一些变量和值。PHP在默认情况下，匿名函数不能调用所在代码块的上下文变量，而需要通过使用 use 关键字。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMoney</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $rmb = <span class="number">1</span>;</span><br><span class="line">    $dollar = <span class="number">6</span>;</span><br><span class="line">    $func = <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="title">use</span> <span class="params">( $rmb )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $rmb;</span><br><span class="line">        <span class="keyword">echo</span> $dollar;</span><br><span class="line">    &#125;;</span><br><span class="line">    $func();</span><br><span class="line">&#125;</span><br><span class="line">getMoney();</span><br><span class="line"><span class="comment">//输出：</span></span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">//报错，找不到dorllar变量</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到，dollar没有在use关键字中声明，在这个匿名函数里也就不能获取到它，所以开发中要注意这个问题。</p>
<p>有人可能会想到，是否可以在匿名函数中改变上下文的变量，但我发现是不可以的：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMoney</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $rmb = <span class="number">1</span>;</span><br><span class="line">    $func = <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="title">use</span> <span class="params">( $rmb )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $rmb;</span><br><span class="line">        <span class="comment">//把$rmb的值加1</span></span><br><span class="line">        $rmb++;</span><br><span class="line">    &#125;;</span><br><span class="line">    $func();</span><br><span class="line">    <span class="keyword">echo</span> $rmb;</span><br><span class="line">&#125;</span><br><span class="line">getMoney();</span><br><span class="line"><span class="comment">//输出：</span></span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">//1</span></span><br></pre></td></tr></table></figure></p>
<p>原来use所引用的也只不过是变量的一个副本而已。但是我想要完全引用变量，而不是复制。要达到这种效果，其实在变量前加一个 &amp; 符号就可以了：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMoneyFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $rmb = <span class="number">1</span>;</span><br><span class="line">    $func = <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="title">use</span> <span class="params">( &amp;$rmb )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $rmb;</span><br><span class="line">        <span class="comment">//把$rmb的值加1</span></span><br><span class="line">        $rmb++;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> $func;</span><br><span class="line">&#125;</span><br><span class="line">$getMoney = getMoneyFunc();</span><br><span class="line">$getMoney();</span><br><span class="line">$getMoney();</span><br><span class="line">$getMoney();</span><br><span class="line"><span class="comment">//输出：</span></span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">//3</span></span><br></pre></td></tr></table></figure></p>
<p>匿名函数<br>实现一个简单的匿名函数：</p>
<p>上面就是一个简单的匿名函数，定义一个函数体，将函数体赋值给一个变量（php5.3之后支持该写法）。</p>
<p>实现闭包<br>1、当做参数传递：</p>
<p>2、将匿名函数返回：</p>
<p>捕获外界变量<br>闭包： 闭包是词法作用于的体现，一个持有外部环境自由变量的函数就是闭包。闭包体现的是在程序运行过程中，由 “不确定”变为“ 确定” 的过程。</p>
<p>捕获外部变量：在PHP中对捕获这一动作有了更清晰的表现，使用use关键字。如上面例2。</p>
<p>在上面的例2中，匿名函数$func通过use关键字捕获了外部的自由变量$param，在调用时通过传入cFunc()函数的参数123（$param此时会变为“确定”状态），进而调用匿名函数时输出“params:456 123”。</p>
<p>use引入的是自由变量的副本。</p>
<p>golang闭包： 在golang中同样通过匿名函数实现了闭包，和PHP不同的是，golang中的闭包是默认会引入上下文的自由变量，且引入的地址，即在闭包函数内部修改变量会在函数外部生效。</p>
<p>PHP Closure类<br>用于代表匿名函数类。在PHP中定义一个闭包函数其实就是一个Closure类的实例。</p>
<p>类摘要<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Closure &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 方法 */</span></span><br><span class="line"></span><br><span class="line">__construct ( void )</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> bind ( Closure $closure , object $newthis [, mixed $newscope = <span class="string">'static'</span> ] ) : Closure</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> bindTo ( object $newthis [, mixed $newscope = <span class="string">'static'</span> ] ) : Closure</span><br></pre></td></tr></table></figure></p>
<p>Closure::__construct — 用于禁止实例化的构造函数</p>
<p>Closure::bind — 复制一个闭包，绑定指定的$this对象和类作用域。<br>Closure::bindTo — 复制当前闭包对象，绑定指定的$this对象和类作用域。<br>Closure::bind<br>复制一个闭包，绑定指定的$this对象和类作用域，返回一个新的匿名函数</p>
<p>参数说明：<br>closure： 需要绑定的匿名函数。<br>newthis： 需要绑定到匿名函数的对象，或者 NULL 创建未绑定的闭包。（ 理解：可以选择是否将匿名函数绑定到一个类对象，若绑定到了一个类对象，则可以在匿名函数内使用 $this ，否则不可使用。 ）<br>newscope： 想要绑定给闭包的类作用域，或者 ‘static’ 表示不改变。如果传入一个对象，则使用这个对象的类型名。类作用域用来决定在闭包中 $this 对象的 私有、保护方法 的可见性。（ 理解：如果传入一个类，则可以访问类的static、private、protected属性，否则只能访问public属性。 ）<br>简单理解：可以简单理解为将该匿名函数绑定到一个类或实例。根据参数的不同，可以访问不同的类的属性。</p>
<p>输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">bind cat</span><br><span class="line"></span><br><span class="line">string(3) &quot;cat&quot;</span><br><span class="line"></span><br><span class="line">bind dog</span><br><span class="line"></span><br><span class="line">string(3) &quot;dog&quot;</span><br><span class="line"></span><br><span class="line">bind dog2</span><br><span class="line"></span><br><span class="line">Fatal error: Using $this when not in object context</span><br></pre></td></tr></table></figure></p>
<p>Closure::bindTo<br>Closure::bind()的非静态形式。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>PHP通过匿名函数实现闭包。<br>可以通过将匿名函数作为参数或返回值实现闭包。<br>可以通过use关键字引入外部变量，且引入的变量副本。<br>匿名函数均实现了Closure类，且可以通过Closure::bind()方法将匿名函数绑定到某个类。以上是文章全部内容，有需要学习交流的友人请加入Swoole交流群的咱们一起，有问题一起交流，一起进步！前提是你是学技术的。感谢阅读！</p>
<p>面向对象变成语言代码的复用主要采用继承来实现，而函数的复用，就是通过闭包来实现。这就是闭包的设计初衷。</p>
<p>注：PHP里面闭包函数是为了复用函数而设计的语言特性，如果在闭包函数里面访问指定域的变量，使用use关键字来实现。</p>
<p>PHP具有面向函数的编程特性，但是也是面向对象编程语言，PHP 会自动把闭包函数转换成内置类 Closure 的对象实例，依赖Closure 的对象实例又给闭包函数添加了更多的能力。 </p>
<p>闭包不能被实例(私有构造函数)，也不能被继承(finally 类)。可以通过反射来判断闭包实例是否能被实例，继承。</p>
<p>匿名函数</p>
<p>提到闭包就不得不想起匿名函数，也叫闭包函数（closures），貌似PHP闭包实现主要就是靠它。声明一个匿名函数是这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line">$func = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">&#125;; <span class="comment">//带结束符</span></span><br><span class="line">```　　</span><br><span class="line"></span><br><span class="line">可以看到，匿名函数因为没有名字，如果要使用它，需要将其返回给一个变量。匿名函数也像普通函数一样可以声明参数，调用方法也相同：</span><br><span class="line"></span><br><span class="line">```php</span><br><span class="line">$func = <span class="function"><span class="keyword">function</span><span class="params">( $param )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $param;</span><br><span class="line">&#125;;</span><br><span class="line">$func( <span class="string">'some string'</span> );</span><br><span class="line"> </span><br><span class="line"><span class="comment">//输出：</span></span><br><span class="line"><span class="comment">//some string</span></span><br><span class="line">```　　</span><br><span class="line"></span><br><span class="line">顺便提一下，PHP在引入闭包之前，也有一个可以创建匿名函数的函数：create <span class="function"><span class="keyword">function</span>，但是代码逻辑只能写成字符串，这样看起来很晦涩并且不好维护，所以很少有人用。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">实现闭包</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">将匿名函数在普通函数中当做参数传入，也可以被返回。这就实现了一个简单的闭包。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">连接闭包和外界变量的关键字：<span class="title">USE</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">PHP</span>在默认情况下，匿名函数不能调用所在代码块的上下文变量，而需要通过使用<span class="title">use</span>关键字。</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">```<span class="title">php</span></span></span><br><span class="line"><span class="function"><span class="title">function</span> <span class="title">getMoney</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $rmb = <span class="number">1</span>;</span><br><span class="line">    $func = <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="title">use</span> <span class="params">( $rmb )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $rmb;</span><br><span class="line">        <span class="comment">//把$rmb的值加1</span></span><br><span class="line">        $rmb++;</span><br><span class="line">    &#125;;</span><br><span class="line">    $func();</span><br><span class="line">    <span class="keyword">echo</span> $rmb; <span class="comment">//闭包内的变量改变了，但是闭包外没有改变。</span></span><br><span class="line">&#125;</span><br><span class="line">getMoney();</span><br><span class="line"> </span><br><span class="line"><span class="comment">//输出：</span></span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">//1</span></span><br><span class="line">```　　</span><br><span class="line"></span><br><span class="line">注：<span class="keyword">use</span>所引用的是变量的复制(副本而），并不是完全引用变量。如果要达到引用的效果，就需要使用 &amp; 符号，进行引用传递参数。</span><br><span class="line"></span><br><span class="line">```<span class="title">php</span></span><br><span class="line"><span class="title">function</span> <span class="title">getMoney</span>() &#123;</span><br><span class="line">    $<span class="title">rmb</span> = 1;</span><br><span class="line">    $func = <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="title">use</span> <span class="params">( &amp;$rmb )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $rmb;</span><br><span class="line">        <span class="comment">//把$rmb的值加1</span></span><br><span class="line">        $rmb++;</span><br><span class="line">    &#125;;</span><br><span class="line">    $func();</span><br><span class="line">    <span class="keyword">echo</span> $rmb;</span><br><span class="line">&#125;</span><br><span class="line">getMoney();</span><br><span class="line"> </span><br><span class="line"><span class="comment">//输出：</span></span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">//2</span></span><br><span class="line">```　　</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">总结：</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">闭包函数不能直接访问闭包外的变量，而是通过<span class="keyword">use</span> 关键字来调用上下文变量(闭包外的变量)，也就是说通过<span class="title">use</span>来引用上下文的变量；</span><br><span class="line"></span><br><span class="line">闭包内所引用的变量不能被外部所访问(即，内部对变量的修改，外部不受影响)，若想要在闭包内对变量的改变从而影响到上下文变量的值，需要使用&amp;的引用传参。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title">PHP</span> <span class="title">Closure</span> 类是用于代表匿名函数的类，匿名函数（在 <span class="title">PHP</span> 5.3 中被引入）会产生这个类型的对象，<span class="title">Closure</span>类摘要如下：</span><br><span class="line">```<span class="title">php</span></span><br><span class="line"><span class="title">Closure</span> &#123;</span><br><span class="line">    <span class="title">__construct</span> ( <span class="title">void</span> )</span><br><span class="line">    <span class="title">public</span> <span class="title">static</span> <span class="title">Closure</span> <span class="title">bind</span> (<span class="title">Closure</span> $<span class="title">closure</span> , <span class="title">object</span> $<span class="title">newthis</span> [, <span class="title">mixed</span> $<span class="title">newscope</span> = '<span class="title">static</span>' ])</span><br><span class="line">    <span class="title">public</span> <span class="title">Closure</span> <span class="title">bindTo</span> (<span class="title">object</span> $<span class="title">newthis</span> [, <span class="title">mixed</span> $<span class="title">newscope</span> = '<span class="title">static</span>' ])</span><br><span class="line">&#125;</span><br><span class="line">```　　</span><br><span class="line"></span><br><span class="line">方法说明：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title">Closure</span>::\<span class="title">_</span>\<span class="title">_construct</span> — 用于禁止实例化的构造函数</span><br><span class="line"><span class="title">Closure</span>::<span class="title">bind</span> — 复制一个闭包，绑定指定的$<span class="title">this</span>对象和类作用域。</span><br><span class="line"><span class="title">Closure</span>::<span class="title">bindTo</span> — 复制当前闭包对象，绑定指定的$<span class="title">this</span>对象和类作用域。</span><br><span class="line">　　</span><br><span class="line"></span><br><span class="line">除了此处列出的方法，还有一个 \<span class="title">_</span>\<span class="title">_invoke</span> 方法。这是为了与其他实现了 \<span class="title">_</span>\<span class="title">_invoke</span>()魔术方法 的对象保持一致性，但调用闭包对象的过程与它无关。</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">参数说明：</span><br><span class="line"></span><br><span class="line"><span class="title">closure</span>表示需要绑定的闭包对象。</span><br><span class="line"><span class="title">newthis</span>表示需要绑定到闭包对象的对象，或者<span class="title">NULL</span>创建未绑定的闭包。</span><br><span class="line"><span class="title">newscope</span>表示想要绑定给闭包的类作用域，可以传入类名或类的示例，默认值是 '<span class="title">static</span>'， 表示不改变。</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">返回值：成功时返回一个新的 <span class="title">Closure</span> 对象，失败时返回<span class="title">FALSE</span>。</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="title">Closure</span>::<span class="title">bind</span>是<span class="title">Closure</span>::<span class="title">bindTo</span>的静态版本</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">例子：</span><br><span class="line">```<span class="title">php</span></span><br><span class="line"><span class="title">class</span> <span class="title">Animal</span> &#123;</span><br><span class="line">    <span class="title">public</span> $<span class="title">cat</span> = '<span class="title">cat</span>';</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $dog = <span class="string">'dog'</span>;</span><br><span class="line">    <span class="keyword">private</span> $pig = <span class="string">'pig'</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $duck = <span class="string">'duck'</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//不能通过 $this 访问静态变量</span></span><br><span class="line"><span class="comment">//不同通过 类名::私有静态变量，只能通过self,或者static,在类里面访问私有静态变量</span></span><br><span class="line"> </span><br><span class="line">$cat = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;cat;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">$dog = <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Animal::$dog;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">$pig =  <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;pig;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">$duck = <span class="keyword">static</span> <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//return Animal::$duck;  这样写，会报错，提示不能通过类名访问私有静态变量</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">self</span>::$duck; <span class="comment">// return static::$duck</span></span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">$bindCat = Closure::bind($cat, <span class="keyword">new</span> Animal(), <span class="string">'Animal'</span>);</span><br><span class="line">$bindCat2 = Closure::bind($cat, <span class="keyword">new</span> Animal(), <span class="keyword">new</span> Animal());</span><br><span class="line"><span class="keyword">echo</span> $bindCat() . PHP_EOL;</span><br><span class="line"><span class="keyword">echo</span> $bindCat2() . PHP_EOL;</span><br><span class="line"> </span><br><span class="line">$bindDog = Closure::bind($dog, <span class="keyword">null</span>, <span class="string">'Animal'</span>);</span><br><span class="line">$bindDog2 = Closure::bind($dog, <span class="keyword">null</span>, <span class="keyword">new</span> Animal());</span><br><span class="line"><span class="keyword">echo</span> $bindDog() . PHP_EOL;</span><br><span class="line"><span class="keyword">echo</span> $bindDog2() . PHP_EOL;</span><br><span class="line"> </span><br><span class="line">$bindPig = Closure::bind($pig, <span class="keyword">new</span> Animal(), <span class="string">'Animal'</span>);</span><br><span class="line">$bindPig2 = Closure::bind($pig, <span class="keyword">new</span> Animal(), <span class="keyword">new</span> Animal());</span><br><span class="line"><span class="keyword">echo</span> $bindPig() . PHP_EOL;</span><br><span class="line"><span class="keyword">echo</span> $bindPig2() . PHP_EOL;</span><br><span class="line"> </span><br><span class="line">$bindDuck = Closure::bind($duck, <span class="keyword">null</span>, <span class="string">'Animal'</span>);</span><br><span class="line">$bindDuck2 = Closure::bind($duck, <span class="keyword">null</span>, <span class="keyword">new</span> Animal());</span><br><span class="line"><span class="keyword">echo</span> $bindDuck() . PHP_EOL;</span><br><span class="line"><span class="keyword">echo</span> $bindDuck2() . PHP_EOL;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">通过上面的例子，可以看出函数复用得，可以把函数挂在不同的类上，或者对象上。</span><br><span class="line"></span><br><span class="line">　</span><br><span class="line"></span><br><span class="line">总结：</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 闭包内如果用 <span class="keyword">$this</span>, 则 <span class="keyword">$this</span> 只能调用非静态的属性，这和实际类中调用原则是一致的，且 Closure::bind() 方法的第<span class="number">2</span>个参数不能为<span class="keyword">null</span>，必须是一个实例 (因为<span class="keyword">$this</span>,必须在实例中使用)，第三个参数可以是实例，可以是类字符串，或 <span class="keyword">static</span>；</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 闭包内调用静态属性时，闭包必须声明为 <span class="keyword">static</span>,同时Closure::bind()方法的第<span class="number">2</span>个参数需要为<span class="keyword">null</span>,因为 静态属性不需要实例，第<span class="number">3</span>个参数可以是类字符串，实例，staic.</span><br><span class="line"></span><br><span class="line">php的闭包（Closure）也就是匿名函数。是PHP5<span class="number">.3</span>引入的。</span><br><span class="line">闭包的语法很简单，需要注意的关键字就只有<span class="keyword">use</span>，<span class="title">use</span>意思是连接闭包和外界变量。</span><br><span class="line"></span><br><span class="line">```<span class="title">php</span></span><br><span class="line">$<span class="title">a</span> = <span class="title">function</span>() <span class="title">use</span>($<span class="title">b</span>) &#123;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>闭包的几个作用：<br>1 减少foreach的循环的代码<br>比如手册<a href="http://php.net/manual/en/functions.anonymous.php" target="_blank" rel="noopener">http://php.net/manual/en/functions.anonymous.php</a> 中的例子Cart<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 一个基本的购物车，包括一些已经添加的商品和每种商品的数量。</span></span><br><span class="line"><span class="comment">// 其中有一个方法用来计算购物车中所有商品的总价格。该方法使用了一个closure作为回调函数。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cart</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> PRICE_BUTTER  = <span class="number">1.00</span>;</span><br><span class="line">    <span class="keyword">const</span> PRICE_MILK    = <span class="number">3.00</span>;</span><br><span class="line">    <span class="keyword">const</span> PRICE_EGGS    = <span class="number">6.95</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">protected</span>   $products = <span class="keyword">array</span>();</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">($product, $quantity)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;products[$product] = $quantity;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getQuantity</span><span class="params">($product)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;products[$product]) ? <span class="keyword">$this</span>-&gt;products[$product] :</span><br><span class="line">               <span class="keyword">FALSE</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getTotal</span><span class="params">($tax)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $total = <span class="number">0.00</span>;</span><br><span class="line">         </span><br><span class="line">        $callback =</span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="params">($quantity, $product)</span> <span class="title">use</span> <span class="params">($tax, &amp;$total)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                $pricePerItem = constant(<span class="keyword">__CLASS__</span> . <span class="string">"::PRICE_"</span> .</span><br><span class="line">                    strtoupper($product));</span><br><span class="line">                $total += ($pricePerItem * $quantity) * ($tax + <span class="number">1.0</span>);</span><br><span class="line">            &#125;;</span><br><span class="line">         </span><br><span class="line">        array_walk(<span class="keyword">$this</span>-&gt;products, $callback);</span><br><span class="line">        <span class="keyword">return</span> round($total, <span class="number">2</span>);;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">$my_cart = <span class="keyword">new</span> Cart;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 往购物车里添加条目</span></span><br><span class="line">$my_cart-&gt;add(<span class="string">'butter'</span>, <span class="number">1</span>);</span><br><span class="line">$my_cart-&gt;add(<span class="string">'milk'</span>, <span class="number">3</span>);</span><br><span class="line">$my_cart-&gt;add(<span class="string">'eggs'</span>, <span class="number">6</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 打出出总价格，其中有 5% 的销售税.</span></span><br><span class="line"><span class="keyword">print</span> $my_cart-&gt;getTotal(<span class="number">0.05</span>) . <span class="string">"\n"</span>;</span><br><span class="line"><span class="comment">// The result is 54.29</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">这里如果我们改造getTotal函数必然要使用到<span class="keyword">foreach</span> </span><br><span class="line"></span><br><span class="line"><span class="number">2</span> 减少函数的参数</span><br><span class="line">```php</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">html</span> <span class="params">($code , $id=<span class="string">""</span>, $class=<span class="string">""</span>)</span></span>&#123;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> ($id !== <span class="string">""</span>) $id = <span class="string">" id = \"$id\""</span> ;</span><br><span class="line"> </span><br><span class="line">$class = ($class !== <span class="string">""</span>)? <span class="string">" class =\"$class\""</span>:<span class="string">"&gt;"</span>;</span><br><span class="line"> </span><br><span class="line">$open = <span class="string">"&lt;$code$id$class"</span>;</span><br><span class="line"> </span><br><span class="line">$close = <span class="string">"&lt;/$code&gt;"</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($inner = <span class="string">""</span>)</span> <span class="title">use</span> <span class="params">($open, $close)</span></span>&#123;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> <span class="string">"$open$inner$close"</span>;&#125;;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果是使用平时的方法，我们会把inner放到html函数参数中，这样不管是代码阅读还是使用都不如使用闭包</p>
<p>3 解除递归函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $fib = <span class="function"><span class="keyword">function</span><span class="params">($n)</span> <span class="title">use</span><span class="params">(&amp;$fib)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>($n == <span class="number">0</span> || $n == <span class="number">1</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> $fib($n - <span class="number">1</span>) + $fib($n - <span class="number">2</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">   <span class="keyword">echo</span> $fib(<span class="number">2</span>) . <span class="string">"\n"</span>; <span class="comment">// 2</span></span><br><span class="line">   $lie = $fib;</span><br><span class="line">   $fib = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;<span class="keyword">die</span>(<span class="string">'error'</span>);&#125;;<span class="comment">//rewrite $fib variable </span></span><br><span class="line">   <span class="keyword">echo</span> $lie(<span class="number">5</span>); <span class="comment">// error   because $fib is referenced by closure</span></span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">注意上题中的<span class="keyword">use</span>使用了&amp;，这里不使用&amp;会出现错误<span class="title">fib</span>(<span class="title">n</span>-1)是找不到<span class="title">function</span>的（前面没有定义<span class="title">fib</span>的类型）</span><br><span class="line"></span><br><span class="line">所以想使用闭包解除循环函数的时候就需要使用</span><br><span class="line"></span><br><span class="line">```<span class="title">php</span></span><br><span class="line">&lt;?<span class="title">php</span></span><br><span class="line">$<span class="title">recursive</span> = <span class="title">function</span> () <span class="title">use</span> (&amp;$<span class="title">recursive</span>)&#123;</span><br><span class="line">// <span class="title">The</span> <span class="title">function</span> <span class="title">is</span> <span class="title">now</span> <span class="title">available</span> <span class="title">as</span> $<span class="title">recursive</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样的形式</p>
<p>4 关于延迟绑定<br>如果你需要延迟绑定use里面的变量，你就需要使用引用，否则在定义的时候就会做一份拷贝放到use中<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$result = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">$one = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123; var_dump($result); &#125;;</span><br><span class="line"> </span><br><span class="line">$two = <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="title">use</span> <span class="params">($result)</span></span></span><br><span class="line"><span class="function"></span>&#123; var_dump($result); &#125;;</span><br><span class="line"> </span><br><span class="line">$three = <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="title">use</span> <span class="params">(&amp;$result)</span></span></span><br><span class="line"><span class="function"></span>&#123; var_dump($result); &#125;;</span><br><span class="line"> </span><br><span class="line">$result++;</span><br><span class="line"> </span><br><span class="line">$one();    <span class="comment">// outputs NULL: $result is not in scope</span></span><br><span class="line">$two();    <span class="comment">// outputs int(0): $result was copied</span></span><br><span class="line">$three();    <span class="comment">// outputs int(1)</span></span><br></pre></td></tr></table></figure></p>
<p>使用引用和不使用引用就代表了是调用时赋值，还是申明时候赋值</p>
<p>PHP Closure类是用于代表匿名函数的类，匿名函数（在PHP5.3中被引入）会产生这个类型的对象，Closure类摘要如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Closure &#123;</span><br><span class="line">    __construct ( void )</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Closure bind (Closure $closure , object $newthis [, mixed $newscope = <span class="string">'static'</span> ])</span><br><span class="line">    <span class="keyword">public</span> Closure bindTo (object $newthis [, mixed $newscope = <span class="string">'static'</span> ])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方法说明：</p>
<ul>
<li>Closure::__construct — 用于禁止实例化的构造函数</li>
<li>Closure::bind — 复制一个闭包，绑定指定的$this对象和类作用域。</li>
<li>Closure::bindTo — 复制当前闭包对象，绑定指定的$this对象和类作用域。</li>
</ul>
<p>除了此处列出的方法，还有一个__invoke 方法。这是为了与其他实现了__invoke()魔术方法 的对象保持一致性，但调用闭包对象的过程与它无关。</p>
<p>下面将介绍Closure::bind和Closure::bindTo。</p>
<p>Closure::bind是Closure::bindTo的静态版本，其说明如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Closure bind (Closure $closure , object $newthis [, mixed $newscope = <span class="string">'static'</span> ])</span><br></pre></td></tr></table></figure></p>
<ul>
<li>closure表示需要绑定的闭包对象。</li>
<li>newthis表示需要绑定到闭包对象的对象，或者NULL创建未绑定的闭包。</li>
<li>newscope表示想要绑定给闭包的类作用域，可以传入类名或类的示例，默认值是 ‘static’， 表示不改变。</li>
</ul>
<p>该方法成功时返回一个新的Closure对象，失败时返回FALSE。</p>
<p>例子说明：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 复制一个闭包，绑定指定的$this对象和类作用域。 </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 疯狂老司机 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $cat = <span class="string">"cat"</span>;</span><br><span class="line">    <span class="keyword">private</span> $dog = <span class="string">"dog"</span>;</span><br><span class="line">    <span class="keyword">public</span> $pig = <span class="string">"pig"</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * 获取Animal类静态私有成员属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">$cat = <span class="keyword">static</span> <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Animal::$cat;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * 获取Animal实例私有成员属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">$dog = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dog;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * 获取Animal实例公有成员属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">$pig = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;pig;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">$bindCat = Closure::bind($cat, <span class="keyword">null</span>, <span class="keyword">new</span> Animal());<span class="comment">// 给闭包绑定了Animal实例的作用域，但未给闭包绑定$this对象</span></span><br><span class="line">$bindDog = Closure::bind($dog, <span class="keyword">new</span> Animal(), <span class="string">'Animal'</span>);<span class="comment">// 给闭包绑定了Animal类的作用域，同时将Animal实例对象作为$this对象绑定给闭包</span></span><br><span class="line">$bindPig = Closure::bind($pig, <span class="keyword">new</span> Animal());<span class="comment">// 将Animal实例对象作为$this对象绑定给闭包,保留闭包原有作用域</span></span><br><span class="line"><span class="keyword">echo</span> $bindCat(),<span class="string">'&lt;br&gt;'</span>;<span class="comment">// 根据绑定规则，允许闭包通过作用域限定操作符获取Animal类静态私有成员属性</span></span><br><span class="line"><span class="keyword">echo</span> $bindDog(),<span class="string">'&lt;br&gt;'</span>;<span class="comment">// 根据绑定规则，允许闭包通过绑定的$this对象(Animal实例对象)获取Animal实例私有成员属性</span></span><br><span class="line"><span class="keyword">echo</span> $bindPig(),<span class="string">'&lt;br&gt;'</span>;<span class="comment">// 根据绑定规则，允许闭包通过绑定的$this对象获取Animal实例公有成员属性</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat</span><br><span class="line">dog</span><br><span class="line">pig</span><br></pre></td></tr></table></figure></p>
<p>Closure::bindTo — 复制当前闭包对象，绑定指定的$this对象和类作用域，其说明如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Closure Closure::bindTo (object $newthis [, mixed $newscope = <span class="string">'static'</span> ])</span><br></pre></td></tr></table></figure></p>
<p>newthis表示绑定给闭包对象的一个对象，或者NULL来取消绑定。<br>newscope表示关联到闭包对象的类作用域，可以传入类名或类的示例，默认值是 ‘static’， 表示不改变。<br>该方法创建并返回一个闭包对象，它与当前对象绑定了同样变量，但可以绑定不同的对象，也可以绑定新的类作用域。绑定的对象决定了返回的闭包对象中的$this的取值，类作用域决定返回的闭包对象能够调用哪些方法，也就是说，此时$this可以调用的方法，与newscope类作用域相同。</p>
<p>例子1：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__autoload</span><span class="params">($class)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">require_once</span> <span class="string">"$class.php"</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">$template = <span class="keyword">new</span> Template;</span><br><span class="line">$template-&gt;render(<span class="keyword">new</span> Article, <span class="string">'tpl.php'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>Template.php 模板类<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 模板类，用于渲染输出 </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 疯狂老司机 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 渲染方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> obj 信息类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string 模板文件名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">($context, $tpl)</span></span>&#123;</span><br><span class="line">        $closure = <span class="function"><span class="keyword">function</span><span class="params">($tpl)</span></span>&#123;</span><br><span class="line">            ob_start();</span><br><span class="line">            <span class="keyword">include</span> $tpl;</span><br><span class="line">            <span class="keyword">return</span> ob_end_flush();</span><br><span class="line">        &#125;;</span><br><span class="line">        $closure = $closure-&gt;bindTo($context, $context);</span><br><span class="line">        $closure($tpl);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Article.php 信息类<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 文章信息类 </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 疯狂老司机 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $title = <span class="string">"这是文章标题"</span>;</span><br><span class="line">    <span class="keyword">private</span> $content = <span class="string">"这是文章内容"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>tpl.php 模板文件<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span> <span class="attr">xml:lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html;charset=UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;title;<span class="meta">?&gt;</span></span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;content;<span class="meta">?&gt;</span></span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>运行时确保以上文件位于同级目录。<br>输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">这是文章标题</span><br><span class="line">这是文章内容</span><br></pre></td></tr></table></figure></p>
<p>例子2：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 给类动态添加新方法</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 疯狂老司机</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">trait</span> DynamicTrait &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自动调用类中存在的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(is_callable(<span class="keyword">$this</span>-&gt;$name))&#123;</span><br><span class="line">            <span class="keyword">return</span> call_user_func(<span class="keyword">$this</span>-&gt;$name, $args);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \RuntimeException(<span class="string">"Method &#123;$name&#125; does not exist"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span><span class="params">($name, $value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;$name = is_callable($value)? </span><br><span class="line">            $value-&gt;bindTo(<span class="keyword">$this</span>, <span class="keyword">$this</span>): </span><br><span class="line">            $value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 只带属性不带方法动物类</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 疯狂老司机</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">DynamicTrait</span>;</span><br><span class="line">    <span class="keyword">private</span> $dog = <span class="string">'dog'</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">$animal = <span class="keyword">new</span> Animal;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 往动物类实例中添加一个方法获取实例的私有属性$dog</span></span><br><span class="line">$animal-&gt;getdog = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dog;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">echo</span> $animal-&gt;getdog();</span><br><span class="line"> </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dog</span><br></pre></td></tr></table></figure></p>
<p>例子3：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 一个基本的购物车，包括一些已经添加的商品和每种商品的数量</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 疯狂老司机</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cart</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 定义商品价格</span></span><br><span class="line">    <span class="keyword">const</span> PRICE_BUTTER  = <span class="number">1.00</span>;</span><br><span class="line">    <span class="keyword">const</span> PRICE_MILK    = <span class="number">3.33</span>;</span><br><span class="line">    <span class="keyword">const</span> PRICE_EGGS    = <span class="number">8.88</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">protected</span>   $products = <span class="keyword">array</span>();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加商品和数量</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string 商品名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string 商品数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">($item, $quantity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;products[$item] = $quantity;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取单项商品数量</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string 商品名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getQuantity</span><span class="params">($item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;products[$item]) ? <span class="keyword">$this</span>-&gt;products[$item] : <span class="keyword">FALSE</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取总价</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string 税率</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getTotal</span><span class="params">($tax)</span> </span>&#123;</span><br><span class="line">        $total = <span class="number">0.00</span>;</span><br><span class="line"> </span><br><span class="line">        $callback = <span class="function"><span class="keyword">function</span> <span class="params">($quantity, $item)</span> <span class="title">use</span> <span class="params">($tax, &amp;$total)</span> </span>&#123;</span><br><span class="line">            $pricePerItem = constant(<span class="keyword">__CLASS__</span> . <span class="string">"::PRICE_"</span> . strtoupper($item));</span><br><span class="line">            $total += ($pricePerItem * $quantity) * ($tax + <span class="number">1.0</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">         </span><br><span class="line">        array_walk(<span class="keyword">$this</span>-&gt;products, $callback);</span><br><span class="line">        <span class="keyword">return</span> round($total, <span class="number">2</span>);;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">$my_cart = <span class="keyword">new</span> Cart;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 往购物车里添加商品及对应数量</span></span><br><span class="line">$my_cart-&gt;add(<span class="string">'butter'</span>, <span class="number">10</span>);</span><br><span class="line">$my_cart-&gt;add(<span class="string">'milk'</span>, <span class="number">3</span>);</span><br><span class="line">$my_cart-&gt;add(<span class="string">'eggs'</span>, <span class="number">12</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 打出出总价格，其中有 5% 的销售税.</span></span><br><span class="line"><span class="keyword">echo</span> $my_cart-&gt;getTotal(<span class="number">0.05</span>);</span><br><span class="line"> </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">132.88</span><br></pre></td></tr></table></figure></p>
<p>补充说明：闭包可以使用USE关键连接外部变量。</p>
<p>总结：合理使用闭包能使代码更加简洁和精炼。</p>
<h1 id="PHP核心特性-匿名函数"><a href="#PHP核心特性-匿名函数" class="headerlink" title="PHP核心特性-匿名函数"></a><span style="color:#339AFF;">PHP核心特性-匿名函数</span></h1><h2 id="提出"><a href="#提出" class="headerlink" title="提出"></a><span style="color:#00ACC1;">提出</span></h2><p>在匿名函数出现之前，所有的函数都需要先命名才能使用：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">increment</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $value + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">array_map(<span class="string">'increment'</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br></pre></td></tr></table></figure></p>
<p>有的时候函数可能只需要使用一次，这时候使用匿名函数会使得代码更加简洁直观，同时也避免了函数在其他地方被使用：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">array_map(<span class="function"><span class="keyword">function</span><span class="params">($value)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $value + <span class="number">1</span>;</span><br><span class="line">&#125;, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br></pre></td></tr></table></figure></p>
<h2 id="定义和使用"><a href="#定义和使用" class="headerlink" title="定义和使用"></a><span style="color:#00ACC1;">定义和使用</span></h2><p>PHP将闭包和匿名函数视为同等概念（本文统称为匿名函数），本质上都是伪装成函数的对象。</p>
<p>匿名函数的本质是对象，因此跟对象一样可将匿名函数赋值给某一变量：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$greet = <span class="function"><span class="keyword">function</span><span class="params">(string $name)</span></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"hello &#123;$name&#125;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$greet(<span class="string">"jack"</span>) <span class="comment">// hello jack</span></span><br></pre></td></tr></table></figure></p>
<p>所有的匿名函数都是Closure对象的实例：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$greet <span class="keyword">instanceof</span> Closure <span class="comment">// true</span></span><br></pre></td></tr></table></figure></p>
<p>对象并没有什么父作用域可言，所以需要使用use来手动声明使用的变量：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$num = <span class="number">1</span>;</span><br><span class="line">$func = <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="title">use</span><span class="params">($num)</span></span>&#123;</span><br><span class="line">    $num = $num + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">echo</span> $num;</span><br><span class="line">&#125;</span><br><span class="line">$func();  <span class="comment">// 2</span></span><br><span class="line"><span class="keyword">echo</span> $num;  <span class="comment">// 还是 1</span></span><br></pre></td></tr></table></figure></p>
<p>如果要让匿名函数中的变量生效，需要使用引用传值：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$num = <span class="number">1</span>;</span><br><span class="line">$func = <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="title">use</span><span class="params">(&amp;$num)</span></span>&#123;</span><br><span class="line">    $num = $num + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">echo</span> $num;</span><br><span class="line">&#125;</span><br><span class="line">$func();  <span class="comment">// 2</span></span><br><span class="line"><span class="keyword">echo</span> $num;  <span class="comment">// 2</span></span><br></pre></td></tr></table></figure></p>
<p>从PHP5.4开始，在类里面使用匿名函数时，匿名函数的$this将自动绑定到当前类：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;   </span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$foo = <span class="keyword">new</span> Foo();</span><br><span class="line">$obj = $foo-&gt;bar(); <span class="comment">// Closure()</span></span><br><span class="line">$obj();   <span class="comment">// Foo</span></span><br></pre></td></tr></table></figure></p>
<p>如果不想让自动绑定生效，可使用静态匿名函数：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;   </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$foo = <span class="keyword">new</span> Foo();</span><br><span class="line">$obj = $foo-&gt;bar(); <span class="comment">// Closure()</span></span><br><span class="line">$obj();   <span class="comment">// Using $this when not in object context</span></span><br></pre></td></tr></table></figure></p>
<h2 id="匿名函数的本质"><a href="#匿名函数的本质" class="headerlink" title="匿名函数的本质"></a>匿名函数的本质</h2><p>匿名函数的本质是Closure对象，包括了以下五个方法<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Closure &#123;</span><br><span class="line">    <span class="keyword">private</span> __construct ( void )</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> bind ( Closure $closure , object $newthis [, mixed $newscope = <span class="string">"static"</span> ] ) : Closure</span><br><span class="line">    <span class="keyword">public</span> bindTo ( object $newthis [, mixed $newscope = <span class="string">"static"</span> ] ) : Closure</span><br><span class="line">    <span class="keyword">public</span> call ( object $newthis [, mixed $... ] ) : mixed</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> fromCallable ( callable $callable ) : Closure</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>__construct - 防止匿名函数被实例化<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$closure = <span class="keyword">new</span> \Closure();</span><br><span class="line"><span class="comment">// PHP Error:  Instantiation of 'Closure' is not allowed</span></span><br></pre></td></tr></table></figure></p>
<p>Closure::bindTo - 复制当前匿名函数对象，绑定指定的 $this 对象和类作用域。通俗的说，就是手动将匿名函数与指定对象绑定，利用这点，可以扩展对象的功能。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义商品类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Good</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $price;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(float $price)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;price = $price;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个匿名函数，计算商品的促销价</span></span><br><span class="line">$addDiscount = <span class="function"><span class="keyword">function</span><span class="params">(float $discount = <span class="number">0.8</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;price * $discount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$good = <span class="keyword">new</span> Good(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将匿名函数绑定到 $good 实例，同时指定作用域为 Good</span></span><br><span class="line">$count = $addDiscount-&gt;bindTo($good, Good::class); </span><br><span class="line">$count(); <span class="comment">// 80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将匿名函数绑定到 $good 实例，但是不指定作用域，将无法访问 $good 的私有属性</span></span><br><span class="line">$count = $addDiscount-&gt;bindTo($good); </span><br><span class="line">$count(); <span class="comment">// 报错</span></span><br></pre></td></tr></table></figure></p>
<p>Closure::bind - bindTo 方法的静态版本，有两种用法：</p>
<p>用法一：实现与bindTo方法同样的效果<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$count = \Closure::bind($addDiscount, $good, Good::class);</span><br></pre></td></tr></table></figure></p>
<p>用法二：将匿名函数与类（而不是对象）绑定，记得要将第二个参数设置为 null<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 商品库存为 10</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Good</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> $num = <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 每次销售后返回当前库存</span></span><br><span class="line">$sell = <span class="keyword">static</span> <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span><span class="string">"当前库存为"</span>. --<span class="keyword">static</span>::$num ;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将静态匿名函数绑定到 Good 类中</span></span><br><span class="line">$sold = \Closure::bind($sell, <span class="keyword">null</span>, Good::class);</span><br><span class="line"></span><br><span class="line">$sold(); <span class="comment">// 当前库存为 9</span></span><br><span class="line">$sold(); <span class="comment">// 当前库存为 8</span></span><br></pre></td></tr></table></figure></p>
<p>call - PHP7新增的call方法可以实现绑定并调用匿名函数，除了语法更加简洁外，性能也更高<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// call 版本</span></span><br><span class="line">$addDiscount-&gt;call($good, <span class="number">0.5</span>);  <span class="comment">// 绑定并传入参数 0.5，结果为 50</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// bindTo 版本</span></span><br><span class="line">$count = $addDiscount-&gt;bindTo($good, Good::class); </span><br><span class="line">$count(<span class="number">0.5</span>); <span class="comment">// 50</span></span><br></pre></td></tr></table></figure></p>
<p>fromCallable - 将给定的 callable 函数转化成匿名函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Good</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $price;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(float $price)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;price = $price;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addDiscount</span><span class="params">(float $discount = <span class="number">0.8</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;price * $discount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$closure = \Closure::fromCallable(<span class="string">'addDiscount'</span>);</span><br><span class="line">$good = <span class="keyword">new</span> Good(<span class="number">100</span>);</span><br><span class="line">$count = $closure-&gt;bindTo($good);  </span><br><span class="line">$count = $closure-&gt;bindTo($good, Good::class);   <span class="comment">// 报错，不能重复绑定作用域</span></span><br><span class="line">$count(); <span class="comment">// 报错，无法访问私有属性</span></span><br></pre></td></tr></table></figure></p>
<p>fromCallable 等价于<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$reflexion = <span class="keyword">new</span> ReflectionFunction(<span class="string">'addDiscount'</span>);</span><br><span class="line">$closure = $reflexion-&gt;getClosure();</span><br></pre></td></tr></table></figure></p>
<p>这里有一点需要特别注意的是，无论是fromCallable转化成的闭包，还是使用反射得到的闭包，在使用 bindTo 时，如果第二个参数指定绑定类，会报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cannot rebind scope of closure created by ReflectionFunctionAbstract::getClosure()</span><br></pre></td></tr></table></figure></p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/函数式编程/" rel="tag"># 函数式编程</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/03/10/Laravel-Facade/" rel="next" title="Laravel-Facade">
                <i class="fa fa-chevron-left"></i> Laravel-Facade
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/03/22/Laravel-Container/" rel="prev" title="Laravel-Container">
                Laravel-Container <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="CheBin">
            
              <p class="site-author-name" itemprop="name">CheBin</p>
              <div class="site-description motion-element" itemprop="description">看视频才能学会，看文字学不会的</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">1017</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">72</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          


          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/2023/04/04/结束语｜秒杀系统之上的业务协同思考/" title="结束语｜秒杀系统之上的业务协同思考" target="_blank">结束语｜秒杀系统之上的业务协同思考</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/14｜百万级流量秒杀系统的关键总结/" title="14｜百万级流量秒杀系统的关键总结" target="_blank">14｜百万级流量秒杀系统的关键总结</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/13｜优化番外篇：Vertx介绍及快速入门/" title="13｜优化番外篇：Vertx介绍及快速入门" target="_blank">13｜优化番外篇：Vertx介绍及快速入门</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/12｜高性能优化：单机Java极致优化/" title="12｜高性能优化：单机Java极致优化" target="_blank">12｜高性能优化：单机Java极致优化</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/11｜高性能优化：物理机极致优化/" title="11｜高性能优化：物理机极致优化" target="_blank">11｜高性能优化：物理机极致优化</a>
                  </li>
                
              </ul>
            </div>
        

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">1.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结"><span class="nav-number">2.</span> <span class="nav-text">小结</span></a></li></ol><li class="nav-item nav-level-1"><a class="nav-link" href="#PHP核心特性-匿名函数"><span class="nav-number"></span> <span class="nav-text">PHP核心特性-匿名函数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#提出"><span class="nav-number">1.</span> <span class="nav-text">提出</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定义和使用"><span class="nav-number">2.</span> <span class="nav-text">定义和使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#匿名函数的本质"><span class="nav-number">3.</span> <span class="nav-text">匿名函数的本质</span></a></li></ol></li></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CheBin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">8.2m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">124:48</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
