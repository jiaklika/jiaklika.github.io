<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="思考并回答以下问题：">
<meta name="keywords" content="PHP语法">
<meta property="og:type" content="article">
<meta property="og:title" content="高性能应用的策略">
<meta property="og:url" content="http://yoursite.com/2020/04/02/高性能应用的策略/index.html">
<meta property="og:site_name" content="车斌的技术博客">
<meta property="og:description" content="思考并回答以下问题：">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-06-12T06:29:16.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="高性能应用的策略">
<meta name="twitter:description" content="思考并回答以下问题：">






  <link rel="canonical" href="http://yoursite.com/2020/04/02/高性能应用的策略/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>高性能应用的策略 | 车斌的技术博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">专注</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/02/高性能应用的策略/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CheBin">
      <meta itemprop="description" content="放弃会成为一种习惯">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">高性能应用的策略

              
            
          </h1>
        

        <div class="post-meta">

          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-04-02 09:42:10" itemprop="dateCreated datePublished" datetime="2020-04-02T09:42:10+08:00">2020-04-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-06-12 14:29:16" itemprop="dateModified" datetime="2020-06-12T14:29:16+08:00">2020-06-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/PHP/" itemprop="url" rel="index"><span itemprop="name">PHP</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">49k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">45 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考并回答以下问题：</p>
<a id="more"></a>
<blockquote>
<p>Listing 5-1 manual.php</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$time1 = microtime(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">$memory1 = memory_get_usage();</span><br><span class="line"></span><br><span class="line">$a_string = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    $output = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ($counter = <span class="number">0</span>; $counter &lt; <span class="number">10</span>; $counter++) &#123;</span><br><span class="line"></span><br><span class="line">    usleep(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    $output .= <span class="string">'a'</span>;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $output;</span><br><span class="line"></span><br><span class="line">&#125;)(); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$memory2 = memory_get_usage();</span><br><span class="line"></span><br><span class="line">$time2 = microtime(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">$b_string = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    $output = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ($counter = <span class="number">0</span>; $counter &lt; <span class="number">10</span>; $counter++) &#123;</span><br><span class="line"></span><br><span class="line">        usleep(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        $output .= str_repeat(<span class="string">'abc'</span>,<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $output;</span><br><span class="line"></span><br><span class="line">&#125;)(); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$memory3 = memory_get_usage();</span><br><span class="line"></span><br><span class="line">$time3 = microtime(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"1st function : "</span>.($time2-$time1).<span class="string">" secs, "</span>.</span><br><span class="line">    ($memory2-$memory1).<span class="string">" bytes\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"2nd function : "</span>.($time3-$time2).<span class="string">" secs, "</span>.</span><br><span class="line">    ($memory3-$memory2).<span class="string">" bytes\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> (<span class="string">"Peak memory usage : "</span>. memory_get_peak_usage().<span class="string">" bytes\n"</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Listing 5-2 manual-output.txt</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1st function : 0.0007178783416748 secs, 40 bytes</span><br><span class="line">2nd function : 0.0016269683837891 secs, 32768 bytes</span><br><span class="line">Peak memory usage : 392504 bytes</span><br></pre></td></tr></table></figure>
<p>如您所见，第二个函数比第一个函数需要更长的时间。现在，您知道使脚本变慢的问题是第二个循环，您可以通过删除usleep语句并完全删除该循环并使用str_repeat(‘abc’，1000000)填充字符串来解决此问题。</p>
<h1 id="记忆化"><a href="#记忆化" class="headerlink" title="记忆化"></a>记忆化</h1><p>如果您已经编程了一段时间，尤其是在Web领域，那么您将遇到缓存的概念。缓存是一个过程，通过该过程，您可以获取“昂贵的”计算结果，存储结果，然后在下次调用该计算时使用存储的结果，而不必再次运行计算本身。昂贵意味着运行时间长，占用大量内存，进行大量外部API调用或出于成本或性能原因而希望将其最小化的任何其他操作。缓存失效是您选择从缓存中删除项目的过程。例如，如果要花费很多精力来生成新闻网站的首页，则需要缓存该页面，这样就不必在每次访问者访问网站时都生成它。但是，一旦发生下一个重大故事，您将要更新首页，并且您不希望访问者点击缓存的版本并获取旧消息，因此您将使缓存“无效”并重新生成页面。<br>如果您曾经参与编写或使用缓存系统，那么毫无疑问，您会根据Phil Karlton的说法熟悉以下说法（或至少了解它的来历）：</p>
<p>在计算机科学中，只有两件困难的事情：命名事物，缓存无效化和一次性错误。</p>
<p>您已经研究了递归如何减少一次性错误，并且没有人希望解决命名问题，那么如何解决缓存失效呢？举起手来，如果你认为<br>函数编程有其窍门。好，金星为您服务！确实如此，诀窍是永远不要使缓存无效。问题解决了！<br>我实际上是认真的。函数式编程提供了一种称为备忘录的技术，该技术植根于纯函数固有的属性中。在较早的理论章节中，您研究了纯函数如何具有参照透明性。给定一组特定的输入参数，纯函数将始终产生相同的返回值，并且（对于该组输入）该函数可以简单地由返回值替换。这听起来应该有点像缓存：对于给定的一组输入（例如，您的新闻报道），您想用其返回值（缓存的输出）替换（运行昂贵）功能。获取纯函数的输出并将其缓存的过程是备忘录，这只是缓存的一种特殊情况。<br>假设您正在记忆一个昂贵的功能，并将结果缓存到磁盘。每次使用不同的参数运行该函数时，您可能会得到不同的结果。您要消除的是在同一参数上多次运行该函数的成本，因为每次（纯）函数都可以保证获得相同的结果。因此，您可以缓存结果，例如，通过创建代表所使用输入参数的哈希并将其用作文件名来存储该运行的返回值。<br>下次运行该函数时，将再次对输入参数进行哈希处理，查看是否存在该名称的缓存文件，如果存在则返回其内容（而不是重新运行昂贵的函数）。<br>到目前为止，这是典型的缓存。但是，如何避免不得不使缓存无效？答案是你不知道。记忆有效地为您做到了。您的功能是纯净的，这意味着没有副作用。因此，如果在您的虚构新闻网站上有新故事中断，则该故事的详细信息将仅通过（纯）功能通过该功能的输入参数创建您的首页。例如，您可能将一系列标题作为一个参数。突然，您的参数的哈希值已更改，因此备注函数将无法在具有该哈希值的磁盘上找到文件，因此将运行完整功能并将新结果缓存到以新哈希值命名的文件中的磁盘上值。回顾一下，作为您唯一的输入<br>是参数，如果所有参数均未更改，则必须可以使用缓存。但是，如果参数已更改，则将没有相应的缓存文件，因此无需使其无效。<br>当然，旧的缓存文件仍然存在，因此当您不小心发布错误地声称这本书是垃圾的故事时，您可以立即将其撤回，该功能将返回使用旧的缓存文件，因为哈希将再次出现匹配参数。<br>到现在为止还挺好。但是，函数式编程并没有止于其优点，哦，不。如果您正在考虑如何编写函数来进行记忆，请停止操作。通常，您不需要。您可以简单地将函数包装在另一个为您自动记住的函数中。这样的包装器函数易于编写，因为您所关心的只是纯函数的输入和输出，而不是其内部的功能。<br>因此，让我们来看一个备忘录的示例。在清单5-3中，您会将纯函数的结果缓存到磁盘。为简便起见，将不纯磁盘功能分成单独的功能，而不是煮一些IO monad，但是您当然可以根据需要这样做。</p>
<blockquote>
<p>Listing 5-3 memoize.php</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># We're going to cache our results on disk, so let's</span></span><br><span class="line"><span class="comment"># define a directory and file prefix</span></span><br><span class="line"></span><br><span class="line">define(<span class="string">'CACHE_PREFIX'</span>, sys_get_temp_dir().<span class="string">'/memo-cache-'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># This is a helper function to read a cached file</span></span><br><span class="line"><span class="comment"># from disk. I've broken it out as a separate function</span></span><br><span class="line"><span class="comment"># as it is necessarily impure. You can replace it</span></span><br><span class="line"><span class="comment"># with an IO monad or similar in production if you wish</span></span><br><span class="line"></span><br><span class="line">$get_value = <span class="function"><span class="keyword">function</span><span class="params">($hash)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># return null if the file doesn't exist</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!file_exists(CACHE_PREFIX.$hash)) &#123; <span class="keyword">return</span> <span class="keyword">null</span>;  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># read the file into $value</span></span><br><span class="line"></span><br><span class="line">    $value = file_get_contents(CACHE_PREFIX.$hash);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># return null if the file exists but couldn't be read</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($value === <span class="keyword">false</span>) &#123; <span class="keyword">return</span> <span class="keyword">null</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># return our value if all is good</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $value;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Likewise, this is an impure helper function to write</span></span><br><span class="line"><span class="comment"># the value to a cache file.</span></span><br><span class="line"></span><br><span class="line">$store_value = <span class="function"><span class="keyword">function</span><span class="params">($hash, $value)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (file_put_contents(CACHE_PREFIX.$hash, $value) === <span class="keyword">false</span>) &#123;</span><br><span class="line"></span><br><span class="line">        $value = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># return the value that was stored, or null if the</span></span><br><span class="line">    <span class="comment"># storage failed</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $value;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Finally, this is our actual memoization function.</span></span><br><span class="line"><span class="comment"># It returns a closure which is a "memoized" version</span></span><br><span class="line"><span class="comment"># of the function you call it on, i.e. a version</span></span><br><span class="line"><span class="comment"># of your function which automatically caches return</span></span><br><span class="line"><span class="comment"># values and automatically uses those cached values</span></span><br><span class="line"><span class="comment"># without further coding from you.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># $func is the function (closure or other callable) that</span></span><br><span class="line"><span class="comment"># you want to memoize</span></span><br><span class="line"></span><br><span class="line">$memoize = <span class="function"><span class="keyword">function</span><span class="params">($func)</span> <span class="title">use</span> <span class="params">($get_value, $store_value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="comment"># We're returning a memoized function</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="title">use</span> <span class="params">($func, $get_value, $store_value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Get the parameters you (the end user) call</span></span><br><span class="line">                <span class="comment"># your memoized function with</span></span><br><span class="line"></span><br><span class="line">        $params = func_get_args();</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Get a unique hash of those parameters, to</span></span><br><span class="line">                <span class="comment"># use as our cache's key. We needs to convert</span></span><br><span class="line">                <span class="comment"># the params array to a string first, we use</span></span><br><span class="line">                <span class="comment"># json_encode rather than serialize here as</span></span><br><span class="line">                <span class="comment"># it is a lot faster in most cases</span></span><br><span class="line"></span><br><span class="line">            $hash = sha1( json_encode( $params ) );</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Check the cache for any return value that</span></span><br><span class="line">                <span class="comment"># has already been cached for that particular</span></span><br><span class="line">                <span class="comment"># set of input parameters (as identified by</span></span><br><span class="line">                <span class="comment"># its hash)</span></span><br><span class="line"></span><br><span class="line">                $value = $get_value($hash);</span><br><span class="line"></span><br><span class="line">                <span class="comment"># If there was no pre-cached version available,</span></span><br><span class="line">                <span class="comment"># $value will be null. We check this with the ??</span></span><br><span class="line">                <span class="comment"># null coalescing operator, returning either :</span></span><br><span class="line">                <span class="comment"># a) the cached $value if it's not null, or</span></span><br><span class="line">                <span class="comment"># b) the results of actually calling the user</span></span><br><span class="line">                <span class="comment"># function. Note that we wrap the call in the</span></span><br><span class="line">                <span class="comment"># $store_value function to cache the results,</span></span><br><span class="line">                <span class="comment"># and $store_value passes the value back</span></span><br><span class="line">                <span class="comment"># through as its result and so it is also</span></span><br><span class="line">                <span class="comment"># returned to the user in this case</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> $value ?? $store_value(</span><br><span class="line"></span><br><span class="line">                                    $hash, call_user_func_array($func, $params)</span><br><span class="line"></span><br><span class="line">                             );</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>首先，您的备忘录功能通过将输入参数编码为JSON来使输入参数具有唯一的字符串表示形式。 例如，如果您想知道为什么不简单使用implode（“ |”，$ params），请考虑以下两个函数调用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">func(<span class="string">"Hello"</span>,<span class="string">"|There"</span>);</span><br><span class="line">func(<span class="string">"Hello|"</span>,<span class="string">"There"</span>);</span><br></pre></td></tr></table></figure>
<p>这将导致两者实际上都被编码为Hello || There，因此实际上被视为相同的一组参数。如果可以保证，可以使用带有粘合字符的爆破<br>该字符永远不会出现在您的参数中，但是通常以防万一，最好使用防御性代码并使用适当的序列化功能。您可以使用PHP的serialize（）函数代替json_encode<br>因为在某些工作负载下它可能会更快。两者都具有一些极端的情况，您可能需要在选择一种情况之前就熟悉一下这些情况，例如，serialize（）无法使用某些类型的对象。<br>有关这两者的更多信息，请参见PHP手册。<br>一旦有了输入的字符串表示形式，就需要将其转换为另一个适合用作文件名的字符串。您的JSON字符串可能包含对文件无效的字符<br>名称，因此您将为其创建一个SHA1哈希。 MD5散列的创建速度会稍快一些，但发生散列冲突的可能性更大（对于两个不同的输入会生成相同的散列）。即使SHA1也会发生冲突，尽管风险通常很小。如果您绝对无法解决冲突，那么您将需要编写一些代码来解析序列化的字符串并替换无效字符，依此类推，以一致的方式确保对缓存介质（文件例如，写入磁盘的名称长度）。<br>现在，您有了哈希（或其他描述输入参数的独特方式）。然后，您尝试从缓存中加载以哈希为名称的文件内容。如果您无法读取它（通常是因为它不存在，因为这是您第一次使用这些参数调用），则可以使用call_user_func_array（）运行纯函数，获取其返回值并创建缓存文件，最后返回所获取的值你<br>返回值。如果您可以读取文件，则只需返回内容作为返回值，然后跳过执行该函数。您会注意到这里没有使用任何形式的严格输入。如果您从pure函数返回的值是一个int（例如），那么当您第一次运行pure函数时，您会将其写入磁盘并将int返回给调用者。但是，在随后的运行中，您将缓存文件的内容作为字符串获取并返回，因此返回值为字符串。如果在应用程序中键入很重要，则始终可以将值序列化到磁盘，并在读回时再次将其反序列化。<br>现在让我们看一个如何实际使用此备忘功能的示例。您将使用另一个经典的示例任务，即一种算法来生成斐波那契数列。我正在使用此功能，因为它是一个简短易懂的功能，而且恰好是递归的。记忆可用于任何功能，无论是否具有递归功能，但它通常特别有用，因为如前所述，递归功能通常会占用大量资源。如果您不熟悉斐波那契数列，它是一系列数字，其中前两个（如果从零开始，则为三个）之后的每个数字都是前两个数字的和，因此：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0, 1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610, 987, 1597, 2584, 4181, 6765, 10946 and so on…</span><br></pre></td></tr></table></figure>
<p>该算法采用整数n并计算序列中的第n个数字。因此，$fibonacci（7）将返回13（13是上一个序列中的第7个数字，从0开始）。<br>您将创建两个函数：该函数的标准版本和包装在早期$ memoize函数中的一个版本。 通常，您将只创建一个函数并将其包装在$ memoize中。 但是，正如我想<br>演示一个递归调用该记忆版本的递归版本（并将其与未记忆形式进行对比），您将在此处创建两个。 而且对于现代人来说，斐波那契并不是一项特别繁重的任务<br>PC，您将以usleep语句的形式添加一些人为的“费用”，以使每次计算花费的时间更长。 这将说明备忘录对真正长时间运行的功能的影响。 参见清单5-4和清单5-5。</p>
<blockquote>
<p>Listing 5-4 memo_example.php</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Get our memoize function and helpers</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'memoize.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define a plain old recursive fibonacci function</span></span><br><span class="line"></span><br><span class="line">$fibonacci =</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="params">($n)</span> <span class="title">use</span> <span class="params">(&amp;$fibonacci)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        usleep(<span class="number">100000</span>); <span class="comment"># make this time-expensive!</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ($n &lt; <span class="number">2</span>) ? $n : $fibonacci($n - <span class="number">1</span>) + $fibonacci($n - <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define the same fibonacci function again in exactly the</span></span><br><span class="line"><span class="comment"># same way (except for the name), but this time wrap the</span></span><br><span class="line"><span class="comment"># function body in a call to $memoize to get a memoized version</span></span><br><span class="line"></span><br><span class="line">$memo_fibonacci = $memoize(</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="params">($n)</span> <span class="title">use</span> <span class="params">(&amp;$memo_fibonacci)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        usleep(<span class="number">100000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ($n &lt; <span class="number">2</span>) ? $n : $memo_fibonacci($n - <span class="number">1</span>) + $memo_fibonacci($n - <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment"># Let's define a timer function, to time a run of a function,</span></span><br><span class="line"><span class="comment"># and return the parameters, results and timings.</span></span><br><span class="line"></span><br><span class="line">$timer = <span class="function"><span class="keyword">function</span><span class="params">($func, $params)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    $start_time = microtime(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    $results = call_user_func_array($func, $params);</span><br><span class="line"></span><br><span class="line">    $time_taken = round(microtime(<span class="keyword">true</span>) - $start_time, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [ <span class="string">"Param"</span> =&gt; implode($params),</span><br><span class="line">                     <span class="string">"Result"</span> =&gt; $results,</span><br><span class="line">                     <span class="string">"Time"</span> =&gt; $time_taken ];</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># And now let's do a set of runs of both our</span></span><br><span class="line"><span class="comment"># ordinary function and it's memoized sister.</span></span><br><span class="line"><span class="comment"># I've added an extra * parameter to the</span></span><br><span class="line"><span class="comment"># non-memoized runs so that you can spot them</span></span><br><span class="line"><span class="comment"># easier in the output (the '*' isn't used</span></span><br><span class="line"><span class="comment"># by the fibonacci functions, it's just passed</span></span><br><span class="line"><span class="comment"># through to the output of the timer function)</span></span><br><span class="line"></span><br><span class="line">print_r( $timer(  $fibonacci, [<span class="number">6</span>, <span class="string">'*'</span>] ) );</span><br><span class="line"></span><br><span class="line">print_r( $timer(  $memo_fibonacci, [<span class="number">6</span>] ) );</span><br><span class="line"></span><br><span class="line">print_r( $timer(  $fibonacci, [<span class="number">6</span>, <span class="string">'*'</span>] ) );</span><br><span class="line"></span><br><span class="line">print_r( $timer(  $memo_fibonacci, [<span class="number">6</span>] ) );</span><br><span class="line"></span><br><span class="line">print_r( $timer(  $memo_fibonacci, [<span class="number">10</span>] ) );</span><br><span class="line"></span><br><span class="line">print_r( $timer(  $memo_fibonacci, [<span class="number">11</span>] ) );</span><br><span class="line"></span><br><span class="line">print_r( $timer(  $memo_fibonacci, [<span class="number">8</span>] ) );</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Listing 5-5. memo_example-output.txt</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [Param]  =&gt; 6*</span><br><span class="line">    [Result] =&gt; 8</span><br><span class="line">    [Time]   =&gt; 2.5</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [Param]  =&gt; 6</span><br><span class="line">    [Result] =&gt; 8</span><br><span class="line">    [Time]   =&gt; 0.7</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [Param]  =&gt; 6*</span><br><span class="line">    [Result] =&gt; 8</span><br><span class="line">    [Time]   =&gt; 2.5</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [Param]  =&gt; 6</span><br><span class="line">    [Result] =&gt; 8</span><br><span class="line">    [Time]   =&gt; 0</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [Param]  =&gt; 10</span><br><span class="line">    [Result] =&gt; 55</span><br><span class="line">    [Time]   =&gt; 0.4</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [Param]  =&gt; 11</span><br><span class="line">    [Result] =&gt; 89</span><br><span class="line">    [Time]   =&gt; 0.1</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [Param]  =&gt; 8</span><br><span class="line">    [Result] =&gt; 21</span><br><span class="line">    [Time]   =&gt; 0</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>如果查看清单5-5中的第一次运行的输出，您会看到标准函数需要2.5秒才能计算出第六个斐波那契数，而备忘录版本仅需0.7秒。当然，它们应该在第一轮操作相同，因为尚未缓存任何内容。好吧，由于您的函数是递归的，因此实际上您每次计算都会多次调用该函数，并且由于已记忆的版本会使用相同的参数多次调用自身，因此将使用缓存。<br>第三次运行表明，下次使用参数6再次调用标准函数仍需要2.5秒，这很明显，因为它不进行缓存。但是，在6上调用记忆版本需要0秒（向下舍入！），因为计算中的每个递归调用都将命中缓存。<br>接下来计算第十个数字，您只需花费0.4秒。这比计算第6个数字要快，因为它们共享一些步骤（每个人都需要计算第1、2、3等个数字），这些步骤已经被缓存了，而第10个数字只需要实际计算第7、8、9和最后10个数字。下一轮进一步展示了这一点。现在，计算第11个数字仅需0.1秒（因为它只有一个未缓存的函数调用），而最后一次计算第8个数字的运行时间为0秒，因为它是从生成第10个数字起已经在缓存中。<br>如果您第二次调用该脚本，则会发现所有使用备注功能的运行都在0秒内完成，因为您的缓存已经存在所有需要的值，因为您已至少一次生成了所有这些值。除非有人改变了数学的基本原理，否则您可以永久保留高速缓存，因为高速缓存的结果对于给定的输入始终是正确的。如果您想知道高速缓存的外观，则运行/ tmp / memo-cache- *可以得到清单5-6的输出。<br>如您所见，有12个文件，这很有意义，因为您计算了第11个斐波那契数（从0开始计数），因此使用12个不同的参数调用了记忆功能。</p>
<p>Listing 5-6. cache_files.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">::::::::::::::</span><br><span class="line">/tmp/memo-cache-10ae24979c5028fa873651bca338152dc0484245</span><br><span class="line">5</span><br><span class="line">::::::::::::::</span><br><span class="line">/tmp/memo-cache-1184f5b8d4b6dd08709cf1513f26744167065e0d</span><br><span class="line">0</span><br><span class="line">::::::::::::::</span><br><span class="line">/tmp/memo-cache-1fb0856518ee0490ff78e43d1b6dae12ad6ec686</span><br><span class="line">21</span><br><span class="line">::::::::::::::</span><br><span class="line">/tmp/memo-cache-2499831338ca5dc8c44f3d063e076799bea9bdff</span><br><span class="line">1</span><br><span class="line">::::::::::::::</span><br><span class="line">/tmp/memo-cache-3ad009a144b1e8e065a75ca775c76b2fc2e5ff76</span><br><span class="line">89</span><br><span class="line">::::::::::::::</span><br><span class="line">/tmp/memo-cache-4a0a63ce33cc030f270c607ea7bf90a6717572bb</span><br><span class="line">8</span><br><span class="line">::::::::::::::</span><br><span class="line">/tmp/memo-cache-7a60554107407bfe358bedce2bfcb95c90a8ea0d</span><br><span class="line">34</span><br><span class="line">::::::::::::::</span><br><span class="line">/tmp/memo-cache-8f4e345e7cd51e4e633816f5a52a47df465da189</span><br><span class="line">3</span><br><span class="line">::::::::::::::</span><br><span class="line">/tmp/memo-cache-bd703dc0b11593277a5a82dd893f2880b8d0f32a</span><br><span class="line">13</span><br><span class="line">::::::::::::::</span><br><span class="line">/tmp/memo-cache-e9310b0c165be166c43d717718981dd6c9379fbe</span><br><span class="line">55</span><br><span class="line">::::::::::::::</span><br><span class="line">/tmp/memo-cache-f1e31df9806ce94c5bdbbfff9608324930f4d3f1</span><br><span class="line">2</span><br><span class="line">::::::::::::::</span><br><span class="line">/tmp/memo-cache-f629ae44b7b3dcfed444d363e626edf411ec69a8</span><br><span class="line">1</span><br></pre></td></tr></table></figure>
<p>在这些示例中，您缓存到了磁盘，这使您可以创建持久的缓存，该缓存可以在重新启动后幸存下来并由多个进程使用。 但是，有时磁盘速度太慢，并且如果您的函数参数经常更改，您可能只想在单个脚本运行期间进行缓存。 另一种方法是在内存中缓存，实际上PHP提供了一种创建变量的方法，这些变量的作用类似于全局变量，但仅限于给定的函数，非常适合在脚本的一次运行中进行缓存。 这些称为静态变量，如果您不熟悉它们，清单5-7（和清单5-8）是静态变量（$ sta）与全局参数（$ glo），参数（$ 参数）和普通函数作用域（$ nor）变量。</p>
<blockquote>
<p>Listing 5-7. static.php</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$my_func = <span class="function"><span class="keyword">function</span> <span class="params">($par)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> $sta;</span><br><span class="line">  <span class="keyword">global</span> $glo;</span><br><span class="line"></span><br><span class="line">  var_dump( <span class="string">"static : "</span>. $sta += <span class="number">1</span> );</span><br><span class="line">  var_dump( <span class="string">"global : "</span>. $glo += <span class="number">1</span> );</span><br><span class="line">  var_dump( <span class="string">"param  : "</span>. $par += <span class="number">1</span> );</span><br><span class="line">  var_dump( <span class="string">"normal : "</span>. $nor += <span class="number">1</span> );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> $sta;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> ( $my_func(<span class="number">1</span>) &lt; <span class="number">5</span>) &#123; <span class="keyword">echo</span> <span class="string">"-----\n"</span>; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"*****\n"</span>;</span><br><span class="line"></span><br><span class="line">var_dump( <span class="string">"static : "</span>. $sta );</span><br><span class="line">var_dump( <span class="string">"global : "</span>. $glo );</span><br><span class="line">var_dump( <span class="string">"param  : "</span>. $par );</span><br><span class="line">var_dump( <span class="string">"normal : "</span>. $nor );</span><br></pre></td></tr></table></figure>
<p>Listing 5-8. static-output.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">string(10) &quot;static : 1&quot;</span><br><span class="line">string(10) &quot;global : 1&quot;</span><br><span class="line">string(10) &quot;param : 2&quot;</span><br><span class="line">string(10) &quot;normal : 1&quot;</span><br><span class="line">-----</span><br><span class="line">string(10) &quot;static : 2&quot;</span><br><span class="line">string(10) &quot;global : 2&quot;</span><br><span class="line">string(10) &quot;param : 2&quot;</span><br><span class="line">string(10) &quot;normal : 1&quot;</span><br><span class="line">-----</span><br><span class="line">string(10) &quot;static : 3&quot;</span><br><span class="line">string(10) &quot;global : 3&quot;</span><br><span class="line">string(10) &quot;param : 2&quot;</span><br><span class="line">string(10) &quot;normal : 1&quot;</span><br><span class="line">-----</span><br><span class="line">string(10) &quot;static : 4&quot;</span><br><span class="line">string(10) &quot;global : 4&quot;</span><br><span class="line">string(10) &quot;param : 2&quot;</span><br><span class="line">string(10) &quot;normal : 1&quot;</span><br><span class="line">-----</span><br><span class="line">string(10) &quot;static : 5&quot;</span><br><span class="line">string(10) &quot;global : 5&quot;</span><br><span class="line">string(10) &quot;param : 2&quot;</span><br><span class="line">string(10) &quot;normal : 1&quot;</span><br><span class="line">*****</span><br><span class="line">string(9) &quot;static : &quot;</span><br><span class="line">string(10) &quot;global : 5&quot;</span><br><span class="line">string(9) &quot;param : &quot;</span><br><span class="line">string(9) &quot;normal : &quot;</span><br></pre></td></tr></table></figure>
<p>如您所见，即使每次都使用相同的参数（1）调用my_func，每次$sta的值也不同。 因此，尽管您无法从函数外部的任何范围访问它，但通常仍将其视为“副作用”，因为对于函数的任何特定调用，您都无法确定其处于何种状态（在这种情况下， 不知道该函数已被调用多少次）。 那么，如何在功能程序中使用静态变量？ 答案是，小心。 让我们看一个示例（参见清单5-9）。 您将创建备忘录功能的一个版本，该版本使用静态数组来保存缓存而不是写入磁盘。</p>
<p>Listing 5-9. memoize-mem.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$memoize = <span class="function"><span class="keyword">function</span><span class="params">($func)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span> <span class="title">use</span> <span class="params">($func)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> $cache;</span><br><span class="line"></span><br><span class="line">        $params = func_get_args();</span><br><span class="line"></span><br><span class="line">        $hash = sha1( json_encode( $params ) );</span><br><span class="line"></span><br><span class="line">        $cache[<span class="string">"$hash"</span>] = $cache[<span class="string">"$hash"</span>] ?? call_user_func_array($func, $params);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $cache[<span class="string">"$hash"</span>];</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>因此，您放入$ cache数组中的所有内容，然后再从中读取，完全取决于您使用（通过散列）调用函数的参数，而放入其中的则是该函数的值。<br>您对static变量的使用实际上是参照透明的，因此在这种情况下，您不会产生任何潜在的副作用。 如果调用与以前相同的memoize-example.php脚本，但改用此基于内存的备忘录功能，则会得到清单5-10的输出。</p>
<p>Listing 5-10. memo_mem_example-output.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [Param] =&gt; 6*</span><br><span class="line">    [Result] =&gt; 8</span><br><span class="line">    [Time] =&gt; 2.51</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [Param]  =&gt; 6</span><br><span class="line">    [Result] =&gt; 8</span><br><span class="line">    [Time]   =&gt; 0.7</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [Param]  =&gt; 6*</span><br><span class="line">    [Result] =&gt; 8</span><br><span class="line">    [Time]   =&gt; 2.51</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [Param]  =&gt; 6</span><br><span class="line">    [Result] =&gt; 8</span><br><span class="line">    [Time]   =&gt; 0</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [Param]  =&gt; 10</span><br><span class="line">    [Result] =&gt; 55</span><br><span class="line">    [Time]   =&gt; 0.4</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [Param]  =&gt; 11</span><br><span class="line">    [Result] =&gt; 89</span><br><span class="line">    [Time]   =&gt; 0.1</span><br><span class="line">)</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [Param]  =&gt; 8</span><br><span class="line">    [Result] =&gt; 21</span><br><span class="line">    [Time]   =&gt; 0</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>如您所见，它的输出与基于文件的示例完全相同。实际上，它的运行速度要快一点，因为您没有在进行磁盘I / O，但是在这里四舍五入到最接近的0.1秒。与基于磁盘的示例相比，唯一的不同之处在于，如果您第二次运行该脚本，您将再次获得此输出（而不是用于记忆调用的全零），因为用于缓存的静态变量为脚本结束时销毁。<br>除了基于磁盘和基于会话的内存缓存之外，还有一种替代方法是普通的RAM磁盘。在Linux类型的系统上，有一个名为tmpfs的文件系统，该文件系统允许您创建和使用存储在其中的文件。<br>内存而不是磁盘。这些虚拟文件的行为和操作类似于磁盘上的普通文件，因此可以像使用普通“磁盘上”文件一样，允许不同的PHP进程读取和写入文件中的缓存数据。 tmpfs带来的好处是双重的。首先，它很快，其次，一切都是暂时的。因为文件保存在内存中，所以没有机械硬盘可以等待，因此I / O非常快。而且由于它们保留在内存中，因此它们只是临时的，如果您尚未删除它们，则在重新启动后会消失。<br>另一个优点是，它们是普通文件，不是特定于PHP的技术，因此可以根据需要从其他软件进行访问。您可以使用与普通文件和流相同的方式来访问tmpfs文件系统上的文件。它们在内存中的事实对您的PHP脚本是透明的。较早的基于文件的示例将与RAM磁盘完美配合。<br>要在Linux上创建tmpfs文件系统，请首先在磁盘上创建一个目录，用于将存储设备“附加”到文件系统。然后将存储设备安装在该位置并开始使用它。清单5-11中的shell脚本（清单5-12中的输出）给出了安装和卸下tmpfs RAM磁盘的示例。</p>
<p>Listing 5-11. ramdisk.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line">mkdir /tmp/myMemoryDrive</span><br><span class="line">sudo mount -t tmpfs /mnt/tmpfs /tmp/myMemoryDrive</span><br><span class="line">php -r <span class="string">"file_put_contents('/tmp/myMemoryDrive/test.txt',\"Hello\n\");"</span></span><br><span class="line">cat /tmp/myMemoryDrive/test.txt</span><br><span class="line">sudo umount /mnt/tmpfs</span><br><span class="line">cat /tmp/myMemoryDrive/test.txt</span><br></pre></td></tr></table></figure>
<p>Listing 5-12. ramdisk-output.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Hello</span><br><span class="line">cat: /tmp/myMemoryDrive/test.txt: No such file or directory</span><br></pre></td></tr></table></figure>
<p>在清单5-11中，您在/ tmp / myMemoryDrive中创建一个目录来附加存储设备，然后将其安装在该目录中。您可以执行一行PHP来演示如何像创建其他任何文件一样创建内存文件，然后将其编入目录，该文件应输出Hello。最后，您卸载了设备并尝试再次保存文件，但是正如您所期望的，文件已经消失了。它永远不会保存到物理磁盘。您可以使用mount命令挂载tmpfs设备，如您每次引导系统或每次使用它们时所显示的那样，也可以将其添加到fstab文件中，以使其在每次系统引导时自动创建。无论以哪种方式安装它，在关闭或重新启动时，请始终记住它及其中的所有文件都会被破坏。<br>由于tmpfs的运行方式与普通文件系统相同，因此您需要确保设置了相关的文件许可权，以允许所有应用程序对其进行访问（或阻止那些不应该使用<br>能够干预）。还请记住，如果系统内存不足，则可能会发生内存交换到磁盘的情况，因此在这种情况下，数据可能会暂时碰到硬盘，在某些情况下，此后可以从磁盘恢复。请始终考虑您选择的任何缓存系统的安全性。<br>如果出于性能原因考虑使用tmpfs代替物理硬盘，则还应记住，现代操作系统（包括现代Linux）可以使用主动内存缓存来访问磁盘。这意味着操作系统透明地将经常读取的基于磁盘的文件缓存到动态分配的未使用的内存中（通常您甚至不知道）以提高明显的物理磁盘性能。在这些情况下，当您从tmpfs内存磁盘读取某些文件并遍历目录树时，可能不会看到预期的性能改进。写磁盘和访问较少的文件通常不会被缓存，因此在这种情况下，tmpfs仍然可以为您带来预期的收益。<br>在Windows中，没有内置的方法来创建基于内存的文件系统。存在用于创建RAM磁盘的各种第三方软件，但尚未标准化，并且大多数应用程序需要GUI才能在每个系统上手动设置磁盘。接下来列出的Wikipedia页面为您提供了更多指示，以供您探索是否仍然感兴趣。</p>
<h1 id="记忆化的缺点"><a href="#记忆化的缺点" class="headerlink" title="记忆化的缺点"></a>记忆化的缺点</h1><p>如您所见，通过记忆进行缓存通常是一件好事，但正如我母亲一直说的：“您可以拥有太多的好东西。”在默认情况下，开始记忆所有功能的诱惑可能会蔓延开来，但与所有其他功能一样，首先要考虑一些折衷。记住的函数会带来一些开销，用于每次运行时检查缓存版本是否可用以及获取或存储生成的任何缓存版本。如果您要记住要加快脚本的执行速度，并且您的缓存与前面的主要示例一样位于磁盘上，那么磁盘I / O会花费额外的时间（与内存存储或实际上许多仅用于计算的功能相比，这通常很慢）可能比运行中低复杂度功能所需的时间更长。当然，如果您要缓存以优化低内存系统，减少对外部API的调用次数或将其他与时间无关的资源使用量降到最低，那么这可能是可以接受的折衷方案。<br>使用备注进行缓存时，要考虑的另一个考虑因素是某些数据的短暂性是否会限制您从中获得的成本价值。例如，如果您的功能的参数之一是客户ID，但您的客户很少对您的网上商店进行多次访问/购买，则对该功能的任何缓存都可能仅在那一次访问期间受益。与更一般的缓存情况相比，使用纯函数记忆化的好处之一是，您不必担心缓存失效，因为您的缓存永远不会无效。但是，这导致了诱惑，便简单地忘记了缓存而将其保留，从编程的角度来看这是完全可以的。您的代码将继续以正确的输出正常运行。但是，您的系统管理员可能很快就会出现并开始询问您是否真的需要昂贵的SAN上的所有磁盘空间。磁盘空间的成本可能超过脚本的有限加速。在这些情况下，您有三个选择。<br>•删除备忘录：接受一些运行时间更长的脚本。<br>•缓存到磁盘上的内存或每个会话文件，而不是长期磁盘上：<br>这样可以在一次访问中加快多个呼叫的速度，但会暂时占用一些内存。<br>•执行某种形式的缓存逐出：删除已存在一个月以上的缓存文件。</p>
<h1 id="懒惰评估"><a href="#懒惰评估" class="headerlink" title="懒惰评估"></a>懒惰评估</h1><p>懒惰评估是一种艺术，它仅进行最少的工作即可获得所需的结果。<br>PHP程序员应该自然而然地做到这一点！ 考虑以下伪代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( do_something_easy() <span class="keyword">OR</span> do_something_hard() ) &#123; <span class="keyword">return</span> &#125;</span><br></pre></td></tr></table></figure>
<p>该代码说明“如果do_something_easy（）或do_something_hard（）为true，则返回。”因此，要确定是否应返回，可以调用两个函数，如果其中一个返回true，则知道要返回。但是，请考虑一下，如果do_something_easy（）返回true，则do_something_hard（）返回什么都无所谓，因为无论如何您都将返回。因此，在运行do_something_easy（）之后，实际上没有必要运行第二个函数调用，并且您可以节省这样做的开销。相反，如果返回的是false，则需要运行第二个，但是，与第一个同时自动调用两者的情况相比，您的情况不会更糟。这称为惰性评估；您只评估需要的内容，而没有声明更多。<br>在评估布尔表达式时，PHP使用一种称为短路评估的惰性评估类型，这取决于逻辑运算符的先例。因此，如果要从这样的表达式中调用函数以确保您不会使短路短路，那么除了注意手册中的以下几页之外，您无需执行其他任何操作！</p>
<h1 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h1><p>但是，您可以采用这种惰性求值的概念，并将其应用到您的函数中以加快执行速度。在上一章中介绍的功能组合示例中，通常会获取一个数据数组，对其进行处理，将该数组传递给下一个函数，然后执行其他操作，等等。<br>即使实际上不需要数组中的所有数据，也通常将其传递给整个数组，然后将函数和转换应用于整个数组。您看过array_filter，它确实使用某些过滤器函数将数组的大小缩减为某些元素，但是即使那样，过滤器函数也将应用于数组的每个单个元素。如果只需要前10个匹配元素并且有100个匹配元素，那么您就浪费了时间，在找到前10个匹配元素之后应用filter函数，还需要执行其他步骤，例如使用array_slice将结果100缩减为10 。<br>PHP有一个称为生成器的有用语言工具，它在PHP 5.5中引入。生成器允许您创建函数，该函数返回有点像数组的东西，但是其数据是在访问元素时“实时”生成的。您可以使用生成器来创建仅执行最少必需工作的惰性函数。<br>将生成器功能链接在一起时，执行将向后执行。考虑如下三个标准函数的伪链：</p>
<ul>
<li>array_filter some_function();</li>
<li>array_filter another_function();</li>
<li>array_slice 0, 10;</li>
</ul>
<p>首先将对整个数组进行过滤，然后对整个结果再次进行过滤，然后将第二个结果减少到十个项目。 在基于生成器的系统中，您可以编写如下所示的链：</p>
<ul>
<li>lazy_filter some_function();</li>
<li>lazy_filter another_function();</li>
<li>lazy_slice 0, 10;</li>
</ul>
<p>它看起来是一样的，但是执行时，操作实际上是从lazy_slice开始，它会拉动整个链中的值。 slice函数从第二个过滤器请求值，直到有十个为止。每次第二个过滤器收到一个值请求时，它都会向第一个过滤器请求值，并向它们应用another_function（）直到匹配为止。并且，每当第一个过滤器获取一个值请求时，它都会从数组中获取值，并对它们应用some_function（）直到获得匹配。因此，当lazy_slice获得其十个值时，这两个lazy_filter函数仅足够多次调用了它们（可能昂贵的）过滤函数，以生成那十个，而不是（不必要）生成原始数据的所有项。<br>稍后，您将看到一个发电机的基本示例。但是在您这样做之前，让我们创建一个函数以重复调用一个函数。当您查看时间时，同一台PC上无关的任务可能会暂时降低脚本的运行速度。多次运行脚本或函数可以限制这种暂时性的延迟对基准计时编号的影响。参见清单5-13。</p>
<blockquote>
<p>Listing 5-13 repeat.php</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 为了获得基准测试结果，最好重复运行该函数，以最大程度地降低任何外部变慢的影响。</span></span><br><span class="line"><span class="comment">// 以下函数仅使用参数$ args调用函数$func $n次，并返回上一次调用的返回值。</span></span><br><span class="line">$repeat = <span class="function"><span class="keyword">function</span> <span class="params">($func, $n, ...$args)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> ($i=<span class="number">0</span>; $i &lt; $n; $i++) </span><br><span class="line">    &#123;</span><br><span class="line">        $result = $func(...$args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>现在，让我们看一个生成器的简单示例（请参见清单5-14，输出如清单5-15所示）。<br>生成器是具有yield语句而不是return语句的函数。 与普通函数在返回时会丢失其状态不同，yield的函数会保持其状态直到下一次调用。<br>PHP具有一个名为range（）的本地函数，该函数返回从$ start到$ end的数字数组，并带有可选的$ step值。 您将创建一个生成器版本gen_range（），该版本会产生相同的输出，但会产生延迟。 您将使用相同的参数调用这两者，以生成介于1到1000万之间的第四个数字，然后在得到一个可被123整除的数字时退出运行函数。</p>
<blockquote>
<p>Listing 5-14 generators.php</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Get our repeat function</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'repeat.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># PHP's native function range() takes a</span></span><br><span class="line"><span class="comment"># $start int, $end in and $step value, and</span></span><br><span class="line"><span class="comment"># returns an array of ints from $start to $end</span></span><br><span class="line"><span class="comment"># stepping up by $step each time. We'll create</span></span><br><span class="line"><span class="comment"># a generator version that takes the same</span></span><br><span class="line"><span class="comment"># parameters and does the same task, called gen_range()</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gen_range</span><span class="params">($start, $end, $step)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> ($i = $start; $i &lt;= $end; $i += $step) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"># yield turns this function into a generator</span></span><br><span class="line">        <span class="keyword">yield</span> $i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># We'll create a function to run either range() or</span></span><br><span class="line"><span class="comment"># gen_range() (as specified in $func) with the</span></span><br><span class="line"><span class="comment"># same paramters, and to iterate through the</span></span><br><span class="line"><span class="comment"># returned values until we find a number exactly</span></span><br><span class="line"><span class="comment"># divisible by 123 (which in this case is 369)</span></span><br><span class="line"></span><br><span class="line">$run = <span class="function"><span class="keyword">function</span> <span class="params">($func)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment"># Get a range from 1 to ten million in steps of 4,</span></span><br><span class="line">    <span class="comment"># so 1,4,9,13,18,...,9999989,9999993,9999997</span></span><br><span class="line">    <span class="keyword">foreach</span> ( $func(<span class="number">1</span>, <span class="number">10000000</span>, <span class="number">4</span>) <span class="keyword">as</span> $n ) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ($n % <span class="number">123</span> == <span class="number">0</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment"># exit the function once we've found one, reporting</span></span><br><span class="line">            <span class="comment"># back the memory in use (as it will be freed once</span></span><br><span class="line">            <span class="comment"># we have returned).</span></span><br><span class="line">            <span class="keyword">return</span> memory_get_usage();</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># A function to get the time/memory use for the runs</span></span><br><span class="line"></span><br><span class="line">$profile = <span class="function"><span class="keyword">function</span> <span class="params">($func, ...$args)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $start = [</span><br><span class="line">        <span class="string">"mem"</span>  =&gt; memory_get_usage(), </span><br><span class="line">        <span class="string">"time"</span> =&gt; microtime(<span class="keyword">true</span>)</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    $end = [</span><br><span class="line">        <span class="string">"mem"</span>  =&gt; $func(...$args),  </span><br><span class="line">        <span class="string">"time"</span> =&gt; microtime(<span class="keyword">true</span>)</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">"Memory"</span> =&gt; $end[<span class="string">"mem"</span>] - $start[<span class="string">"mem"</span>],</span><br><span class="line">        <span class="string">"Time"</span>   =&gt; $end[<span class="string">"time"</span>] - $start[<span class="string">"time"</span>]</span><br><span class="line">    ];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Finally let's run each of range() and gen_range() 100 times,</span></span><br><span class="line"><span class="comment"># and output the time taken for each and memory used</span></span><br><span class="line"><span class="keyword">Echo</span> <span class="string">"*** range() ***\n"</span>;</span><br><span class="line"></span><br><span class="line">print_r ( $profile($repeat, $run, <span class="number">100</span>, <span class="string">'range'</span>) );</span><br><span class="line"></span><br><span class="line"><span class="keyword">Echo</span> <span class="string">"*** gen_range() ***\n"</span>;</span><br><span class="line"></span><br><span class="line">print_r ( $profile($repeat, $run, <span class="number">100</span>, <span class="string">'gen_range'</span>) );</span><br></pre></td></tr></table></figure>
<p>Listing 5-15. generators-output.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">*** range() ***</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [Memory] =&gt; 134222280</span><br><span class="line">    [Time]   =&gt; 8.9564578533173</span><br><span class="line">)</span><br><span class="line">*** gen_range() ***</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [Memory] =&gt; 4952</span><br><span class="line">    [Time]   =&gt; 0.0016660690307617</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>因此，如您所见，惰性版本使用的内存量比正常的range（）函数少得多。这是因为range（）必须在开始迭代之前生成值的整个数组<br>通过foreach遍历它们，而gen_range（）仅保存序列中的当前值。 gen_range（）所花费的时间也少得多，因为一旦您达到369，就完成了，而range（）必须甚至在开始之前就生成序列中的每个单个值。<br>注意，使用的内存是$ run函数返回时返回的值memory_get_usage，这对于您的函数来说可能只是每个函数中使用的最大内存量。<br>因此，这就是生成器的外观。现在，让我们看一下如何在功能组合中使用它们，以最大程度地减少功能链要做的工作量。您将创建一个脚本，该脚本需要莎士比亚的名副其实的完整著作（作为纯文本文件），获得提及英雄一词的行，并获得任何长度超过60个字符的行，然后返回前三个匹配项。<br>清单5-16展示了如何以一种非延迟的方式进行操作，清单5-17中显示了输出。</p>
<p>Listing 5-16. filter.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Borrow some functions from Chapter 3,</span></span><br><span class="line"><span class="comment"># and our repeat function</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'../Chapter 3/compose.php'</span>);</span><br><span class="line"><span class="keyword">require</span>(<span class="string">'../Chapter 3/partial_generator.php'</span>);</span><br><span class="line"><span class="keyword">require</span>(<span class="string">'repeat.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># A helper function to fix parameters from the right,</span></span><br><span class="line"><span class="comment"># as we'll otherwise call partial(reverse()) a lot below.</span></span><br><span class="line"></span><br><span class="line">$partial_right = <span class="function"><span class="keyword">function</span> <span class="params">($func, ...$params)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> partial(reverse($func), ...$params);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get the start time, to see how long the script takes</span></span><br><span class="line"></span><br><span class="line">$start_time = microtime(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># A function to return true if $word is in $str</span></span><br><span class="line"><span class="comment"># (not comprehensive, but matches a word bounded</span></span><br><span class="line"><span class="comment"># by non-A-Z chars, so matches "hero" but not "heroes")</span></span><br><span class="line"></span><br><span class="line">$match_word = <span class="function"><span class="keyword">function</span><span class="params">($word, $str)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> preg_match(<span class="string">"/[^a-z]$&#123;word&#125;[^a-z]/i"</span>, $str);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># A function to return true if $str is longer than $len chars</span></span><br><span class="line"></span><br><span class="line">$longer_than = <span class="function"><span class="keyword">function</span><span class="params">($len, $str)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> strlen($str) &gt; $len;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># A partial function, fixing hero as the word to search for</span></span><br><span class="line"></span><br><span class="line">$match_hero = partial($match_word, <span class="string">'hero'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># Another partial function, picking out strings longer than 60 chars</span></span><br><span class="line"></span><br><span class="line">$over_sixty = partial($longer_than, <span class="number">60</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># A partial function which uses array_filter to apply $match_hero</span></span><br><span class="line"><span class="comment"># to all elements of an array and return only those with 'hero' in</span></span><br><span class="line"></span><br><span class="line">$filter_hero = $partial_right(<span class="string">'array_filter'</span>, $match_hero );</span><br><span class="line"></span><br><span class="line"><span class="comment"># Similarly, we'll filter an array with the $over_sixty function</span></span><br><span class="line"></span><br><span class="line">$filter_sixty = $partial_right(<span class="string">'array_filter'</span>, $over_sixty );</span><br><span class="line"></span><br><span class="line"><span class="comment"># A function to grab the first 3 elements from an array</span></span><br><span class="line"></span><br><span class="line">$first_three = $partial_right(<span class="string">'array_slice'</span>, <span class="number">3</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># Let's now compose the function above to create a</span></span><br><span class="line"><span class="comment"># function which grabs the first three long</span></span><br><span class="line"><span class="comment"># sentences mentioning hero.</span></span><br><span class="line"></span><br><span class="line">$three_long_heros = compose(</span><br><span class="line">                                                            $filter_hero,</span><br><span class="line">                                                            $filter_sixty,</span><br><span class="line">                                                            $first_three</span><br><span class="line">                                                 );</span><br><span class="line"></span><br><span class="line"><span class="comment"># Finally, let's actually call our composed function 100 times</span></span><br><span class="line"><span class="comment"># on the contents of all_shakespeare.txt</span></span><br><span class="line"><span class="comment"># Note that calling file() as a parameter means that it is</span></span><br><span class="line"><span class="comment"># only evaluated once (and not 100 times), so the time for disk</span></span><br><span class="line"><span class="comment"># IO won't be a major element of our timings</span></span><br><span class="line"></span><br><span class="line">$result = $repeat(</span><br><span class="line">                                   $three_long_heros,</span><br><span class="line">                                     file(<span class="string">'all_shakespeare.txt'</span>),</span><br><span class="line">                                     <span class="number">100</span></span><br><span class="line">                                 );</span><br><span class="line"></span><br><span class="line"><span class="comment"># Print out the result of the last call (which should be the</span></span><br><span class="line"><span class="comment"># same as all of the rest, as all of our composed functions are</span></span><br><span class="line"><span class="comment"># pure and are called on exactly the same input parameter)</span></span><br><span class="line"></span><br><span class="line">print_r($result);</span><br><span class="line"></span><br><span class="line"><span class="comment"># and the time taken</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Time taken : '</span>.(microtime(<span class="keyword">true</span>) - $start_time);</span><br></pre></td></tr></table></figure>
<p>Listing 5-17. filter-output.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Array</span><br><span class="line">(</span><br><span class="line">[0] =&gt; Enter DON PEDRO, DON JOHN, LEONATO, FRIAR FRANCIS, CLAUDIO, BENEDICK, HERO,</span><br><span class="line">BEATRICE, and Attendants</span><br><span class="line">[1] =&gt; Sweet Hero! She is wronged, she is slandered, she is undone.</span><br><span class="line">[2] =&gt; Think you in your soul the Count Claudio hath wronged Hero?</span><br><span class="line">)</span><br><span class="line">Time taken : 6.2691030502319</span><br></pre></td></tr></table></figure>
<p>这为您提供了三行所需的信息，在我的薄弱笔记本电脑上运行100次大约需要6秒钟。 清单5-18懒惰地重写了此脚本，输出如清单5-19所示。</p>
<p>Listing 5-18. lazy_filter.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Again we'll borrow some functions from Chapter 3,</span></span><br><span class="line"><span class="comment"># and our repeat function</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'../Chapter 3/compose.php'</span>);</span><br><span class="line"><span class="keyword">require</span>(<span class="string">'../Chapter 3/partial_generator.php'</span>);</span><br><span class="line"><span class="keyword">require</span>(<span class="string">'repeat.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># and start timing</span></span><br><span class="line"></span><br><span class="line">$start_time = microtime(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># We'll now define a lazy version of array_filter, using</span></span><br><span class="line"><span class="comment"># a generator (note the yield statement)</span></span><br><span class="line"></span><br><span class="line">$lazy_filter = <span class="function"><span class="keyword">function</span> <span class="params">($func, $array)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Loop through the array</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($array <span class="keyword">as</span> $item) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Call the function on the array item, and</span></span><br><span class="line">        <span class="comment"># if it evaluates to true, return the item</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( $func($item) ) &#123; <span class="keyword">yield</span> $item; &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># The following functions are exactly the same as</span></span><br><span class="line"><span class="comment"># in the non-lazy filter.php example</span></span><br><span class="line"></span><br><span class="line">$match_word = <span class="function"><span class="keyword">function</span><span class="params">($word, $str)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> preg_match(<span class="string">"/[^a-z]$&#123;word&#125;[^a-z]/i"</span>, $str);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$longer_than = <span class="function"><span class="keyword">function</span><span class="params">($len, $str)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> strlen($str) &gt; $len;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$match_hero = partial($match_word, <span class="string">'hero'</span>);</span><br><span class="line"></span><br><span class="line">$over_sixty = partial($longer_than, <span class="number">60</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># Our $filter_hero function is almost the same,</span></span><br><span class="line"><span class="comment"># but note that it calls $lazy_filter instead of</span></span><br><span class="line"><span class="comment"># array_filter (and it uses partial() rather than</span></span><br><span class="line"><span class="comment"># $partial_right, as I've implemented $lazy_filter</span></span><br><span class="line"><span class="comment"># with the parameters in the opposite order to</span></span><br><span class="line"><span class="comment"># array_filter.</span></span><br><span class="line"></span><br><span class="line">$filter_hero = partial($lazy_filter, $match_hero );</span><br><span class="line"></span><br><span class="line"><span class="comment"># Again $filter_sixty uses $lazy_filter rather than array_filter</span></span><br><span class="line"></span><br><span class="line">$filter_sixty = partial($lazy_filter, $over_sixty );</span><br><span class="line"></span><br><span class="line"><span class="comment"># As the output from filter_sixty will be a generator object</span></span><br><span class="line"><span class="comment"># rather than an array, we can't use array_slice to</span></span><br><span class="line"><span class="comment"># get the first three items (as data doesn't exist in a</span></span><br><span class="line"><span class="comment"># generator until you call for it). Instead, we'll create</span></span><br><span class="line"><span class="comment"># a $gen_slice function which calls the generator $n times</span></span><br><span class="line"><span class="comment"># and returns the $n returned values as an array. We'll take</span></span><br><span class="line"><span class="comment"># advantage of that fact that a generator is an iterable object,</span></span><br><span class="line"><span class="comment"># and so has current() and next() methods to get each value.</span></span><br><span class="line"><span class="comment"># We'll practice our recursion, rather than just using</span></span><br><span class="line"><span class="comment"># a for loop!</span></span><br><span class="line"></span><br><span class="line">$gen_slice = <span class="function"><span class="keyword">function</span> <span class="params">($n, $output = [], $generator)</span> <span class="title">use</span> <span class="params">(&amp;$gen_slice)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    $output[] = $generator-&gt;current();</span><br><span class="line"></span><br><span class="line">    $generator-&gt;next();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($n &gt; <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">                $output = $gen_slice(--$n, $output, $generator);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> $output;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># $first_three uses $gen_slice rather than array_slice</span></span><br><span class="line"></span><br><span class="line">$first_three = partial($gen_slice, <span class="number">3</span>, []);</span><br><span class="line"></span><br><span class="line"><span class="comment"># We'll compose them together, repeatedly call them</span></span><br><span class="line"><span class="comment"># and output the results using exactly the same</span></span><br><span class="line"><span class="comment"># code as in the non-lazy version</span></span><br><span class="line"></span><br><span class="line">$three_long_heros = compose(</span><br><span class="line">                                                            $filter_hero,</span><br><span class="line">                                                            $filter_sixty,</span><br><span class="line">                                                            $first_three</span><br><span class="line">                                                 );</span><br><span class="line"></span><br><span class="line">$result = $repeat( $three_long_heros, file(<span class="string">'all_shakespeare.txt'</span>), <span class="number">100</span> );</span><br><span class="line"></span><br><span class="line">print_r($result);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Time taken : '</span>.(microtime(<span class="keyword">true</span>) - $start_time);</span><br></pre></td></tr></table></figure>
<p>Listing 5-19. lazy_filter-output.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Array</span><br><span class="line">(</span><br><span class="line">[0] =&gt; Enter DON PEDRO, DON JOHN, LEONATO, FRIAR FRANCIS, CLAUDIO, BENEDICK, HERO,</span><br><span class="line">BEATRICE, and Attendants</span><br><span class="line">[1] =&gt; Sweet Hero! She is wronged, she is slandered, she is undone.</span><br><span class="line">[2] =&gt; Think you in your soul the Count Claudio hath wronged Hero?</span><br><span class="line">)</span><br><span class="line">Time taken : 2.1842160224915</span><br></pre></td></tr></table></figure>
<p>您得到相同的结果，但仅需2秒钟，大约快了三倍。 那么，这是如何工作的呢？ 好吧，您的lazy_filter不会返回任何数据，而是“产生”一个生成器对象。 该对象实现了PHP的迭代器接口，因此诸如foreach之类的功能会自动知道如何使用它，就好像它是任何其他可迭代的数据类型一样。 当您使用gen_slice（）函数时，这一点变得尤为明显。该函数不是假装您正在使用数组，而是仅调用生成器对象的current（）和next（）方法来请求下三个数据。 如果您不熟悉迭代器，则PHP手册的以下部分将对您进行分类。</p>
<p>顺便说一句，当我编写以前的脚本时，我首先使用compose语句命名了它链接在一起的三个功能，然后向后进行工作以找出实现它们所需的功能。 在进行功能编程时，您经常会发现这种模式。 声明式的性质使其适用于自上而下的程序设计方法。</p>
<h1 id="懒惰评估的缺点"><a href="#懒惰评估的缺点" class="headerlink" title="懒惰评估的缺点"></a>懒惰评估的缺点</h1><p>生成器很棒，并且惰性评估通常是一个非常有用的工具。 但是，正如您可能期望的那样，值得一提的是可能会有不利之处。 如果再次运行您的generators.php示例，但是这次不是寻找一个可被123整除的数字，而是使用值9999989，清单5-20和清单5-21显示了发生的情况。</p>
<p>Listing 5-20. generators2-output.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">*** range() ***</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [Memory] =&gt; 134222280</span><br><span class="line">    [Time]   =&gt; 26.05708694458</span><br><span class="line">)</span><br><span class="line">*** gen_range() ***</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [Memory] =&gt; 4952</span><br><span class="line">    [Time]   =&gt; 41.604923009872</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>标准range（）函数需要26秒，但是您的gen_range（）惰性函数几乎将其翻了一番，达到41秒。为什么？好的，发电机中存在固有的开销。寻找一个可以被9999989整除的数字（在这种情况下，它本身就是数字）意味着您必须一直进行直到找到数字序列的末尾为止。但是您必须对序列中的每个数字都调用一个函数（通过foreach），而不是对range（）进行一次函数调用，而且每次函数调用都会产生少量开销。<br>此外，您要调用的函数是由您用PHP编写的，而不是由整个PHP核心开发人员团队使用C编写的，因此，高度优化的代码要少得多。因此，通常会出现一个问题，即与最初进行全面评估相比，生成器的时间效率较低。通常这是最小的，并且在评估过程即将结束时，并且如果您的运行输入值“分散”了，即使其中一些花费的时间比完整的评估方法花费的时间更长，通常也可以总体上领先。不过，始终值得考虑您的用例，并确保根据实际数据对代码进行性能分析。</p>
<p>不过，这也不是个坏消息。 如果查看一下内存使用情况的数字，您会发现它们与第一个示例中的数字完全相同，在第一个示例中，您寻找的数字可以被123整除。在这种情况下，您可能会考虑由于 如果您正在使用内存受限的设备，则每次更改值（而不是预先生成所有值）都值得偶尔的额外执行时间。</p>
<h1 id="并行编程"><a href="#并行编程" class="headerlink" title="并行编程"></a>并行编程</h1><p>在写书的漫长过程中，我经常希望自己的双手可以同时写不同的章节。这样一来，我完成本书的速度就会快两倍。不幸的是，当我意识到我微不足道的大脑一次只能跟踪一组单词时，我的狡猾计划受到了挫败。<br>幸运的是，现代计算机并没有我这么有限，可以一次执行并跟踪许多任务。<br>计算机以各种方式（并行计算，多任务，多线程，多处理等）执行此操作，但是它们全都归结为一件事：您同时执行的次数越多，完成任务的速度就越快。<br>不过，即使您同时执行不同的操作，即使拥有现代PC的智能功能，也可以确保一切顺利。资源争用，死锁，争用条件：当多个线程或进程试图同时访问相同的资源（变量，数据，文件，硬件等）时，这些都是发生的事情。像这样的编程中最难的部分可能是在考虑脚本执行在不同路径上可能发生的所有可能性。<br>函数式编程可以使此操作更容易。当您的程序需要执行并行任务时，它们将剥离一些线程，子进程或类似任务以完成任务，并且它们通常会合并结果或在线程或进程返回时采取某些措施。如果您使用本书中介绍的功能原理编写这些任务工作程序，则每个工作程序都可以成为一连串的纯函数，其中：<br>•任务仅取决于其给定的输入（例如函数的参数），而不取决于<br>外部状态。<br>•由于不受其他任务的影响，因此可以很容易地对任务进行单独推理。<br>这意味着您不必（过多）担心其他任务在做什么，它们可能正在使用的所需资源等，等等。您的任务具有调用时所需要的一切作为输入的一部分，并且它将返回其输出以供父脚本使用，以担心处理/存储等问题。即使它不是严格的函数，也可以像编写脚本一样编写工作脚本，接受来自父文件的输入，就好像它是参数一样，并返回单个最后返回给父级的值，就像返回值一样。<br>PHP并非自然而然地用于并行编程，但是有多种实现并行计算的方法，可以在需要时将其付诸实践。也许最简单的方法是使用PHP的内置过程控制功能并行启动多个PHP脚本来完成工作。让我们看一个以这种方式使用流程控制的示例。<br>您将创建一个程序来对莎士比亚的完整作品进行一些分析。您将创建一个以正常线性方式进行分析的函数，以及一个生成的函数<br>多个“客户端” PHP工作程序脚本并行进行分析。首先，您将看到主要的parallel.php控制脚本，然后是并行版本中使用的client.php脚本，最后您将看到functions.php脚本，其中包含各种分析和并行化功能。您的脚本将从文本中挑选出符合特定条件的单词，将这些单词在整个文本中出现的次数相加，然后报告该集合中出现次数最多的十个单词。您将重复每个功能100次以对其进行基准测试。</p>
<p>Listing 5-21. parallel.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Get a set of functions that we'll look at shortly</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'functions.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># The text to work on.</span></span><br><span class="line"></span><br><span class="line">$shakespeare = file_get_contents(<span class="string">'all_shakespeare.txt'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># How many times we're going to run each function, for</span></span><br><span class="line"><span class="comment"># benchmarking purposes</span></span><br><span class="line"></span><br><span class="line">$repeats = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compose our single process "standard" function.</span></span><br><span class="line"></span><br><span class="line">$analyze_single = compose(</span><br><span class="line"></span><br><span class="line">                    $only_letters_and_spaces, <span class="comment"># simplify the text</span></span><br><span class="line"></span><br><span class="line">                    <span class="string">'strtolower'</span>, <span class="comment"># all lowercase, please</span></span><br><span class="line"></span><br><span class="line">                    $analyze_words, <span class="comment"># do the analysis</span></span><br><span class="line"></span><br><span class="line">                    $sort_results, <span class="comment"># sort the results</span></span><br><span class="line"></span><br><span class="line">                    <span class="string">'array_reverse'</span>, <span class="comment"># get the results in descending order</span></span><br><span class="line"></span><br><span class="line">                    $top_ten <span class="comment"># return the top ten results</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run the single process version $repeats time on $shakespeare input</span></span><br><span class="line"><span class="comment"># Time the runs</span></span><br><span class="line"></span><br><span class="line">$checkpoint1 = microtime(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">print_r( $repeat($analyze_single, $repeats, $shakespeare) );</span><br><span class="line"></span><br><span class="line">$checkpoint2 = microtime(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># Now create a parallel process version</span></span><br><span class="line"></span><br><span class="line">$analyze_parallel = compose (</span><br><span class="line"></span><br><span class="line">                    $launch_clients, <span class="comment"># Launch a set of client processes to do</span></span><br><span class="line">                                                     <span class="comment"># the analysis</span></span><br><span class="line"></span><br><span class="line">                    $report_clients, <span class="comment"># Tell us how many clients were launched</span></span><br><span class="line"></span><br><span class="line">                    $get_results, <span class="comment"># Get the results back from the clients</span></span><br><span class="line"></span><br><span class="line">                    $combine_results, <span class="comment"># Combine their results into one set</span></span><br><span class="line"></span><br><span class="line">                    $sort_results, <span class="comment"># sort the combined results</span></span><br><span class="line"></span><br><span class="line">                    <span class="string">'array_reverse'</span>, <span class="comment"># get the results in descending order</span></span><br><span class="line"></span><br><span class="line">                    $top_ten <span class="comment"># return the top ten results</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run the parallel version and time it</span></span><br><span class="line"></span><br><span class="line">$checkpoint3 = microtime(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">print_r ( $repeat($analyze_parallel, $repeats, $shakespeare) );</span><br><span class="line"></span><br><span class="line">$checkpoint4 = microtime(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># Finally, dump the timings for comparison</span></span><br><span class="line"></span><br><span class="line">var_dump( <span class="string">'Single : '</span>.($checkpoint2 - $checkpoint1));</span><br><span class="line"></span><br><span class="line">var_dump( <span class="string">'Parallel : '</span>.($checkpoint4- $checkpoint3));</span><br></pre></td></tr></table></figure>
<p>在$ analyse_parallel组合中，$ launch_clients函数将并行启动清单5-22中的脚本多次运行。</p>
<p>Listing 5-22. client.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'functions.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get the chunk of text for the client to analyze</span></span><br><span class="line"><span class="comment"># by reading the contents of STDIN which are piped to</span></span><br><span class="line"><span class="comment"># this script by the fwrite($clients[$key]["pipes"][0], $string)</span></span><br><span class="line"><span class="comment"># line in the $launch_clients function in the parent process</span></span><br><span class="line"></span><br><span class="line">$string = stream_get_contents(STDIN);</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compose a function to do the analysis. This is the same</span></span><br><span class="line"><span class="comment"># as the first three steps of the single process analysis</span></span><br><span class="line"><span class="comment"># function, with a step to encode the results as JSON at</span></span><br><span class="line"><span class="comment"># the end so we can safely pass them back</span></span><br><span class="line"></span><br><span class="line">$client_analyze = compose(</span><br><span class="line"></span><br><span class="line">                                        $only_letters_and_spaces,</span><br><span class="line"></span><br><span class="line">                                        <span class="string">'strtolower'</span>,</span><br><span class="line"></span><br><span class="line">                                        $analyze_words,</span><br><span class="line"></span><br><span class="line">                                        <span class="string">'json_encode'</span></span><br><span class="line"></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run the function and write the results to STDOUT,</span></span><br><span class="line"><span class="comment"># which will be read by the stream_get_contents($client["pipes"][1])</span></span><br><span class="line"><span class="comment"># line in the $get_results function in the parent process. In most cases</span></span><br><span class="line"><span class="comment"># you can use echo to write to STDOUT, but sometimes it can be</span></span><br><span class="line"><span class="comment"># redirected, and so explicitly writing like this is better practice</span></span><br><span class="line"></span><br><span class="line">fwrite(STDOUT, $client_analyze($string) );</span><br></pre></td></tr></table></figure>
<p>最后，清单5-23显示了functions.php脚本，该脚本实现了您在先前脚本中组成的所有功能。 我将它们分开，以使脚本更易于阅读，也因为两个脚本都可以访问许多脚本。</p>
<p>Listing 5-23. functions.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Borrow some utility functions from previous examples</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'../Chapter 3/compose.php'</span>);</span><br><span class="line"><span class="keyword">require</span>(<span class="string">'repeat.php'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># To simplify our analysis, replace anything that's not</span></span><br><span class="line"><span class="comment"># a letter with a space.</span></span><br><span class="line"></span><br><span class="line">$only_letters_and_spaces = <span class="function"><span class="keyword">function</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> preg_replace(<span class="string">'/[^A-Za-z]+/'</span>, <span class="string">' '</span>, $string);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># This is the "expensive" deliberately un-optimized function</span></span><br><span class="line"><span class="comment"># that does our "analysis".</span></span><br><span class="line"></span><br><span class="line">$analyze_words = <span class="function"><span class="keyword">function</span> <span class="params">($string)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Split our text into an array, one word per element</span></span><br><span class="line"></span><br><span class="line">    $array = preg_split(<span class="string">'/ /i'</span>, $string, <span class="number">-1</span>, PREG_SPLIT_NO_EMPTY);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Filter our array for words that...</span></span><br><span class="line"></span><br><span class="line">    $filtered = array_filter($array, <span class="function"><span class="keyword">function</span> <span class="params">($word)</span>  </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># ... contain any of the letters from the word shakespeare</span></span><br><span class="line"></span><br><span class="line">                            preg_match(<span class="string">'/[shakespeare]/'</span>, $word) != <span class="keyword">false</span>)</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># ... AND has at least 1 character in common with this sentence</span></span><br><span class="line"></span><br><span class="line">                            &amp;&amp; (similar_text($word, <span class="string">'William is the best bard bar none'</span>) &gt; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># ... AND sound like the word "bard"</span></span><br><span class="line"></span><br><span class="line">                            &amp;&amp; (metaphone($word) == metaphone(<span class="string">'bard'</span>))</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># ... AND have more than three characters in them</span></span><br><span class="line"></span><br><span class="line">                            &amp;&amp; ( (strlen($word) &gt; <span class="number">3</span> )</span><br><span class="line"></span><br><span class="line">                        );</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Finally, count up the number of times each of the filtered</span></span><br><span class="line">    <span class="comment"># words appears in the analyzed text, and return that</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> array_count_values($filtered);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Slice the top 10 items off the top of the array</span></span><br><span class="line"></span><br><span class="line">$top_ten = <span class="function"><span class="keyword">function</span> <span class="params">($array)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> array_slice($array, <span class="number">0</span> ,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sort the results numerically</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># asort mutates the array, so we wrap it in a function</span></span><br><span class="line"></span><br><span class="line">$sort_results = <span class="function"><span class="keyword">function</span><span class="params">($array)</span>  </span>&#123;</span><br><span class="line"></span><br><span class="line">            asort($array, SORT_NUMERIC);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> $array;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># The following functions manage the execution of parallel client scripts</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A function to split the text into chunks and launch the</span></span><br><span class="line"><span class="comment"># appropriate number of clients to process it</span></span><br><span class="line"></span><br><span class="line">$launch_clients = <span class="function"><span class="keyword">function</span> <span class="params">($string)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Split the string into chunks of 1 million characters,</span></span><br><span class="line">        <span class="comment"># a value which I found by trial and error to give the</span></span><br><span class="line">        <span class="comment"># best results on this machine for this process</span></span><br><span class="line"></span><br><span class="line">        $strings = str_split($string, <span class="number">1000000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment"># An array to hold the resource identifiers for the client scripts</span></span><br><span class="line"></span><br><span class="line">        $clients = [];</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Descriptors for "pipes" to read/write the data to/from our client</span></span><br><span class="line">        <span class="comment"># scripts</span></span><br><span class="line"></span><br><span class="line">        $descriptors = [</span><br><span class="line">                                            <span class="number">0</span> =&gt; [<span class="string">"pipe"</span>, <span class="string">"r"</span>], <span class="comment">#STDIN, to get data</span></span><br><span class="line">                                            <span class="number">1</span> =&gt; [<span class="string">"pipe"</span>, <span class="string">"w"</span>]  <span class="comment">#STDOUT, to send data</span></span><br><span class="line">                                    ];</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Iterate through the chunks...</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($strings <span class="keyword">as</span> $key =&gt; $string) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># $key will be the array index, 0, 1, 2, 3... etc.</span></span><br><span class="line">            <span class="comment"># We'll use it as a handy way to number our clients</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Define the command that runs the client</span></span><br><span class="line"></span><br><span class="line">            $command = <span class="string">"php client.php"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Open the clients with proc_open. This returns a resource identifier.</span></span><br><span class="line">            <span class="comment"># We'll store it, although our script won't actually use it.</span></span><br><span class="line"></span><br><span class="line">            $clients[$key][<span class="string">"resource"</span>] = proc_open( $command,</span><br><span class="line">                                                                                            $descriptors,</span><br><span class="line">                                                                                            $clients[$key][<span class="string">"pipes"</span>]</span><br><span class="line">                                                                                        );</span><br><span class="line">            <span class="comment"># Note the third parameter above is a variable passed by reference.</span></span><br><span class="line">            <span class="comment"># This is used by proc_open to store an array of file pointers</span></span><br><span class="line">            <span class="comment"># identifying PHP's end of the pipes that are created.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># We use that info here to write our text chunk to. This writes</span></span><br><span class="line">            <span class="comment"># it to STDOUT, and our client script reads it in through STDIN</span></span><br><span class="line">            <span class="comment"># at its end of the pipe.</span></span><br><span class="line"></span><br><span class="line">            fwrite($clients[$key][<span class="string">"pipes"</span>][<span class="number">0</span>], $string);</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Close the pipe now we're done writing to this client.</span></span><br><span class="line"></span><br><span class="line">        fclose($clients[$key][<span class="string">"pipes"</span>][<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Once all of the clients have been launched, return their</span></span><br><span class="line">        <span class="comment"># resource identifiers and pipe details</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $clients;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Simple impure function to report how many clients were</span></span><br><span class="line"><span class="comment"># launched. You could use a writer monad instead if you wanted</span></span><br><span class="line"></span><br><span class="line">$report_clients = <span class="function"><span class="keyword">function</span> <span class="params">($clients)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># The escape code at the end minimizes our output when</span></span><br><span class="line">    <span class="comment"># when running the script many times, by going up one line</span></span><br><span class="line">    <span class="comment"># and overwriting the output each time.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">"Launched "</span>.sizeof($clients).<span class="string">" clients\n\033[1A"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $clients;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># A function to get the results back from the clients.</span></span><br><span class="line"><span class="comment"># The clients will send a JSON encoded array back to us</span></span><br><span class="line"></span><br><span class="line">$get_results = <span class="function"><span class="keyword">function</span> <span class="params">($clients)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># An array to gather the results. Each clients' result</span></span><br><span class="line">    <span class="comment"># will be stored as an element of the array</span></span><br><span class="line"></span><br><span class="line">    $results = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Iterate through the client resource identifiers</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($clients <span class="keyword">as</span> $key =&gt; $client) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Clients write output to STDOUT, which corresponds to the</span></span><br><span class="line">                <span class="comment"># STDIN Pipe at our end. We'll read that JSON data and</span></span><br><span class="line">                <span class="comment"># decode it to a PHP array. Each client's results will be</span></span><br><span class="line">                <span class="comment"># stored as a separate element of the $results array.</span></span><br><span class="line"></span><br><span class="line">                $results[] = json_decode(</span><br><span class="line"></span><br><span class="line">                                                                stream_get_contents($client[<span class="string">"pipes"</span>][<span class="number">1</span>]),</span><br><span class="line"></span><br><span class="line">                                                                <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment"># We've done reading from the client, so we can close the pipe.</span></span><br><span class="line"></span><br><span class="line">                fclose($clients[$key][<span class="string">"pipes"</span>][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># And finally return all of the results from all of the clients</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> $results;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># This function takes the results array from $get_results above and</span></span><br><span class="line"><span class="comment"># combines it into a single array</span></span><br><span class="line"></span><br><span class="line">$combine_results = <span class="function"><span class="keyword">function</span> <span class="params">($results)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Reduce and return the input array by...</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> array_reduce($results, <span class="function"><span class="keyword">function</span><span class="params">($output, $array)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#... iterating over each individual clients results array</span></span><br><span class="line">        <span class="comment"># and either creating or adding the count for each word to</span></span><br><span class="line">        <span class="comment"># the output depending on whether that word already exists in</span></span><br><span class="line">        <span class="comment"># the output</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($array <span class="keyword">as</span> $word =&gt; $count) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">isset</span>($output[$word]) ?</span><br><span class="line">                                                $output[$word] += $count  :</span><br><span class="line">                                                $output[$word] = $count ;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># return $output through to the next iteration of array_reduce</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $output;</span><br><span class="line"></span><br><span class="line">    &#125;, []); <span class="comment"># starting with a blank array [] as output</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>让我们运行parallel.php看看会发生什么（参见清单5-24）。</p>
<p>Listing 5-24. parallel-output.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [beard]  =&gt; 76</span><br><span class="line">    [bright] =&gt; 43</span><br><span class="line">    [buried] =&gt; 43</span><br><span class="line">    [bred]   =&gt; 36</span><br><span class="line">    [breed]  =&gt; 35</span><br><span class="line">    [bird]   =&gt; 34</span><br><span class="line">    [bride]  =&gt; 30</span><br><span class="line">    [broad]  =&gt; 15</span><br><span class="line">    [bread]  =&gt; 15</span><br><span class="line">    [board]  =&gt; 15</span><br><span class="line">)</span><br><span class="line">Launched 4 clients</span><br><span class="line">AArray</span><br><span class="line">(</span><br><span class="line">    [beard]  =&gt; 76</span><br><span class="line">    [bright] =&gt; 43</span><br><span class="line">    [buried] =&gt; 43</span><br><span class="line">    [bred]   =&gt; 36</span><br><span class="line">    [breed]  =&gt; 35</span><br><span class="line">    [bird]   =&gt; 34</span><br><span class="line">    [bride]  =&gt; 30</span><br><span class="line">    [broad]  =&gt; 15</span><br><span class="line">    [bread]  =&gt; 15</span><br><span class="line">    [board]  =&gt; 15</span><br><span class="line">)</span><br><span class="line">string(24) &quot;Single : 48.808692932129&quot;</span><br><span class="line">string(25) &quot;Parallel : 25.10250711441&quot;</span><br></pre></td></tr></table></figure>
<p>如您所见，从单个流程版本和并行流程版本的分析中都可以得到相同的结果，但是并行版本大约需要执行一半的时间。 如您所做的那样，将文本分块可以并行地给您提供四个客户端流程来分析所有文本。 考虑到两个版本的函数使用的是完全相同的昂贵函数（$ analyze_words），您可能想知道为什么有四个客户端在四分之一的时间内都没有完成。 原因是要并行运行需要大量的设置，包括以下内容：<br>•将文本分成大块<br>•启动新的PHP流程<br>•写入和读取过程管道<br>•最后将结果组合在一起<br>因此，如果您想进一步加快速度，难道您不能简单地同时增加更多的客户吗？ 让我们尝试一下，将文本分成100,000个字符的块，这需要38个客户端来并行计算（请参见清单5-25）。</p>
<p>Listing 5-25. parallel-output2.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [beard]  =&gt; 76</span><br><span class="line">    [bright] =&gt; 43</span><br><span class="line">    [buried] =&gt; 43</span><br><span class="line">    [bred]   =&gt; 36</span><br><span class="line">    [breed]  =&gt; 35</span><br><span class="line">    [bird]   =&gt; 34</span><br><span class="line">    [bride]  =&gt; 30</span><br><span class="line">    [broad]  =&gt; 15</span><br><span class="line">    [bread]  =&gt; 15</span><br><span class="line">    [board]  =&gt; 15</span><br><span class="line">)</span><br><span class="line">Launched 38 clients</span><br><span class="line">Array</span><br><span class="line">(</span><br><span class="line">    [beard]  =&gt; 76</span><br><span class="line">    [bright] =&gt; 43</span><br><span class="line">    [buried] =&gt; 43</span><br><span class="line">    [bred]   =&gt; 36</span><br><span class="line">    [breed]  =&gt; 35</span><br><span class="line">    [bird]   =&gt; 34</span><br><span class="line">    [bride]  =&gt; 30</span><br><span class="line">    [broad]  =&gt; 15</span><br><span class="line">    [bread]  =&gt; 15</span><br><span class="line">    [board]  =&gt; 15</span><br><span class="line">)</span><br><span class="line">string(24) &quot;Single : 49.230798959732&quot;</span><br><span class="line">string(26) &quot;Parallel : 145.74519586563&quot;</span><br></pre></td></tr></table></figure>
<p>在这种情况下，您的速度从原来的两倍提高到了将近三倍！这再次是因为协调所有客户端并将结果汇​​总在一起的开销。因此，使用这种技术，并行处理的数量通常会达到最佳效果。这在很大程度上取决于手头的任务，对于具有以下特征的功能，您可能会获得更好的结果：<br>•不需要大量后处理的功能（例如，来自不同客户的结果的顺序或内容无关紧要）<br>•设置便宜的功能（例如，最少的处理以拆分输入数据，最少的数据传输到客户端）<br>•运行时间更长的功能（与函数执行时间相比，时间开销最小）<br>如您所见，没有很多额外的代码来管理并行化，就不会提高速度。在进入并行化代码阶段之前，您可以做很多事情<br>加快执行速度，包括以下步骤：<br>•使用懒惰求值，首先对单词进行计数和排序（便宜的操作）<br>然后将分析作为生成器功能的一部分<br>•重新排列array_filter中的操作以利用PHP的延迟评估，在调用更昂贵的preg_match之前，先使用strlen等廉价函数对数据进行缩减<br>•预先计算metaphone（’bard’）并存储在变量中，而不是每次都计算<br>•用便宜的strpbrk PHP函数替换preg_match如果这不足以使您达到性能目标，并且需要并行运行，则可以做一些其他事情来加快并行版本的速度（我还没有这样做）为了使代码简单和<br>节省书中的空间）。<br>•仅在每个脚本中包括所需的功能，也许使用构建步骤来内联它们。<br>•直接在共享内存中传递数据，而不是通过管道传递数据，这样可以更快。<br>•不要等待每个客户端发送数据之后再继续从下一个客户端读取数据，以无阻塞的方式反复遍历它们，直到每个客户端都准备好数据为止。</p>
<p>使用并行脚本很难进行惰性求值，因为每个脚本都以适合其本地输入的顺序返回数据，而不一定代表整个数据。例如，使用此脚本，每个客户都可以计算自己的最佳结果，但是您不能只接受您收到的前十个结果，因为它们可能不是莎士比亚作品中前十个，而仅仅是那些经过分析并先返回。如您所见，并行化工作需要一些思考，即使函数式编程通过消除考虑副作用的额外负担来帮助您。<br>还请考虑一下，如果您的一个客户未能完成或挂起，我什至没有涉及该怎么办，您将了解为什么只有在真正必要时才考虑使用此类技术。</p>
<h1 id="多线程编程"><a href="#多线程编程" class="headerlink" title="多线程编程"></a>多线程编程</h1><p>多线程编程的工作方式与您在上一节中介绍的多进程示例类似。关键区别在于并行执行发生在同一流程而不是单独的流程中。 PHP不是多线程的；但是，使用Pthreads扩展可以实现多线程。 Pthreads是基于OOP的可靠实现，其性能可以明显优于多进程脚本。但是，由于线程在同一进程中共存，因此实​​现起来比多进程代码更复杂。另外，请注意，Pthreads扩展只能与PHP的“线程安全”版本一起使用，该版本与许多PHP扩展都不兼容。 Linux上的大多数程序包管理器都不包含线程安全版本，因此将要求您手动编译PHP（如果需要自己编译PHP的信息，请参阅附录A），或者对于Windows，则需要下载线程安全的可执行文件。从PHP网站。<br>尽管如此，采用前面所示的函数式编程原理仍可以帮助您绕过多线程编程常见的一些问题领域。可以在Pthreads网站上找到有关扩展的更多信息和使用示例。</p>
<h1 id="标准PHP库（SPL）"><a href="#标准PHP库（SPL）" class="headerlink" title="标准PHP库（SPL）"></a>标准PHP库（SPL）</h1><p>在本章的开头，我讨论了一个事实，即PHP存在一些明显的性能问题，这是因为为用户提供易于使用和通用的数据结构和功能所需的开销。如果您发现这种开销开始限制脚本，则可以调用的标准端口库是标准PHP库（SPL），它是包含通用和深奥的数据结构和功能的核心PHP扩展。<br>它们旨在解决常见的编程问题，尽管与PHP较常见的结构（如普通的PHP数组类型）相比，需要使用更多的思想。没有什么是独家的<br>SPL中的函数式编程，但是您可以在本书中介绍的函数式技术中使用一些有用的函数和结构。<br>因此，例如，如果您发现传递大量数据导致脚本达到内存限制，则可能需要查看SplFixedArray类。它有一些限制（您只能使用整数作为索引，并且必须预先指定数组的长度），但是提供了比普通数组使用更少内存的更快实现。如果您不熟悉SPL中的某些数据结构（例如堆，链接列表等），那么计算机科学的大多数基本介绍（或使用更传统的语言进行编程）都可以为您提供帮助。 SPL还包含用于常见的基于迭代器的任务的函数和类，您可以将它们与之前查看的生成器一起使用。</p>
<p>清单5-26中的示例脚本向您介绍了iterator_to_array函数，SplFixedArray结构和FilterIterator类。</p>
<p>Listing 5-26. spl.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Borrow our simple generator example</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gen_range</span><span class="params">($start, $end, $step)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ($i = $start; $i &lt;= $end; $i += $step) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">yield</span> $i;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Call the generator...</span></span><br><span class="line"></span><br><span class="line">$gen_obj = gen_range(<span class="number">1</span>,<span class="number">10</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># ... and check what we have is a generator object</span></span><br><span class="line">print_r($gen_obj);</span><br><span class="line"></span><br><span class="line"><span class="comment"># Generators are iterators, so when we need a full array</span></span><br><span class="line"><span class="comment"># of data instead of a generator, we can convert</span></span><br><span class="line"><span class="comment"># it to an array using SPL's iterator_to_array function</span></span><br><span class="line"></span><br><span class="line">$array = iterator_to_array($gen_obj);</span><br><span class="line"></span><br><span class="line">print_r($array);</span><br><span class="line"></span><br><span class="line"><span class="comment"># An SplFixedArray is SPLs fixed size array data structure.</span></span><br><span class="line"><span class="comment"># Let's create an empty SPL fixed array and a standard PHP array.</span></span><br><span class="line"><span class="comment"># Note we need to specify a size for the SPL array</span></span><br><span class="line"></span><br><span class="line">$spl_array = <span class="keyword">new</span> SplFixedArray(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">$std_array = [];</span><br><span class="line"></span><br><span class="line"><span class="comment"># Let's create a function to fill an array with data. As both</span></span><br><span class="line"><span class="comment"># array types can be written to in the same way, we can</span></span><br><span class="line"><span class="comment"># use the same function here for both</span></span><br><span class="line"></span><br><span class="line">$fill_array = <span class="function"><span class="keyword">function</span><span class="params">($array, $i = <span class="number">0</span>)</span> <span class="title">use</span> <span class="params">(&amp;$fill_array)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># recursively fill the $array with data</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($i &lt; <span class="number">10000</span>) &#123;</span><br><span class="line"></span><br><span class="line">        $array[$i] = $i * <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $fill_array($array, ++$i);</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ($array);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Let's do some operations with the arrays. We'll measure</span></span><br><span class="line"><span class="comment"># the memory in use before and after each operation.</span></span><br><span class="line"></span><br><span class="line">$mem1 = memory_get_usage();</span><br><span class="line"></span><br><span class="line"><span class="comment"># Fill the standard array with data</span></span><br><span class="line"></span><br><span class="line">$std_array = $fill_array($std_array);</span><br><span class="line"></span><br><span class="line">$mem2 = memory_get_usage(); <span class="comment"># 528384 bytes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Fill the SPL array with data</span></span><br><span class="line"></span><br><span class="line">$spl_array = $fill_array($spl_array);</span><br><span class="line"></span><br><span class="line">$mem3 = memory_get_usage(); <span class="comment"># 0 bytes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># It took no memory to fill!</span></span><br><span class="line"><span class="comment"># This is because this type of array allocates all of its memory</span></span><br><span class="line"><span class="comment"># up-front when you create it</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a new SPL array and fill with data</span></span><br><span class="line"></span><br><span class="line">$spl_array2 = <span class="keyword">new</span> SplFixedArray(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">$spl_array2 = $fill_array($spl_array2);</span><br><span class="line"></span><br><span class="line">$mem4 = memory_get_usage(); <span class="comment"># 163968 bytes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This time it did, as we declared it within the section we</span></span><br><span class="line"><span class="comment"># were measuring</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a new empty standard array</span></span><br><span class="line"></span><br><span class="line">$std_array2 = [];</span><br><span class="line"></span><br><span class="line">$mem5 = memory_get_usage(); <span class="comment"># 56 bytes - a small amount</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a new empty SPL array</span></span><br><span class="line"></span><br><span class="line">$spl_array3 = <span class="keyword">new</span> SplFixedArray(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">$mem6 = memory_get_usage(); <span class="comment"># 163968 bytes - for an empty array!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This shows that you need to use it with care. A Standard</span></span><br><span class="line"><span class="comment"># array may use more memory for the same amount of data, but</span></span><br><span class="line"><span class="comment"># the memory also shrinks with the array contents too.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Filled Standard Array : "</span>.($mem2 - $mem1). <span class="string">" bytes \n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"1st Filled SPLFixedArray : "</span>.($mem3 - $mem2). <span class="string">" bytes \n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"2nd Filled SPLFixedArray : "</span>.($mem4 - $mem3). <span class="string">" bytes \n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Empty Standard Array : "</span>.($mem5 - $mem4). <span class="string">" bytes \n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Empty SPLFixedArray : "</span>.($mem6 - $mem5). <span class="string">" bytes \n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># The SPL provides various iterator classes that you can extend</span></span><br><span class="line"><span class="comment"># to work with iterable structures like the SPLFixedArray and</span></span><br><span class="line"><span class="comment"># generators</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Let's create a class to filter for values that are divisible by three</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">by_three</span> <span class="keyword">extends</span> <span class="title">FilterIterator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># We extend the FilterIterator class, and implement the accept() class</span></span><br><span class="line">    <span class="comment"># with our filtering function</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">accept</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line"></span><br><span class="line">    $value = <span class="keyword">$this</span>-&gt;current();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($value % <span class="number">3</span> == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># return true to include the value in the output</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment"># or false to filter it out</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Let's use it to filter our previous SPL array</span></span><br><span class="line"></span><br><span class="line">$nums = <span class="keyword">new</span> by_three($spl_array);</span><br><span class="line"></span><br><span class="line">var_dump(iterator_count($nums)); <span class="comment"># int(3334) (~third of the array is returned)</span></span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>在本章中，您研究了性能改进领域中函数编程的一些常见应用程序。 即使您不会全力以赴地用功能代码编写应用程序，也可以挑选出导致瓶颈的关键功能，并牢记功能原理进行重写，这可以使您将这些提高性能的技术应用于代码的这些部分。 当然，如果您确实以一种功能样式从头开始编写应用程序，那么在发现问题功能时应用备忘等技术便可以快速简便地完成。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/PHP语法/" rel="tag"># PHP语法</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/03/31/在面向对象和面向过程中使用函数式编程/" rel="next" title="在面向对象和面向过程中使用函数式编程">
                <i class="fa fa-chevron-left"></i> 在面向对象和面向过程中使用函数式编程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/04/02/PHP实现反转链表/" rel="prev" title="PHP实现反转链表">
                PHP实现反转链表 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="CheBin">
            
              <p class="site-author-name" itemprop="name">CheBin</p>
              <div class="site-description motion-element" itemprop="description">放弃会成为一种习惯</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">184</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          


          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/2021/01/25/API在云计算中的作用/" title="API在云计算中的作用" target="_blank">API在云计算中的作用</a>
                  </li>
                
                  <li>
                    <a href="/2021/01/25/gRPC入门/" title="gRPC入门" target="_blank">gRPC入门</a>
                  </li>
                
                  <li>
                    <a href="/2021/01/24/第2章-基本知识/" title="第2章 基本知识" target="_blank">第2章 基本知识</a>
                  </li>
                
                  <li>
                    <a href="/2021/01/07/markdown1/" title="markdown1" target="_blank">markdown1</a>
                  </li>
                
                  <li>
                    <a href="/2020/12/08/既然有HTTP请求，为什么还要用RPC调用？/第3章 Python的图表绘制 _ 车斌的技术博客_files/next-boot/" title target="_blank"></a>
                  </li>
                
              </ul>
            </div>
        

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#记忆化"><span class="nav-number">1.</span> <span class="nav-text">记忆化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#记忆化的缺点"><span class="nav-number">2.</span> <span class="nav-text">记忆化的缺点</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#懒惰评估"><span class="nav-number">3.</span> <span class="nav-text">懒惰评估</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#迭代器"><span class="nav-number">4.</span> <span class="nav-text">迭代器</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#懒惰评估的缺点"><span class="nav-number">5.</span> <span class="nav-text">懒惰评估的缺点</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#并行编程"><span class="nav-number">6.</span> <span class="nav-text">并行编程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#多线程编程"><span class="nav-number">7.</span> <span class="nav-text">多线程编程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#标准PHP库（SPL）"><span class="nav-number">8.</span> <span class="nav-text">标准PHP库（SPL）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">9.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CheBin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">2m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">30:26</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
