<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">
<meta name="keywords" content="Kubernetes in Action">
<meta property="og:type" content="article">
<meta property="og:title" content="13-保障集群内节点和网络安全">
<meta property="og:url" content="http://yoursite.com/2022/10/01/13-保障集群内节点和网络安全/index.html">
<meta property="og:site_name" content="车斌的技术博客">
<meta property="og:description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2022-10-04T02:25:52.521Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="13-保障集群内节点和网络安全">
<meta name="twitter:description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">






  <link rel="canonical" href="http://yoursite.com/2022/10/01/13-保障集群内节点和网络安全/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>13-保障集群内节点和网络安全 | 车斌的技术博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">放弃会成为一种习惯</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/10/01/13-保障集群内节点和网络安全/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CheBin">
      <meta itemprop="description" content="看视频才能学会，看文字学不会的">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">13-保障集群内节点和网络安全

              
            
          </h1>
        

        <div class="post-meta">

          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2022-10-01 10:11:14" itemprop="dateCreated datePublished" datetime="2022-10-01T10:11:14+08:00">2022-10-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2022-10-04 10:25:52" itemprop="dateModified" datetime="2022-10-04T10:25:52+08:00">2022-10-04</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">22k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">20 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考并回答以下问题：</p>
<ul>
<li>总结一下，这章作者最主要想表达什么观点？</li>
</ul>
<a id="more"></a>
<p>本章内容涵盖<br>■在pod中使用宿主节点的默认Linux命名空间<br>■以不同用户身份运行容器<br>■运行特权容器<br>添加或禁用容器的内核功能<br>■定义限制 pod行为的安全策略<br>1保障pod的网络安全<br>在第12章中，我们谈到了如何保障API服务器的安全。如果攻击者获得了访问API服务器的权限，他们可以通过在容器镜像中打包自己的代码并在pod中运行来做任何事。但是这样做真的能够造成损害吗？容器不是与同一宿主节点上的其他容器隔离开来的吗？<br>并不一定。本章将会介绍如何允许pod访问所在宿主节点的资源。本章还会介绍如何配置集群，使得用户不能通过pod在集群中为所欲为。本章的最后将会介绍如何保障pod间通信的网络的安全。<br>13.1在pod中使 用宿主节点的Linux命名空间<br>pod中的容器通常在分开的Linux命名空间中运行。这些命名空间将容器中的</p>
<p>进程与其他容器中，或者宿主机默认命名空间中的进程隔离开来。<br>例如，每一个pod有自己的IP和端口空间，这是因为它拥有自己的网络命名空间。类似地，每一个pod拥有自己的进程树，因为它有自己的PID命名空间。同样地，pod 拥有自己的IPC命名空间，仅允许同一pod内的进程通过进程间通信（ InterProcess Communication，简称IPC）机制进行交流。<br>13.1.1 在pod中使用宿主节点的网络命名空间<br>部分pod （特别是系统pod）需要在宿主节点的默认命名空间中运行，以允许它们看到和操作节点级别的资源和设备。例如，某个pod可能需要使用宿主节点上的网络适配器，而不是自己的虚拟网络设备。这可以通过将pod spec中的hostNetwork设置为true实现。<br>如图13.1所示，在这种情况下，这个pod可以使用宿主节点的网络接口，而不是拥有自己独立的网络。这意味着这个pod没有自己的IP地址；如果这个pod中的某一进程绑定了某个端口，那么该进程将被绑定到宿主节点的端口上。</p>
<p>图13.1一个配置了 hostNetwork：true 的 pod 使用宿主节点的网络接口， 而不是它自己的<br>可以尝试运行一个这样的 pod。 以下的代码清单展示了此种 pod 的一个例子。代码清单 13.1一个使用宿主节点默认的网络命名空间的 pod：pod-with-host： network.yaml</p>
<p>在运行了这个 pod 之后，可以用如 下的命令来验证它确实使用了宿主节点的网络命名空间（例如，它可以看到宿主节点 上所有的网络接口）。<br>代码清单 13.2<br>使用宿主机网络命名空间的 pod 网络</p>
<p>Kubernetes 控制平面组件通过pod 部署时（例如， 像附录B中那样使用kubeadm 部署 Kubernetes 集群）， 这些 pod 都会使用 hostNetwork 选项， 让它们的行为与不在 pod 中运行时相同。<br>13.1.2 绑定宿主节点上的端口而不使用宿主节点的网络命名空间<br>一个与此有关的功能可以让 pod 在拥有自己的网络命名空间的同时，将端口绑 定到宿主节点的端口上。这可以通过配置 pod的 spec.containers.ports字段 中某个容器某一端口的 hostPort 属性来实现。<br>不要混淆使用 hostPort 的 pod 和通过 NodePort 服务暴露的 pod。如图 13.2所示，它们是不同的。<br>在图中首先注意到的是，对于一个使用 hostPort 的 pod，到达宿主节点的端 口的连接会被直接转发到 pod 的对应端口上； 然而在 NodePort 服务中，到达宿主 节点的端口的连接将被转发到随机选取的 pod. 上（这个 pod 可能在其他节点上）。另 外一个区别是，对于使用 hostPort 的 pod，仅有运行了这类 pod 的节点会绑定对 </p>
<p>应的端口；而 NodePort类型的服务会在所有的节点上绑定端口， 即使这个节点上没有运行对应的 pod（如图中所示的节点 3）。 </p>
<p>图13.2 使用 hostPort 的 pod 和通过 NodePort服务暴露的 pod 的区别<br>很重要的一点是，如果一个 pod 绑定了宿主节点上的一个特定端口， 每个宿主节点只能调度一个这样的 pod 实例， 因为两个进程不能绑定宿主机上的同一个端口。调度器在调度 pod 时会考虑这一点， 所以它不会把两个这样的 pod 调度到同一个节点上，如图 13.3 所示。如果要在3个节点上部署4个这样的 pod 副本， 只有3个副本能够成功部署（剩余1个 pod 保持 Pending 状态）。 </p>
<p>图13.3如果使用了 hostport， 一个宿主节点只能调度一个副本<br>13.1在pod中使用宿主节点的Linux命名空间<br>e<br>如何在pod的YAML定义文件中定义 hostPort 选项。以下代码清单展示了 一个运行 kubia pod， 并将该 pod 绑定到宿主机的9000端口的 YAML 描述文件。<br>代码清单 13.3将pod 中的一个端口绑定到宿主节点默认网络命名空间的端 口：kubia-hostport.yaml</p>
<p>创建这个pod之后，可以通过它所在节点的9000端口访问这个pod。有多个宿主节点时，并不能通过其他宿主节点的同一端口访问该pod。<br>注意在GKE中运行时，需要按照第5章描述的方法，正确使用gcloudcompute firewall-rules配置防火墙。<br>hostPort功能最初是用于暴露通过DeamonSet部署在每个节点上的系统服务的。最初，这个功能也用于保证一个pod的两个副本不被调度到同一节点上，但是现在有更好的方法来实现这一需求。这种方法将在第16章中介绍。<br>13.1.3 使用宿主节点的PID与IPC命名空间<br>pod spec中的hostPID和hostIPC选项与hostNetwork相似。当它们被设置为true时，pod中的容器会使用宿主节点的PID和IPC命名空间，分别允许它们看到宿主机上的全部进程，或通过IPC机制与它们通信。以下代码清单是一个使用hostPID和hostIPC的pod的例子。<br>代码清单13.4使用宿主节点的PID和IPC命名空间：pod-with-host-pid-and-ipc.yaml</p>
<p>pod中通常只能看到自己内部的进程，但在这个pod的容器中列出进程，可以看到宿主机上的所有进程，而不仅仅是容器内的进程，就如同以下的代码清单所示。<br>代码清单13.5配置hostPID：true的pod内可见的进程列表</p>
<p>将hostIPC设置为true，pod中的进程就可以通过进程间通信机制与宿主机上的其他所有进程进行通信。<br>13.2 配置节点的安全上下文<br>除了让pod使用宿主节点的Linux命名空间，还可以在pod或其所属容器的描述中通过security-Context选项配置其他与安全性相关的特性。这个选项可以运用于整个pod，或者每个pod中单独的容器。<br>了解安全上下文中可以配置的内容<br>配置安全上下文可以允许你做很多事：<br>·指定容器中运行进程的用户（用户ID）。<br>阻止容器使用root用户运行（容器的默认运行用户通常在其镜像中指定，所以可能需要阻止容器以root用户运行）。<br>·使用特权模式运行容器，使其对宿主节点的内核具有完全的访问权限。 ·与以上相反，通过添加或禁用内核功能，配置细粒度的内核访问权限。<br>设置SELinux（Security EnhacedLinux，安全增强型Linux）选项，加强对容器的限制。</p>
<p>阻止进程写入容器的根文件系统。<br>以下内容将开始探索这些选项的细节。<br>运行 pod 而不配置安全上下文<br>首先，运行一个没有任何安全上下文配置的 pod（不指定任何安全上下文选项）， 与配置了安全上下文的 pod 形成对照：<br>$ kubectl run pod-with-defaults —image alpine —restart Never<br>mh - /bin/sleep 999999<br>pod “pod-with-defaults” created<br>来看一看这个容器中的用户ID 和组 ID， 以及它所属的用户组。这可以通过在 容器中运行id 命令查看。<br>$ kubectl exec pod-with-defaults id<br>uid=0(root) gid=0(root) groups=0(root), 1(bin), 2(daemon), 3(sys), 4(adm), 6(disk), 10(wheel), 11(floppy), 20(dialout), 26(tape), 27(video)<br>这个容器在用户ID（uid）为0的用户， 即 root，用户组ID（gid）为0（同 样是 root）的用户组下运行。 它同样还属于一些其他的用户组。<br>注意 容器运行时使用的用户在镜像中指定。 在 Dockerfile 中，这是通过使用USER命令实现的。如果该命令被省略， 容器将使用 root 用户运行。<br>现在来运行一个使用特定用户运行容器的 pod。<br>13.2.1 使用指定用户运行容器<br>为了使用一个与镜像中不同的用户ID 来运行 pod，需要设置该 pod 的  securityContext.runAsUser 选项。 可以通过以下代码清单来运行一个使用  guest 用户运行的容器，该用户在 alpine 镜像中的用户ID为405。<br>代码清单13.6使用特定用户运行容器： pod-as-user-guest.yaml </p>
<p>现在可以像之前一样在 pod 中运行 id 命令，查看 runAsUser 选项的效果： $ kubectl exec pod-as-user-guest id<br>uid=405(guest) gid=100(users)<br>与要求的一样，该容器在 guest 用户下运行。<br>13.2.2 阻止容器以 root 用户运行<br>如果你不关心容器是哪个用户运行的， 只是希望阻止以 root 用户运行呢？<br>假设有一个已经部署好的 pod， 它使用一个在 Dockerfile 中使用 USER daemon命令制作的镜像， 使其在 daemon 用户下运行。 如果攻击者获取了访问镜像仓库的权限，并上传了一个标签完全相同， 在 root 用户下运行的镜像，会发生什么？ 当Kubernetes 的调度器运行该 pod 的新实例时， kubelet 会下载攻击者的镜像， 并运行该镜像中的任何代码。<br>虽然容器与宿主节点基本上是隔离的， 使用 root 用户运行容器中的进程仍然是 一种不好的实践。例如，当宿主节点上的一个目录被挂载到容器中时， 如果这个容器中的进程使用了 root 用户运行， 它就拥有该目录的完整访问权限； 如果用非 root用户运行，则没有完整权限。<br>为了防止以上的攻击场景发生， 可以进行配置， 使得 pod 中的容器以非 root 用户运行，如以下的代码清单所示。<br>代码清单 13.7 阻止容器使用 root 用户运行：pod-run-as-non-root.yaml </p>
<p>部署这个 pod 之后，它会被成功调度， 但是不允许运行：<br>$ kubectl get po pod-run-as-non-root<br>NAME<br>READY STATUS<br>pod-run-as-non-root 0/1 container has runAsNonRoot and image will run<br>as root<br>现在，即使攻击者篡改了镜像， 他们也无法做出进一步的破坏。 </p>
<p>13.2.3 使用特权模式运行pod<br>有时pod需要做它们的宿主节点.上能够做的任何事，例如操作被保护的系统设备，或使用其他在通常容器中不能使用的内核功能。<br>这种pod的一个样例就是kube-proxy pod，该pod需要像第11章中描述的那样，修改宿主机的iptables规则来让Kubernetes中的服务规则生效。当按照附录B，使用kubeadm部署集群时，你会看到每个节点上都运行了kube-proxypod，并且可以查看YAML描述文件中所有使用到的特殊特性。<br>为获取宿主机内核的完整权限，该pod需要在特权模式下运行。这可以通过将容器的securityContext中的privileged设置为true实现。可以通过以下代码清单中的YAML文件创建一个特权模式的pod.<br>代码清单13.8个 带有特权容器的pod ： pod-privileged.yaml</p>
<p>部署这个pod，然后与之前部署的非特权模式的pod做对比。<br>熟悉Linux的读者会知道Linux中有一个叫作/dev的特殊目录，该目录包含系统中所有设备对应的设备文件。这些文件不是磁盘、上的常规文件，而是用于与设备通信的特殊文件。通过列出/dev目录下文件的方式查看先前部署的非特权模式容器（名为pod-with-defaults的pod）中的设备，如以下代码清单所示。<br>代码清单13.9非特权 pod可用的设备列表</p>
<p>这个相当短的列表已经列出了全部的设备，将这个列表与下面的列表比较。下面的列表列出了在特权pod中能看到的特权设备。<br>390<br>13 保障集群内节点和网络安全<br>代码清单13.10特权pod可用的设备列表</p>
<p>由于完整的设备列表过长，以上没有完整列出所有的设备，但这已经足以证明这个设备列表远远长于之前的列表。事实上，特权模式的pod可以看到宿主节点上的所有设备。这意味着它可以自由使用任何设备。<br>举个例子，如果要在树莓派上运行一个pod，用这个pod来控制相连的LED，那么必须使用特权模式运行这个pod.<br>13.2.4”为容器单独添加内核功能<br>上一节中已经介绍了-种给予容器无限力量的方法。过去，传统的UNIX实现只区分特权和非特权进程，但是经过多年的发展，Linux 已经可以通过内核功能支持更细粒度的权限系统。<br>相比于让容器运行在特权模式下以给予其无限的权限，-个更加安全的做法是只给予它使用真正需要的内核功能的权限。Kubermetes允许为特定的容器添加内核功能，或禁用部分内核功能，以允许对容器进行更加精细的权限控制，限制攻击者潜在侵入的影响。<br>例如，一个容器通常不允许修改系统时间（硬件时钟的时间）。可以通过在pod-with-defaults pod中修改设定时间来验证：<br>kubectl exec -it pod-with-defaults — date +%T -8 “12:00: 00■<br>date: can’t set date: Operation not permi tted<br>如果需要允许容器修改系统时间，可以在容器的capbilities里add一项名为CAP_ sYS_ TIME 的功能，如以下代码清单所示。</p>
<p>注意 Linux 内核功能的名称通常以 CAP_ 开头。但在 pod spec 中指定内核功  能时，必须省略 CAP_前缀。<br>在新的容器中运行同样的命令， 可以成功修改系统时间：<br>$ kubectl exec -it pod-add-settime-capability — date +%T -s “12:00:00”<br>12:00:00<br>$ kubectl exec -it pod-add-settime-capability — date<br>Sun May 7 12:00:03 UTC 2017<br>警告自行尝试时， 请注意这样可能导致节点不可用。 在 Minikube 中，尽管系统时间成功被网络时间协议（Network Time Protocol，NTP）重置， 仍然不得不重启节点以调度新的pod。<br>可以通过在运行该 pod 的节点上查看时间来确认系统时间已经被成功修改。笔者使用的是 Minikube，仅有一个节点， 可以通过如下命令查看时间：<br>$ minikube ssh date<br>Sun May 7 12:00:07 UTC 2017<br>添加内核功能远比通过设置 privileged：true更好， 诚然这样需要使用者了解各种内核功能。<br>提示可以在Linux 手册中查阅 Linux 内核功能列表。<br>13.2.5 在容器中禁用内核功能<br>你已经了解到如何给容器添加内核功能， 另一方面你也可以禁用容器中的内核 功能。例如，默认情况下容器拥有 CAP CHOWN 权限，允许进程修改文件系统中文 </p>
<p>件的所有者。<br>在以下示例中可以看到，可以在pod-with-defaults中将/tmp目录的所有者改为guest用户：<br>$ kubectl exec pod-wi th-defaults chown guest / tmp<br>$ kubectl exec pod-wi th-defaults — 1s -la /| grep tmp<br>arwxrwxrwt 2 guest root<br>5 May 25 15:18 tmp<br>为了阻止容器的此种行为，需要如以下代码清单所示，在容器的securi tyContext . capabilities. drop列表中加入此项，以禁用这个修改文件所有者的内核功能。<br>代码清单13.12禁用容 器中的内核功能： pod-drop-chown-capabilityaml</p>
<p>禁用 CHOWN 内核功能后，不允许在这个 pod 中修改文件所有者：<br>$ kubectl exec pod-drop-chown-capability chown guest /tmp<br>chown: /tmp: Operation not permitted<br>这里已经对容器安全上下文的大部分选项研究完毕。 下面再介绍一个选项。<br>13.2.6 阻止对容器根文件系统的写入<br>因为安全原因，你可能需要阻 止容器中的进程对容器的根文件系统进行写入，仅允许它们写入挂载的存储卷。<br>假如你在运行一个有隐藏漏洞， 可以允许攻击者写入文件系统的 PHP 应用。这些 PHP 文件在构建时放入容器的镜像中， 并且在容器的根文件系统中提供服务。由 于漏洞的存在， 攻击者可以修改这些文件， 在其中注入恶意代码。<br>这一类攻击可以通过阻止容器写入自 己的根文件系统 （应用的可执行代码的通常储存位置）来防止。 可以如以下代码清单所示，将容器的 securityContext.read0nlyRootFilesystem 设置为 true 来实现。 </p>
<p>这个pod中的容器虽然以root用户运行，拥有/目录的写权限，但在该目录下写入一个文件会失败：<br>$ kubectl exec -it pod-wi th- readonly- filesystem touch /new- file<br>touch: /new-file: Read-only file system<br>另一方面，对挂载的卷的写入是允许的：<br>$ kubectl exec -it pod-wi th- readonly- filesystem touch /volume/newfile<br>kubectl exec -it pod -wi th- readonly- filesystem — ls -la /volume/newfile<br>-rw-r—r— 1 root<br>root<br>D May 7 19:11 / mountedvolume/newfile<br>如以上例子所示，如果容器的根文件系统是只读的，你很可能需要为应用会写入的每一个目录（如日志、磁盘缓存等）挂载存储卷。<br>提示为了增强安全性，请将在生产环境运行的容器的readOnlyRootFilesystem选项设置为true。<br>设置pod级别的安全，上下文<br>以上的例子都是对单独的容器设置安全上下文。这些选项中的一部分也可以从pod级别设定（通过pod. spec. securityContext属性）。它们会作为pod中每一个容器的默认安全上下文，但是会被容器级别的安全上下文覆盖。下面将会介绍pod级别安全上下文独有的内容。</p>
<p>13.2.7 容器使用不同用户运行时共享存储卷<br>第6章中已经介绍了如何使用存储卷在 pod 的不同容器中共享数据。可以顺利 地在一个容器中写入数据， 在另一个容器中读出这些数据。<br>但这只是因为两个容器都以 root用户运行， 对存储卷中的所有文件拥有全部权 限。现在假设使用前面介绍的 runAsUser 选项。你可能需要在一个 pod 中用两个不同的用户运行两个容器 （可能是两个第三方的容器， 都以它们自己的特定用户运行进程）。如果这样的两个容器通过存储卷共享文件， 它们不一定能够读取或写入另一个容器的文件。<br>因此，Kubernetes 允许为 pod 中所有容器指定 supplemental 组， 以允许它们无论以哪个用户ID运行都可以共享文件。 这可以通过以下两个属性设置：<br>￥sGroup<br>supplementalGroups<br>解释它们的效果的最好方法是使用例子说明 ，下面来看一下如何在 pod 中使用 它们，以及它们效果。以下代码清单描述了一个拥有两个共享同一存储卷的容器的 pod。<br>代码清单 13.14 fsGroup 和 supplementalGroups： pod-with-shared_  volume-fsgroup.yaml</p>
<p>创建这个 pod 之后， 进入第一个容器查看它的用户 ID 和组 ID ：<br>$ kubectl exec -it pod-with-shared-volume-fsgroup -c first sh<br>/ $ id<br>uid=1111 gid=0(root) groups=555,666,777<br>id 命令显示，这个pod 运行在 ID 为 1111 的用户下，它的用户组为0（root），  但用户组 555、666、 777 也关联到了该用户下。<br>在 pod 的定义中，将 fsGroup 设置成了 555，因此，存储卷属于用户组ID为 555 的用户组：<br>/ $ 1s -l / | grep volume<br>drwxrwsrwx 2 root<br>555<br>6 May 29 12:23 volume<br>该容器在这个存储卷所在目录中创建的文件，所属的用户ID为1111 （即该容器运行时使用的用户ID），所属的用户组 ID为 555：<br>/ $ echo foo &gt; /volume/foo<br>/ $ 1s -l /volume<br>total 4<br>-rw-r—r—<br>11111<br>555<br>4 May 29 12:25 £00<br>这个文件的所属用户情况与通常设置下的新建文件不同。在通常情况下，某一 用户新创建文件所属的用户组ID， 与该用户的所属用户组ID 相同， 在这种情下是0。在这个容器的根文件系统中创建一个文件， 可以验证这一点：<br>/ $ echo foo &gt; /tmp/foo<br>/ $ ls -1 /tmp<br>total 4<br>-rw-r—r— 11111<br>root<br>4 May 29 12:41 foo<br>如你所见，安全上下文中的 fsGroup 属性当进程在存储卷中创建文件时起作 用，而 supplementalGroups 属性定义了某个用户所关联的额外的用户组。<br>这一节对配置 容器安全上下文的介绍到此结束。 接下来我们看一下集群管理员对用户的限制。</p>
<p>13.3 限制pod使用安全相关的特性<br>以上章节中的例子已经介绍了如何在部署 pod 时在任一宿主节点上做任何想做 的事。比如，部署一个特权模式的 pod。 很明显，需要有一种机制阻止用户使用其 中的部分功能。集群管理人员可以通过创建 PodSecurityPolicy 资源来限制对以上提 到的安全相关的特性的使用。<br>13.3.1 PodSecurityPolicy 资源介绍<br>PodSecurityPolicy 是一种集群级别 （无命名空间）的资源，它定义了用户能否 在 pod 中使用各种安全相关的特性。维护 PodSecurityPolicy 资源中配置策略的工作 由集成在 API 服务器中的 PodSecurityPolicy 准入控制插件完成（第 11 章中介绍了准入控制插件）。<br>注意你的集群中不一定启用了 PodSecurityPolicy 准入控制插件。 在运行以下样例时，请确保它已被启用。Minikube 的使用者请参考下面的注解。<br>当有人向 API 服务器发送 pod 资源时， PodSecurityPolicy 准入控制插件会将这 个 pod 与已经配置的 PodSecurityPolicy 进行校验。如果这个 pod 符合集群中已有安全策略，它会被接收并存入 ctcd； 否则它会立即被拒绝。 这个插件也会根据安全策略中配置的默认值对 pod 进行修改。<br>在 Minikube 中启用 RBAC和 PodSecurityPolicy 准入控制<br>笔者使用 Minikube v0.19.0 来运行以下样例。这个版本没有启用 RBAC和PodSecurityPolicy 准入控制插件， 这些在以下的部分练习中是必需的。 其中一个练习需要以不同用户认证，因此你还需要开启 basic authenticate 插件，其中用户 的信息在一个文件中定义。<br>为了在Minikube中启用这些插件， 需要运行如下命令（或类似的命令，这 取决于你使用的版本）：</p>
<p>这个API服务器需要创建在以上命令中制定的口令文件才能开始运行。以下命令可以创建这个文件：<br>$ cat &lt;&lt;EoF I minikube ssh sudo tee /etc/kubernetes/passwd<br>password, alice,100o, basic-user<br>password, bob,2000,privileged-user<br>EOF<br>可以在本书的代码存档的Chapter13/minikube-with-rbac-and-psp-enabled.sh中找到运行以上命令的shell脚本。<br>了解PodSecurityPolicy可以做的事<br>一个PodSecurityPolicy资源可以定义以下事项：<br>，是否允许pod使用宿主节点的PID、IPC、网络命名空间<br>·pod允许绑定的宿主节点端口<br>容器运行时允许使用的用户ID<br>，是否允许拥有特权模式容器的pod<br>允许添加哪些内核功能，默认添加哪些内核功能，总是禁用哪些内核功能允许容器使用哪些SELinux选项<br>容器是否允许使用可写的根文件系统<br>允许容器在哪些文件系统组下运行<br>。允许pod使用哪些类型的存储卷<br>如果你在阅读本章时读到了这里，应当已经熟悉了以上列表除最后一项外的内容。最后一项也应当比较清楚。<br>检视一个PodSecurityPolicy样例<br>以下代码清单展示了一个PodSecurityPolicy的样例。它阻止了pod使用宿主节点的PID、IPC、网络命名空间，运行特权模式的容器，以及绑定大多数宿主节点的端口（除11000~11000和13000~14000范围内的端口）。它没有限制容器运行时使用的用户、用户组和SELinux选项。</p>
<p>以上样例的大部分选项是不言自明的，特别是当你已经阅读了本章前几节的内容时。这个PodSecurityPolicy在集群中创建成功之后，API 服务器将不再允许之前样例中的特权pod.例如<br>$ kubectl create -f pod-privileged. yaml<br>Error from server (Forbidden) : error when creating “pod- privil eged. yaml “<br>pods “pod-privileged” is forbidden: unable to validate against any pod<br>security policy: [spec . containers [0] . securi tyContext . privileged: Inval ic<br>value: true: Privileged containers are not al lowed]<br>类似地，集群中不能再部署使用宿主节点的PID、IPC、网络命名空间的pod了。同样，因为以上策略中的readOnlyRootFilesystem选项已设置为true，容器的根文件系统将变为只读（容器只能写入挂载的存储卷）。<br>13.3.2 了解runAsUser、fsGroup和supplementalGroup策略<br>前面的例子中的策略没有对容器运行时可以使用的用户和用户组施加任何限制，因为它们在runAsUser、fsGroup、supplementalGroups 等字段中使用</p>
<p>了runAsAny规则。如果需要限制容器可以使用的用户和用户组ID，可以将规则改为MustRunAs，并指定允许使用的ID范围。<br>使用MustRunAs规则<br>来看以下的例子。为了只允许容器以用户ID2的身份运行并限制默认的文件系统组和增补组ID在2-10或20-30的范围（包含临界值）内，需要在PodSecurityPolicy资源中加入如以下代码清单所示片段。<br>代码清单13.16指定容器运行时必须使用的用户和用户组ID：psp-must-run-as.yaml</p>
<p>如果pod spec试图将其中的任一字段设置为该范围之外的值，这个pod将不会被API服务器接收。可以通过删除之前的PodSecurityContextPolicy，并通过psp-must-run-as.yaml文件创建一个新的来实践这一点。<br>注意修改策略对已经存在的pod无效，因为PodSecurityPolicy资源仅在创建和升级pod时起作用。<br>部署runAsUser在指定范围之外的pod<br>如果尝试使用之前的pod-as-user-guest.yaml文件部署一个pod，其中指定了容器运行的用户ID为405，API服务器会拒绝这个pod：</p>
<p>好，这个是显然的。但是如果部署pod时没有指定runAsUser属性，但用户ID被注入到镜像的情况下（在Dockerfle中使用USER命令），会发生什么？<br>部署镜像中用户ID在指定范围之外的pod<br>笔者创建了一个不同版本的Node.js镜像，在全书的例子中使用。这个镜像被配置为使用用户ID为5的用户运行。该镜像使用的Dockerfile如以下代码清单所示。代码清单 13.17包含 USER指令的Dockerfile ； kubia-run-as user-5/Dockerile<br>FROM node: 7<br>使用这个镜像运行的<br>ADD app.is /apr<br>容器会在ID为5的<br>DnaPP.JS /app.js<br>用户下运行。<br>USER 5<br>ENTRYPOINT [“node”, “app.js”]<br>笔者将这个镜像命名为uksa/ kubia-run-as-user-5，.上 传到DockerHub。如果使用这个镜像创建pod， API 服务器不会拒绝：<br>$ kubectl run run-as-5 — image luksa/kubia- run-as-user-5 —restart Never<br>pod “run-as-5” created<br>与之前不同，API 服务器接收了这个pod， kubelet 也运行了这个容器。接下来查看这个容器使用的用户ID和用户组ID：<br>$ kubect1 exec run-as-5 — id<br>uid=2 (bin) gid=2 (bin) groups=2 (bin)<br>oups<br>可以看到，这个容器运行时使用的用户ID为2，就是在PodSecurityPolicy中指定的ID。PodSecurityPolicy 可以将硬编码覆盖到镜像中的用户ID。<br>在runAsUser字段中使用mustRunAsNonRoot规则<br>runAsUser字段中还可以使用另一种规则： mustRunAsNonRoot。正如其名，它将阻止用户部署以root用户运行的容器。在此种情况下，spec 容器中必须指定runAsUser字段，并且不能为0 （0 为root用户的ID），或者容器的镜像本身指定了用一个非0的用户ID运行。这种做法的好处已经在之前介绍过。<br>13.3.3配置允许、 默认添加、禁止使用的内核功能<br>如你所知，容器可以运行在特权模式下，也可以通过对每个容器添加或禁用</p>
<p>Linux内核功能来定义更细粒度的权限配置。以下三个字段会影响容器可以使用的内核功能：<br>●allowedCapabilities<br>de faultAddCapabilities<br>requi redDropCapabilities<br>下面先来看一个例子，然后讨论这三个字段各自的行为。以下代码清单展示了一个定义了这三个字段的PodSecurityPolicy资源。<br>代码清单13.18在 PodSecurityPolicy资源中指定内核功能： psp-capabilities.yaml<br>apiVersion: extensions/v1betal<br>kind: PodSecurityPolicy<br>允许容器添加<br>spec<br>SYS_ TIME功能<br>allowedCapabilities: - SYS_ TIME<br>defaultAddCapabilities: - CHOWN<br>为每个容器自动添加CHOWN功能<br>requiredDropCapabilities: - SYS_ ADMIN<br>要求容器禁用SYS_ ADMIN和SYS_ _MODULE功能</p>
<ul>
<li>sYs MODULB<br>…<br>注意SYS_ ADMIN 功能允许使用一系列的管理操作； SYS_ MODULE 功能允许加载或卸载Linux内核模块。<br>指定容器中可以添加的内核功能<br>allowedCapabilities字段用于指定spec 容器的securityContext .capabilities中可以添加哪些内核功能。之前的一个例子中，容器内添加了sYs_ TIME 内核功能。如果启用了PodSecurityPolicy 访问控制插件，pod 中不能添加以上内核功能，除非在PodSecurityPolicy中指明允许添加，如代码清单13.18 所示。为所有容器添加内核功能<br>defaultAddcapabilities字段中列出的所有内核功能将被添加到每个已部署的pod的每个容器中。如果用户不希望某个容器拥有这些功能，必须在容器的spec中显式地禁用它们。<br>代码清单13.18中的例子自动在每个容器中添加CAP_CHOWN功能，因此容器中的进程允许修改容器中文件的所有者（例如，使用chown命令）。</li>
</ul>
<p>禁用容器中的内核功能<br>这个例子中的最后一个字段是requi redDropCapabilities.笔者承认，这个名字对我来说在最初看到时有点奇怪，但它并没有那么复杂。在这个字段中列出的内核功能会在所有容器中被禁用（PodSecurityPolicy 访问控制插件会在所有容器的securityContext. capabilities. drop字段中加入这些功能）。<br>如果用户试图在创建的pod中显式加入requi redDropCapabilities字段中的内核功能，这个pod会被拒绝：<br>$ kubectl creat ate - Pod-add-BYsadmin-capability.yam1<br>Error from server (Forbidden) : error when creating “ pod- add- sYsadmin-<br>capability.yaml”: pods “pod-add- sysadmin-capability” is forbidden: unable<br>to validate against any pod security policy: [capabilities.add: Invalid<br>value: nsys ADMIN”: capabilitv mav not be added]<br>vaLue;“SXS- ADMLN”: capabi<br>13.3.4 限制pod可以使用的存储卷类型<br>最后一项PodSecurityPolicy资源可以做到的是定义用户可以在pod中使用哪些类型的存储卷。在最低限度上，一个PodSecurityPolicy需要允许pod使用以下类型的存储卷：emptyDir、configMap、 secret、 downwardAPI、persistentVolumeClaim. PodSecurityPolicy 资源中的相关部分如以下代码清单所示。<br>代码清单13.19仅 允许特定类型存储卷的PodSecurityPolicy片段： psp-volumes.yaml<br>kind: PodSecurityPolicy<br>anen.<br>volumes :<br>voLumes:.<br>”emptyD1r<br>configMap<br>secret<br>一downwardAPI<br>persi stentVol umeClaim<br>ers1<br>如果有多个PodSecurityPolicy资源，pod 可以使用PodSecurityPolicy 中允许使用的任何一 个存储卷类型（实际生效的是所有vol ume列表的并集）。<br>13.3.5对不同的用 户与组分配不同的PodSecurityPolicy<br>我们已经提到，PodSecurityPolicy是集群级别的资源，这意味着它不能存储和应用在某一特定的命名空间上。这是否意味着它总是会应用在所有的命名空间上</p>
<p>呢？不是的，因为这样会使得它们相当难以应用。毕竟，系统pod经常需要允许做一些常规pod不应当做的事情。<br>对不同用户分配不同PodSecurityPolicy是通过前一章中描述的RBAC机制实现的。这个方法是，创建你需要的PodSecurityPolicy资源，然后创建ClusterRole资源并通过名称将它们指向不同的策略，以此使PodSecurityPolicy资源中的策略对不同的用户或组生效。通过ClusterRoleBinding资源将特定的用户或组绑定到ClusterRole上，当PodSecurityPolicy访问控制插件需要决定是否接纳一个pod时，它只会考虑创建pod的用户可以访问到的PodSecurityPolicy中的策略。<br>可以在下面的练习中看到如何做到这些。首先，创建另一个PodSecurityPolicy。创建一个允许部署特权容器的PodSecurityPolicy<br>首先，要创建一个特殊的PodSecurityPolicy，允许用户创建拥有特权容器的pod。以下代码清单展示了该PodSecurityPolicy的定义。<br>代码清单13，20特权用户使用的PodSecurityPolicy： psp-privileged.yaml</p>
<p>在向API服务器post这个PodSecurityPolicy之后，集群中有两个策略：<br>$ kubectl get PSP<br>NAME<br>PRIV false true<br>CAPS<br>SELINUX RunAsAny RunAsAny<br>RUNASUSER RunAsAny RunAsAny<br>ESGROUP RunAsAny RunAsAny<br>default<br>“<br>privileged<br>注意psp是PodSecurityPolicy的简写。<br>正如PRIV列中所示，default 策略禁止运行特权容器，然而privileged策略是允许的。因为现在是以cluster-admin身份登录的，所以可以看到所有的策略。部署pod时，如果任一策略允许使用pod中使用到的特性，API服务器就会接收这</p>
<p>个pod。<br>现在考虑另外两个使用该集群的用户：Alice和Bob。你希望Alice只能部署受限制的（非特权）pod，允许Bob部署特权pod。可以通过让Alice只能使用 default PodSecurityPolicy，而Bob可以使用以上两个PodSecurityPolicy来做到。 使用RBAC将不同的PodSecurityPolicy分配给不同用户<br>在上一章中，你已经使用了RBAC机制来给用户授予特定类型的资源的访问权限，但RBAC机制也可以通过使用引用其名字来授予对特定资源实例的访问权限。这就是你为了让不同用户使用不同PodSecurityPolicy的方法。<br>首先需要创建两个ClusterRole，分别允许使用其中一个策略。将第一个 ClusterRole命名为psp-default并允许其使用default PodSecurityPolicy资源。 可以使用kubectl create clusterrole来操作：<br>$ kubectl create clusterrole psp-default —verb=use<br>—resource=podsecuritypolicies —resource-name=default<br>clusterrole “psp-defaultu created<br>注意你使用的动词是use，而非get、list.watch或类似的动词。<br>如你所见，通过—resource-name选项引用了一个PodSecurityPolicy资源的特定实例。现在，创建另一个名为psp-Privileged ClusterRole，指向privileged策略：<br>$ kubectl create clusterrole psp-privileged —verb=use<br>-resource=podsecuritypolicies —resource-name=privileged<br>clusterrole “psp-privileged” created<br>现在，你需要把这两个策略绑定到用户上。在之前的章节提到过，为了绑定一个ClusterRole资源以授予对集群级别资源（PodSecurityPolicy资源就是集群级别的资源）的访问权限，需要使用ClusterRoleBinding资源而非（有命名空间的）RoleBinding。<br>要将psp-default ClusterRole绑定到所有已认证用户上，而非只有Alice。这是必需的，否则没有用户可以创建pod，因为PodSecurityPolicy访问控制插件会因为没有找到任何策略而拒绝创建pod。所有已认证用户都属于system：authenticated组，因此你需要将该ClusterRole绑定到这个组：<br>$ kubectl create clusterrolebinding psp-all-users<br>—clusterrole=psp-default —group=system:authenticated<br>clusterrolebinding “psp-all-users” created<br>接着，你需要将psp-privileged ClusterRole绑定到用户Bob：</p>
<p>作为一个已认证用户，Alice现在拥有使用default PodSecurityPolicy的权限，然而Bob拥有使用default和privilegedPodSecurityPolicy的权限。Alice不能创建特权pod，而Bob可以。接下来看看是否确实如此。<br>为kubectl创建不同用户<br>如何以Alice或Bob的身份通过认证，而非现在已经认证的用户？本书的附录A说明了如何在多个集群和多个上下文中使用kubectl。上下文中包含用来与集群交互的用户凭据。若需要了解更多的相关知识，请查阅附录A。这里只展示允许你以Alice或Bob的身份使用kubectl的命令。<br>首先，你需要使用如下命令，用kubectl的config子命令创建两个新用户：<br>$ kubectl config set-credentials alice —username=alice —password=password User “alice” set.<br>$ kubectl config set-credentials bob —username=bob —password=password<br>User “bob” set.<br>这些命令的行为应当很明显。因为你使用了用户名和密码作为凭据，kubectl将对这两个用户使用基础HTTP认证进行认证（其他的认证方法包括token、客户端证书等）。<br>使用不同用户创建pod<br>现在，可以尝试以Alice的身份认证，并创建一个特权pod。可以通过—user选项向kubectl传达你使用的用户凭据：<br>$ kubectl —user alice create -f pod-privileged.yaml<br>Error from server (Forbidden): error when creating “pod-privileged.yaml”:<br>pods “pod-privileged” is forbidden: unable to validate against any pod security policy: [spec.containers [o].securityContext.privileged: Invalid value: true: Privileged containers are not allowed]<br>与预期相同，API服务器不允许Alice创建特权pod。现在我们来看一下Bob是否允许：<br>$ kubectl —user bob create -f pod-privileged.yaml<br>pod “pod-privileged” created<br>到这里就可以了。你成功地使用了RBAC，让访问控制插件对不同用户使用不同的PodSecurityPolicy资源。</p>
<p>13.4 隔离pod的网络<br>到此为止，本章中已经检视了很多与安全相关的配置选项，作用在 pod 和 pod中的容器上。在本章的剩余部分中， 我们来看一下如何通过限制 pod 可以与其他哪些 pod 通信，来确保 pod 之间的网络安全。<br>是否可以进行这些配置取决于集群中使用的容器网络插件。如果网络插件支持， 可以通过 NetworkPolicy 资源配置网络隔离。<br>一个 NetworkPolicy 会应用在匹配它的标签选择器的 pod 上， 指明这些允许访问这些 pod 的源地址， 或这些 pod 可以访问的目标地址。 这些分别由入向（ingress）和出向（egress）规则指定。 这两种规则都可以匹配由标签选择器选出的pod，或者一个 namespace 中的所有 pod， 或者通过无类别域间路由（Classless Inter-DomainRouting，CIDR）指定的 IP 地址段。<br>我们将介绍这两种规则及全部三种匹配选项。<br>注意入向规则与第5章中的Ingress 资源无关。<br>13.4.1 在一个命名空间中启用网络隔离<br>在默认情况下，某一命名空间中的 pod 可以被任意来源访问。首先，需要改变 这个设定。需要创建一个 default-deny NetworkPolicy，它会阻止任何客户端访 问中的 pod。这个 NetworkPolicy 的定义如以下代码清单所示。<br>代码清单 13.21 default-deny NetworkPolicy定义： network-policy-  default-deny.yaml<br>apiVersion: networking.k8s.io/v1<br>kind: NetworkPolicy<br>metadata:<br>name: default-deny<br>空的标签选择器匹配命名<br>spec:<br>空间中的所有pod<br>podSelector:<br>在任何一个特定的命名空间中创建该 NetworkPolicy 之后，任何客户端都不能 访问该命名空间中的 pod。<br>注意集群中的 CNI插件或其他网络方案需要支持NetworkPolicy，否则NetworkPolicy 将不会影响 pod之间的 可达性。 </p>
<p>13.4.2允许同一命名空间中的部分pod访问一个服务端pod<br>为了允许同一命名空间中的客户端pod访问该命名空间的pod，需要指明哪些pod可以访问。接下来，我们通过例子来探究如何做到这些。<br>假设在foo namespace中有一个pod运行PostgreSQL数据库，以及一个使用该数据库的网页服务器pod，其他pod也在这个命名空间中运行，然而你不允许它们连接数据库。为了保障网络安全，需要在数据库pod所在的命名空间中创建—个如以下代码清单所示的NetworkPolicy资源。<br>代码清单13.22为 Postgres pod使用的NetworkPolicy ： network-policy-postgres. yaml</p>
<p>例子中的NetworkPolicy允许具有app=webserver标签的pod访问具有app=database的pod的访问，并且仅限访问5432 端口，如图13.4所示。</p>
<p>客户端pod通常通过Service而非直接访问pod来访问服务端pod，但这对结果没有改变。NetworkPolicy在通过Service访问时仍然会被执行。<br>13.4.3在不同Kubernetes命名空间之间进行网络隔离<br>现在我们来看有另一个多个租户使用同一Kubernetes集群的例子。每个租户有多个命名空间，每个命名空间中有一个标签指明它们属于哪个租户。例如，有一个租户Manning，它的所有命名空间中都有标签tenant：manning。其中的一个命名空间中运行了一个微服务Shopping Cart，它需要允许同一租户下所有命名空间的所有pod访问。显然，其他租户禁止访问这个微服务。<br>为了保障该微服务安全，可以创建如下的NetworkPolicy资源，如以下代码清单所示。<br>代码清单13.23为shopping cart微服务中的pod使用的NetworkPolicy：network-policy-cart.yaml</p>
<p>以上NetworkPolicy保证了只有具有tenant=manning标签的命名空间中运行的pod可以访问Shopping Cart微服务，如图13.5所示。<br>如果shopping cart服务的提供者需要允许其他租户（可能是他们的合作公司）访问该服务，他们可以创建一个新的NetworkPolicy资源，或者在之前的Networkpolicy中添加一条入向规则。</p>
<p>图13.5仅允许匹配 namespaceSelector 的命名空间中的pod访问特定 pod 的 NetworkPolicy<br>注意在多租户的 Kubernetes 集群中， 通常租户不能为他们的命名空间添加标 签（或注释）。否则，他们可以规避基于 namespaceSelector 的入向规则。<br>13.4 使用 CIDR隔离网络<br>除了通过在 pod 选择器或命名空间选择器定义哪些 pod 可以访问 NetworkPolicy资源中指定的目标 pod， 还可以通过 CIDR 表示法指定一个 IP 段。 例如，为了允许 IP 在 192.168.1.1 到 192.168.1.255 范围内的客户端访问之前提到的shopping-cart的pod，可以在入向规则中加入如以下代码清单所示的代码。<br>代码清单 13.24 在入向规则中指明 IP 段： network-policy-cidr.yaml<br>ingress:</p>
<ul>
<li>from:</li>
<li>ipBlock:<br>这条入向规则来自 192.168.1.0/24 IP 段的客户<br>cidr: 192.168.1.0/24<br>端的流量<br>13.4.5 限制 pod 的对外访问流量<br>在之前的所有例子中， 已经通过入向规则限制了进入 pod 的访问流量。然而，也可以通过出向规则限制 pod 的对外访问流量。以下代码清单展示 了一个例子。</li>
</ul>
<p>代码清单13.25在NetworkPolicy中使用出向规则：network-policy-egress.yaml<br>spec:<br>podSelector:<br>这个策略应用于包含<br>matchLabels:<br>app=webserver标签的pod<br>app:webserver<br>限制pod<br>D<br>egress:<br>的出网流量<br>-to:<br>webserver的pod只能与有<br>-podSelector:<br>app=webserver标签的pod<br>matchLabels:<br>通信<br>app:database<br>以上的NetworkPolicy仅允许具有标签app=webserver的pod访问具有标签app=database的pod，除此之外不能访问任何地址（不论是其他pod，还是任何其他的IP，无论在集群内部还是外部）。<br>13.5<br>本章小结<br>在本章中，你了解了如何保障集群中宿主节点和pod的安全，不被其他pod攻击。你学习了：<br>pod可以使用宿主节点的Linux命名空间，而不是它们自己的。<br>容器可以运行在与镜像中不同的用户或用户组下。<br>，容器可以在特权模式下运行，允许它们访问通常情况下不对pod暴露的设备。容器可以在只读模式下运行，阻止进程写入容器的根文件系统（只允许写入挂载的存储卷）。<br>集群级别的PodSecurityPolicy资源可以用来防止用户创建可能危及宿主节点的pod.<br>· PodSecurityPolicy资源可以通过RBAC中的ClusterRole和ClusterRoleBinding 与特定用户关联。<br>· NetworkPolicy资源可以限制pod的入向或出向网络流量。<br>在下一章中，你将会了解如何限制pod可以使用的计算资源，以及如何配置pod的服务质量控制（Quality of Service，QoS）。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Kubernetes-in-Action/" rel="tag"># Kubernetes in Action</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/10/01/12-Kubernetes-API服务器的安全防护/" rel="next" title="12-Kubernetes API服务器的安全防护">
                <i class="fa fa-chevron-left"></i> 12-Kubernetes API服务器的安全防护
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/10/01/14-计算资源管理/" rel="prev" title="14-计算资源管理">
                14-计算资源管理 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="CheBin">
            
              <p class="site-author-name" itemprop="name">CheBin</p>
              <div class="site-description motion-element" itemprop="description">看视频才能学会，看文字学不会的</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">1017</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">72</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          


          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/2023/04/04/结束语｜秒杀系统之上的业务协同思考/" title="结束语｜秒杀系统之上的业务协同思考" target="_blank">结束语｜秒杀系统之上的业务协同思考</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/14｜百万级流量秒杀系统的关键总结/" title="14｜百万级流量秒杀系统的关键总结" target="_blank">14｜百万级流量秒杀系统的关键总结</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/13｜优化番外篇：Vertx介绍及快速入门/" title="13｜优化番外篇：Vertx介绍及快速入门" target="_blank">13｜优化番外篇：Vertx介绍及快速入门</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/12｜高性能优化：单机Java极致优化/" title="12｜高性能优化：单机Java极致优化" target="_blank">12｜高性能优化：单机Java极致优化</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/11｜高性能优化：物理机极致优化/" title="11｜高性能优化：物理机极致优化" target="_blank">11｜高性能优化：物理机极致优化</a>
                  </li>
                
              </ul>
            </div>
        

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CheBin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">8.2m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">124:48</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
