<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">
<meta name="keywords" content="Kubernetes in Action">
<meta property="og:type" content="article">
<meta property="og:title" content="12-Kubernetes API服务器的安全防护">
<meta property="og:url" content="http://yoursite.com/2022/10/01/12-Kubernetes-API服务器的安全防护/index.html">
<meta property="og:site_name" content="车斌的技术博客">
<meta property="og:description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2022-10-03T00:39:55.485Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="12-Kubernetes API服务器的安全防护">
<meta name="twitter:description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">






  <link rel="canonical" href="http://yoursite.com/2022/10/01/12-Kubernetes-API服务器的安全防护/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>12-Kubernetes API服务器的安全防护 | 车斌的技术博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">放弃会成为一种习惯</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/10/01/12-Kubernetes-API服务器的安全防护/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CheBin">
      <meta itemprop="description" content="看视频才能学会，看文字学不会的">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">12-Kubernetes API服务器的安全防护

              
            
          </h1>
        

        <div class="post-meta">

          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2022-10-01 10:10:52" itemprop="dateCreated datePublished" datetime="2022-10-01T10:10:52+08:00">2022-10-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2022-10-03 08:39:55" itemprop="dateModified" datetime="2022-10-03T08:39:55+08:00">2022-10-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">22k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">20 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考并回答以下问题：</p>
<ul>
<li>总结一下，这章作者最主要想表达什么观点？</li>
</ul>
<a id="more"></a>
<p>本章内容涵盖<br>了解认证机制<br>ServiceAccounts是什么及使用的原因了解基于角色（RBAC）的权限控制插件使用角色和角色绑定<br>使用集群角色和集群角色绑定<br>了解默认角色及其绑定<br>在第8章里学习了运行在pod中的应用如何与API服务器交互来查看和控制部署在集群中的资源状态。在上述过程中，使用挂载进pod中的ServiceAccount token和API服务器完成认证。在本章中，你会学习到ServiceAccount是什么，以及如何配置它们的权限和在集群中用到的其他产品的权限。<br>12.1 了解认证机制<br>在前面的章节中，我们讲到API服务器可以配置一到多个认证的插件（授权插件同样也可以）。API服务器接收到的请求会经过一个认证插件的列表，列表中的每个插件都可以检查这个请求和尝试确定谁在发送这个请求。列表中的第一个插件可</p>
<p>以提取请求中客户端的用户名、用户ID和组信息，并返回给API服务器。API服务器会停止调用剩余的认证插件并继续进入授权阶段。<br>目前有几个认证插件是直接可用的。它们使用下列方法获取客户端的身份认证：·客户端证书<br>·传入在HTTP头中的认证token<br>·基础的HTTP认证<br>·其他<br>启动API服务器时，通过命令行选项可以开启认证插件。<br>12.1.1 用户和组<br>认证插件会返回已经认证过用户的用户名和组（多个组）。Kubernetes不会在任何地方存储这些信息，这些信息被用来验证用户是否被授权执行某个操作。<br>了解用户<br>Kubernetes区分了两种连接到API服务器的客户端。<br>·真实的人（用户）<br>·pod（更准确地说是运行在pod中的应用）<br>这两种类型的客户端都使用了上述的认证插件进行认证。用户应该被管理在外部系统中，例如单点登录系统（SSO），但是pod使用一种称 为service accounts的机制，该机制被创建和存储在集群中作为ServiceAccount资源。相反，没有资源代表用户账户，这也就意味着不能通过API服务器来创建、更新或删除用户。<br>我们不会详细讨论如何管理用户，但是会具体地探讨ServiceAccount，因为它们对于运行中的pod很重要。关于如何配置集群来供用户身份认证的更多信息，集群管理员应该参考<a href="http://kubernetes.io/docs/admin中的Kubernetes集群管理员指南。了解组" target="_blank" rel="noopener">http://kubernetes.io/docs/admin中的Kubernetes集群管理员指南。了解组</a><br>正常用户和ServiceAccount都可以属于一个或多个组。我们已经讲过认证插件会连同用户名和用户ID返回组。组可以一次给多个用户赋予权限，而不是必须单独给用户赋予权限。<br>由插件返回的组仅仅是表示组名称的字符串，但是系统内置的组会有—些特殊的含义。<br>system： unauthenticated组用于所有认证插件都不会认证客户端身份的请求。<br>system：authenticated 组会自动分配给一个成功通过认证的用户。 system： serviceaccounts组包含所有在系统中的ServiceAccount。</p>
<p>system：serviceaccounts： <namespace> 组包含了所有在特定命名空间中的 ServiceAccount。<br>12.1.2 ServiceAccount 介绍<br>接下来我们更详细地探讨 ServiceAccount。 你已经了解API 服务器要求客户端 在服务器上执行操作之前对自己进行身份认证，并且你已经了解了 pod 是怎么通过发送 /var/run/secrets/kubernetes. io/serviceaccount/token 文件内容来进行身份认证的。 这个文件通过加密卷挂载进每个容器的文件系统中。<br>但是那个文件具体表示了什么呢？每个 pod 都与一个 ServiceAccount 相关 联，它代表了运行在 pod 中应用程序的身份证明。token 文件持有 ServiceAccount的认证 token。应用程序使用这个 token 连接 API 服务器时，身份认证插件会对  ServiceAccount 进行身份认证，并将 ServiceAccount 的用户名传回 API 服务器内部。 ServiceAccount 用户名的格式像下面这样：<br>system:serviceaccount <namespace>:<service account name><br>API 服务器将这个用户 名传给已配置好的授权插件， 这决定该应用程序所尝试执行的操作是否被 ServiceAccount 允许执行。<br>ServiceAccount 只不过是一种运行在 pod 中的应用程序和API服务器身份认证 的一种方式。如前所述， 应用程序通过在请求中传递 ServiceAccount token 来实现这一点。<br>了解 ServiceAccount 资源<br>ServiceAccount 就像 Pod、Secret、 ConfigMap 等一样都是资源，它们作用在单 独的命名空间， 为每个命名空间自动创建一个默认的 ServiceAccount（你的 pod 会一直使用）。<br>可以像其他资源那样查看ServiceAccount 列表：<br>$ kubectl get sa<br>NAME<br>SECRETS<br>AGE<br>default<br>1<br>1d<br>注意serviceaccount 的缩写是 sa。<br>如你所见， 当前命名空间只包含default ServiceAccount，其他额外的 ServiceAccount 可以在需要时添加。每个 pod 都与一个 ServiceAccount相关联，但 是多个 pod 可以使用同一个 ServiceAccount。通过图 12.1 我们可以了解，pod 只能使用同一个命名空间中的 ServiceAccount。</service></namespace></namespace></p>
<p>图12.1每个pod会分配一个在这个pod命名空间中的单一ServiceAccount<br>ServiceAccount如何和授权进行绑定<br>在pod的manifest文件中，可以用指定账户名称的方式将一个ServiceAccount赋值给一个pod。如果不显式地指定ServiceAccount的账户名称，pod会使用在这个命名空间中的默认ServiceAccounto<br>可以通过将不同的ServiceAccount赋值给pod来控制每个pod可以访问的资源。当API服务器接收到一个带有认证token的请求时，服务器会用这个token来验证发送请求的客户端所关联的ServiceAccount是否允许执行请求的操作。API服务器通过管理员配置好的系统级别认证插件来获取这些信息。其中一个现成的授权插件是基于角色控制的插件（RBAC），这个插件会在本章后续进行讨论。从Kubernetes 1.6版本开始，RBAC插件是绝大多数集群应该使用的授权插件。<br>12.1.3创建ServiceAccount<br>我们已经讲过每个命名空间都拥有一个默认的ServiceAccount，也可以在需要时创建额外的ServiceAccount。但是为什么应该费力去创建新的ServiceAccount而不是对所有的pod都使用默认的ServiceAccount ？<br>显而易见的原因是集群安全性。不需要读取任何集群元数据的pod应该运行在一个受限制的账户下，这个账户不允许它们检索或修改部署在集群中的任何资源。需要检索资源元数据的pod应该运行在只允许读取这些对象元数据的ServiceAccount下。反之，需要修改这些对象的pod应该在它们自己的ServiceAccount下运行，这些ServiceAccount允许修改API对象。<br>下面让我们了解一下如何创建其他的ServiceAccount，它们如何与密钥进行关联，以及如何将它们分配给pod。</p>
<p>创建ServiceAccount<br>得益于kubectl create serviceaccount 命令，创建ServiceAccount非常容易。让我们新创建一个名为foo的ServiceAccount ：<br>$ kubectl create serviceaccount foo<br>serviceac too<br>count “foo” created<br>reacea<br>然后如下面的代码清单所示的那样，可以使用describe命令来查看ServiceAccount.<br>代码清单 12.1使用 kubectl describe 命令查看ServiceAccount<br>$ kubectl describe 8a foo<br>这些会被自动地添加到使<br>Name : Namespace: Labels:<br>foo default snone&gt;<br>用这个ServiceAccount的所有pod中<br>“aues<br>如果 强制使用可挂载的密钥，<br>Image pull secrets: <none><br>那么使用这个ServiceAccount<br>的pod只能挂载这些密钥<br>Mountable secrets: foo- token- gzq7j<br>Tokens:<br>foo- token-qzq7j<br>认证token，第一个token<br>挂载在容器内<br>可以看到，我们已经创建了自定义的token密钥，并将它和ServiceAccount相关联。如果通过kubectl describe secret foo- token-qzq7j 查看密钥里面的数据，如下面的代码清单所示，你会发现它包含了和默认的ServiceAccount相同的条目（CA证书、命名空间和token），当然这两个token本身显然是不相同的。代码清单 12.2查看自定 义的ServiceAccount密钥<br>$ kubectl describe secret foo- token-qzq7j<br>ca.crt: namespace: Holon’ token:<br>1066 bytes<br>7 bytes<br>evJhbec<br>hbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9…<br>注意你可能已经了解过JSON Web Token （JWT）。ServiceAccount 中使用的身份认证token就是JWT token。<br>了解ServiceAccount上的可挂载密钥<br>通过使用kubectl describe 命令查看ServiceAccount时，token 会显示在可挂载密钥列表中。下面让我们来解释一下 这个列表代表什么。在第7章中，你学会</none></p>
<p>了如何创建密钥并且把它们挂载进一个pod里。在默认情况下，pod可以挂载任何它需要的密钥。但是我们可以通过对ServiceAccount进行配置，让pod只允许挂载ServiceAccount中列出的可挂载密钥。为了开启这个功能，ServiceAccount 必须包含以下注解： kubernetes. io/enforce-mountable-secrets=”true”.<br>如果ServiceAccount被加上了这个注解，任何使用这个ServiceAccount的pod只能挂载进ServiceAccount的可挂载密钥一这些 pod不能使用其他的密钥。<br>了解ServiceAccount的镜像拉取密钥<br>ServiceAccount也可以包含镜像拉取密钥的list.这个list曾经在第7章中查看过； 如果你已经不记得了，镜像拉取密钥持有从私有镜像仓库拉取容器镜像的凭证。<br>下面的代码清单中显示了ServiceAccount定义的一个例子，它包含了我们在第7章中创建的镜像拉取密钥。<br>代码清单12.3带 有镜像拉取密钥的ServiceAccount ： sa-image pull-secrets.yaml<br>apiversion: v1<br>kind: servi ceAccount<br>metadata:<br>metadata:<br>name: my- service-account<br>imagePullSecrets:<br>一name： my- dockerhub - secret<br>ServiceAccount的镜像拉取密钥和它的可挂载密钥表现有些轻微不同。和可挂载密钥不同的是，ServiceAccount 中的镜像拉取密钥不是用来确定一个pod可以使用哪些镜像拉取密钥的。添加到ServiceAccount中的镜像拉取密钥会自动添加到所有使用这个ServiceAccount的pod中。向ServiceAccount中添加镜像拉取密钥可以不必对每个pod都单独进行镜像拉取密钥的添加操作。<br>12.1.4 将ServiceAccount分配给pod<br>在创建另外的ServiceAccount之后，需要将它们赋值给pod。通过在pod定义文件中的spec. serviceAccountName字段，上设置ServiceAccount的名称来进行分配。<br>注意pod的ServiceAccount必须在pod创建时进行设置，后续不能被修改。创建使用自定义ServiceAccount的pod<br>在第8章中部署了一个运行在基于tutum/curl镜像的容器上的pad，并在</p>
<p>其旁边放置了一个ambassador容器。我们使用它来查看API服务器的REST接口。这个ambassador容器会运行kubectlproxy进程，这个进程会使用pod的ServiceAccount的token和API服务器进行身份认证。<br>现在可以修改pod，让pod使用我们几分钟前创建的fooServiceAccount。接下来的代码清单展示了这个pod的定义。<br>代码清单12.4使用一个非默认ServiceAccount的pod：curl-custom-sa.yam<br>apiVersion: vl<br>kind:Pod<br>metadata:<br>name:curl-custom-sa<br>spec:<br>serviceAccountName: foo<br>这个pod使用foo ServiceAccount而不是默认的ServiceAccount<br>containers;<br>-name:main<br>image:tutum/curl<br>command: [“sleep”，”9999999”] name:ambassador<br>image:luksa/kubectl-proxy:1.6.2<br>为了确认自定义的ServiceAccount token已经挂载进这两个容器中，如下面的代码清单所示的那样，可以打印出这个token的内容。<br>代码清单12.5查看挂载进pod容器内的token<br>$ kubectl exec -it curl-cugtom-sa -c main<br>cat/var/run/secrets/kubernetes.io/serviceaccount/token eyJhbGci0iJSUzI1NiIsInR5cCI6IkpXVCJ9.<br>通过对比代码清单12.5和12.2中token的字符串，你会发现这个token来自foo ServiceAccount的token。<br>使用自定义的ServiceAccount token和API服务器进行通信<br>让我们看看是否可以使用这个token和API服务器进行通信。前面提到过，ambassador容器在使用这个token和服务器进行通信，因此可以通过ambassador来测试这个token，这个ambassador 监听在localhost：8001上，如下面的代码清单所示。<br>代码清单12.6使用自定义的ServiceAccount和API服务器进行通信</p>
<p>好的，我们从服务器得到了正确的响应，也就意味着自定义的ServiceAccount可以允许列出pod。这可能是因为集群没有使用RBAC授权插件，或者按照第8章所讲的那样，你给了所有的ServiceAccount全部的权限。<br>如果集群没有使用合适的授权，创建和使用额外的ServiceAccount并没有多大意义，因为即使默认的ServiceAccount也允许执行任何操作。在这种情况下，使用ServiceAccount的唯一原因就是前面讲过的加强可挂载密钥，或者通过ServiceAccount提供镜像拉取密钥。<br>如果使用RBAC授权插件，创建额外的ServiceAccount实际上是必要的，我们会在后面讨论RBAC授权插件的使用。<br>12.2通过基于角色的权限控制加强集群安全<br>从Kubemetes1.6.0版本开始，集群安全性显著提高。在早期版本中，如果你设法从集群中的一个pod获得了身份认证token，就可以使用这个token在集群中执行任何你想要的操作。如果在谷歌上搜索，可以找到演示如何使用path traversal（或者directory traversal）攻击的例子（客户端可以检索位于Web服务器的Web根目录之外的文件）。通过这种方式可以获取token，并用这个token在不安全的Kubemetes集群中运行恶意的pod。<br>但是在Kubemetes1.8.0版本中，RBAC授权插件升级为GA（通用可用性），并且在很多集群上默认开启（例如，通过kubadm部署的集群，如附录B所述）。 RBAC会阻止未授权的用户查看和修改集群状态。除非你授予默认的ServiceAcaount额外的特权，否则默认的ServiceAccount不允许查看集群状态，更不用说以任何方式去修改集群状态。要编写和KubermetesAPI服务器通信的APP（如第8章所讲的那样），需要了解如何通过RBAC具体的资源管理授权。<br>注意除了RBAC插件，Kuberetes也包含其他的授权插件，比如基于属性的访问控制插件（ABAC）、WebHook插件和自定义插件实现。但是，RBAC插件是标准的。</p>
<p>12.2.1 介绍 RBAC 授权插件<br>Kubernetes API 服务器可以配置使用一个授权插件来检查是否允许用户请求的动作执行。因为 API 服务器对外暴露了 REST 接口， 用户可以通过向服务器发送HTTP 请求来执行动作， 通过在请求中包含认证凭证来进行认证 （认证 token、用户名和密码或者客户端证书）。<br>了解动作<br>但是有什么动作？如你所了解的， REST 客户端发送 GET、 POST、 PUT、 DELETE 和其他类型的HTTP请求到特定的 URL 路径上，这些路径表示特定的REST 资源。在 Kubernetes 中， 这些资源是Pod、Service、Secret，等等。 以下是Kubernetes 请求动作的一些例子：<br>获取 pod<br>创建服务<br>更新密钥<br>这些示例中的动词（get、create、update） 映射到客户端请求的HTTP 方法 （GET、 POST、PUT）上（完整的映射如表 12.1 所示）。名词（Pod、Service、 Secret）显然是映射到 Kubernetes上的资源。<br>例如 RBAC 这样的授权插件运行在 API 服务器中，它会决定一个客户端是否允 许在请求的资源上执行请求的动词。<br>表 12.1 认证动词和 HTTP 方法之间的映射关系 </p>
<p>注意额外的动词 use 用于 PodSecurityPolicy 资源，我们会在下一章进行解释。 除了可以对全部资源类型应用安全权限， RBAC 规则还可以应用于特定的资源 实例（例如，一个名为 myservice 的服务 ），并且后面你会看到权限也可以应用于 non-resource（非资源）URL 路径， 因为并不是API 服务器对外暴露的每个路径都映射到一个资源（例如/api 路径本身或服务器健康信息在的路径 /healthz）。</p>
<p>了解RBAC插件<br>顾名思义，RBAC授权插件将用户角色作为决定用户能否执行操作的关键因素。主体（可以是一个人、一个ServiceAccount，或者一组用户或ServiceAccount）和一个或多个角色相关联，每个角色被允许在特定的资源上执行特定的动词。<br>如果一个用户有多个角色，他们可以做任何他们的角色允许他们做的事情。如果用户的角色都没有包含对应的权限，例如，更新密钥，API服务器会阻止用户3个“他的”对密钥执行PUT或PATCH请求。<br>通过RBAC插件管理授权是简单的，这一切都是通过创建四种RBAC特定的Kubemetes资源来完成的，我们会在下面学习这个过程。<br>12.2.2 介绍RBAC资源<br>RBAC授权规则是通过四种资源来进行配置的，它们可以分为两个组：<br>·Role（角色）和ClusterRole （集群角色），它们指定了在资源.上可以执行哪些动词。<br>RoleBinding （ 角色绑定）和ClusterRoleBinding （集群角色绑定），它们将上述角色绑定到特定的用户、组或ServiceAccounts.上。<br>角色定义了可以做什么操作，而绑定定义了谁可以做这些操作（如图12.2所示）。</p>
<p>图12.2Role授予权限，同时RoleBinding将Role绑定到主体上<br>角色和集群角色，或者角色绑定和集群角色绑定之间的区别在于角色和角色绑定是命名空间的资源，而集群角色和集群角色绑定是集群级别的资源（不是命名空间的），如图12.3所示。<br>从图中可以看到，多个角色绑定可以存在于单个命名空间中（对于角色也是如</p>
<p>此）。同样地，可以创建多个集群绑定和集群角色。图中显示的另外一件事情是，尽管角色绑定是在命名空间下的，但它们也可以引用不在命名空间下的集群角色。<br>学习这四种资源及其影响的最好方法就是在实践中尝试。可以现在就开始尝试。</p>
<p>图12.3Role 和 RoleBinding 都在命名空间中， ClusterRole和 ClusterRoleBinding 不在命名空间中<br>开始练习<br>在研究 RBAC 资源是怎样通过 API 服务器影响你可以执行什么操作之前， 需要确定 RABC 在集群中已经开启。首先， 确保使用的 Kubernet es 在 1.6 版本以上， 并且 RBAC 插件是唯一的配置生效的授权插件。 可以同时并行启用多个插件，如果其中一个插件允许执行某个操作， 那么这个操作就会被允许。<br>注意如果正在使用 GKE 1.6 或 1.7， 需要在创建集群时使用—no-enable- legacy-authorization： 选项来显式地禁用老版本遗留的授权。 如果正在使用 Minikube， 可能还需要在启动 Minikube 时使用 —extra-config=apiserver. Authorization.Mode=RBAC 选项来启用RBAC。<br>如果按照第8章中讲述的如何禁用 RBAC的指令进行操作， 现在通过运行下面的命令可以重新启用 RBAC：<br>$ kubectl delete clusterrolebinding permissive-binding<br>为了尝试 RBAC，就像第 8 章中所做的那样，可以运行一个 pod， 通过它尝试和 API 服务器进行通信。但是这次， 要在不同的命名空间运行两个 pod， 用来观察每个命名空间表现出来的安全性。</p>
<p>在第8章的示例中，运行了两个容器演示一个容器中的应用如何使用另一个容器来和API进行服务器通信。这次要运行一个容器（基于kubectl-proxy的镜像），并且直接在容器中使用kubectlexec运行curl命令。代理会负责验证和HTTPS，因此可以关注API服务器的安全性授权。<br>创建命名空间和运行pod<br>创建一个在命名空间foo中的pod和另一个在命名空间bar中的pod，如下面的代码清单所示。<br>代码清单12.7在不同的命名空间中运行测试pod</p>
<p>现在打开两个命令行终端，并使用 kubectl exec 在两个 pod 中分别（每个 终端对应一个 pod 的 shell） 运行一个 shell。例如，要在命名空间 foo 中运行pod中的 shell，首先要获得 pod 的名称：<br>$ kubectl get po -n foo<br>NAME<br>READY<br>STATUS<br>RESTARTS<br>AGE<br>test-145485760-ttq36<br>1/1<br>Runni.ng<br>0<br>1m<br>然后在 kubectlexec 命令中使用这个名称：<br>$ kubectl exec -it test-145485760-ttq36 -n foo sh<br>/ #<br>对于在 bar 命名空间中的 pod， 在另外一个命令行终端执行同样的操作。 列出pod中的服务<br>为了验证RBAC是否已经开启并且阻止 pod 读取集群状态，可以使用curl命 令来列出 foo 命名空间中的服务：<br>/ # curl localhost:8001/api/v1/namespaces/foo/services<br>User “system:serviceaccountfoo:default” cannot list services in the<br>namespace “foo”.<br>你正在连接到 localhost：8001， 这是kubectl proxy 进程监听的地址（如第 8 章所述）。 这个进程接收到请求并将其发送到API 服务器，同时以foo命名空间中</p>
<p>默认的ServiceAccount进行身份认证（从API服务器的响应中可以明显看出这一点 ）。<br>API 服务器响应表明ServiceAccount 不允许列出 foo 命 名 空间中的服务， 即使 pod 就运行在同一个命名空间中。 可以看到 RBAC 插件已经起作用了。ServiceAccount 的默认权限不允许它列出或修改任何资源。下面，让我们学习如何让 ServiceAccount做到这一点。首先， 需要创建一个 Role 资源。<br>12.2.3 使用 Role 和 RoleBinding<br>Role 资源定义了哪些操作可以在哪些资源上执行（ 或者如前面讲过的，哪种类型的 HTTP 请求可以在哪些 RESTful 资源上执行）。 下面的代码清单定义了一个Role，它允许用户获取并列出 foo 命名空间中的服务。<br>代码清单 12.8一个 Role的定义文件： service-reader.yaml </p>
<p>警告在指定资源时必须使用复数的形式。<br>这个 Role 资源会在 foo命名空间中创建出来。在第 8 章中， 你了解到每个资源类型属于一个 API 组，在资源清单 （manifest）的 apiversion 字段中指定  API 组（以及版本）。在角色定义中， 需要为定义包含的每个规则涉及的资源指定  apiGroup。如果你允许访问属于不同API 组的资源，可以使用多种规则。<br>注意在本例中， 你允许访问所有服务资源， 但是也可以通过额外的resourceNames 字段指定服务实例的名称来限制对服务实例的访问。<br>图 12.4 中显示了角色， 以及它的动词和资源， 还有它的命名空间。</p>
<p>图12.4service-reader Role允许获取和列出在foo命名空间中的服务<br>创建角色<br>现在在foo命名空间中创建先前讲的角色：<br>$ kubectl create -f service-reader.yaml -n £oo role “service-readern created<br>注意-n选项是—namespace的缩写。<br>注意如果你正在使用GKE，先前的命令可能因为你没有集群管理员权限而发生错误。运行下面的命令来获取这些权限：<br>$ kubectl create clusterrolebinding cluster-admin-binding<br>.-clusterrole=cluster-admin —user=your.email@address.com<br>可以使用特殊的kubectl create role命令创建service-reader角色，而不是通过YAML文件来创建。让我们使用这个方法来创建bar命名空间中的角色：<br>$ kubectl create role service-reader —verb=get —verb=list -resource=services-n bar<br>role”service-readeru created<br>这两个角色会允许你在两个pod（分别在foo和bar命名空间中运行）中列出foo和bar命名空间中的服务。但是创建了两个角色还不够（可以执行curl命令来再次检查），你需要将每个角色绑定到各自命名空间中的ServiceAccount上。<br>绑定角色到ServiceAccount<br>角色定义了哪些操作可以执行，但没有指定谁可以执行这些操作。要做到这一点，必须将角色绑定一个到主体，它可以是一个user（用户）、一个ServiceAccount</p>
<p>或一个组（用户或ServiceAccount的组）。<br>通过创建一个RoleBinding资源来实现将角色绑定到主体。运行以下命令，可以将角色绑定到de fault ServiceAccount：<br>$ kubectl create rolebinding test —role=service- reader<br>中—serviceaccount=foo：default -n foo<br>rolebinding “test” created<br>命令应该是不言自明的。你会创建一个RoleBinding资源，它将service- reader角色绑定到命名空间foo中的defaultServiceAccount上。这个 RoleBinding资源会被创建在命名空间foo中。RoleBinding 资源和ServiceAccount 和角色的引用如图12.5所示。<br>注意如果要绑定一个角色到一个user （用户）而不是ServiceAccount上，使用—user作为参数来指定用户名。如果要绑定角色到组，可以使用—group参数。</p>
<p>JHJLT<br>图12.5<br>test RoleBinding将default ServiceAccount和service-reader Role绑定<br>下面的代码清单显示了你创建的RoleBinding的YAML格式。代码清单12.9个RoleBinding 引用一个Role</p>
<p>如你所见，RoleBinding 始终引用单个角色（从roleRef属性中可以看出），但是可以将角色绑定到多个主体（例如，一 个或多个ServiceAccount和任意数量的用户或组），上。因为这个RoleBinding将角色绑定到一个ServiceAccount 上，这个ServiceAccount运行在foo命名空间中的pod上，所以现在可以列出来自pod中的服务。<br>代码清单12.10从API服务器中获取服务</p>
<p>在角色绑定中使用其他命名空间的 ServiceAccount<br>bar 命名空间中的 pod 不能列出自己命名空间中的服务， 显然也不能列出 foo命名空间中的服务。但是可以修改在 foo 命名空间中的 RoleBinding 并添加另一个 pod 的 ServiceAccount，即使这个 ServiceAccount 在另一个不同的命名空间中。 运行下面的命令：<br>$ kubectl edit rolebinding test -n foo<br>然后对于列出的 subjects 增加下面几行， 如下面的代码清单所示。<br>代码清单12.11 从另一个命名空间中引用ServiceAccount<br>subjects:</p>
<ul>
<li>kind: ServiceAccount name: default<br>引用来自 bar 命名空间中的default ServiceAccount<br>namespace: bar<br>现在，就可以从运行在 bar 命名空间里的 pod 中列出 foo 命名空间中的服务。运行和代码清单 12.10 中相同的命令， 但是在另一个终端执行， 这个终端运行另一</li>
</ul>
<p>个pod的shell。<br>在探讨ClusterRole和ClusterRoleBinding之前，让我们总结当前拥有的 RBAC资源。在foo命名空间中有一个RoleBinding，它引用service-reader角色（也在foo命名空间中），并且绑定foo和bar命名空间中的defaultServiceAccount，如图12.6所示。</p>
<p>图12.6RoleBinding将来自不同命名空间中的ServiceAccount绑定到同一个Role<br>12.2.4使用ClusterRole和ClusterRoleBinding<br>Role和RoleBinding都是命名空间的资源，这意味着它们属于和应用在一个单一的命名空间资源上。但是，如我们所见，RoleBinding可以引用来自其他命名空间中的ServiceAccounto<br>除了这些命名空间里的资源，还存在两个集群级别的RBAC资源：ClusterRole和ClusterRoleBinding，它们不在命名空间里。让我们看看为什么需要它们。<br>一个常规的角色只允许访问和角色在同一命名空间中的资源。如果你希望允许跨不同命名空间访问资源，就必须要在每个命名空间中创建一个Role和 RoleBinding。如果你想将这种行为扩展到所有的命名空间（集群管理员可能需要），需要在每个命名空间中创建相同的Role和RoleBinding。当创建一个新的命名空间时，必须记住也要在新的命名空间中创建这两个资源。<br>正如你在整本书中了解到的，一些特定的资源完全不在命名空间中（包括Node、 PersistentVolume、 Namespace，等等）。我们也提到过API服务器对外暴露了一些不表示资源的URL路径（例如/healthz）。常规角色不能对这些资源或非资源型的URL进行授权，但是ClusterRole可以。<br>ClusterRole是一种集群级资源，它允许访问没有命名空间的资源和非资源型的</p>
<p>URL，或者作为单个命名空间内部绑定的公共角色， 从而避免必须在每个命名空间中重新定义相同的角色。<br>允许访问集群级别的资源<br>已经提到过，可以使用 ClusterRole 来允许集群级别的资源访问。让我们来了 解一下如何允许 pod 列出集群中的 PersistentVolume。首先，你会创建一个叫作 pv-reader 的 ClusterRole：<br>$ kubectl create clusterrole pv-reader —verb=get,list<br>—resource=persistentvolumes<br>clusterrole “pv-reader” created<br>这个 ClusterRole 的 YAML 格式内容展示在 下面的代码清单中。<br>代码清单12.12一个 ClusterRole的定义</p>
<p>在你将这个ClusterRole绑定到pod的ServiceAccount之前，请验证pod是否可以列出 PersistentVolume。在第一个命令行终端上运行下面的命令，这个终端正在运行一个shell，这个shell在foo命名空间下的pod内：<br>/ # curl localhost:8001/api/v1/persistentvolumes<br>User “system:serviceaccount:foo:defaultm cannot list persistentvolumes at the<br>cluster scope.<br>注意这个URL没有包含命名空间，因为PersistentVolume不在命名空间里。和预期的一样，默认ServiceAccount不能列出PersistentVolume，需要将ClusterRole绑定到ServiceAccount来允许它这样做。ClusterRole可以通过常规的RoleBinding（角色绑定）来和主体绑定，因此你要创建一个RoleBinding：</p>
<p>现在你能列出PersistentVolume了吗？<br>/# curl localhost:8001/api/v1/persistentvolumes<br>User “system:serviceaccount:foo:default” cannot list persistentvolumes at the cluster scope.<br>呃，这就奇怪了。让我们在下面的代码清单中检查RoleBinding的YAML内容。你能说出它有什么问题吗？<br>代码清单12.13<br>一个RoleBinding 引用一个ClusterRole<br>$ kubectl get rolebindings pv-test -o yaml apiVersion: rbac.authorization.k8s.io/vl kind: RoleBinding<br>metadata:<br>name:pv-test<br>namespace:foo<br>roleRef:<br>apiGroup: rbac.authorization.k8s.io<br>kind:ClusterRole<br>这个绑定引用了pv-reader<br>name: pv-reader<br>ClusterRole<br>subjects:</p>
<ul>
<li>kind: ServiceAccount<br>这个绑定的主体是在<br>name:default<br>foo命名空间中的默认<br>namespace:foo<br>ServiceAccount<br>这个YAML内容看起来相当正确。它正在引用正确的ClusterRole和正确的ServiceAccount，如图12.7所示。那么有什么问题呢？</li>
</ul>
<p>图12.7RoleBinding 引用了一个ClusterRole，不会授予集群级别的资源的权限<br>尽管你可以创建一个RoleBinding并在你想开启命名空间资源的访问时引用一</p>
<p>个 ClusterRole，但是不能对集群级别（ 没有命名空间的）资源使用相同的方法。必 须始终使用 ClusterRoleBinding 来对集群级别的资源进行授权访问。<br>幸运的是，创建一个 ClusterRoleBinding 和创建一个 RoleBinding 并没有什么太 大区别，但是首先你要清理和删除 RoleBinding：<br>$ kubectl delete rolebinding pv-test<br>rolebinding “pv-test” deleted<br>接下来创建 ClusterRoleBinding：<br>$ kubectl create clusterrolebinding pv-test —clusterrole=pv-reader<br>—serviceaccount=foo:default<br>clusterrolebinding “pv-test” created<br>如你所见，在命令中使用 clusterrolebinding 替换了 rolebinding，并且不（需要）指定命名空间。图 12.8 显示了你现在有的资源。<br>让我们来看一下，现在是否可以列出 PersistentVolume ：<br>/ # curl localhost:8001/api/v1/persistentvolumes<br>{<br>“kind”:”PersistentVolumeList”,<br>“apiversion”:”v1”,</p>
<p>图12.8ClusterRoleBinding和 ClusterRole 必须一起使用授予集群级别的资源的权限<br>可以了！这表明在授予集群级别的资源访问权限时，必须使用一个 ClusterRole和一个 ClusterRoleBinding。<br>提示记住一个 RoleBinding 不能授予集群级别的资源访问权限， 即使它引用了一个 ClusterRoleBinding。</p>
<p>允许访问非资源型的 URL<br>我们已经提过，API 服务器也会对外暴露非资源型的 URL。 访问这些URL也必须要显式地授予权限；否则， API 服务器会拒绝客户端的请求。通常， 这个会通过 system：discovery ClusterRole 和相同命名的 ClusterRoleBinding 帮你自动完成，它出现在其他预定义的 ClusterRoles 和 ClusterRoleBindings 中（我们将在 12.2.5 节讨论它们）。<br>让我们查看一下下面的代码清单中的 system：discovery ClusterRole。 代码清单 12.14 默认 system： discovery ClusterRole </p>
<p>可以发现，ClusterRole引用的是URL路径而不是资源（使用的是非资源URL字段而不是资源字段）。verbs 字段只允许在这些URL上使用GET HTTP 方法。<br>注意对于非资源型URL，使用普通的HTTP动词，如post、put和patch，而不是create 或update。动词需要使用小写的形式指定。<br>和集群级别的资源-样， 非资源型的URL ClusterRole 必须与ClusterRoleBinding结合使用。把它们和RoleBinding 绑定不会有任何效果。system： discoveryClusterRole有一个与之对应的system：discovery ClusterRoleBinding，所以让我们通过下面的代码清单来看看它们里面有什么。<br>代码清单12.15 默认的system： discovery ClusterRoleBinding</p>
<p>YAML内容显示ClusterRoleBinding正如预期的那样指向system ：di scoveryClusterRole.它绑定到了两个组，分别是system： authenticated和system： unauthenticated，这使得它和所有用户绑定在一起。 这意味着每个人都绝对可以访问列在ClusterRole中的URL。<br>注意组位于身份认证插件的域中。API 服务器接收到一个请求时，它会调用身份认证插件来获取用户所属组的列表，之后授权中会使用这些组的信息。<br>可以通过在一个pod内和本地机器访问/api URL 路径来进行确认（通过kubectl proxy， 意味着你会使用pod的ServiceAccount来进行身份认证），访问URL时不要指定任何认证的token （这会让你成为一个未认证的用户）。<br>$ curl https://$ (minikube ip) :8443/api -k<br>“kind”: “APIVersions” ,<br>“versions”: [<br>现在我们已经使用ClusterRole和ClusterRoleBinding授权访问集群级别的资源和非资源型的URL。让我们来了解一下ClusterRole怎么和命名空间中的RoleBinding一起来授权访问RoleBinding的命名空间中的资源。<br>使用ClusterRole来授权访问指定命名空间中的资源<br>ClusterRole不是必须一直和集群级别的ClusterRoleBinding捆绑使用。它们也可以和常规的有命名空间的RoleBinding进行捆绑。我们已经研究过预先定义好的ClusterRole，所以让我们了解另一个名为view的ClusterRole，如下面的代码清单所示。</p>
<p>这个ClusterRole有很多规则。只有第一条会展示在这个代码清单中。这个规则允许get、list和watch资源，这些资源就像ConfigMap、Endpoint、PersistentVolumeClaim，等等。这些资源是有命名空间的，即使我们正在了解的是一个ClusterRole （它不是一个常规的、有命名空间的角色）。这个ClusterRole到底做了什么？<br>这取决于它是和ClusterRoleBinding还是和RoleBinding绑定（可以和其中的一个进行绑定）。如果你创建了一个ClusterRoleBinding并在它里面引用了ClusterRole，在绑定中列出的主体可以在所有命名空间中查看指定的资源。相反，如果你创建的是一个RoleBinding，那么在绑定中列出的主体只能查看在RoleBinding命名空间中的资源。现在可以尝试使用这两个选项。<br>可以看到这两种方式如何影响测试pod列出pod的能力。首先，让我们了解这些绑定生效之前会发生什么：</p>
<p>通过使用第一个命令，可以试着列出所有命名空间的pod。使用第二个命令，可以试着列出在foo命名空间中的pod。服务器都不允许你执行这些操作。<br>现在，让我们了解创建一个ClusterRoleBinding并且把它绑定到pod的ServiceAccount上时发生了什么：<br>$ kubectl create clusterrolebinding view-test —clusterrole=view<br>—serviceaccount=foo:default<br>clusterrolebinding uview-testu created<br>现在这个pod能列出在foo命名空间中的pod了吗？<br>/ # curl localhogt:8001/api/v1/namespaces/↵oo/pods<br>“kind”:”PodList”,<br>“apiVersion”:  “v1”,<br>可以了！因为你创建了一个ClusterRoleBinding，并且它应用在所有的命名空间上。通过它命名空间foo中的pod也可以列出bar命名空间中的pod：<br>/# curl localhost:80o1/api/vl/namespaces/bar/pods<br>“kind”: “PodList”,<br>“apiversion”: “v1”,<br>这个pod现在允许列出一个不同的命名空间中的pod。它也可以使用/api/v1/pods URL路径来检索所有命名空间中的pod。<br>/# curl localhogt:8001/api/vl/pods<br>“kind”: “PodList”, “apiVersion”: “v1”,<br>正如预期的那样，这个pod可以获取集群中所有pod的列表。总之，将ClusterRoleBinding和ClusterRole结合指向命名空间的资源，允许pod访问任何命名空间中的资源，如图12.9所示。</p>
<p>可以看到，这个pod 可以列出 foo命名空间中的pod,但并不是其他特定的命<br>名空间或者所有的命名空间都能做到，如图 12.10所示。</p>
<p>图12.10指向一个 ClusterRole的RoleBinding 只授权获取在 RoleBinding 命名空间中的资源<br>总结 Role、ClusterRole、Rolebinding和 ClusterRoleBinding的组合 我们已经介绍了许多不同的组合， 可能很难记住何时去使用对应的每个组合。 让我们来看看如果对所有组合按每个特定的 用例进行分类会不会对记忆有帮助，参考表12.2。<br>表12.2何时使用具体的 role 和 binding的组合</p>
<p>希望现在这四个RBAC资源之间的关系更加清晰了。不要担心，如果你仍然觉得自己还没有掌握这些。在接下来的章节中，随着我们讨论预先配置好的ClusterRole和ClusterRoleBinding，这些内容会变得更加清晰。<br>12.2.5 了解默认的ClusterRole和ClusterRoleBinding<br>Kubemetes提供了一组默认 的ClusterRole和ClusterRoleBinding，每次API服务</p>
<p>器启动时都会更新它们。这保证了在你错误地删除角色和绑定，或者Kubemetes的新版本使用了不同的集群角色和绑定配置时，所有的默认角色和绑定都会被重新创建。<br>可以在下面的代码清单中看到默认的集群角色和绑定。<br>代码清单12.17列出所有 ClusterRoleBinding和ClusterRole</p>
<p>view、edit、admin和cluster-admin ClusterRole 是最重要的角色，它们应该绑定到用户定义pod中的ServiceAccount上。<br>用view ClusterRole允许对资源的只读访问<br>在前面的例子中，我们已经使用了默认的view ClusterRole。它允许读取一个</p>
<p>命名空间中的大多数资源，除了Role、RoleBinding和Secret。你可能会想为什么Secrets不能被读取？因为Secrets中的某一个可能包含一个认证token，它比定义在view ClusterRole中的资源有更大的权限，并且允许用户伪装成不同的用户来获取额外的权限（权限扩散）。<br>用edit ClusterRole允许对资源的修改<br>接下来是edit ClusterRole，它允许你修改一个命名空间中的资源，同时允许读取和修改Secret。但是，它也不允许查看或修改Role和RoleBinding，这是为了防止权限扩散。<br>用admin ClusterRole赋予一个命名空间全部的控制权<br>一个命名空间中的资源的完全控制权是由admin  ClusterRole赋予的。有这个ClusterRole的主体可以读取和修改命名空间中的任何资源，除了ResourceQuota（我们会在第14章中了解它是什么）和命名空间资源本身。edit和admin ClusterRole之间的主要区别是能否在命名空间中查看和修改Role和RoleBinding.<br>注意为了防止权限扩散，API服务器只允许用户在已经拥有一个角色中列出的所有权限（以及相同范围内的所有权限）的情况下，创建和更新这个角色。<br>用cluster-admin ClusterRole得到完全的控制<br>通过将cluster-admin ClusterRole赋给主体，主体可以获得Kubernetes集群完全控制的权限。正如你前面了解的那样，admin ClusterRole不允许用户修改命名空间的ResourceQuota对象或者命名空间资源本身。如果你想允许用户这样做，需要创建一个指向cluster-admin ClusterRole的RoleBinding。这使得RoleBinding中包含的用户能够完全控制创建RoleBinding所在命名空间上的所有方面。<br>如果你留心观察，可能已经知道如何授予用户一个集群中所有命名空间的完全控制权。就是通过在ClusterRoleBinding而不是RoleBinding中引用cluster-admin ClusterRole.<br>了解其他默认的ClusterRole<br>默认的ClusterRole列表包含了大量其他的ClusterRole，它们以system：为前缀。这些角色用于各种Kubernetes组件中。在它们之中，可以找到如system：kube-scheduler之类的角色，它明显是给调度器使用的，system：node是给Kubelets组件使用的，等等。<br>虽然Controller Manager作为一个独立的pod来运行，但是在其中运行的每个控制器都可以使用单独的ClusterRole和ClusterRoleBinding（它们以system：</p>
<p>Controller: 为前缀）。<br>这些系统的每个ClusterRole都有一个匹配的ClusterRoleBindi ng，它会绑定到系统组件用来身份认证的用户上。例如，system：kube-scheduler ClusterRoleBi ndi ng将名称相钓ClusterRole分配给system：kube-scheduler 用户，它是调度器作为身份认证的用户名。<br>12.2.6理性地授予授权权限<br>在默认情况下，命名空间中的默认ServiceAccount除了未经身份验证的用户段有其他权限（你可能记得前面的示例之一，system：discovery ClusterRole和相关联的绑定允许任何人对一些非资源型的URL发送GET请求）。因此，在默认情况下，pod甚至不能查看集群状态。应该授予它们适当的权限来做这些操作。<br>显然，将所有的Servi ceAccounts赋予uster-admin ClusterRole是一个坏主意。和安全问题一样，我们最好只给每个人提供他们工作所需要的权限，一个单独权限也不能多（最小权限原则）。<br>为每个pod创建特定的ServiceAccount<br>一个好的想法是为每一个pod（或一组pod的副本）创建一个特定Servi ceAccount，并且把它和一个定制的Role（或ClusterRole）通过RoleBinding联系起来（不是ClusterRoleBindi ng因为这样做会给其他命名空间的pod对资源的访问权限，这可能不是你想要的）。<br>如果你的一个pod（应用程序在它内部运行）只需要读取pod，而其他的pod也需要修改它们，然后创建两个不同的ServiceAccount，并且让这些pod通过指定在pod spec中的serviceAccountName属性来进行使用，和你在本章的第一部分了解的那样。不要将这两个pod所需的所有必要权限添加到命名空间中的默认Servi ceAccount上。<br>假设你的应用会被入侵<br>你的目标是减少入侵者获得集群控制的可能性。现在复杂的应用程序会包含很多的漏洞，你应该期望不必要的用户最终获得ServiceAccount的身份认证token。因此你应该始终限制ServiceAccount，以防止它们造成任何实际的伤害。<br>12.3<br>本章小结<br>本章介绍了如何对Kubemetes API服务器进行安全防护的基础知识。你已经了解了下面这几点：</p>
<p>API服务器的客户端有真实的用户和pod中运行的应用。<br>pod中的应用与一个ServiceAccount关联。<br>·用户和ServiceAccount都与组进行关联。<br>在默认情况下，pod运行在每个命名空间自动创建的默认ServiceAccount下。额外的ServiceAccount可以手动创建，并且和一个pod关联。<br>ServiceAccount通过配置可以允许只挂载给定pod中受限的Secret列表。<br>，一个ServiceAccount也可以用来给pod添加镜像拉取密钥，因此你就不需要在每个pod里指定密钥了。<br>· Role和ClusterRole定义了可以在哪些资源上执行什么操作。<br>· RoleBinding和ClusterRoleBinding将Role和ClusterRole绑定给用户、组和ServiceAccount.<br>·每个集群都有默认的ClusterRole和ClusterRoleBinding。<br>在下一章中，你会学习如何保护集群节点不受pod影响，以及如何通过网络安全防护将pod隔离开。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Kubernetes-in-Action/" rel="tag"># Kubernetes in Action</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/10/01/11-了解Kubernetes机理/" rel="next" title="11-了解Kubernetes机理">
                <i class="fa fa-chevron-left"></i> 11-了解Kubernetes机理
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/10/01/13-保障集群内节点和网络安全/" rel="prev" title="13-保障集群内节点和网络安全">
                13-保障集群内节点和网络安全 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="CheBin">
            
              <p class="site-author-name" itemprop="name">CheBin</p>
              <div class="site-description motion-element" itemprop="description">看视频才能学会，看文字学不会的</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">1017</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">72</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          


          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/2023/04/04/结束语｜秒杀系统之上的业务协同思考/" title="结束语｜秒杀系统之上的业务协同思考" target="_blank">结束语｜秒杀系统之上的业务协同思考</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/14｜百万级流量秒杀系统的关键总结/" title="14｜百万级流量秒杀系统的关键总结" target="_blank">14｜百万级流量秒杀系统的关键总结</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/13｜优化番外篇：Vertx介绍及快速入门/" title="13｜优化番外篇：Vertx介绍及快速入门" target="_blank">13｜优化番外篇：Vertx介绍及快速入门</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/12｜高性能优化：单机Java极致优化/" title="12｜高性能优化：单机Java极致优化" target="_blank">12｜高性能优化：单机Java极致优化</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/11｜高性能优化：物理机极致优化/" title="11｜高性能优化：物理机极致优化" target="_blank">11｜高性能优化：物理机极致优化</a>
                  </li>
                
              </ul>
            </div>
        

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CheBin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">8.2m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">124:48</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
