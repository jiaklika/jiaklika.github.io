<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">
<meta name="keywords" content="Kubernetes in Action">
<meta property="og:type" content="article">
<meta property="og:title" content="16-高级调度">
<meta property="og:url" content="http://yoursite.com/2022/10/01/16-高级调度/index.html">
<meta property="og:site_name" content="车斌的技术博客">
<meta property="og:description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2022-10-03T10:30:21.655Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="16-高级调度">
<meta name="twitter:description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">






  <link rel="canonical" href="http://yoursite.com/2022/10/01/16-高级调度/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>16-高级调度 | 车斌的技术博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">专注</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/10/01/16-高级调度/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CheBin">
      <meta itemprop="description" content="学如逆水行舟，不进则退">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">16-高级调度

              
            
          </h1>
        

        <div class="post-meta">

          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2022-10-01 10:11:58" itemprop="dateCreated datePublished" datetime="2022-10-01T10:11:58+08:00">2022-10-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2022-10-03 18:30:21" itemprop="dateModified" datetime="2022-10-03T18:30:21+08:00">2022-10-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">13k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">12 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考并回答以下问题：</p>
<ul>
<li>总结一下，这章作者最主要想表达什么观点？</li>
</ul>
<a id="more"></a>
<p>本章内容涵盖<br>■使用节点污点和pod容忍度组织pod调度到<br>特定节点<br>■将 节点亲缘性规则作为节点选择器的一种替代<br>■使用节点亲缘性进行多个 pod的共同调度<br>1使用节点非亲缘性来分离 多个pod<br>Kubernetes允许你去影响pod被调度到哪个节点。起初，只能通过在pod规范里指定节点选择器来实现，后面其他的机制逐渐加入来扩容这项功能，本章将包括这些内容。<br>16.1使用污点和容忍度阻止节点调度到特定节点<br>首先要介绍的高级调度的两个特性是节点污点，以及pod对于污点的容忍度，这些特性被用于限制哪些pod可以被调度到某一个节点。只有当一个pod容忍某个节点的污点，这个pod才能被调度到该节点。</p>
<p>这与使用节点选择器和节点亲缘性有些许不同，本章后面部分会介绍到。节点选择器和节点亲缘性规则，是通过明确的在pod中添加的信息，来决定一个pod可以或者不可以被调度到哪些节点上。而污点则是在不修改已有pod信息的前提下，通过在节点上添加污点信息，来拒绝pod在某些节点上的部署。<br>16.1.1 介绍污点和容忍度<br>学习节点污点的最佳路径就是看一个已有的污点。附录B展示了如何使用kubeadm工具去设置一个多节 点的集群，默认情况下，这样一个集群中的主节点需要设置污点，这样才能保证只有控制面板pod才能部署在主节点上。<br>显示节点的污点信息<br>可以通过kubectl describe node 查看节点的污点信息，如以下代码清单所示。<br>代码清单16.1显示通过 kubeadm创建的集群中的主节点信息</p>
<p>主节点包含一个污点， 污点包含了一个 key、value，以及一个 effect，表现为 <key>=<value>：<effect>。 上面显示的主节点的污点信息， 包含一个为node- role.kubernetes.io/master 的 key， 一个空的 value，以及值为 NoSchedule  的 effect。<br>这个污点将阻止 pod 调度到这个节点上面， 除非有 pod 能容忍这个污点，而通 常容忍这个污点的 pod 都是系统级别 pod （见图 16.1）。 </effect></value></key></p>
<p>图16.1一个pod只有容忍了节点的污点，才能被调度到该节点上面<br>显示pod的污点容忍度<br>在一个通过kubeadm初始化的集群中，kube-proxy集群组件以pod的形式运行在每个节点上，其中也包括主节点。因为以pod形式运行的主节点组件同时也需要访问Kubernetes服务。为了确保kube-proxy pod也能够运行在主节点上，该pod需要添加相应的污点容忍度。该pod整体包含了3个污点容忍度，如以下代码清单所示。<br>代码清单16.2一个pod的污点容忍度<br>$ kubectl describe po kube-proxy- 80wqm -n kube- sys tem<br>Tolerations : node - role . kubernetes . io/ master= :NoSchedule<br>node . alpha .kubernetes . io/notReady= :Exists :NoExecute<br>，..<br>如你所见，第一个污点容忍度匹配了主节点的污点，表示允许这个kube- proxypod被调度到主节点上。<br>注意尽管在pod的污点容忍度中显示了等号，但是在节点的污点信息中却没有。当污点或者污点容忍度中的value为null时，kubectl 故意将污点和污点容忍度进行不同形式的显示。</p>
<p>了解污点的效果<br>另外两个在kube-proxy pod上的污点定义了当节点状态是没有ready或者是 unreachable时，该pod允许运行在该节点多长时间（时间用秒来表示，这里没有显示，但是在podYAML中可以看到）。这两个污点容忍度使用的效果是NoExecute而不是NoSchedule.<br>每一个污点都可以关联一个效果，效果包含了以下三种：<br> NoSchedule表示如果pod没有容忍这些污点，pod则不能被调度到包含这些污点的节点上。<br> PreferNoSchedule是NoSchedule的一个宽松的版本，表示尽量阻止pod被调度到这个节点上，但是如果没有其他节点可以调度，pod依然会被调度到这个节点上。<br>NoExecute不同于NoSchedule以及PreferNoSchedule，后两者只在调度期间起作用，而NoExecute也会影响正在节点上运行着的pod。如果在一个节点上添加了NoExecute污点，那些在该节点上运行着的pod，如果没有容忍这个NoExecute污点，将会从这个节点去除。<br>16.1.2在节点上添加自定义污点<br>假设你有一个单独的Kubermetes集群，上面同时有生产环境和非生产环境的流量。其中最重要的一点是，非生产环境的pod不能运行在生产环境的节点上。可以通过在生产环境的节点上添加污点来满足这个要求，可以使用kubectltaint命令来添加污点：<br>$ kubectl taint node nodel.k8g node-type=production: NoSchedule<br>node “nodel.k8s” tainted<br>这个命令添加了一个taint，其中，key为node-type， value为production，效果为NoSchedule。如果现在你部署一个常规pod的多个副本，你会发现没有一个pod被部署到你添加了污点信息的节点上面，如以下代码清单所示。<br>代码清单16.3部署没有污点容忍度的pod</p>
<p>现在，没人能够随意地将pod部署到生产环境节点上了。<br>16.1.3 在pod，上添加污点容忍度<br>为了将生产环境pod部署到生成环境节点上，pod需要能容忍那些你添加在节点上的污点。你的生产环境pod的清单里面需要增加以下的YAML代码片段。<br>代码清单16.4标记污点容 忍度的生产环境部署： production-deployment.yam</p>
<p>如果运行了这个部署，你将看到pod就会被调度到生产环境节点，如以下代码清单所示。<br>代码清单16.5包含污 点容忍度的pod被调度到生产环境节点node1<br>$ kubectl get po -。wide<br>NAME<br>READY STATUS<br>RESTARTS<br>AGE IP<br>NODE<br>prod- 350605-1ph5h 0/1 prod-350605-ctqcr 1/1 prod- 350605- f 7pcc 0/ ] prod- 350605-k7c8g 1/1 prod- 350605-rplnv 0/1<br>Running Running Running Running Running<br>16s 10.44.0.3 node1.k8s<br>16s 1 7s 17 s 17s<br>10.47.0.4 node2 .k8s 10.44.0.6 node1.k8s 10.47.0.9 node2.k8s 10.44.0.4 node1 .k8s<br>0<br>正如你所见，生产环境pod也被调度到了非生产环境node2。为了防止这种情况发生，你也需要在非生产环境的节点设置污点信息，例如node-type=non-production： NoSchedule。那么，你也需要在非生产环境pod.上添加了对应的污点容忍度。<br>16.1.4 了解污点和污点容忍度的使用场景<br>节点可以拥有多个污点信息，而pod也可以有多个污点容忍度。正如你所见，污点可以只有一个key和一个效果，而不必设置valuc。污点容忍度可以通过设置</p>
<p>Equal操作符Equal操作符来指定匹配的value（默认情况下的操作符），或者也可以通过设置Exists操作符来匹配污点的key。<br>在调度时使用污点和容忍度<br>污点可以用来组织新pod的调度（使用NoSchedule效果），或者定义非优先调度的节点（使用PreferNoSchedule效果），甚至是将已有的pod从当前节点剔除。<br>可以用任何你觉得合适的方式去设置污点和容忍度。例如，可以将一个集群分成多个部分，只允许开发团队将pod调度到他们特定的节点上。当你的部分节点提供了某种特殊硬件，并且只有部分pod需要使用到这些硬件的时候，也可以通过设置污点和容忍度的方式来实现。<br>配置节点失效之后的pod重新调度最长等待时间<br>你也可以配置一个容忍度，用于当某个pod运行所在的节点变成unready或者 unr eachable状态时，Kubemetes可以等待该pod被调度到其他节点的最长等待时间。如果查看其中一个pod的容忍度信息，你将看到两条容忍度信息，如以下代码清单所示。<br>代码清单16.6带有默认容忍度的pod</p>
<p>这两个容忍度表示，该pod将容忍所在节点处于notReady或者unreachable状态维持300秒。当Kubernetes控制器检测到有节点处于notReady或者unreachable状态时，将会等待300秒，如果状态持续的话，之后将把该pod重新调度到其他节点上。<br>当没有定义这两个容忍度时，他们会自动添加到pod上。如果你觉得对于你的pod来说，5分钟太长的话，可以在pod描述中显式地将这两个容忍度设置得更短一些。<br>注意当前这是一个alpha阶段的特性，在未来的Kubernetes版本中可能会有所改变。基于污点信息的pod剔除也不是默认启用的，如果要启用这个特性，需要在</p>
<p>运行控制器管理器时使用—feature-gates=TaintBasedEvictions=true选项。<br>16.2 使用节点亲缘性将pod调度到特定节点上<br>正如你目前所学到的，污点可以用来让pod远离特定的几点。现在，你将学习一种更新的机制，叫作节点亲缘性（node afinity），这种机制允许你通知Kubernetes将pod只调度到某个几点子集上面。<br>对比节点亲缘性和节点选择器<br>在早期版本的Kubernetes中，初始的节点亲缘性机制，就是pod描述中的nodeSelector字段。节点必须包含所有pod对应字段中的指定label，才能成为pod调度的目标节点。<br>节点选择器实现简单，但是它不能满足你的所有需求。正因为如此，一种更强大的机制被引入。节点选择器最终会被弃用，所以现在了解新的节点亲缘性机制就变得重要起来。<br>与节点选择器类似，每个pod可以定义自己的节点亲缘性规则。这些规则可以允许你指定硬性限制或者偏好。如果指定一种偏好的话，你将告知Kubermetes对于某个特定的pod，它更倾向于调度到某些节点上，之后Kuberetes将尽量把这个 pod调度到这些节点上面。如果没法实现的话，pod将被调度到其他某个节点上。 检查默认的节点标签<br>节点亲缘性根据节点的标签来进行选择，这点跟节点选择器是一致的。当你了解到如何使用节点亲缘性之后，让我们来检查下一个Google Kubernetes引擎集群（GKE）中节点的标签，来看一下它们默认的标签是什么，如以下代码清单所示。<br>代码清单16.7GKE节点的默认标签</p>
<p>这个节点有很多标签，但涉及节点亲缘性和 pod 亲缘性时，最后三个标签是最 重要的。我们将在稍后学到， 这三个标签的含义如下：<br>failure-domain.beta.kubernetes.io/region 表示该节点所在的地理地域。<br>· failure-domain.beta.kubernetes io/zone 表示该节点所在的可用性区域（availability zone）。<br>kubernetes.io/hostname 很显然是该节点的主机名。<br>这三个以及其他标签， 将被用于 pod 亲缘性规则。在第三章中， 你已经学会如何给一个节点添加自定义标签，并且在 pod 的节点选择器中使用它。可以通过给  pod 加上节点选择器的方式， 将节点部署到含有这个自定义标签的节点上。 现在， 你将学习到怎么用节点亲缘性规则实现 同样的功能。<br>16.2.1 指定强制性节点亲缘性规则<br>在第3章的例子中， 使用了节点选择器使得需要 GPU 的 pod 只被调度到有GPU的节点上。包含了 nodeSelector字段的 pod 描述如以下代码清单所示。<br>代码清单16.8使用了节点选择器的 pod： kubia-gpu-nodeselector.yaml </p>
<p>nodeSelector字段表示， pod只能被部署在包含了gpu=true 标签的节点上。 如果你将节点选择器替换为节点亲缘性规则，pod定义将会如以下代码清单所示。<br>代码清单16.9使用了节点亲缘性规则的pod ： kubia-gpu-nodeafinity yaml </p>
<p>首先你会注意到的是，这种写法比简单的节点选择器要复杂得多，但这是因为它的表达能力更强，让我们再详细看一下这个规则。<br>较长的节点亲缘性属性名的意义<br>正如你所看到的，这个pod的描述包含了affinity字段，该字段又包含了 nodeAffinity字段，这个字段有一个极其长的名字，所以，让我们先重点关注这个。 让我们把这个名字分成两部分，然后分别看下它们的含义：<br>requiredDuringScheduling…表明了该字段下定义的规则，为了让pod能调度到该节点上，明确指出了该节点必须包含的标签。<br>… IgnoredDur ingExecution表明了该字段下定义的规则，不会影响已经在节点.上运行着的pod。<br>目前，当你知道当前的亲缘性规则只会影响正在被调度的pod，并且不会导致已经在运行的pod被剔除时，情况可能会更简单一些。这就是为什么目前的规则都是以IgnoredDuringExecution结尾的。最终，Kubernetes 也会支持Requi redDuringExecution，表示如果去除掉节点上的某个标签，那些需要节点包含该标签的pod将会被剔除。正如笔者所说，Kubernetes 目前还不支持次特性。所以，我们可以暂时不去关心这个长字段的第二部分。<br>了解节点选择器条件<br>记住上一节所解释的内容，我们将更容易理解nodeSelectorTerms和 matchExpressions字段，这两个字段定义了节点的标签必须满足哪一种表达式，才能满足pod调度的条件。样例中的单个表达式比较容易理解，节点必须包含—个叫作gpu的标签，并且这个标签的值必须是true。<br>因此，这个pod只会被调度到包含gpu=true的节点上，如图16.2所示。<br>现在，更有趣的部分来了，节点亲缘性也可以在调度时指定节点的优先级，我们将在接下来的部分看到。</p>
<p>图16.2一个pod的节点亲缘性指定了节点必须包含哪些标签才能满足pod调度的条件<br>16.2.2调度pod时优先考虑某些节点<br>最近介绍的节点亲缘性的最大好处就是，当调度某一个pod时，指定调度器可以优先考虑哪些节点，这个功能是通过preferredDuringSchedulingIgnoredDuringExecution字段来实现的。<br>想象一下你拥有一个跨越多个国家的多个数据中心，每一个数据中心代表了一个单独的可用性区域。在每个区域中，你有一些特定的机器，只提供给你自己或者你的合作公司使用。现在，你想要部署一些pod，希望将pod优先部署在区域zone1，并且是为你公司部署预留的机器上。如果你的机器没有足够的空间用于这些pod，或者出于其他一些重要的原因不希望这些pod调度到上面，那么就会调度到其他区域的其他机器上面，这种情况你也是可以接受的。节点亲缘性就可以实现这样的功能。<br>给节点加上标签<br>首先，节点必须加上合适的标签。每个节点需要包含两个标签，一个用于表示所在的这个节点所归属的可用性区域，另一个用于表示这是一个独占的节点还是一个共享的节点。<br>附录B解释了如何在本地VM中设置一个三个节点的集群（一个主节点和两个工作节点）。在接下来的例子中，笔者将使用这个集群中的两个工作节点，当然你也可以使用GKE或者其他多节点的集群。</p>
<p>注意Minikube并不是运行这些例子的最佳选择，因为它只运行了一个节点。首先，给这些节点加上标签，如以下代码清单所示。<br>代码清单16.10给节点加上标签<br>$ kubectl label node nodel.k8s availability-zone=zonel<br>node”nodel.k8su labeled<br>$ kubectl label node nodel.k8s share-type=dedicated<br>node”nodel.k8s labeled<br>$ kubectl label node node2.k8s availability-zone=zone2 node”node2.k8s” labeled<br>$ kubectl label node node2.k8g share-type=shared<br>node”node2.k8s” labeled<br>$ kubectl get node -L availability-zone -L share-type<br>NAME<br>STATUS<br>AGE<br>VERSION AVAILABILITY-ZONE<br>SHARE-TYPE cnone&gt;<br>master.k8s<br>Ready<br>4d<br>v1.6.4<br>cnone&gt;<br>nodel.k8s<br>Ready<br>4d<br>v1.6.4<br>zonel<br>dedicated ghared<br>node2.k8s<br>Ready<br>4d<br>v1.6.4<br>zone2<br>指定优先级节点亲缘性规则<br>当这些节点的标签设置好，现在可以创建一个Deployment，其中优先选择zone1中的dedicated节点。下面的代码清单显示了这个Deployment的描述。<br>代码清单16.11含有优先级节点亲缘性规则的Deployment： preferred-deployment.yaml</p>
<p>让我们仔细查看上面的代码清单，你定义了一个节点亲缘性优先级，而不是强制要求。你想要pod被调度到包含标签availability-zone=zone1以及share- type=dedicated的节点上。第一个优先级规则是相对重要的，因此将其weight设置为80，而第二个优先级规则就不那么重要（weight 设置为20）。<br>了解节点优先级是如何工作的<br>如果你的集群包含多个节点，当调度，上面的代码清单中的Deploymentpod时，节点将会分成4个组，如图16.3所示。那些包含availability-zone以及 share-type标签，并且匹配pod亲缘性的节点，将排在最前面。然后，由于pod的节点亲缘性规则配置的权重，接下来是zone1的shared节点，然后是其他区域的dedicated节点，优先级最低的是剩下的其他节点。</p>
<p>以几儿心<br>图16.3基于pod节点亲缘性优先级对节点进行排序<br>在一个包含两个节点的集群中部署节点<br>如果你在一个包含两个节点的集群中创建该部署，你看到的最多的应该是pod被部署在了node1上面。检查下面的代码清单看情况是否属实。<br>16.3使用pod亲缘性与非亲缘性对pod进行协同部署<br>475<br>代码清单16.12查看pod调度情况</p>
<p>5个pod被创建，其中4个部署在了node1，1个部署在了node2。为什么会有1个pod会被调度到node2而不是node1？原因是除了节点亲缘性的优先级函数，调度器还是使用其他的优先级函数来决定节点被调度到哪。其中之一就是selector SpreadPriority函数，这个函数确保了属于同一个ReplicaSet或者 Service的pod，将分散部署在不同节点上，以避免单个节点失效导致这个服务也宕机。 这就是有1个pod被调度到node2的最大可能。<br>可以去试着扩容部署至20个实例或更多，你将看到大多数的pod被调度到nodel。在笔者的测试中，20个实例只有2个被调度到了node2。如果你没有设置任何节点亲缘性优先级，pod将会被均匀地分配在两个节点上面。<br>16.3使用pod亲缘性与非亲缘性对pod进行协同部署<br>你已经了解了节点亲缘性规则是如何影响pod被调度到哪个节点。但是，这些规则只影响了pod和节点之间的亲缘性。然而，有些时候你也希望能有能力指定pod自身之间的亲缘性。<br>举例来说，想象一下你有一个前端pod和一个后端pod，将这些节点部署得比较靠近，可以降低延时，提高应用的性能。可以使用节点亲缘性规则来确保这两个pod被调度到同一个节点、同一个机架、同一个数据中心。但是，之后还需要指定调度到具体哪个节点、哪个机架或者哪个数据中心。因此，这不是一个最佳的解决方案。更好的做法应该是，让Kubernetes将你的pod部署在任何它觉得合适的地方，同时确保2个pod是靠近的。这种功能可以通过pod亲缘性来实现，让我们从一个例子来了解更多吧。<br>16.3.1使用pod间亲缘性将多个pod部署在同一个节点上<br>你将部署1个后端pod和5个包含pod亲缘性配置的前端pod实例，使得这些前端实例将被部署在后端pod所在的同一个节点上。<br>首先，我们来部署后端pod：</p>
<p>该部署并没有什么特别的，唯一需要注意的是通过-l选项添加的app=backend标签，这个标签将在前端pod的podAffinity配置中使用到。<br>在pod定义中指定pod亲缘性<br>前端pod的描述如以下代码清单所示。<br>代码清单16.13使用podAffinity的pod：frontend-podafinity-host.yaml</p>
<p>代码清单显示了，该部署将创建包含强制性要求的pod，其中要求pod将被调度到和其他包含app=backend标签的pod所在的相同节点上（通过topologyKey字段指定），如图16.4 所示。</p>
<p>注意 除了使用简单的matchLabels字段，也可以使用表达能力更强的 matchExpressions 字段。<br>部署包含 pod 亲缘性的 pod<br>在你创建此次部署之前， 让我们先来看一下之前的后端pod 被调度到了哪个节点上：<br>$ kubectl get po -o wide<br>NAME<br>READY STATUS RESTARTS AGE IP<br>NODE<br>backend-257820-qhqj6<br>1/1 Running 0<br>8m 10.47.0.1 node2.k8s<br>当你创建前端 pod 时， 它们应该也会被调度到 node2 上。 接着你开始创建 Deployment，然后看 pod 被调度到了哪里。 结果显示在下面的代码清单中。<br>代码清单 16.14部署前端pod，观察pod 被调度到哪些节点</p>
<p>所有的前端pod确实都被调度到了和后端pod相同的节点上。当调度前端pod时，调度器首先找出所有匹配前端pod的podAffinity配置中labelSelector的pod，之后将前端pod调度到相同的节点上。<br>了解调度器如何使用pod亲缘性规则<br>有趣的是，如果现在你删除了后端pod，调度器会将该pod调度到node2，即便后端pod本身没有定义任何pod亲缘性规则（只有前端pod设置了规则）。这种情况很合理，因为假设后端pod被误删除而被调度到其他节点上，前端pod的亲缘性规则就被打破了。<br>如果增加调度器的日志级别检查它的日志的话，可以确定调度器是会考虑其他pod的亲缘性规则的。下面的代码清单显示了相关的日志。</p>
<p>如果你关注加粗的两行日志， 你会发现当调度后端 pod 时， 由于 pod 间亲缘性，node2 获得了比 node1 更高的分数。<br>16.3.2 将 pod 部署在同一机柜、 可用性区域或者地理地域<br>在前面的例子中，使用了 podAffinity 将前端 pod 和后端 pod 部署在了同一个节点上。你可能不希望所有的前端 pod 都部署在同一个节点上，但仍希望和后端 pod 保持足够近， 比如在同一个可用性区域中。<br>在同一个可用性区域中协同部署 pod<br>笔者正在使用的集群运行在本机的三个虚拟机中， 因此可以说所有节点都运行在同一个可用性区域中。但是， 如果这些节点运行在不同的可用性区域中， 那么需要将topologyKey 属性设置为 failure-domain.beta.kubernetes.io/zone，以确保前端 pod 和后端 pod 运行在同一个可用性区域中。<br>在同一个地域中协同部署 pod<br>为了允许你将 pod 部署在同一个地域而不是区域内 （云服务提供商通常拥有多个地理地域的数据中心， 每个地理地域会被划分成多个可用性区域），那么需要将 topologyKey 属性设置为 failure-domain.beta kubernetes.io/region。<br>了解topologyKey是如何工作的<br>topologyKey 的工作方式很简单， 目前我们提到的 3 个键并没有什么特别的。 如果你愿意，可以任意设置自定义的键，例如 rack， 为了让 pod 能部署到同一个机柜。 唯一的前置条件就是，在你的节点上加上 rack 标签。这种场景将在图 16.5 中进行 展示。</p>
<p>举例来说，你有20个节点，每10个节点在同一个机柜中，你将前10个节点加上标签rack=rack1，另外10个加上标签rack=rack2。接着，当定义pod的podAffi nity时，将toplogyKey设置为rack。<br>当调度器决定pod调度到哪里时，它首先检查pod的podAffinity配置，找出那些符合标签选择器的pod，接着查询这些pod运行在哪些节点上。特别的是，它会寻找标签能匹配podAffinity配置中topologyKey的节点。接着，它会优先选择所有的标签匹配pod的值的节点。在图16.5中，标签选择器匹配了运行在 Node12的后端pod，那个节点rack标签的值等于rack2。所以，当调度1个前端pod时，调度器只会在包含标签rack=rack2的节点中进行选择。<br>注意在调度时，默认情况下，标签选择器只有匹配同一命名空间中的pod。但是，可以通过在labelSelector同一级添加namespaces字段，实现从其他的命名空间选择pod的功能。</p>
<p>图 16.5 podAffinity 中的 topologyKey决定了 pod 被调度的范围<br>16.3.3 表达 pod 亲缘性优先级取代强制性要求<br>较早的篇幅，我们谈论了节点亲缘性， 你了解了 nodeAffi nity 可以表示一种 强制性要求，表示 pod 只能被调度到符合节点亲缘性规则的节点上。它也可以表示一种节点优先级，用于告知调度器将 pod 调度到某些节点上，同时也满足当这些节 点出于各种原因无法满足 pod 要求时，将 pod 调度到其他节点上。<br>480<br>16高级调度<br>这种特性同样适用于 podAffinity， 你可以告诉调度器，优先将前端pod调度 到和后端pod相同的节点上， 但是如果不满足需求， 调度到其他节点上也是可以的。一个使用了 preferredDuringSchedulingIgnoredDuringExecutionpod亲缘性规则的 Deployment 的样例如以下代码清单所示。<br>代码清单.16.16pod 亲缘性优先级</p>
<p>跟 nodeAffinity优先级规则一样，需要为一个规则设置一个权重。同时也需<br>要设置 topologyKey 和 labelSelector,正如 podAffinity规则中的强制性<br>要求一样。图16.6展示了这种场景。</p>
<p>图16.6pod亲缘性可以用来告知调度器优先考虑那些有包含某些标签的pod正在运行着的节点<br>16.3使用pod亲缘性 与非亲缘性对pod进行协同部署<br>481<br>正如nodeAffinity样例，部署将4个pod调度到和后端pod -样的节点，另外一个调度到了其他节点（ 如下面的代码清单所示）。<br>代码清单16.17使用podAffinity优先级的pod部署</p>
<p>16.3.4 利用 pod 的非亲缘性分开调度 pod<br>你现在已经知道了如何告诉调度器对 pod 进行协同部署，但有时候你的需求却 恰恰相反，你可能希望 pod 远离彼此。 这种特性叫作 pod 非亲缘性。 它和pod亲缘性的表示方式一样，只不过是将 podAffinity 字段换成 podAntiAffinity，这将导致调度器永远不会选择那些有包含 podAntiAffinity 匹配标签的 pod 所在的节 点，如图 16.7 所示。</p>
<p>图16.7使用pod非亲缘性使得pod原理包含某些标签pod所在的节点<br>一个为什么需要使用pod非亲缘性的例子，就是当两个集合的pod，如果运行在同一个节点上会影响彼此的性能。在这种情况下，你需要告知调度器永远不要将这些pod部署在同一个节点上。另一个例子是强制让调度器将同一组的pod分在在<br>482<br>16 高级调度<br>不同的可用性区域或者地域，这样让整个区域或地域失效之后，不会使得整个服务完全不可用。<br>使用非亲缘性分散一个部署中的pod<br>让我们来看一下如何强制前端pod被调度到不同节点上。下面的代码清单展示了pod的非亲缘性是如何配置的。<br>代码清单16.18包含非 亲缘性的pod ： frontend. podantiaffinity hostyaml</p>
<p>这次，你需要定义podAntiAffinity而不是podAffinity，并且将labelselector和Deployment创建的pod匹配。让我们看一下当创建了该Deployment之后会发生什么，创建的pod如下面的代码清单所示。<br>代码清单16.19 Deployment 创建的pod</p>
<p>正如你所见，只有2个pod被调度，一个在 node1 上，另一个在 node2上。<br>剩下的3个pod均处于Pending状态，因为调度器不允许这些pod调度到同一个<br>节点上。</p>
<p>理解pod非亲缘性优先级<br>在这种情况下，你可能应该制定软性要求（使用preferredDuringSchedulingIgnoredDuringExecution字段）。毕竟，如果有2个前端pod运行在同一个节点上也不是什么大问题。但是如果运行在同一个节点上会造成问题的场景下，使用requiredDuringScheduling就比较合适了。<br>与使用pod亲缘性一样，topologyKey字段决定了pod不能被调度的范围。可以使用这个字段决定pod不能被调度到同一个机柜、可用性区域、地域，或者任何你创建的自定义节点标签标示的范围。<br>16.4本章小结<br>在本章中，我们了解了如何通过节点的标签或是上面运行的pod，保证不把pod调度到某个节点上，或者只把pod调度到特定节点上。<br>·如果你在节点上添加了1个污点信息，除非pod容忍这些污点，否则pod不会被调度到该节点上。<br>·有3种污点类型：NoSchedule完全阻止调度，PreferNoSchedule不强制阻止调度，NoExecute会将已经在运行的pod从节点上剔除。<br>NoExecute污点同时还可以设置，当pod运行的节点变成unreachable 或者unready状态，pod需要重新调度时，控制面板的最长等待时间。<br>节点亲缘性允许你去指定pod应该被调度到哪些节点上。它可以被用作一种强制性要求，也可以作为一种节点的优先级。<br>pod亲缘性被用于告知调度器将pod调度到和另一个pod相同的一节点（基于pod的标签）上。<br>pod亲缘性的topologyKey表示了被调度的pod和另一个pod的距离（在同一个节点、同一个机柜、同一个可用性局域或者可用性地域）。<br>·pod非亲缘性可以被用于将pod调度到远离某些pod的节点。<br>和节点亲缘性一样，pod亲缘性和非亲缘性可以设置是强制性要求还是优先选择。<br>在下一章，你将学习在Kubernetes环境中开发应用，以及将应用平滑运行的最佳实践。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Kubernetes-in-Action/" rel="tag"># Kubernetes in Action</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/10/01/15-自动横向伸缩pod与集群节点/" rel="next" title="15-自动横向伸缩pod与集群节点">
                <i class="fa fa-chevron-left"></i> 15-自动横向伸缩pod与集群节点
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/10/01/17-开发应用的最佳实践/" rel="prev" title="17-开发应用的最佳实践">
                17-开发应用的最佳实践 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="CheBin">
            
              <p class="site-author-name" itemprop="name">CheBin</p>
              <div class="site-description motion-element" itemprop="description">学如逆水行舟，不进则退</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">727</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">16</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">56</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          


          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/2022/10/25/企业微信源码/" title="企业微信源码" target="_blank">企业微信源码</a>
                  </li>
                
                  <li>
                    <a href="/2022/10/10/结课测试-这些Go语言的知识你都掌握了吗？/" title="结课测试 | 这些Go语言的知识你都掌握了吗？" target="_blank">结课测试 | 这些Go语言的知识你都掌握了吗？</a>
                  </li>
                
                  <li>
                    <a href="/2022/10/10/49-程序性能分析基础（下）/" title="49 | 程序性能分析基础（下）" target="_blank">49 | 程序性能分析基础（下）</a>
                  </li>
                
                  <li>
                    <a href="/2022/10/10/48-程序性能分析基础（上）/" title="48 | 程序性能分析基础（上）" target="_blank">48 | 程序性能分析基础（上）</a>
                  </li>
                
                  <li>
                    <a href="/2022/10/10/47-基于HTTP协议的网络服务/" title="47 | 基于HTTP协议的网络服务" target="_blank">47 | 基于HTTP协议的网络服务</a>
                  </li>
                
              </ul>
            </div>
        

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2022</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CheBin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">6.6m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">99:59</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
