<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">
<meta name="keywords" content="Kubernetes in Action">
<meta property="og:type" content="article">
<meta property="og:title" content="8-从应用访问pod元数据以及其他资源">
<meta property="og:url" content="http://yoursite.com/2022/10/01/8-从应用访问pod元数据以及其他资源/index.html">
<meta property="og:site_name" content="车斌的技术博客">
<meta property="og:description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2022-10-04T02:15:14.256Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="8-从应用访问pod元数据以及其他资源">
<meta name="twitter:description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">






  <link rel="canonical" href="http://yoursite.com/2022/10/01/8-从应用访问pod元数据以及其他资源/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>8-从应用访问pod元数据以及其他资源 | 车斌的技术博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">放弃会成为一种习惯</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/10/01/8-从应用访问pod元数据以及其他资源/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CheBin">
      <meta itemprop="description" content="什么是强迫自己？就是不想去干什么，就去干什么">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">8-从应用访问pod元数据以及其他资源

              
            
          </h1>
        

        <div class="post-meta">

          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2022-10-01 10:08:41" itemprop="dateCreated datePublished" datetime="2022-10-01T10:08:41+08:00">2022-10-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2022-10-04 10:15:14" itemprop="dateModified" datetime="2022-10-04T10:15:14+08:00">2022-10-04</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">16k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">14 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考并回答以下问题：</p>
<ul>
<li>总结一下，这章作者最主要想表达什么观点？</li>
</ul>
<a id="more"></a>
<p>本章内容涵盖<br>1通过DownwardAPI传递信息到容器<br>探索Kubernetes REST API<br>把授权和服务器验证交给kubectl proxy<br>■从容器内部访问API服务器<br>理解ambassador容器模式<br>■使用 Kubernetes客户端库<br>应用往往需要获取所运行环境的一些信息，包括应用自身以及集群中其他组件的信息。我们已经了解到Kubernetes如何通过环境变量以及DNS进行服务发现，但其他信息如何处理呢？在本章，我们将了解特定的pod和容器元数据如何被传递到容器，了解在容器中运行的应用如何便捷地与KubernetesAPI服务器进行交互，从而获取在集群中部署资源的信息，并且进一步了解如何创建和修改这些资源。<br>8.1通过Downward API传递元数据<br>在之前的章节中，我们已经了解到如何通过环境变量或者configMap和secret卷向应用传递配置数据。这对于pod调度、运行前预设的数据是可行的。</p>
<p>但是对于那些不能预先知道的数据，比如pod的IP、主机名或者是pod自身的名称 （当名称被生成，比如当pod通过ReplicaSet或类似的控制器生成时）呢？此外，对于那些已经在别处定义的数据，比如pod的标签和注解呢？我们不想在多个地方重复保留同样的数据。<br>对于此类问题，可以通过使用Kubernetes Downward API解决。Downward API允许我们通过环境变量或者文件（在downwardAPI卷中）的传递pod的元数据。不要对这个名称产生困惑，Downward API的方式并不像REST endpoint那样需要通过访问的方式获取数据。这种方式主要是将在pod的定义和状态中取得的数据作为环境变量和文件的值，如图8.1所示。</p>
<p>图8.1Downward APl通过环境变量或者文件对外暴露pod元数据<br>8.1.1 了解可用的元数据<br>Downward API可以给在pod中运行的进程暴露pod的元数据。目前我们可以给容器传递以下数据：<br>pod的名称<br>‘pod的IP<br>“pod所在的命名空间<br>pod运行节点的名称<br>‘pod运行所归属的服务账户的名称<br>·每个容器请求的CPU和内存的使用量</p>
<p>，每个容器可以使用的CPU和内存的限制<br>·pod的标签<br>pod 的注解<br>这个清单中所列举的大部分项目，除了还没有讲到的服务账户、CPU和内存的请求和限制概念，其他都无须进一步解释。我们将在第12章详细讲解服务账户。现在，你只需了解，服务账户是pod访问API服务器时用来进行身份验证的账户。CPU和内存的请求和限制将在第14章进行说明，它们代表了分配给-个容器的CPU和内存的使用量，以及一个容器可以分配的上限。<br>列表中的大部分项目既可以通过环境变量也可以通过downwardAPI卷传递给容器，但是标签和注解只可以通过卷暴露。部分数据可以通过其他方式获取（例如，可以直接从操作系统获取），但是Downward API提供了-种更加便捷的方式。<br>让我们来看一个向容器化的进程传递元数据的例子。<br>8.1.2 通过环境变量暴露元数据<br>首先，我们来了解如何通过环境变量的方式将pod和容器的元数据传递到容器中。我们根据如下列出的manifest创建一个简单的单容器。<br>代码清单8.1在环境变 量中使用downward API： downward-api- envyaml</p>
<p>当我们的进程在运行时， 它可以获取所有我们在 pod 的定义文件中设定的环境变量。图 8-2 展示了所有的环境变量以及变量值的来源。pod的名称、 IP和命名空间可以通过 pod_NAME、pod_IP 和 pod_ NAMESPACE 这几个环境变量分别暴露。 容器运行的节点的名称可以通过NODE_ NAME 变量暴露。同样， 服务账户可以使用环境变量 SERVICE_ACCOUNT。 我们也可以创建两个环境变量来保存容器请求使用的 CPU 的数量， 以及容器被最大允许使用的内存数量。<br>对于暴露资源请求和使用限制的环境变量， 我们会设定一个基数单位。实际的资源请求值和限制值除以这个基数单位， 所得的结果通过环境变量暴露出去。在 前面的例子中，我们设定 CPU 请求的基数为 1m（即 1 millicore， 也就是千分之一核 CPU）。当我们设置资源请求为 15m 时， 环境变量 CONTAINER_CPU_REQUEST_  MILLICORES 的值就是 15。同样， 我们设定内存的使用限制为4Mi（4 mebibytes） ， 设 定 基 数 为 1 Ki（1 Kibibyte），则 环 境 变 量 CONTAINER_ MEMORY_LIMIT KIBIBYTES 的值就是 4096。</p>
<p>图8.2 pod 元数据与属性通过环境变量暴露给pod<br>对于CPU资源请求量和使用限制可以被设定为1，也就意味着整颗CPU的计算能力，也可以设定为1m，即千分之一核的计算能力。对于内存的资源请求和使用限制可以设定为1 （字节），也可以是1k（kilobute）或1Ki （kibibute）， 同样也可以设为1M （megavyte）或者1Mi（mebibyte）， 等等。<br>在完成创建pod后，我们可以使用kubectlexec命令来查看容器中的所有环境变量，如下面的代码清单所示。<br>代码清单8.2 downward pod中的环境变量</p>
<p>8.1.3 通过downwardAPI卷来传递元数据<br>如果更倾向于使用文件的方式而不是环境变量的方式暴露元数据，可以定义一个downwardAPI卷并挂载到容器中。由于不能通过环境变量暴露，所以必须使用downwardAPI卷来暴露pod标签或注解。我们将摘后将讨论原因。<br>与环境变量一样，需要显示地指定元器据字段来暴露份进程。下面我们将把前面的示例从使用环境变量修改为使用存储卷，如下面的代码清单所示。<br>代码清单8.3一 个带有dowanwardAPI卷的pod示例：dowanward-api-volume.yaml</p>
<p>现在我们没有通过环境变量来传递元数据，而是定义了一个叫作downward的卷，并且通过/etc/downward目录挂载到我们的容器中。卷所包含的文件会通过卷定义中的downwardAPI.items属性来定义。<br>对于我们想要在文件中保存的每一个pod级的字段或者容器资源字段，都分别在downwardAPI.items中说明了元数据被保存和引用的path（文件名），如图8.3所示。</p>
<p>图8.3 使用 dowanward API 卷来传递元数据<br>从之前列表的 manifest 中删除原来的 pod， 并且新建一个 pod。然后查看已挂载 到 downwardAPI 卷目录的内容， 存储卷被挂载在 /etc/downward/目录下， 列出目<br>(<br>236<br>8从应用访问pod元数据以及其他资源<br>录中的文件，如下面的代码清单所示。<br>代码清单8.4r.downwordAPI 卷中的文件</p>
<p>注意与configMAp和secret卷一样，可以通过pod定义中downwardAPI卷的defaultMode属性来改变文件的访问权限设置。<br>每个文件都对应了卷定义中的一项。文件的内容与之前例子中的元数据字段和值，这里不再重复展示。不过由于不能通过环境变量的方式暴露label和annotation，所以看一下我们暴露的这两个文件的代码清单。<br>代码清单8.5展示downwardARB卷中的标签和注解</p>
<p>正如我们上面看到的， 每一个标签和注解都以 key=value 的格式保存在单独的行中，如对应多个值，则写在同一行， 并且用回车符\n连接。<br>修改标签和注解<br>可以在 pod 运行时修改标签和注解。 如我们所愿，当标签和注解被修改后，  Kubernetes 会更新存有相关信息的文件， 从而使 pod 可以获取最新的数据。这也解 释了为什么不能通过环境变量的方式暴露标签和注解，在环境变量方式下， 一旦标签和注解被修改，新的值将无法暴露。<br>在卷的定义中引用容器级的元数据<br>在结束这一部分的内容之前， 需要说明一点，当暴露容器级的元数据时， 如容器可使用的资源限制或者资源请求 使用字段 resourceFieldRef）， 必须指定引用资源字段对应的容器名称， 如下面的代码清单所示。<br>8.2 与Kubernetes API服务器交互<br>237<br>代码清单8.6在downwardAPI 卷中引用容器级的元数据 </p>
<p>这样做的理由很明显，因为我们对于卷的定义是基于pod级的，而不是容器级的。当我们引用卷定义某一个容器的资源字段时，我们需要明确说明引用的容器的名称。这个规则对于只包含单容器的pod同样适用。<br>使用卷的方式来暴露容器的资源请求和使用限制比环境变量的方式稍显复杂，但好处是如果有必要，可以传递一个容器的资源字段到另一个容器（当然两个容器必须处于同一个pod）。使用环境变量的方式，-个容器只能传递它自身资源申请求和限制的信息。<br>何时使用Dowanward API方式<br>正如我们看到的，DownwardAPI方式并不复杂，它使得应用独立于 Kubermetes。这一点在处理部分数据已在环境变量中的现有应用时特别有用。DownwardAPI方式使得我们不必通过修改应用，或者使用shell脚本获取数据再传递给环境变量的方式来暴露数据。<br>不过通过DownwardAPI的方式获取的元数据是相当有限的，如果需要获取更多的元数据，需要使用直接访问Kubermetes API服务器的方式。我们将在接下来的部分了解这种方式。<br>8.2 与Kubernetes API服务器交互<br>我们已经知道，DownwardAPI提供了一种简单的方式，将pod和容器的元数据传递给在它们内部运行的进程。但这种方式其实仅仅可以暴露一个pod自身的元数据，而且只可以暴露部分元数据。某些情况下，我们的应用需要知道其他pod的信息，甚至是集群中其他资源的信息。这种情况下DownwardAPI方式将无能为力。正如书中提到的，可以通过服务相关的环境变量或者DNS来获取服务和pod的信息，但如果应用需要获取其他资源的信息或者获取最新的信息，就需要直接与API服务器进行交互（如图8.4所示）。</p>
<p>图8.4从 pod内部与API服务器交互获取其他API对象的信息<br>在了解pod中的应用如何与KubemetesAPI服务器交互之前，先在自己的本机.上研究一下服务器的RESTendpoit，这样我们可以大致了解什么是API服务器。<br>8.2.1 探究Kubernetes REST API<br>我们已经了解了Kubemetes 不同的资源类型。但如果打算开发一个可以与Kubemetes API交互的应用，要首先了解API.<br>先尝试直接访问 API服务器，可以通过运行kubectl cluster-info 命令来得到服务器的URL。<br>$ kubect1 cluster-info<br>Kubernetesmasterisrunningat<a href="https://192.168.99.100:8443" target="_blank" rel="noopener">https://192.168.99.100:8443</a><br>因为服务器使用HTTPS协议并且需要授权，所以与服务器交互并不是一件简单的事情，可以尝试通过curl来访问它，使用curl的—insecure（或-k）选项来跳过服务器证书检查环节，但这也不能让我们走得更远。<br>$curl<a href="https://192.168.99.100:8443-k" target="_blank" rel="noopener">https://192.168.99.100:8443-k</a><br>Unauthori zed<br>Unauthor 12ed<br>幸运的是，我们可以执行kubectl proxy 命令，通过代理与服务器交互，而不是自行来处理验证过程。<br>通过Kubectl proxy访问API服务器<br>kubectlproxy命令启动了一个代理服务来接收来自你本机的HTTP连接并转发至API服务器，同时处理身份认证，所以不需要每次请求都上传认证凭证。它也可以确保我们直接与真实的API服务器交互，而不是一个中间人（通过每次验证服务器证书的方式）。<br>运行代理很简单，所要做的就是运行以下命令：</p>
<p>我们也无须传递其他任何参数，因为kubectl已经知晓所需的所有参数（API服务器URL、认证凭证等）。一旦启动，代理服务器就将在本地端口8001接收连接请求，让我们看一下它是如何工作的：<br>$ curllocalhost:8001<br>“paths”:[<br>“/api”<br>“/api/v1”,<br>看，我们发送请求给代理，代理接着发送请求给API服务器，然后代理将返回从服务器返回的所有信息，现在让我们开始研究。<br>通过Kubectl proxy研究Kubernetes APl<br>我们可以继续使用curl，或者打开浏览器并且指向ttp://localhost:8001，看一下当我们访问这个基础的URL时，API服务器会返回什么。服务器的应答是一组路径的清单，如下所示。<br>代码清单8.7API服务器的REST endpoint清单：ttp：/localhost：8001</p>
<p>这些路径对应了我们创建 Pod、Service 这些资源时定义的 API 组和版本信息。 你或许已经发现在 /apis/batch/v1 路径下的 batch/V1就是在第 4 章了解的 Job 资源 API 组和版本信息。同样， /api/v1 对应 apiversion： 这里所说 的 v1 指的是我们创建的基础资源 （Pod、Service、ReplicationController等）。 在Kubernetes最早期版本中提到的最基础的资源并不属于任何指定的组，原因是Kubernetes 初期并没有使用API组的概念 ，这个概念是后期引入的。<br>注意这些没有列入API 组的初始资源类型现在一般被认为归属于核心的API组。<br>240<br>8从应用访问pod元数据以及其他资源<br>研究批量 API 组的REST endpoint<br>让我们来研究Job资源API，从路径 /apis/batch 下的内容开始（暂时忽略 版本），如下面的代码清单所示。<br>代码清单8.8在/apis/batch’目录下6.endpoint清单nttp://<br>localhost:8001/apis/batch</p>
<p>这个响应消息展示了包括可用版本、客户推荐使用版本在内的批量API组信息。让我们接着看一下/apis/batch/V1路径下的内容，如下面的代码清单所示。<br>代码清单8.9在batch/V1中的资源类型:<a href="http://ocalhost:8001/" target="_blank" rel="noopener">http://ocalhost:8001/</a><br>apis/batch/v1</p>
<p>像我们看到的一样，API服务器返回了在batch/V1目录下API组中的资源类型以及REST endpoint清单。除了资源的名称和相关的类型，API 服务器也包含了一些其他信息，比如资源是否被指定了命名空间、名称简写（如果有的话，对于Job来说没有）、资源对应可以使用的动词列表等。<br>返回的列表描述了在API服务器中暴露的REST资源。”name”： “jobs”行的信息告诉我们API包含了/apis/batch/V1/jobs的endpoint， “verbs” 数组告诉我们可以通过endpoint恢复、修改以及删除Job资源。对于某些特定的资源，API 服务器暴露了额外的API endpoint （例如，通过jobs/status路径可以修改Job的状态）。列举集群中所有的Job实例<br>通过在/apis/batch/v1/jobs路径运行一个GET请求，可以获取集群中所有Job的清单，如下面的代码清单所示。<br>代码清单8.10Job清单:<a href="http://ocalhost:8001/apis/batch/v1/jobs" target="_blank" rel="noopener">http://ocalhost:8001/apis/batch/v1/jobs</a></p>
<p>如果在集群中没有部署Job资源，那么 items 数组将是空的。可以尝试在 Chapter08/my-job.yaml 中部署 Job， 然后再次访问 RESR endpoint 从而得到与代码清单 8.10 中相同的输出信息。<br>通过名称恢复一个指定的 Job 实例<br>前面的 endpoint 返回了跨命名空间的所有 Job 的清单，如果想要返回指定的 一个 Job，需要在 URL中指定它的名称和所在的命名空间。 为了恢复在之前清单中的一个 Job （name：my-job；namespace：dfault）， 需要访问路径：/apis/batch/v1/namespaces/default/jobs/my-job，如下面的代码清单所示。<br>代码清单8.11<br>通过名称恢复一个指定命名空间下的资源</p>
<p>可以看到，我们得到了my-job这个Job资源的完整的JSON定义信息，和运行$kubetcl get job my-job -o json 命令得到的信息完全一致。<br>$ kubectl get job my- job- o j son<br>虽然不使用任何特定的工具，我们也可以访问KubernetesRESTAPI服务器，但如果要全面地研究REST API并与之交互，在本章最后会介绍更好的方式。暂时来看，像这样使用curl进行研究，对我们理解一个应用如何在pod中运行并与Kubernetes交互已经足够。<br>8.2.2 从pod内部与API服务器进行交互<br>我们已经知道如何从本机通过使用kubectl proxy 与API服务器进行交互。现在我们来研究从一个pod内部访问它，这种情况下通常没有kubectl可用。因此，想要从pod内部与API服务器进行交互，需要关注以下三件事情：</p>
<p>·确定API服务器的位置<br>·确保是与API服务器进行交互，而不是一个冒名者<br>·通过服务器的认证，否则将不能查看任何内容以及进行任何操作<br>接下来我们看一下交互如何实现。<br>运行一个pod来尝试与API服务器进行通信<br>首先需要一个pod以便从它内部发起与API服务器的交互。运行一个什么也不做的pod（在它仅有的容器内部运行一个sleep命令），然后通过kubectl exec在容器内部运行一个脚本，接下来在脚本中使用curl尝试访问API服务器。<br>因此，需要使用一个包含curl二进制的容器镜像。如果在Docker Hub中搜索，就会发现tutum/curl镜像，可以使用这个镜像（也可以使用任何包含curl二进制的已有镜像或者自己打包的镜像）。pod的定义如下面的代码清单所示。<br>代码清单8.12用来尝试与API服务器通信的pod ： curl：yaml</p>
<p>在完成pod的创建后，在容器中运行kubectlexec来启动一个bash shell：$ kubectl exec -it curl bash<br>root@curl:/#<br>我们现在已经做好了与API服务器交互的准备。<br>发现API服务器地址<br>首先，需要找到Kubermetes API服务器的IP地址和端口。这一点比较容易做到，因为一个名为kubernetes的服务在默认的命名空间被自动暴露，并被配置为指向API服务器。也许你应该记得，每次使用kubectl get svc命令显示所有服务清单时，都会看到这个服务。</p>
<p>在第5章中说过每个服务都被配置了对应的环境变量，在容器内通过查询KUBERNETES _SERVICE_ HOST和KUBERNETES_SERVICE_PORT这两个环境变量就可以获取API服务器的IP地址和端口。<br>root@curl:/#env|grep KUBERNETES SERVICE KUBERNETES SERVICE PORT=443<br>KUBERNETES SERVICE HOST=10.0.0.1<br>KUBERNETES SERVICE PORT HTTPS-443<br>同样，我们应该记得每个服务都可以获得一个DNS入口，所以甚至没有必要去查询环境变量，而只是简单地将curl指向htps://kubernetes。公平地讲，如果我们不知道服务在哪个端口是可用的，既可以查询环境变量，也可以查看DNSSRV记录来得到实际的端口号。<br>之前展示的环境变量说明API服务器监听HTTPS协议默认的443端口，所以尝试通过HTTPS协议来访问服务器。<br>root@curl:/#curl<a href="https://kubernetes" target="_blank" rel="noopener">https://kubernetes</a><br>curl:(60) ssL certificate problem: unable to get local issuer certificate If you’d like to turn off curl’s verification of the certificate, use<br>the -k (or —insecure) option.<br>虽然最简单的绕开这一步骤的方式是使用推荐的-k选项（这也是我们在手工操作API服务器时通常会使用的方式），但还是来看一下更长（也是正确）的途径。我们应该通过使用curl检查证书的方式验证API服务器的身份，而不是盲目地相信连接的服务是可信的。<br>提示在真实的应用中，永远不要跳过检查服务器证书的环节。这样做会导致你的应用验证凭证暴露给采用中间人攻击方式的攻击者。<br>验证服务器身份<br>在之前的章节中，在讨论Secret时，我们看到一个名为defalut-token-xyz的Secret被自动创建，并挂载到每个容器的/var/run/secrets/kubermetes.io/serviceaccount目录下。让我们查看目录下的文件，再次看一下Secret的内容。<br>root@curl:/#ls/var/run/secrets/kubernetes.io/serviceaccount/<br>ca.crt<br>namespace<br>token<br>Secret有三个入口（因此在Secret卷中有三个文件）。现在，我们关注一下ca.crt文件。该文件中包含了CA的证书，用来对Kubemetes API服务器证书进行签</p>
<p>名。为了验证正在交互的API服务器，我们需要检查服务器的证书是否是由CA签发。 curl允许使用-cacert选项来指定CA证书，我们来尝试重新访问API服务器： root@curl:/#cur1—cacert/var/run/secrets/kubernetes.io/serviceaccount<br>/ca.crt<a href="https://kubernetes" target="_blank" rel="noopener">https://kubernetes</a><br>Unauthorized<br>注意我们可能看到一个比“Unauthorized”更长的错误描述。<br>到目前为止，我们已经取得进展，服务使用了我们信任的CA签名的证书，所以curl验证通过了服务器的身份，但Unauthorized这个响应提醒我们需要关注授权的问题。同时，看一下如何通过设置CURLCA BUNDLE环境变量来简化操作，从而不必在每次运行curl时都指定—cacert选项：<br>root@curl:/# export cURL_cA_BUNDLE=/var/run/secrete/kubernete8.io/<br>serviceaccount/ca.crt<br>现在，我们可以不使用—cacert来访问API服务器：<br>root@curl:/#curl<a href="https://kubernetes" target="_blank" rel="noopener">https://kubernetes</a><br>Unauthorized<br>这样操作相对便捷，我们的客户端（curl）现在信任API服务器，但API服务器并不确认访问者的身份，所以没有授权允许访问。<br>获得API服务器授权<br>我们需要获得API服务器的授权，以便可以读取并进一步修改或删除部署在集群中的API对象。为了获得授权，我们需要认证的凭证，幸运的是，凭证可以使用之前提到的default-token Secret来产生，同时凭证可以被存放在secret卷的token文件中。Secret这个名字就说明了它主要的作用。<br>可以使用凭证来访问API服务器，第一步，将凭证挂载到环境变量中：root@curl:/# TOKEN=$(cat /var/run/secrets/kubernetes.io/<br>gerviceaccount/token)<br>此时，凭证已经被存放在TOKEN环境变量中，如下面的代码清单所示，可以在向API服务器发送请求时使用它。</p>
<p>关闭基于角色的访问控制（RBAC）<br>如果我们正在使用一个带有 RBAC机制的 Kubernetes 集群，服务账户可能 不会被授权访问API服务器 （或只有部分授权）。我们将在第 12 章详细了解服务账户和RBAC机制。 目前最简单的方式就是运行下面的命令查询API服务器，从而绕过 RBAC 方式。<br>$ kubectl create clusterrolebinding permissive-binding<br>—clusterrole=cluster-admin \<br>—group=system:serviceaccounts<br>这个命令赋予了所有服务账户 （也可以说所有的 pod）的集群管理员权限， 允许它们执行任何需要的操作， 很明显这是一个危险的操作， 永远都不应该在生产的集群中执行， 对于测试来说是没有问题的。<br>我们通过发送请求的 HTTP 头中的 Authorization字段向API 服务器传递了凭证，API 服务器识别确认凭证并返回正确的响应， 正如前面几个章节我们所做的，现在可以探索集群中所有的资源。<br>例如，可以列出集群中所有的 pod， 但前提是我们知道运行 curl 的 pod 属于哪个命名空间。<br>获取当前运行 pod 所在的命名空间<br>在本章的第一部分，我们了解了如何使用 Downward API 的方式将命名空间 的属性传递到 pod。如果你注意观察的话， 或许注意到 secret 卷中也包含了一个 </p>
<p>叫作命名空间的文件。 这个文件包含了当前运行 pod所在的命名空间，所以我们可以读取这个文件来获得命名空间信息， 而不是通过环境变量明确地传递信息到 pod 。文件内容挂载到 NS 环境变量中， 然后列出所有的 pod， 如下面的代码清单所示。<br>代码清单 8.14 获取当前 pod 所在命名空间中的所有 pod 清单<br>root@curl:/# NS=$(cat /var/run/secrets/kubernetes.io/<br>gerviceaccount/namespace)<br>root@curl:/# curl -H “Authorization: Bearer $TOKEN”<br><a href="https://kubernetes/api/v1/namespaces/$NS/podg" target="_blank" rel="noopener">https://kubernetes/api/v1/namespaces/$NS/podg</a><br>{<br>“kind”:”PodList”,<br>“apiversion”: “v1”,<br>这就对了，通过使用挂载在 secret 卷目录下的三个文件，可以罗列出与当 前 pod 运行在同一个命名空间下的所有 pod 的清单。使用同样的方式不仅可以使用 GET 请求，还可以使用 PUT 或者 PATCH 来检索和修改其他 API 对象。<br>简要说明 pod 如何与 Kubernetes 交互<br>我们来简单说明一下在 pod 中运行的应用如何正确访问 Kubernetes 的 API： ·应用应该验证 API服务器的证书是否是证书机构所签发， 这个证书是在 ca.crt 文件中。<br>应用应该将它在 token 文件中持有的凭证通过Authorization 标头来获得 API 服务器的授权。<br>·当对 pod 所在命名空间的 API 对象进行 CRUD 操 作 时， 应该使用namespace 文件来传递命名空间信息到 API服务器。<br>定义 CRUD 代表创建、读取、 修改和删除操作，与之对应的 HTTP方法分别是 POST、GET、 PATCH/PUT 以及 DELETE。<br>与API 服务器通信相关的 pod 的三个方面如图 8.5 所示。 </p>
<p>图8.5通过default-token Secret中的文件与API服务器进行交互<br>8.2.3通过ambassador容器简化与API服务器的交互<br>使用HTTPS、证书和授权凭证，对于开发者来说看上去有点复杂。碰到过开发者在许多场景下关闭了对服务器证书验证的功能（当然笔者有时候也会这么做）。幸运的是，我们在保证安全性的前提下有办法简化通信的方式。<br>还记得在8.2.1中提到过的kubectlproxy命令吗？在本机上运行这个命令，从而可以更加方便地访问API服务器。向代理而不是直接向API服务器发送请求，通过代理来处理授权、加密和服务器验证。同样，也可以在pod中这么操作。<br>ambassador容器模式介绍<br>想象一下，如果一个应用需要查询API服务器（此外还有其他原因）。除了像之前章节讲到的直接与API服务器交互，可以在主容器运行的同时，启动一个ambassador容器，并在其中运行kubecctlproxy命令，通过它来实现与API服务器的交互。<br>在这种模式下，运行在主容器中的应用不是直接与API服务器进行交互，而是通过HTTP协议（不是HTTPS协议）与ambassador连接，并且由ambassador通过HTTPS协议来连接API服务器，对应用透明地来处理安全问题（见图8.6）。这种方式同样使用了默认凭证Secret卷中的文件。</p>
<p>图8.6使用ambassador连接API服务器<br>因为在同一个pod中的所有连接共享同样的回送网络接口，所以我们的应用可以使用本地的端口来访问代理。<br>运行带有附加ambassador容器的CURLpod<br>为了通过操作来理解ambassador容器模式，我们像之前创建curlpod一样创建一个新的pod，但这次不是仅仅在pod中运行单个容器，而是基于一个多用途的ku bectl-proxy容器镜像来运行一个额外的ambassador容器，这个镜像是之前创建的并已提交到Docker Hub。如果你想自己来编译它，可以在代码存档中找到Dockerfile镜像（在/Chapter08/kubectl-proxy/目录下）。<br>pod的manifest文件如以下代码清单所示。<br>代码清单8.15带有ambassador容器的pod ：curl-with-ambassador. yaml</p>
<p>pod 的 spec 与之前非常类似，但 pod 名称是不同的，同时增加了一个额外的容器。  运行这个 pod， 并且通过以下命令进入主容器：<br>$ kubectl exec -it curl-with-ambassador -c main bash<br>root@curl-with-ambassador:/#<br>现在 pod 包含两个容器， 我们希望在 main 容器中运行 bash，所以使用-c main 选项。如果想在 pod 的第一个容器中运行该命令， 也无须明确地指定容器。但如果想在任何其他的容器中运行这个命令，就需要使用-c 选项来说明容器的名称。</p>
<p>通过ambassador来与API服务器进行交互<br>接下来我们尝试通过ambassador容器来连接API服务器。默认情况下，kubectl proxy绑定8001端口，由于pod中的两个容器共享包括回送地址在内的相同的网络接口，可以如下面的代码清单所示，将curl指向localhost：8001。<br>代码清单8.16通过ambassador容器访问API服务器</p>
<p>成功了！curl的输出打印结果与我们之前看到的响应相同，但这次，并不需要处理授权的凭证和服务器证书。<br>想要清楚地了解处理的细节，请参考图8.7。curl向在ambassador容器内运行的代理发送普通的HTTP请求（不包含任何授权相关的标头），然后代理向API服务器发送HTTPS请求，通过发送凭证来对客户端授权，同时通过验证证书来识别服务器的身份。<br>这是一个很好的例子，它说明了如何使用一个ambassador容器来屏蔽连接外部服务的复杂性，从而简化在主容器中运行的应用。ambassador容器可以跨多个应用复用，而且与主应用使用的开发语言无关。负面因素是需要运行额外的进程，并且消耗资源。</p>
<p>8.2.4 使用客户端库与API 服务器交互<br>在之前的例子中，我们已经体验到了使用 ambassador容器 kubectl-proxy 的好处，如果我们的应用仅仅需要在 API 服务器执行一些简单的操作，往往可以使 用一个标准的客户端库来执行简单的 HTTP 请求。但对于执行更复杂的 API 清求来说，使用某个已有的 Kubernetes API 客户端库会更好一点。<br>使用已有的客户端库<br>目前，存在由 API Machinery special interest group（SIG） 支持的两个版本的 Kuberbetes API 客户端库。<br>Golangclient一<a href="https://github.com/kubernetes/client-go" target="_blank" rel="noopener">https://github.com/kubernetes/client-go</a><br>Python-<a href="https://github.com/kubernetes-incubator/client-python" target="_blank" rel="noopener">https://github.com/kubernetes-incubator/client-python</a><br>注意 Kubernetes 社区有大量的兴趣组和工作组，这些小组分别关注着  Kubernetes生态系统中的某个特定部分。可以在<a href="https://github.com/kubernetes/" target="_blank" rel="noopener">https://github.com/kubernetes/</a> community/blob/master/sig-list.md 下看到它们的清单。<br>除了官方支持的两个库， 这里列出了一些由用户贡献的针对不同语言的客户端库：<br>Fabric8维护的Java客户端一<a href="https://github.com/fabric8io/kubernetesclient" target="_blank" rel="noopener">https://github.com/fabric8io/kubernetesclient</a><br>Amdatu维护的Java客户端一<a href="https://bitbucket.org/amdatulabs/amdatu-kubernetes" target="_blank" rel="noopener">https://bitbucket.org/amdatulabs/amdatu-kubernetes</a> tenxcloud维护的Node.js客户端一<a href="https://github.com/tenxcloud/node-kubernetes" target="_blank" rel="noopener">https://github.com/tenxcloud/node-kubernetes</a>. client<br>GoDaddy维护的Node.js客户端一<a href="https://github.com/godaddy/kubemetes-client" target="_blank" rel="noopener">https://github.com/godaddy/kubemetes-client</a> PHP-<a href="https://github.com/devstub/kubernetes-api-php-client" target="_blank" rel="noopener">https://github.com/devstub/kubernetes-api-php-client</a><br>另一个PHP客户端一<a href="https://github.com/maclof/kubernetes-client" target="_blank" rel="noopener">https://github.com/maclof/kubernetes-client</a><br>Ruby-<a href="https://github.com/Ch00k/kubr" target="_blank" rel="noopener">https://github.com/Ch00k/kubr</a><br>●另一个Ruby客户端一<a href="https://github.com/abonas/kubeclient" target="_blank" rel="noopener">https://github.com/abonas/kubeclient</a><br>Clojure-<a href="https://github.com/yanatan16/clj-kubernetes-api" target="_blank" rel="noopener">https://github.com/yanatan16/clj-kubernetes-api</a><br>● Scala一<a href="https://github.com/doriordan/skuber" target="_blank" rel="noopener">https://github.com/doriordan/skuber</a><br>Perl-<a href="https://metacpan.org/pod/Net::Kubernetes" target="_blank" rel="noopener">https://metacpan.org/pod/Net::Kubernetes</a><br>这些库通常支持 HTTPS 协议， 并且可以处理授权操作， 所以我们不需要使用ambassador 容器。<br>一个使用Fabric8 Java 库与 Kubernetes 进行交互的例子<br>为了说明如何通过客户端库与 API 服务器进行交互，以下的代码清单给出了一 个例子说明如何使用 Fabric8 Kubernetes 客户端列出一个 Java 应用中的服务。</p>
<p>由于Fabric8 客户端暴露了一种友好的流畅（fluent） 的Domain-SpecficLanguage（DSL） API， 所以以，上代码浅显易懂。<br>使用Swagger和OpenAPI打造你自己的库<br>如果我们选择的开发语言没有可用的客户端，可以使用Swagger API框架生成客户端库和文档。Kubernetes API服务器在/swaggerapi下暴露Swagger API定义，在/swagger.json下暴露OpenAPI定义。<br>想要了解更多关于Swagger框架的内容，请访问网站<a href="http://swagger.io" target="_blank" rel="noopener">http://swagger.io</a>.<br>使用Swagger Ul研究API<br>在本章开头，已经提到了一种更好的研究Rest API的方式，而不是使用curl直接访问RESTendpoint。正如在前面部分所提到的，Swagger不仅是描述API的工具，如果暴露了SwaggerAPI定义，还能够提供一个用于查看REST API的web Ul。<br>Kubernetes不仅暴露了SwaggerAPI，同时也有与API服务器集成的Swagger Ul。Swagger UI默认状态没有激活，可以通过使用—enable-swagger -ui=true 选项运行API服务器对其进行激活。<br>提示如果使用Minikube，可以在启动集群时，使用minikube start—extra-config=apiserver . Features . Enable-SwaggerUI=true选项来激活Swagger Ul。<br>在激活UI后，可以通过以下地址在浏览器中打开它：<br>http(s) ://<api server> :<port>/ swagger-ui<br>强烈建议尝试使用Swagger UI，通过它不仅可以浏览Kubernetes API，也可以使用它来进行交互（例如，可以POST JSON资源manifest、PATCH资源或者DELETE它们）。<br>8.3本章小结<br>在完成本章的学习后，我们知道了在一个pod中运行的应用，如何获取它自身的数据，或者部署在集群中的其他pod、其他组件的数据。我们也了解了以下内容：<br>·如何通过环境变量或者downwardAPI卷中的文件，将pod的名称、所在的命名空间信息以及其他元数据暴露给进程<br>，如何将CPU和内存的资源请求和使用限额以任何应用指定的单位传递给应用·pod如何使用downwardAPI卷来获取最新的元数据，而这些元数据可能在</port></api></p>
<p>pod（如标签和注解）的生命周期内发生变化<br>如何使用 kubectl proxy 浏览 Kubernetes RESTAPI<br>pod 如何使用环境变量或者DNS 来找到 API 服务器的定位，与此类似的还有  Kubernetes 中定义的服务<br>在 pod 中运行的应用如何验证与之交互的服务器的身份，以及如何获得授权·如何通过使用 ambassador 容器使得其中运行的应用与 API 服务器的交互更加简单<br>· 如何在短时间内使用客户端库与 Kubernetes 交互<br>在本章，我们了解了如何与 API 服务器进行交互， 接下来的环节将了解更多的工作原理，我们将在第 11 章进行学习。 在深入了解这方面的细节之前，仍然需要了 解另外两种 Kubernetes 资源—Deployment 和 StatefulSet，我们将在接下来的两章 展开这方面的内容。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Kubernetes-in-Action/" rel="tag"># Kubernetes in Action</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/10/01/7-ConfigMap和Secret：配置应用程序/" rel="next" title="7-ConfigMap和Secret：配置应用程序">
                <i class="fa fa-chevron-left"></i> 7-ConfigMap和Secret：配置应用程序
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/10/01/9-Deployment：声明式地升级应用/" rel="prev" title="9-Deployment：声明式地升级应用">
                9-Deployment：声明式地升级应用 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="CheBin">
            
              <p class="site-author-name" itemprop="name">CheBin</p>
              <div class="site-description motion-element" itemprop="description">什么是强迫自己？就是不想去干什么，就去干什么</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">1005</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">72</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          


          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/2023/04/04/35丨数据库主从同步的作用是什么，如何解决数据不一致问题？/" title="35丨数据库主从同步的作用是什么，如何解决数据不一致问题？" target="_blank">35丨数据库主从同步的作用是什么，如何解决数据不一致问题？</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/03/08｜化骨绵掌：降级、热点和容灾处理/" title="08｜化骨绵掌：降级、热点和容灾处理" target="_blank">08｜化骨绵掌：降级、热点和容灾处理</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/03/加餐｜高并发场景：如何提升对突发事件的应急处理能力？/" title="加餐｜高并发场景：如何提升对突发事件的应急处理能力？" target="_blank">加餐｜高并发场景：如何提升对突发事件的应急处理能力？</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/03/07｜乾坤大挪移：秒杀的削峰和限流/" title="07｜乾坤大挪移：秒杀的削峰和限流" target="_blank">07｜乾坤大挪移：秒杀的削峰和限流</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/03/06｜谋定后动：秒杀的流量管控/" title="06｜谋定后动：秒杀的流量管控" target="_blank">06｜谋定后动：秒杀的流量管控</a>
                  </li>
                
              </ul>
            </div>
        

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CheBin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">8.1m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">123:22</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
