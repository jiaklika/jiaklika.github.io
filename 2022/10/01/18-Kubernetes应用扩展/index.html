<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">
<meta name="keywords" content="Kubernetes in Action">
<meta property="og:type" content="article">
<meta property="og:title" content="18-Kubernetes应用扩展">
<meta property="og:url" content="http://yoursite.com/2022/10/01/18-Kubernetes应用扩展/index.html">
<meta property="og:site_name" content="车斌的技术博客">
<meta property="og:description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2022-10-04T01:53:16.890Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="18-Kubernetes应用扩展">
<meta name="twitter:description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">






  <link rel="canonical" href="http://yoursite.com/2022/10/01/18-Kubernetes应用扩展/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>18-Kubernetes应用扩展 | 车斌的技术博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">放弃会成为一种习惯</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/10/01/18-Kubernetes应用扩展/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CheBin">
      <meta itemprop="description" content="看视频才能学会，看文字学不会的">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">18-Kubernetes应用扩展

              
            
          </h1>
        

        <div class="post-meta">

          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2022-10-01 10:12:23" itemprop="dateCreated datePublished" datetime="2022-10-01T10:12:23+08:00">2022-10-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2022-10-04 09:53:16" itemprop="dateModified" datetime="2022-10-04T09:53:16+08:00">2022-10-04</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">20k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">18 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考并回答以下问题：</p>
<ul>
<li>总结一下，这章作者最主要想表达什么观点？</li>
</ul>
<a id="more"></a>
<p>本章内容涵盖<br>在Kubernetes 上添加自定义对象<br>为自定义对象添加控制器<br>添加自定义API服务器<br>使用 Kubernetes 服务目录完成自助服务配置 红帽（Red Hat） 容器平台 OpenShift 介绍Deis Workflow与Deis Helm<br>本章是本书的最后一章。作为总结， 我们介绍如何自定义API对象，并为这 些对象添加控制器。除此之外， 我们还会了解基于Kubernetes 的优秀平台即服务（platform-as-a-Service，PaaS）解决方案。<br>18.1定义自定义API对象<br>通过阅读本书，你已经了解了 Kubernetes 所提供的 API 对象，以及如何使用它 们开发应用。然而，目前 Kubernetes 用户使用的大多仅是代表相对底层、 通用概念的对象。<br>随着 Kubernetes 生态系统的持续发展， 越来越多高层次的对象将会不断涌现。 比起目前使用的对象， 新对象将更加专业化。有了它们， 开发者将不再需要逐一进</p>
<p>行Deployment、Service、 ConfigMap 等步骤，而是创建并管理一些用于 表述整个应用程序或者软件，服务的对象。我们能使用自定义控件观察高阶对象，并在这些高阶对象的基础上创建底层对象。例如，你想在Kubernetes集群中运行一个 messaging代理，只需要创建一个队列资源实例，而自定义队列控件将自动完成所需的Secret、 Deployment和Service。目前，Kubernetes 已经提供了类似的自定义资源添加方式。 18.1.1 CustomResourceDefinitions 介绍<br>开发者只需向KubernetesAPI服务器提交CRD对象，即可定义新的资源类型。成功提交CRD之后，我们就能够通过API服务器提交JSON清单或YAML清单的方式创建自定义资源，以及其他Kubernetes资源实例。<br>注意在Kubernetes 1.7之前的版本中，需要通过ThirdPartyResource 对象的方式定义自定义资源。ThirdPartyResource 与CRD 十分相似，但在Kubernetes 1.8中被CRD取代。<br>开发者可以通过创建CRD来创建新的对象类型。但是，如果创建的对象无法在集群中解决实际问题，那么它就是一个无效特性。通常，CRD与所有Kubernetes核心资源都有一个关联控制器（一个基于自定义对象有效实现目标的组件），详见第11章。因此，只有在部署了控制器之后，开发者才能真正知道CRD所具有的功能远不止添加自定义对象实例而已。接下来的内容将详细介绍这一点。<br>CRD范例介绍<br>如果你想让自己的Kubernetes集群用户不必处理pod.服务以及其他Kubernetes资源，甚至只需要确认网站域名以及网站中的文件（HTML、CsS、PNG，等等）就能以最简单的方式运行静态网站。这时候，你需要一个Git存储库当作这些文件的来源。当用户创建网站资源实例时，你希望Kubernetes创建一个新的web服务器pod，并通过服务将它公开，如图18.1 所示。<br>想要创建网站资源，用户可以按照如下代码清单所示的方式发布清单。</p>
<p>图18.1每个网站对象都应该产生一个服务和一个HTTP服务器pod<br>18.1定义自定义API对象<br>519<br>代码清单18.1虚构的自定义资源：imaginary-kubia-website.yaml</p>
<p>与其他所有资源一样， 你所创建的资源也包含一个 kind 和一个 metadata.name 字段和一个 spec 小节。 它包含一个单独的 gitRepo 字段 （字段名称可自选）一它指向了存储网站文件 Git 仓库。 除此之外，自定义资源还需要包含一个 apiVersion 字段，但它的值不是固定的。<br>如果像下图这样将资源发布到 Kubernetes， 那么你将会收到报错提示，因为 Kubernetes 无法识别这样的网站对象：<br>$ kubectl create -f imaginary-kubia-website.yaml<br>error: unable to recognize “imaginary-kubia-website.yaml”: no matches for /, Kind=Website<br>因此，在你创建自定义对象实例之前， 首先需要确保 Kubernetes 能够识别它们。 创建一个 CRD 对象<br>想要使 Kubernetes 接收你的 自定义网站资源实例， 需要按照以下代码清单所示的格式向 API 服务器提交 CRD。<br>代码清单 18.2一个 CRD 列表 ： website-crd.yaml</p>
<p>将以上描述符发布到 Kubernetes 之后，你便能够创建任意数量的自定义网站资<br>源实例。</p>
<p>然后，就可以依照代码归档文件中找到的 website-crd.yaml 文件创建 CRD 了： $ kubectl create -f website-crd-definition.yaml<br>customresourcedefinition “websites.extensions.example.com” created<br>如果 CRD 的名称长到让你惊讶的话， 为了避免冲突，不妨暂且称它为 Website。为了区分它们， 可以采取添加 CRD 名称后缀 （通常情况下，后缀即创建该 CRD 的机构名称）的方式。幸好， 一个长的资源名字并不意味着你一定要用  kind： websitesextensions.example.com 这种方式来创建Website 资源。可以用 CRD 中指定的 names.kind 属性， 即 kind： Website。extensions. example.com 的部分是资源的 API 组。<br>如你所见，在创建 Deployment 对象时，你需要将 apiVersion 设置为 apps/  v1beta1而不是v1。 其中，“/”前的部分为API组（属于该API组的 Deployment），“/”后的部分为 API 组的版本名 （如果是 Deployment 的话，则为 v1beta1）。 在创建自定义网站资源的实例时，apiVersion 属性需要设置为extensions.example. com/v1。<br>创建自定义资源实例<br>现在，请为你的网站创建一个合适的 YAML 资源实例。YAML 列表显示在下面 的代码清单中。<br>代码清单 18.3一个自定义网站资源： kubia-website.yaml</p>
<p>这个自定义资源的kind是Website，而apiVersion是由API组和你在CRD中定义的版本号两部分组成的。<br>下一步，创建网站对象：<br>$ kubectl create -f kubia-website. yaml<br>website “kubia” created<br>从响应看出，API 服务器已经接收并存储了你的自定义对象。现在， 让我们看看你是否可以检索它。</p>
<p>检索自定义资源实例<br>首先，我们需要列举出集群中的所有网站：<br>$ kubectl get websites<br>NAME<br>KIND<br>kubia Website.v1. extensions . example . com<br>与现有的Kubernetes资源一样，可以创建并列出自定义资源实例。也可以使用 kubectldescribe来查看自定义对象的详细信息，或者使用kubectl get 检索整个YAML列表，如代码清单18.4所示。<br>代码清单18.4从API服务器检索完整的网站资源定义</p>
<p>请注意，该资源包含了YAML基本定义中的所有内容。同时，与其他所有资源样，Kubernetes 已经初始化了该资源中额外的元数据字段。<br>删除自定义资源实例<br>显然，除了创建和检索自定义资源实例，也可以删除它们：<br>$ kubectl delete website kubia<br>website “kubia” deleted<br>注意你删除的是网站实例，而不是网站CRD资源。当然也可以删除CRD对象本身，但是我们在这里不进行详细介绍，因为在下一节你需要创建更多网站实例。<br>让我们总结一下之前的内容。通过创建一个CRD对象，可以通过Kubernetes API服务器存储、检索和删除自定义对象。这些对象目前还没有任何动作，因此， 你需要创建一个控制器来控制它们的运行。<br>通常情况下，像这样创建自定义对象，并不仅仅是为了解决实际问题。因为某些自定义对象仅用于存储数据，而不是使用更通用的机制（例如ConfigMap）。在pod内运行的应用程序可以查询这些对象的API服务器并读取存储在其中的全部内容。</p>
<p>但是在本例中，希望启动一个web服务器为Website对象中的Git仓库中的内容提供服务，接下来我们将看看如何做到这一点。<br>18.1.2使用自定义控制器自动定制资源<br>为了让你的网站对象运行一个通过服务暴露的web服务器pod，你就需要构建和部署一个网站控制器。它能查看API服务器创建网站对象的过程，然后为每一个对象创建服务和Web服务器pod。<br>控制器将创建Deployment资源，而不是直接创建非托管pod，这样就能确保pod既能被管理，还能在遇到节点故障时继续正常工作。控制器的操作总结如图18.2所示。</p>
<p>图18.2使用网站控制器创建网站对象并创建Deployment和Service<br>这是笔者写的一个简单的初始版控制器，它能够很好地展示CRD和控制器的实际运行情况。但由于它被过度简化，因此不可用于生产环境。容器镜像的地址为docker.io/luksa/website-controller:latest,源码存放在<a href="https://github.com/luksa/k8s-website-controller" target="_blank" rel="noopener">https://github.com/luksa/k8s-website-controller</a> 上。接下来解释控制器的功能。<br>了解网站控制器的功能<br>启动后，控制器立即开始通过以下URL请求查看网站对象：<br><a href="http://localhost:8001/apis/extensions.example.com/vl/websites?watch=true" target="_blank" rel="noopener">http://localhost:8001/apis/extensions.example.com/vl/websites?watch=true</a><br>通过识别主机名和端口，我们看到控制器不直接连接到API服务器，而是连接</p>
<p>到 kubectl proxy 进程。 该进程在同一个pod 中的 sidecar 容器中运行，并充当 API服务器的 ambassador（见第8章）。 代理将请求转发给API服务器，并同时处  理 TLS 加密和认证 18.3）。</p>
<p>图18.3网站控制器通过代理（在ambassador容器中）与API服务器交互<br>通过此HTTPGET请求打开的连接，API服务器将针对任何网站对象的每个更改发送监听事件（watch event）。<br>每次创建新的网站对象时，API服务器都会发送ADDED监听事件。当控制器收到这样的事件时，就会在该监听事件所包含的网站对象中提取网站名称和Git存储库的URL，然后将它们的JSON清单发布到API服务器，来创建Deployment和Service对象。<br>Deployment资源包含一个具有两个容器的pod模板（如图18.4所示）：其中↵个容器运行一个nginx服务器，另一个容器则运行一个gitsync进程，用来保持本地目录与Git仓库的内容同步。本地目录通过一个emptyDir卷与nginx容器共享（类似第6章，但此处不是让本地目录与Git仓库卷保持同步，而是使用gitrepo卷在pod启动时下载Git仓库的内容；该卷的内容与Git存储库并不同步）。作为一个NodePort Service，它通过每个节点上的随机端口公开你的web服务器pod（所有节点使用相同的端口）。这样，当Deployment对象创建一个pod时，用户就可以通过节点端口访问该网站。<br>当网站资源实例被删除时，API服务器还会发送DELETED监听事件。在收到事件后，控制器就会删除之前创建的Deployment资源和Service资源。与此同时，控制器也会关闭并删除为该网站提供服务的web服务器。<br>注意由于笔者所编写的控制器查看API对象的方式无法确保它不会错过任何一个监听事件，因此并没有被正确实施。当我们通过API服务器查看对象时，还要定期重新列出所有对象，以防监听事件被错过。</p>
<p>图18.4网站对象中服务指定网站的pod<br>将控制器作为pod运行<br>在开发期间，笔者在本地笔记本电脑上运行控制器时，会使用本地运行的 kubectl proxy 进程作为Kubernetes API服务器的ambassador（不是作为pod运行）。这种方法能够更快地完成开发，因为不需要在每次修改源代码之后构建一个容器镜像，然后在Kubernetes内运行它。<br>当准备将控制器部署到生产环境中时，最好的方法是在Kubernetes内部运行控制器，就像所有其他核心控制器那样。要在Kubernetes中运行控制器，可以通过 Deployment资源进行部署。下 面的代码清单展示了这样一个 示例的Deployment。 代码清单18.5部署 网站控制器： website-controller.yaml</p>
<p>如你所见， 在 Deployment 过程中部署了一个双容器 pod 副本。其中一个容器用于运行你的控制器， 而另一个容器则是用于与 API 服务器进行简单通信的ambassador。这个 pod 在其特殊的服务账户下运行， 因此需要在部署控制器之前创建一个服务账户：<br>$ kubectl create serviceaccount website-controller<br>serviceaccount “website-controller” created<br>如果你在集群中启用了基于角色的访问控制（RBAC），Kubernetes 将不允许 控制器查看网站资源或创建Deployment 或 Service。为了避免这种情况，需要采 用创建一个集群角色绑定的方式， 将 website-controller服务账户绑定到cluster-admin ClusterRole， 如下面的代码清单所示。<br>$ kubectl create clusterrolebinding website-controller<br>—clusterrole=cluster-admin<br>—serviceaccount=defaultwebsite-controller<br>clusterrolebinding “website-controller” created<br>一旦你有了服务账户和集群角色绑定， 就可以部署控制器的 Deployment。 观察运行中的控制器<br>在控制器运行过程中，再次创建 kubia 网站资源：<br>$ kubectl create -f kubia-website.yaml<br>website “kubia” created<br>这时候，让我们来检查控制器的日志 （如下面的代码清单所示）是否接收到了 监听事件。<br>代码清单 18.6显示网站控制器的日志</p>
<p>从日志中我们看到，控制器收到了ADDED事件，并且为kubia-website 网站创建了Service 和Deployment。同时， API 服务器响应201 Created， 这表示两个资源都已经存在。接下来， 我们可以看看下面的代码清单，来验证Deployment、Service 和Pod是否已经创建了。<br>526<br>18 Kubernetes应用扔展<br>代码清单18.7为 kubia-website创建的Deployment、Service 和Pod</p>
<p>你已经成功创建了Deployment、Service和Pod。同时，所有集群节点上的端口 32589都能够提供kubia-website服务，通过它可以用浏览器访问你的网站。是不是很棒呢？<br>现在你的Kubernetes集群用户可以在几秒钟内部署静态网站。而且，除了你自定义的网站资源而不必了解有关Pod、Service或其他Kubernetes资源的任何信息。<br>不过，完成这些并不代表没有改进空间了。例如，控制器可以监听Service对象；可以在分配了节点端口之后，立即将该网站可访问的URL写入网站资源的status部分；还可以让控制器为每个网站创建一个Ingress对象。你可以将实现这些附加功能作为练习。<br>18.1.3验证自定义对象<br>可能你已经发现，你还没有在网站CRD中指定任何类型的验证模式。这会导致你的用户可以在网站对象的YAML中包含他们想要的任何字段。由于API服务器并不会验证YAML的内容（apiversion.kind和metadata等常用字段除外），用户创建的Website对象就有可能是无效对象（例如没有gitRepo字段）。<br>既然如此，我们是否可以向控制器添加验证并防止无效的对象被API服务器接收？事情并没有这么简单。因为API服务器首先需要存储对象，然后向客户端（kubectl）返回成功响应，最后才会通知所有监听器（包括你的控制器）。在监听事件中，所有控制器都可以在收到对象时验证这个对象。如果对象无效，则将报错信息写入Website对象（通过对API服务器的新请求更新对象）。但是，你的用户并不会收到自动错误通知，而是只能通过查询网站对象的API服务器来获取错误消息，否则他们无法知道对象是否有效。<br>显然，你希望的是API服务器在验证对象时立即拒绝无效对象。在Kubernetes1.8版本中，自定义对象的验证作为alpha特性被引入。如果想要让API服务器验证自定义对象，需要在API服务器中启用CustomResourcevalidation特性，并</p>
<p>在CRD中指定一个JSON schema。<br>18.1.4为自定义对象提供自定义API服务器<br>如果你想更好地支持在Kubernetes中添加自定义对象，最好的方式是使用你自己的API服务器，并让它直接与客户端进行交互。<br>API服务器聚合<br>在Kubemetes 1.7版本中，通过API服务器聚合，可以将自定义API服务器与主Kubernetes API服务器进行集成。从诞生以来，Kubernetes API服务器一直是单一的单片组件。直到Kubemetes 1.7版本，我们才可以在同一个location暴露多个聚合的API服务器。从此，客户端可以被连接到聚合API，并直接将请求转发给相应的API服务器。这样一来，客户端甚至无法察觉幕后有多个API服务器正在处理不同的对象。因此，即使是Kubernetes API核心服务器最终也可能会被拆分成多个较小的API服务器。通过聚合后，这些被拆分的API服务器会作为单独服务器被暴露，如图18.5所示。</p>
<p>图18.5API服务器聚合<br>对你来说，可以创建一个专门负责处理你的网站对象的API服务器，并使它参照Kuberetes API核心服务器验证对象的方式来验证你的网站。这样你就不必再创建CRD来表示这些对象，就可以直接将网站对象类型实现到你的自定义API服务器中。<br>通常来说，每个API服务器会负责存储它们自己的资源。如图18.5所示，它可以运行自己的etcd实例（或整个etcd集群），也可以通过创建CRD实例将其资源存储在核心API服务器的etcd存储中。在这种情况下，就需要先创建一个CRD对象，然后才能创建CRD实例，正如在示例中所做的那样。</p>
<p>注册一个自定义API服务器<br>如果你想要将自定义 API 服务器添加到集群中，可以将其部署为一个 pod 并通过 Service 暴露。下一步， 为了将它集成到主 API 服务器中， 需要部署一个描述APIService 资源的 YAML 列表， 如下面的代码清单所示。<br>代码清单18.8APIService YAML定义</p>
<p>在创建以上代码列表中的APIService资源后，被发送到主API服务器的包含extensions.example.comAPI组任何资源的客户端请求，会和vlalpha1版本号一起被转发到通过website-api Service公开的自定义API服务器pod。<br>创建自定义客户端<br>虽然你可以使用常规的kubectl客户端从YAML文件创建自定义资源，但为了更简便地部署自定义对象，除了提供自定义API服务器，还可以构建自定义CLI工具。构建自定义CLI工具之后，你就可以添加用于操作这些对象的专用命令，类似于kubectl允许通过resource-specifc命令（如kubectl createsecret或kubectl create deployment）创建Secret、Deployment和其他资源。<br>正如前文所述，定制API服务器、API服务器聚合，以及与Kubermetes扩展相关的其他功能目前还在不断开发中。因此，它们的最新进展在本书发布后仍将发生变化。想要获得有关该主题的最新信息，可以参阅<a href="http://github.com/kubernetes中的Kubernetes" target="_blank" rel="noopener">http://github.com/kubernetes中的Kubernetes</a> Git仓库。<br>18.2使用Kubernetes服务目录扩展Kubernetes<br>第一个通过API服务器aggregation 加入Kubernetes的附加API服务器是服务目录API服务器。服务目录是Kubernetes社区的热门话题之一，让我们来了解一下。<br>目前，对于使用服务的pod（这里的服务与Service资源无关。例如，数据库服</p>
<p>务包含了用户能够在其应用中使用数据库所需的所有内容），有人需要部署提供服务的pod、一个Service资源，可能还需要一个可以让客户端pod用来同服务器进行身份认证的密钥。通常是与部署客户端pod相同的一个用户，或者如果一个团队专门部署这些类型的通用服务。那么用户需要提交一个票据，并等待团队提供服务。这意味着用户需要为服务的所有组件创建文件，知道如何正确配置，并手动部署，或者等待其他团队来完成。<br>但是，Kubermetes 显然应该是一个 易于使用的自助服务系统。理想情况下， 如果用户的应用需要特定的服务（例如，需要后端数据库的web应用程序），那么他只需要对Kubermetes说：“嘿，我需要一个PostgreSQL数据库。请告诉我在哪里，以及如何连接到它。”想要快速实现这-功能，你就需要使用Kubermetes服务目录。18.2.1服务目录介绍<br>顾名思义，服务目录就是列出所有服务的目录。用户可以浏览目录并自行设置目录中列出的服务实例，却无须处理服务运行所需的Pod、Service、ConfigMap和其他资源。这听起来与自定义网站资源很相似。<br>服务目录并不会为每种服务类型的API服务器添加自定义资源，而是将以下四种通用API资源引入其中：<br>一个ClusterServiceBroker， 描述一个可以提供服务的（外部）系统<br>个ClusterServiceClass， 描述一个可供应的服务类型<br>一个ServiceInstance， 己配置服务的一 一个实例<br>·一个ServiceBinding， 表示一 组客户端（pod） 和ServiceInstance之间的绑定图18.6中阐释了这四种资源的关系，接下来我们会做进一步解释。</p>
<p>图18.6服务目录API资源之间的关系<br>简而言之，集群管理员为会每个服务代理创建一个ClusterServiceBroker资源，而这些服务代理需要在集群中提供它们的服务。接着，Kuberetes从服务代理获取它可以提供的服务列表，并为它们中的每个服务创建一个ClusterServiceClass资源。当用户调配服务时，首先需要创建一个Servicelnstance资源，然后创建一个ServiceBinding 以将该ServiceInstance绑定到它们的pod。下一步，这些pod会被注入一个Secret，该Secret包含连接到配置的ServiceInstance所需的凭证和其他数据。图18.7展示了服务目录系统体系结构。</p>
<p>aUEK力<br>图18.7服务目录的体系结构<br>接下来对图中的各个组件进行说明。<br>18.2.2 服务目录API服务器与控制器管理器介绍<br>与核心Kubernetes类似的是，服务目录也是由三个组件组成的分布式系统：，服务目录API服务器<br>作为存储的etcd<br>运行所有控制器的控制器管理器<br>之前所介绍的四个与服务目录相关的资源是通过将YAML/JSON清单发布到API服务器来创建的。随后， API 服务器会将它们存储到自己的etcd实例中，或者使用主API服务器中的CRD作为替代存储机制（在这种情况下不需要额外的etcd实例）。<br>使用这些资源的控制器正在控制器管理器中运行。显然，它们与服务目录API服务器交互的方式，与其他核心Kubernetes控制器与核心API服务器交互的方式相同。这些控制器本身不提供所请求的服务，而是将其留给外部服务代理，再由代理通过在服务目录API中创建Servic eBroker资源进行注册。<br>18.2.3 Service代理和OpenServiceBroker API<br>集群管理员可以在服务目录中注册一个或多个外部Servic eBroker。同时，每个代理都必须实施Op enServic eBrokerAPI.</p>
<p>OpenServiceBrokerAPl介绍<br>通过OpenServiceBroker API，服务目录可以通过API与broker进行通信。这个简单的RESTAPI，能够提供以下功能：<br>·使用GET/v2/catalog检索服务列表<br>。配置服务实例（PUT/v2/service_instances/：id）<br>·更新服务实例（PATCH/v2/service_instances/：id）<br>·绑定服务实例（PUT/v2/service_instances/：id/service bindings/:binding_id)<br>解除绑定实例（DELETE/v2/service_instances/：id/service_bindings/:binding_id)<br>·取消服务实例配置（DELETE/v2/service_instances/：id）<br>查看OpenServiceBrokerAPI规范，请浏览<a href="https://github.com/openservicebrokerapi/servicebroker。" target="_blank" rel="noopener">https://github.com/openservicebrokerapi/servicebroker。</a><br>在服务目录中注册代理<br>集群管理员可以通过向服务目录API发布ServiceBroker资源清单来注册代理，如代码清单18.9所示。<br>代码清单18.9一个ClusterServiceBroker清单：database-broker.yaml<br>正</p>
<p>代码清单 18.9 描述了一个可以提供不同类型数据库的虚构代理。在管理员创建 ClusterServiceBroker 资源后，Service Catalog Controller Manager 中的控制器就会连  接到资源中指定的URL， 并且检索此代理可以提供的服务列表。<br>在检索服务列表后， 就会为每个服务创建一个 ClusterServiceClass 资源。每个ClusterServiceClass 资源都描述 了一种可供应的服务（“PostgreSQL 数据库”就是ClusterServiceClass 的一个典型例子）。 每个 ClusterServiceClass 都有一个或多个与之关联的服务方案。 用户可以根据他们需要的服务级别选择不同的方案（例如，仅提供有限数据库和机械硬盘的“免费” 方案，或是提供无线数据库和 SSD存储的“高</p>
<p>端”方案）。<br>罗列集群中的可用服务<br>通过使用 kubectl get serviceclasses， Kubernetes 集群用户可以按照  以下代码清单中的方法检索集群中所有 可供应服务列表。<br>代码清单 18.10<br>集群中的 ClusterServiceClass 列表<br>$ kubectl get clusterserviceclasses<br>NAME<br>KIND<br>postgres-database<br>ClusterServiceClass.vlalpha1 .servicecatalog.k8s.io<br>mysql-database<br>ServiceClass.v1alphal.servicecatalog.k8s.io<br>mongodb-database<br>ServiceClass.v1alpha1 .servicecatalog.k8s.io<br>这个代码清单显示了虚拟数据库代理可 以提供的服务 ClusterServiceClasses。 通过将 ClusterServiceClass与在第6章 中讨论的StorageClass 进行比较，就会发 现两者之间的区别，StorageClass允许你选择想要容器中使用的存储类型， 而ClusterServiceClasses 允许选择服务类型。<br>可以采用检索其YAML的方式， 来查看其中一个ClusterServiceClass 的详细信息。<br>代码清单18.11ClusterServiceClass定义</p>
<p>代码清单中的 ClusterServiceClass 包含两种方案:free方案和premium方案。<br>我们可以看到 ClusterServiceClass是由 database-broker broker提供的。</p>
<p>18.2.4 提供服务与使用服务<br>假设你正在部署的 pod 需要使用数据库。 在此之前，你已经查看了全部可用 的 ClusterServiceClass 列表，并选择使用 postgres-database ClusterServiceClassfree 方案。<br>提供服务实例<br>要想预分配数据库，需要做的是创建一个 ServiceInstance 资源，如下面的代码 清单所示。<br>代码清单18.12 Servicelnstance 列表：database-instance.yaml</p>
<p>创建了一个名为my-postgres-db （这会是你部署的资源的名字）的ServiceInstance，并且指定ClusterServiceClass、选定方案。还需要指定一个明确的broker和ClusterServiceClass需要的参数。假设你已经看过broker的文档了解了可能需要的参数。<br>一旦你创建了这个资源，服务目录就要求ClusterServiceClass所属的代理来调配服务，它将传递你选择的ClusterServiceClass、 计划名称以及指定的所有参数。<br>接下来，由于采取何种方法处理这些信息完全由代理决定，你可能会看到你的数据库代理会启动一个新的PostgresSQL数据库的实例，这个实例可能不在同一个 Kubemetes集群中，甚至根本不在Kubemetes中，而是在一个虚拟机上运行数据库。 对此，服务目录和用户请求服务都不会察觉。<br>可以通过检查你创建的my-postgres-db ServiceInstance 的status来检查是否已经成功提供服务，如以下代码清单所示。<br>代码清单18.13查看Servicelnstance 状态</p>
<p>可以看到数据库实例已经在运行了，但如果你想在pod中使用这个实例，就需要将其绑定。<br>绑定服务实例<br>想要在pod中使用配置的ServiceInstance，可以按照以下代码列表创建ServiceBindingresource。<br>代码清单18.14 ServiceBinding： my-postgres-db-binding.yaml</p>
<p>代码显示你正在定义一个名为my-postgres-db-binding的ServiceBinding资源，其中引用了之前创建的my-postgres-db服务实例，同时你也命名了一个Secret。在这个名为postgres-secret的Secret中，你希望服务目录放入所有访问服务实例必需的凭证。但是要在哪里将Servicelnstance绑定到pod上呢？实际上，并不需要绑定。<br>目前，服务目录并不能向pod注入Servicelnstance的证书。当一个叫PodPresets的新的Kubemetes特性可用时向pod注入ServiceInstance 证书将变得可能。在那之前，可以创建一个密钥，将需要的证书存进密钥并将密钥手动挂载到pod上。<br>在你将ServiceBinding资源从先前的列表提交到服务目录API服务器时，控制器会再次联系数据库代理，并为之前配置的ServiceInstance创建一个绑定。作为响应，这时候代理会返回以连接到数据库所需的凭证和其他数据。随后，服务目录会使用在ServiceBinding资源中指定的名称创建一个新的Secret，并将所有数据存储在Secret中。<br>在客户端pod中使用新创建的Secret<br>服务目录系统创建的Secret可以装载到pod中，这样Secret就可以读取其中的</p>
<p>内容并使用它们连接到配置好的服务实例 （示例中的一个 PostgreSQL数据库）。这 个 Secret 可能和 以下代码清单中的十分相似。<br>代码清单18.15一个持有连接到服务实例的凭证的 Secret</p>
<p>由于可以自己选择Secret的名称，因此可以在设置或绑定服务之前部署pod。如果没有这样一个Secret， pod就不会启动，就像第7章中提到的那样。<br>必要情况下，还可以为不同的pod创建多个绑定。这样一来服务代理就可以在每个绑定中使用相同的凭据集（但最好为每个绑定实例重新创建一组凭据）。通过这种方式，你就可以通过删除ServiceBinding资源来阻止使用该服务。<br>18.2.5解除绑定与取消配置<br>一旦你不再需要服务绑定，可以按照删除其他资源的方式将其删除：<br>$ kubectl delete servicebinding my-postgres-db-binding<br>servicebinding “my-postgres-db-binding” deleted<br>这时候，服务目录控制器将删除密钥并通知代理解除绑定，而服务实例（PostgreSQL数据库）仍会运行。因此，你可以创建一个新的服务绑定。<br>但是，如果你不再需要数据库实例，就应该一并删除服务实例资源：<br>$ kubectl delete serviceinstance my-postgres-db<br>serviceinstance “my-postgres-db u deleted<br>删除ServiceInstance资源后，服务目录就会在服务代理上执行取消配置的操作。同样，尽管取消配置带来的后果是由代理决定的，但你应该让代理关闭调配服务实例时创建的PostgreSQL数据库实例。<br>18.2.6 服务目录给我们带来了什么<br>如你所知，服务提供者可以通过在任何Kubernetes集群中注册代理，在该集群</p>
<p>中暴露服务，这就是服务目录的最大作用。<br>很早之前，笔者就已经使用服务目录实施了一个代理。由此，可以很方便地配 置消息系统，并将其暴露给 Kubernetes 集群中的 pod。 也有别的团队实施了一个能轻松配置 Amazon Web 服务的代理。<br>总而言之，服务代理让你能够在 Kubernetes 中轻松配置和暴露服务。 这一优点使得 Kubernetes 成为你部署应用程序的最佳平台之一。<br>18.3 基于Kubernetes搭建的平台<br>由于 Kubernetes 中的组件都可以轻松扩展， 越来越多原本拥有自研平台的公司转而在 Kubernetes 上重新实施。 Kubernetes 被大量新一代 PaaS 产品采用， 这也证明了它的确是一个伟大的系统。<br>基于 Kubernetes 构建的最著名的PaaS 系统包括 Deis Workflow 和 Red Hat 的 OpenShift。 我们对这两套系统进行大致介绍，看看 Kubernetes 在它们的成功背后发挥了什么作用。<br>18.3.1 红帽 OpenShift 容器平台<br>作为一个 PaaS 平台，红帽（Red Hat） OpenShift 非常注重开发者的体验。红帽 OpenShift 容器平台最想要实现的目标就是帮助开发者实现应用程序快速开发、 便捷部署、轻松扩展以及长期维护。早在 Kubernetes 正式发布之前， OpenShift 容器平台就已经迭代了第一版和第二版。而当 Kubernetes 正式发布之后， 红帽公司当即决定，抛弃原有基础，基于 Kubernetes 重新开发第三版， 对于像红帽这样的公司来说，显然是充分考察了 Kubernetes 的优点， 才会做出如此重大决策。<br>与Kubernetes 能够实现应用程序自动化部署和扩展相似， OpenShift 也能实现应用程序开发自动化， 并且开发者无须在集群中集成解决方案即 可完成自动部署。<br>OpenShift 还提供了用户管理和群组管理功能， 使你能够运行安全的多用户 Kubernetes 集群。 在这个集群中个人用户只能访问他们自己名下的 Kubernetes空间， 而在这些空间中运行的应用程序也默认完全与网络隔离。<br>OpenShift 容器平台中其他可用的资源<br>除了 Kubernetes 中提供的所有可用 API 外， OpenShift还提供了一些额外的 API 对象。通过接下来的介绍， 你就能很好地了解 OpenShift 所提供的功能。这些功能包括：<br>Users&amp;Groups（用户与群组）<br>Projects（项目）</p>
<p>· Templates（模板）<br>· Buildconfigs（构建配置）<br>· DeploymentConfigs （部署配置）<br>· ImageStreams（镜像流）<br>· Routes（路由）<br>·其他<br>用户、群组、项目简介<br>在前文中我们已经提到，与Kubernetes没有API对象来表示集群中的单个用户不同，OpenShift为用户提供了多用户环境（Kubernetes可以用ServiceAccounts代表运行在其中的服务）。OpenShif可以设定每个用户可以执行或不能执行的操作。这些强大的用户管理功能实现时间早于基于角色的访问控制，而到了Kubernetesvanilla版本中，已经成了标准功能。<br>每个用户只能访问特定的项目，而这些项目仅仅是一个个带有附加注释的Kubernetes命名空间。用户只能对其有权访问的项目中的资源进行操作，并且仅有集群管理员能够授予用户项目访问权限。<br>应用程序模板简介<br>Kubernetes可以通过单个JSON或YAML清单部署一组资源。而OpenShift则更进一步，通过让清单可参数化来完成这一工作，这个可参数化的列表就被称为模板（Template）。应用程序模板实际上就是一个对象列表，列表中的定义包含了一些占位符。在你处理完这些占位符，并将模板实例化之后，就可以用参数值替换这些占位符（见图18.8）。</p>
<p>图 18.8 OpenShift 模板<br>本质上，模板就是一个包含了参数列表的 JSON或 YAML 文件，列举了这个 JSON / YAML 文件定义的资源中被引用的参数。 与其他对象一样，模板也可以存储</p>
<p>在API服务器中。在你将模板实例化之前，需要事先通过以下方式进行处理：首先提供模板参数的值，然后OpenShift用这些值替换对参数的引用。经过处理之后，你就能像创建Kubernetes资源列表一样， 通过单个POST请求创建模板了，<br>OpenShift还为用户提供了许多预制的模板列表，用户仅需指定几个参数（如果模板为参数提供合理的默认值，甚至可以不用指定参数），就能快速运行复杂的应用程序。例如，一个模板可以创建JavaEE应用程序所需的全部Kubernetes资源，来保证其在应用程序服务器中运行。同时，模板还能将应用程序服务器与后端数据库连接。用户只需一个命令就能完成全部部署。<br>使用构建配置通过源码构建镜像<br>通过将OpenShift集群指向包含应用程序源代码的Git存储库，用户能在 OpenShift集群中快速构建和部署应用程序，这也是OpenShift最好的特性之一。OpenShift会创建一个名为构建配置的资源，构建配置能够在你向Git仓库提交变更之后立即触发构建容器镜像，这样你就不必亲自构建容器镜像了，因为OpenShift已经为你完成了这一步。<br>尽管OpenShift不会监控Git仓库本身，但仓库中的hook可以将新的提交通知OpenShift。然后，OpenShift 将从Git仓库中提取更改并开始构建过程。通过一个名为Source To Image的构建机制，可以检测Git存储库中的应用程序类型，并为其运行适当的构建过程。例如，如果它检测到JavaMaven格式项目中使用的pom.xml文件，那么它就会运行Maven构建。构建生成后，它就会被打包到容器镜像中，并被推送到内部容器注册表（由OpenShift提供）。在注册表内，构建就会被提取并在集群中运行。<br>开发者通过创建一个BuildConfig对象，就可以指向一个Git仓库。这样开发者就不用再构建容器镜像，甚至几乎不需要知道有关容器的任何信息。如果ops团队部署了OpenShift 集群并向开发者开放访问，那么开发者就能像将应用程序打包到容器一样，将他们开发好的代码提交并推送到Git仓库。而接下来的构建、部署和应用程序管理就都会由OpenShift负责。<br>使用部署配置自动部署新建的镜像<br>通过创建一个部署配置对象并将其指向一个镜像流的方法，新建立的容器镜像也可以自动部署到集群中。顾名思义，镜像流就是一串图像，镜像一旦被构建就会被添加到镜像流中。由于这-功能，DeploymentConfig 能够及时找到新建的镜像，并允许它产生新镜像（见图18.9）。</p>
<p>图 18.9 OpenShift 中的构建配置和部署配置<br>除了发布时间更早，部署配置与 Kubernetes中的部署对象几乎相同。并且，和 部署对象一样， 部署配置具有用于在部署之间转换的可配置策略。部署配置包含一个用于创建实际 pod 的 pod 模板， 但它也同时支持配置部署前hook和部署后 hook。与 Kubernetes 部署会创建 ReplicaSet 不同的是，部署配置的是 ReplicationController，并提供了一些附加功能。<br>使用路由向外部暴露服务<br>在 Kubernetes 诞生之初，它并没有提供 Ingress 对象，所以需要使用 NodePort 或是 LoadBalancer 类型的服务来对外暴露服务。而在那个时候， OpenShift就已经通过路径资源提供了一个更好的选择。 尽管路径与 Ingress 有些类似，但它提供了 一些与 TLS 终止和流量拆分有关的其他配置。<br>与 Ingress 控制器类似， 路径也需要一个路由器作为一个控制器来提供负载均衡器，或者该路由器提供负载均衡器或代理。 而与 Kubernetes 不同的是，OpenShift 提 供的路由器能够做到开箱即用。<br>试用 OpenShift<br>如果你有兴趣尝试OpenShift，可以先使用 Minishift（与Minikube 等效的 OpenShift)。还可以在<a href="https://manage.openshift.com上尝试免费的多租户托管解决方案一OpenShift" target="_blank" rel="noopener">https://manage.openshift.com上尝试免费的多租户托管解决方案一OpenShift</a> Online Starter。<br>18.3.2 Deis Workflow与Helm<br>另一个基于 Kubernetes 开发的优秀 PaaS 产品案例是 Deis 的 Workflow， 而微软 宣布完成了对 Deis 的收购。除了 Workflow， 他们还开发了一个名为 Helm 的工具。</p>
<p>在Kubermetes社区里，Helm已经成了部署现有应用的标准方式，具有极大的知名度。接下来会介绍一下这两个产 品。<br>Deis Workflow简介<br>可以将DeisWorkflow部署到任何现有的Kubernetes集群中（而OpenShift是一个包含修改后的API服务器和其他Kubernetes组件的完整集群）。在你运行Workflow时，它会创建一组 Service和ReplicationController，这会为开发人员提供一个简单、友好的开发环境。<br>只需通过gitpushdeismaster推送更改就可以触发应用程序新版本更新，而剩余的工作都会由Worklow完成。与OpenShift类似，Workflow 也为核心Kubernetes中的镜像机制、应用部署和回滚、边缘路由、日志聚合、指标监控和告警提供了源。<br>想要在Kubernetes集群中运行Workflow，你首先需要安装DeisWorkflow和HelmCLI工具，然后将Workfow安装到集群中。具体步骤和更多详细情况可以访问<a href="https://eis.com/workfow.接下来我们将要探讨Helm工具，它可以在没有工作流的情况下使用，并且已经在社区中得到普及。" target="_blank" rel="noopener">https://eis.com/workfow.接下来我们将要探讨Helm工具，它可以在没有工作流的情况下使用，并且已经在社区中得到普及。</a><br>通过Helm部署资源<br>Helm是一个Kubernetes包管理器（类似于OS包管理器，比如Linux中的yum、apt， 或者MacOS中的homebrew）。<br>Helm由两部分组成：<br>， 一个helm CLI工具（客户端）.<br>·Tiller，一个作为Kuberetes集群内pod运行的服务器组件。<br>这两个组件用于在Kubernetes集群中部署和管理应用程序包。Helm应用程序包称为图表，它们与配置结合在一起，包含配置信息且合并到图表中以创建一个发行版本（Release）， 这是一个应用程序的运行实例（结合了图表和配置）。可以使用 helm CLI工具部署和管理发行版本，以及与Tiller服务器交互。如图18.10所示， 想要创建所有图表中定义的必需Kubemetes资源，你就需要使用Tiller服务器组件。<br>可以自己创建图表并将它们保存在本地磁盘.上，也可以在<a href="https://github.com/kubernetes/charts.上寻找现有的图表。目前，可用的图表数量还在不断增加中，包括" target="_blank" rel="noopener">https://github.com/kubernetes/charts.上寻找现有的图表。目前，可用的图表数量还在不断增加中，包括</a> PostgreSQL、MySQL、MariaDB、 Magento、 Memcached、 MongoDB、OpenVPN 、 PHPBB、RabbitMQ、 Redis、 WordPress 等应用程序的图表。<br>就像你不需要在Linux系统中手动构建和安装其他人开发的应用程序一样，你可能也不想亲自为这些应用程序构建和管理自己的Kubernetes清单。因此，Helm和笔者所提到的GitHub仓库正是你需要的。</p>
<p>图 18.10Helm概览<br>如果你准备在 Kubernetes 集群中运行 PostgreSQL或MySQL数据库，不必急着 编写清单，而是检查一下是否已经有别人踩过相关的坑， 并且准备好了一个 Helm图表。<br>一旦某人为特定的应用程序准备了Helm 图表并将其添加到Helm 图表 Git 仓库 中， 安装整个应用程序只需一条单行命令。 比如说，你想要在 Kubernetes 集群中运行 MySQL，只需将图表Git 仓库克隆到你的本地计算机， 然后运行以下命令（需要保证你的集群中运行了Helm 的 CLI 工具和 Tiller）：<br>$ helm install —name my-database stable/mysql<br>这样就能够创建在集群中运行 MySQL 所需的 Deployment、Service、Secret和 PersistentVolumeClaim，你不必关心 自己需要什么组件， 以及如何配置它们以正确运行MySQL。是不是很棒！<br>提示OpenVPN 图表是仓库中最有趣的图表之一， 他能使你在Kubemetes 集群内运行 OpenVPN服务器，并允许你通过 VPN 和访问服务来输入 pod 网络，就好像 本地计算机是集群中的一个容器一样。 这在开发应用程序并在本地运行时非常有用， 。<br>以上这些例子说明了 Kubemetes 以及 Red Hat 和 Deis（现在的微软）等公司如 何扩展应用。你还在等什么？快赶上 Kubernetes 的浪潮吧！<br>18.4 本章小结<br>在最后一章里，我们向你展示了基于 Kubernetes 扩展各种功能，并介绍了 Deis 和 Red Hat 的应用案例。读完本章， 你已经能够掌握如下知识： </p>
<p>通过创建一个 CRD 对象， 能够在 API 服务器中注册自定义资源。<br>可以对自定义对象实例进行存储、检索、 更新和删除，而无须更改 API 服务 器代码。<br>实施自定义控制器能让对象生效。<br>Kubernetes 可以通过 API aggregation 扩展自定义 API 服务器。<br>Kubernetes 服务目录使自部署外部服务， 并且暴露给集群中运行的 pod 变为可能。<br>通过API聚合，Kubernetes 可以在自定义 API 服务器进行扩展。<br>·基于Kubernetes 构建的 PaaS 产品可以轻松地在同一个Kubernetes集群中构建、 运行容器化应用程序。<br>使用名为 Helm 的软件包管理器， 可以部署现有的应用程序， 而不需要为它们构建资源清单。<br>感谢你花时间阅读这本书。 笔者在撰写这本书的过程中学到了很多 ，希望你在阅读后也能收获颇丰。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Kubernetes-in-Action/" rel="tag"># Kubernetes in Action</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/10/01/17-开发应用的最佳实践/" rel="next" title="17-开发应用的最佳实践">
                <i class="fa fa-chevron-left"></i> 17-开发应用的最佳实践
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/10/01/30-如何使用Redis实现分布式锁？/" rel="prev" title="30 | 如何使用Redis实现分布式锁？">
                30 | 如何使用Redis实现分布式锁？ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="CheBin">
            
              <p class="site-author-name" itemprop="name">CheBin</p>
              <div class="site-description motion-element" itemprop="description">看视频才能学会，看文字学不会的</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">1140</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">27</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">79</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          


          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/2023/07/19/zero-admin-3/" title="zero-admin-3" target="_blank">zero-admin-3</a>
                  </li>
                
                  <li>
                    <a href="/2023/07/19/zero-admin-2/" title="zero-admin-2" target="_blank">zero-admin-2</a>
                  </li>
                
                  <li>
                    <a href="/2023/07/19/zero-admin-1/" title="zero-admin-1" target="_blank">zero-admin-1</a>
                  </li>
                
                  <li>
                    <a href="/2023/07/19/Day7-服务发现与注册中心/" title="Day7 服务发现与注册中心" target="_blank">Day7 服务发现与注册中心</a>
                  </li>
                
                  <li>
                    <a href="/2023/07/19/Day6-负载均衡/" title="Day6 负载均衡" target="_blank">Day6 负载均衡</a>
                  </li>
                
              </ul>
            </div>
        

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CheBin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">8.9m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">135:21</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
