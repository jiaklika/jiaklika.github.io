<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="思考并回答以下问题：">
<meta name="keywords" content="Kubernetes进阶实战">
<meta property="og:type" content="article">
<meta property="og:title" content="第8章 配置容器应用：ConfigMap和Secret">
<meta property="og:url" content="http://yoursite.com/2022/10/06/第8章-配置容器应用：ConfigMap和Secret/index.html">
<meta property="og:site_name" content="车斌的技术博客">
<meta property="og:description" content="思考并回答以下问题：">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2022-10-06T10:01:36.572Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第8章 配置容器应用：ConfigMap和Secret">
<meta name="twitter:description" content="思考并回答以下问题：">






  <link rel="canonical" href="http://yoursite.com/2022/10/06/第8章-配置容器应用：ConfigMap和Secret/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>第8章 配置容器应用：ConfigMap和Secret | 车斌的技术博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">放弃会成为一种习惯</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/10/06/第8章-配置容器应用：ConfigMap和Secret/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CheBin">
      <meta itemprop="description" content="什么是强迫自己？就是不想去干什么，就去干什么">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">第8章 配置容器应用：ConfigMap和Secret

              
            
          </h1>
        

        <div class="post-meta">

          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2022-10-06 16:20:10 / 修改时间：18:01:36" itemprop="dateCreated datePublished" datetime="2022-10-06T16:20:10+08:00">2022-10-06</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">21k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">19 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考并回答以下问题：</p>
<a id="more"></a>
<p>ConfigMap和Secret是Kubernetes系统上两种特殊类型的存储卷，ConfigMap对象用于为容器中的应用提供配置数据以定制程序的行为，不过敏感的配置信息，例如密钥、证书等通常由Secret对象来进行配置。它们将相应的配置信息保存于对象中，而后在Pod资源上以存储卷的形式将其挂载并获取相关的配置以实现配置与镜像文件的解耦。本章将主要讲解ConfigMap与Secret存储卷的用法。<br>8.1容器化应用配置方式<br>每个应用程序都是一个可执行程序文件，它包含操作码列表，CPU通过执行这些操作码来完成特定的操作。例如，cat命令是由/usr/bin/cat文件提供的，该文件含有机器指令的列表，在屏幕上显示指定文件的内容时需要使用这些机器指令。几乎每个程序的行为都可以通过其命令行选项及参数或配置文件来按需定制。实践中，人们通常不会以默认的配置参数运行应用程序，而是需要根据特定的环境或具体的需求定制其运行特性，对于复杂的服务类应用程序更是如此，如Nginx、Tomcat和HBase等，而且通过配置文件定义其配置通常是首选甚至是唯一的途径。<br>那么，如何为容器中的应用提供配置信息呢？例如，为Nginx配置一个特定Server或指定worker进程的数量，为Tomcat的JVM配置其堆内存的大小等。传统实践中，通常有这么几种途径：启动容器时直接向命令传递参数、将定义好的配置文件硬编码于（嵌入）镜像文件中、通过环境变量（EnvironmentVariables）传递配置数据，以及基于Docker卷传送配置文件等。</p>
<p>1.通过命令行参数进行配置<br>Docker容器可用来运行单个应用程序。在制作Docker镜像时，Dockerfile中的ENTRYPOINT和CMD指令可用于指定容器启动时要运行的程序及其相关的参数。CMD指令以列表的形式指定要运行的程序及其相关的参数，但若同时存在ENTRYPOINT指令，则CMD指令中列表的所有元素均将被视作是由ENTRYPOINT指定的程序的命令行参数。另外，在基于某镜像使用Docker命令创建容器时，可以在命令行向ENTRYPOINT中的程序传递额外的自定义参数，甚至还可以修改要运行的应用程序本身。例如，使用dockerrun命令创建并启动容器的格式为：dockerrun[OPTIONS]IMAGE[COMMAND][ARG…]<br>其中的[COMMAND]即为自定义运行的程序，[ARG]则是传递给程序的参数。若定义相关的镜像文件时使用了ENTRYPOINT指令，则[COMMAND]和[ARG]都会被当作命令行参数传递给ENTRYPOINT指令中指定的程序，除非为dockerrun命令额外使用—entrypoint选项覆盖ENTRYPOINT而指定运行其他程序。相关的使用详情请参考Docker的相关教程。<br>在Kubernetes系统上创建Pod资源时，也能够向容器化应用传递命令行参数，甚至指定运行其他应用程序，相关的字段分别为pods.spec.containers.command和pods.spec.containers.args。这一点在前面相关的章节中已有相关的使用说明。<br>2.将配置文件嵌入镜像文件<br>所谓的将配置文件嵌入镜像文件，是指用户在Dockerfile中使用COPY指令把定义好的配置文件复制到镜像文件系统上的目标位置，或者使用RUN指令调用sed或echo一类的命令修改配置文件从而达到为容器化应用提供自定义配置文件之目的。使用时，若DockerHub上的某镜像文件额外添加配置文件即能符合需要，则克隆其Dockerfile文件修改至符合需求之后再将之推送至GitHub，并由DockerHub自动构建出镜像文件即可。<br>这种方式的优势在于对于用户来说简单易用，不用任何额外的设定就能启动符合需求的容器，用于Kubernetes环境亦无须多余的配置。但配置文件相关的任何额外的修改需求都不得不通过重新构建镜像文件来实现，路径长、效率低。<br>3.通过环境变量向容器注入配置信息<br>通过环境变量为镜像提供配置信息是DockerHub上最常见的使用方式。例如，使用MySQL官方提供的镜像文件启动MySQL容器时使用的MYSQL_ROOT_PASSWORD环境变量，它用于为MySQL服务器的root用户设置登录密码。<br>在基于此类镜像启动容器时，用户为dockerrun命令通过e选项向环境变量传值即能实现应用配置，命令的使用格式为“dockerrun-eSETTING1=foo-eSETTING2=bar<imagename>”。启动时，容器的ENTRYPOINT启动脚本会抓取到这些环境变量，并在启动容器应用之前，通过sed或echo等一类的命令将变量值替换到配置文件中。<br>一般说来，容器的ENTRYPOINT脚本应该为这些环境变量提供默认值，以便在用户未为环境变量传值时也能基于此类需要环境变量的镜像启动容器。使用环境变量这种配置方式</imagename></p>
<p>的优势在于配置信息的动态化供给，不过，有些应用程序的配置可能会复杂到无法通过key/value格式的环境变量完成。<br>另外，也可以让容器的ENTRYPOINT启动脚本通过网络中的K/V存储获取配置参数，常用的此类存储系统有Consul或etcd等。这种方式较之简单的环境变量能够提供更复杂的配置信息，因为KV存储系统支持多层级的嵌套数据结构，有一些应用广泛的数据抓取工具能够从KV存储中加载相关的数据并替换于配置文件中，甚至于像confd这类的工具还能在KV中的数据变化时自动将其重载至配置文件中，这一点实现了真正意义上的配置动态化。不过，这种方式为容器化应用引人了额外的依赖条件。<br>Kubernetes系统支持在为Pod资源配置容器时使用spec.containers.env为容器的环境变量传值从而完成应用的配置。如前所述，这种方式无法应付较复杂的配置场景，因此提供的配置能力也很有限。<br>4.通过存储卷向容器注入配置信息<br>Docker存储卷（volumes）能够将宿主机之上的任何文件或目录映射到容器文件系统上，因此，可以事先将配置文件放置于宿主机之上的某特定路径中，而后在启动容器时进行加载。这种方式灵活易用，但也依赖于用户需要事先将配置数据提供在宿主机上的特定路径下，而且在多主机模型中，若容器存在被调度至任一主机运行的可能性时，用户还需要将配置共享到任一宿主机以确保容器能够正确地获取到它们。<br>5.借助Dockerconfig进行容器配置<br>Dockerswarmservice自1.13版本起支持使用secret于容器之外保存二进制数据，包括口令、SSH私钥、SSL证书以及其他不建议通过网络传输或不应该在Dockerfile及程序源码中非加密保存的机密数据。用户可使用secret集中化管理这类数据并将其安全关联至那些需要访问这些数据的容器中。<br>另外，Docker自17.06版本起为swarmservice引人了允许用户于容器之外存储非敏感信息（如配置文件）的组件“serviceconfig”，从而支持用户创建通用目的镜像文件，并且不再需要通过挂载存储卷或使用环境变量为容器提供配置文件。<br>Dockerswarmservicesecret和config为容器化应用的配置提供了极大的灵活性，不过，它们也只能应用于Dockerswarmservice环境中，而不能应用于单独运行的容器之上。<br>Kubernetes系统也有类似的组件，它们称为Secret和ConfigMap，而且是Kubernetes系统上一等类别的资源对象，它们要么被Pod资源以存储卷的形式加载，要么由容器通过envFrom字段以变量的形式加载。<br>8.2通过命令行参数配置容器应用<br>创建Pod资源时，可以在容器定义中自定义要运行的命令以及为其传递的选项和参数。</p>
<p>在容器的配置上下文中，使用command字段指定要运行的程序，而args字段则可用于指定传递给程序的选项及参数。在配置文件中定义的command和args会覆盖镜像文件中相关的默认设定，这类程序会被直接运行，而不会由shell解释器解释运行，因此与shell相关的特性均不被支持，如命令行展开符号{}、重定向等操作。<br>下面是定义在command-demo.yaml文件中的Pod资源示例，它在容器command-demo-container中将busybox镜像文件中默认运行的命令[“/bin/sh”，”-c”]修改为[“httpd”]，并为其额外传递了[“-f”]选项：</p>
<p>事实上，用户也可以只在容器配置的上下文中提供args字段，以实现向默认运行的程序提供额外的参数。如果默认的命令为Shell解释器或entrypoint启动脚本，那么这些参数本身甚至还可以是要运行的命令及其参数。例如，下面的容器配置，表示要运行的程序为“/bin/sh-chttpd-f，实现了以shell解释器解释运行指定的程序之目的：<br>spec:<br>containers:<br>-name:command-demo-containerimage:busybox<br>args:[“httpa”,”-f”]<br>ports:<br>-containerPort:80<br>由上述的应用示例可见，Kubernetes配置文件中的command对应于Dockerfile中的ENTRYPOINT，而配置文件中的args则对应于Dockerfile中的CMD。在Kubernetes中只给出command字段时，它会覆盖Dockerfile中的ENTRYPOINT和CMD，只给出args字段时，它仅覆盖CMD，而同时给出command和args时，会对应覆盖ENTRYPOINT和CMD。其应用生效的示例如图8-1所示。<br>通过命令行参数的方式向容器应用传递配置数据的操作比较简单，但其功能有限，难</p>
<p>通过命令行参数进行的配置将无法基于这种机制另外需要注意的是，在容器创建完成后，修改command和args并不会直接生效，(以为应用生成复杂配置，尤其是那些不支持来实现<br>除非重建Pod对象。</p>
<p>图8-1command/args和ENTRYPOINT/CMD<br>8.3利用环境变量配置容器应用<br>于运行时配置Docker容器中应用程序的第二种方式是在容器启动时向其传递环境变量。Docker原生的应用程序应该使用很小的配置文件，并且每一项参数都可由环境变量或命令行选项覆盖，从而能够在运行时完成任意的按需配置。然而，目前只有极少一部分应用程序为容器环境原生设计，毕竟为容器原生重构应用程序工程浩大，且旷日持久。好在有通过容器启动脚本为应用程序预设运行环境的方法可用，通行的做法是在制作Docker镜像时，为ENTRYPOINT指令定义一个脚本，它能够在启动容器时将环境变量替换至应用程序的配置文件中，而后再由此脚本启动相应的应用程序。基于这类镜像运行容器时，即可通过向环境变量传值的方式来配置应用程序。<br>在Kubernetes中使用此类镜像启动容器时，也可以在Pod资源或Pod模板资源的定义中，为容器配置段使用env参数来定义所使用的环境变量列表。事实上，即便容器中的应用本身不处理环境变量，也一样可以向容器传递环境变量，只不过它不被使用罢了。<br>环境变量配置容器化应用时，需要在容器配置段中嵌套使用env字段，它的值是一个由环境变量构建的列表。环境变量通常由name和value（或valueFrom）字段构成。<br>Dname<string>：环境变量的名称，必选字段。<br>Ovalue<string>：环境变量的值，通过$（VARNAME）引用，逃逸格式为“$$（VAR_NAME）”，默认值为空。<br>OvalueFrom<object>：环境变量值的引用源，例如，当前Pod资源的名称、名称空间、标签等，不能与非空值的value字段同时使用，即环境变量的值要么源于value字段，要么源于valueFrom字段，二者不可同时提供数据。<br>valueFrom字段可引用的值有多种来源，包括当前Pod资源的属性值，容器相关的系统资源配置、ConfigMap对象中的Key以及Secret对象中的Key，它们应分别使用不同的嵌套字段进行定义。<br>口fieldRef<object>：当前Pod资源的指定字段，目前支持使用的字段包括metadata.</object></object></string></string></p>
<p>name、metadata.namespace、metadata.labels、metadata.annotations、spec.nodeName、spec.serviceAccountName、status.hostIP和status.podIP。<br>configMapKeyRef<object>：ConfigMap对象中的特定Key。<br>secretKeyRef<object>：Secret对象中的特定Key。<br>resourceFieldRef<object>：当前容器的特定系统资源的最小值（配额）或最大值（限额），目前支持的引用包括limits.cpu、limits.memory、limits.ephemeral-storage、requests.cpu、requests.memory和requests.ephemeral-storage。<br>下面是定义在配置文件env-demo.yaml中的Pod资源，其通过环境变量引用当前Pod资源及其所在的节点的相关属性值配置容器。fieldRef字段的值是一个对象，它一般由apiVersion（创建当前Pod资源的API版本）或fieldPath嵌套字段所定义：</object></object></object></p>
<p>创建上面资源清单中定义的Pod对象env-demo,而后打印它的环境变量列表、命令及<br>其结果如下:</p>
<p>容器的启动脚本或应用程序调用或处理这些环境变量，即可实现容器化应用的配置。相较于命令行参数的方式来说，使用环境变量的配置方式更清晰、易懂，尤其是对于首次使用相关容器的用户来说，这种方式能够快速了解容器的配置方式。不过，这两种配置方式有-一个共同的缺陷：法在容器应用运行过程中更新环境变量从而达到更新应用之目的。这通常意味着用户不得不为production.development和qa等不同的环境分别配置Pod资源。好在，用户还有ConfigMap资源可用。<br>8.4应用程序配置管理及ConfigMap资源<br>分布式环境中，基于负载、容错等需求的考虑，几乎所有的服务都需要在不同的机器节点上部署不止一个实例。随着程序功能的日益复杂，程序的配置日益增多，而且配置文件的修改频率通常远远大于代码本身，这种情况下，有时仅仅是一个配置内容的修改，就不得不重新进行代码提交到SVN/Git、打包、分发上线的流程。部署规则较大的场景中，分发上线工作既繁杂又沉重。<br>究其根本，所有的这些麻烦都是由于配置和代码在管理和发布过程中不加区分所致。配置本身源于代码，是为了提高代码的灵活性而提取出来的一些经常变化的或需要定制的内容，而正是配置的这种天生的变化特征为部署过程带来了不小的麻烦，也最终催生了分布式系统配置管理系统，将配置内容从代码中完全分离出来，及时可靠高效地提供配置访问和更新服务。<br>提国内分布式配置中心相关的开源项目有Diamond（阿里）、Apollo（携程）、Qconf（奇<br>虎360）和disconf（百度）等。<br>作为分布式系统的Kubernetes也提供了统一配置管理方案ConfigMap。Kubernetes基于ConfigMap对象实现了将配置文件从容器镜像中解耦，从而增强了容器应用的可移植性。简单来说，一个ConfigMap对象就是一系列配置数据的集合，这些数据可“注人”到Pod对象中，并为容器应用所使用，注人方式有挂载为存储卷和传递为环境变量两种。<br>ConfigMap对象将配置数据以键值对的形式进行存储，这些数据可以在Pod，对象中使用或者为系统组件提供配置，例如控制器对象等。不过，无论应用程序如何使用ConfigMap对象中的数据，用户都完可以通过在不同的环境中创建名称相同但内容不同的ConfigMap对象，从而为不同环境中同一功能的Pod资源提供不同的配置信息，实现应用与配置的灵.</p>
<p>活勾兑。<br>8.4.1创建ConfigMap对象<br>Kubernetes的不少资源既可以使用kubectlcreate命令创建，也可以使用清单创建，例如前面讲到的namespace。ConfigMap是另一个两种创建方式都比较常用的资源。而且，通过使用“kubectlcreateconfigmap”命令，用户可以根据目录、文件或直接值创建ConfigMap对象。命令的语法格式如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectlcreateconfigmap&lt;map-name&gt;&lt;data-source&gt;</span><br></pre></td></tr></table></figure></p>
<p>其中，<code>&lt;map-name&gt;</code>即为ConfigMap对象的名称，而<code>&lt;data-source&gt;</code>是数据源，它可以通过直接值、文件或目录来获取。无论是哪一种数据源供给方式，它都要转换为ConfigMap对象中的Key-Value数据，其中Key由用户在命令行给出或是文件数据源的文件名，它仅能由字母、数字、连接号和点号组成，而Value则是直接值或文件数据源的内容。<br>1.利用直接值创建<br>为“kubectlcreateconfigmap”命令使用“—from-literal”选项可在命令行直接给出键值对来创建ConfigMap对象，重复使用此选项则可以传递多个键值对。命令格式如下：<br>kubectlcreateconfigmapconfigmap_name-from-literal=key-name-1=value-1<br>例如，“下面的命令创建special-config时传递了两个键值对：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]$kubectlcreateconfigmapspecial-config</span><br><span class="line">--from-1iteral=special.how=very--from-literal=special.type=charm</span><br></pre></td></tr></table></figure></p>
<p>“getconfigmap”命令可用于查看创建的ConfigMap对象special-config的相关信息，例如，如下的命令及其结果：</p>
<p>此类方式提供的数据量有限，一般是在仅通过有限的几个数据项即可为Pod资源提供</p>
<p>足够的配置信息时使用。<br>2.基于文件创建<br>为“kubectlcreateconfigmap”命令使用“—from-file”选项即可基于文件内容来创建ConfigMap对象，它的命令格式如下。可以重复多次使用“-from-file”选项以传递多个文件内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectlcreateconfigmap&lt;configmap_namex--from-file=&lt;path-to-file&gt;</span><br></pre></td></tr></table></figure></p>
<p>例如，下面的命令可以把事先准备好的Nginx配置文件模板保存于ConfigMap对象nginx-config中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]$kubectlcreateconfigmapnginx-config\</span><br><span class="line">--from-file=./data/configs/nginx/conf.d/myserver.conf</span><br></pre></td></tr></table></figure></p>
<p>这种方式创建的ConfigMap对象，其数据存储的键为文件路径的基名，值为文件内容，例如下面命令显示的nginx-config对象的信息</p>
<p>如果需要自行指定键名，则可在“—from-file”选项中直接指定自定义的键，命令格式如下：<br>kubectlcreateconfigmap<configmap_name>—from-file=<my-key-name>=<path-to-file>通过这种方式创建的ConfigMap资源可以直接以键值形式收纳应用程序的完整配置信息，多个文件可分别存储于不同的键值当中。另外需要说明的是，基于直接值和基于文件创建的方式也可以混编使用。<br>3.基于目录创建<br>如果配置文件数量较多且存储于有限的目录中时，kubectl还提供了基于目录直接将多</path-to-file></my-key-name></configmap_name></p>
<p>个文件分别收纳为键值数据的ConfigMap资源创建方式。将“—fom-file”选项后面所跟的路径指向一个目录路径就能将目录下的所有文件—同创建于同一ConfigMap资源中，命令格式如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectlcreateconfigmap&lt;configmap_.name&gt;--from-file=&lt;path-to-directory&gt;</span><br></pre></td></tr></table></figure></p>
<p>如下面的命令，将/data/configs/nginx/conf.d/目录下的所有文件都保存于nginx-configfiles对象中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]$kubectlcreateconfigmapnginx-config-files--from-file=./data/configs/nginx/conf.d/</span><br></pre></td></tr></table></figure></p>
<p>此目录中包含myserver.conf、myserver-status.cfg和myserver-gzip.cfg三个配置文件。创建ConfigMap资源时，它们会被分别存储为三个键值数据，如下面的命令及其结果所示：</p>
<p>注意，describe命令和get-oyaml命令都可显示由文件创建而成的键及其值，不过两者使用的键和值之间的分隔符不同。<br>4.使用清单创建<br>基于配置文件创建ConfigMap资源时，它所使用的字段包括通常的apiVersion、kind和metadata字段，以及用于存储数据的关键字段“data”。例如下面的示例代码：</p>
<p>如果其值来自于文件内容时，则使用配置文件创建ConfigMap资源的便捷性还不如直接通过命令行的方式，因此建议直接使用命令行加载文件或目录的方式进行创建。为了便于配置留存，可以在创建完成后使用get-oyaml命令获取到相关信息后再进行编辑留存。<br>8.4.2向Pod环境变量传递ConfigMap对象键值数据<br>如8.3节中所描述的，Pod资源的环境变量值的获得方式之一包括引用ConfigMap对象中的数据，这一点通过在env字段中为valueFrom内嵌configMapKeyRef对象即可实现，其使用格式如下：<br>valueFrom:<br>configMapKeyRef:<br>key:<br>name:<br>optional:<br>其中，字段name的值为要引用的ConfigMap对象的名称，字段key可用于指定要引用ConfigMap对象中某键的键名，而字段optional则用于为当前Pod资源指明此引用是否为可选。此类环境变量的使用方式与直接定义的环境变量并无区别，它们可被用于容器的启动脚本或直接传递给容器应用等。<br>下面是保存于配置文件configmap-env.yaml的资源定义示例，它包含了两个资源，彼此之间使用“—-”相分隔。第一个资源是名为busybox-httpd-config的ConfigMap对象，它包含了两个键值数据；第二个资源是名为configmap-env-demo的Pod对象，它通过环境变量引用了busybox-httpd-config对象中的键值数据，并将其直接传递给了自定义运行的容器应用httpd：<br>…-</p>
<p>注意，在command或args字段中引用环境变量要使用“$（VAR_NAME）”的格式。待上面配置文件中的资源创建完成后，可以通过如下命令验证Pod资源监听的端口等配置信息是否为busybox-httpd-config中定义的内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~]$kubectlexecconfigmap-env-demopsaux</span><br><span class="line">PIDUSER</span><br><span class="line">TIMECOMMAND</span><br><span class="line">1root</span><br><span class="line">0:00/bin/httpd-f-p8080-vv</span><br></pre></td></tr></table></figure></p>
<p>裱创建引用了ConfigMap资源的Pod对象时，被引用的资源必须事先存在，否则将无<br>法启动相应的容器，直到被依赖的资源创建完成为止。不过，那些未引用不存在的ConfigMap资源的容器将不受此影响。另外，ConfigMap是名称空间级别的资源，它必须与引用它的Pod资源在同一空间中。<br>假设存在这么一种情形，某ConfigMap资源中存在较多的键值数据，而全部或大部分的这些键值数据都需要由容器来引用。此时，为容器逐一配置相应的环境变量将是一件颇为劳心费神之事，而且极易出错。对此，Pod资源支持在容器中使用envFrom字段直接将ConfigMap资源中的所有键值一次性地完成导人。它的使用格式如下：</p>
<p>envFrom字段值是对象列表，可用于同时从多个ConfigMap对象导人键值数据。为了避免从多个ConfigMap引用键值数据时产生键名冲突，可以在每个引用中将被导人的键使用prefix字段指定一个特定的前缀，如“HTCFG_”一类的字符串，于是，ConfigMap对象中的httpd_port将成为Pod资源中名为HTCFG_httpd_port的变量。<br>洼如果键名中使用了连接线“_”，那么在转换为变量名时，连接线将被自动替换为下意划线“’_”。<br>例如，把上面示例中的Pod资源转为如下形式的定义（configmap-envfrom-pod.yaml配置文件）后，其引用ConfigMap进行配置的效果并无不同：</p>
<p>待Pod资源创建完成后，可通过查看其环境变量验证其导人的结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~]$kubectlexecconfigmap-envfrom-demoprintenv</span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">HOSTNAME=configmap-envfrom-demo</span><br><span class="line">HTCFG_httpd_port=8080</span><br><span class="line">HTCFG__verbose_level=-vv</span><br></pre></td></tr></table></figure></p>
<p>值得提醒的是，从ConfigMap对象导人资源时，prefix为可选字段，省略时，所有变量名同ConfigMap中的键名。如果不存在键名冲突的可能性，例如从单个ConfigMap对象导人变量或在ConfigMap对象中定义键名时已然添加了特定的前缀，那么省略前缀的定义</p>
<p>既不会导致键名冲突，又能保持变量的简洁。<br>8.4.3ConfigMap存储卷<br>若ConfigMap对象中的键值来源于较长的文件内容，那么使用环境变量将其导入会使得变量值占据过多的内存空间而且不易处理。此类数据通常用于为容器应用提供配置文件，因此将其内容直接作为文件进行引用方为较好的选择。其实现方式是，在定义Pod资源时，将此类ConfigMap对象配置为ConfigMap类型的存储卷，而后由容器将其挂载至特定的挂载点后直接进行访问。<br>1.挂载整个存储卷<br>关联为Pod资源的存储卷时，ConfigMap对象中的每个键都对应地表现为一个文件，键名转为文件名，而键值则为相应文件的内容，即便是通过直接值创建的键值数据，也一样表现为文件视图。挂载于容器上之后，由键值数据表现出的文件位于挂载点目录中，容器中的进程可直接读取这些文件的内容。<br>配置Pod资源时，基于存储卷的方式引用ConfigMap对象的方法非常简单，仅需要指明存储卷名称及要引用的ConfigMap对象名称即可。下面是于配置文件configmap-volume-pod.yaml中定义的Pod资源，它引用了8.4.1节下第3小节中创建的ConfigMap对象nginx-config-files，容器nginx-server将其挂载至应用程序Nginx加载配置文件模块的目录/etc/nginx/conf.d中，具体如下：</p>
<p>此Pod资源引用的nginx-config-files中包含三个配置文件，其中myserver.conf定义了一个虚拟主机<code>www.ilinux.io</code>，并通过include指令包含/etc/nginx/conf.d/目录下以“myserver-”为前缀且以.cfg为后缀的所有配置文件，例如在nginx-config-files中包含的myserver-status.cfg和myserver-gzip.cfg。具体的配置内容请参考8.4.1节下第3小节中命令的输出。ConfigMap</p>
<p>存储卷中的文件如图8-2所示。</p>
<p>图8-2ConfigMap存储卷中的文件<br>创建此Pod资源后于Kubernetes集群中的某节点直接向PodIP的8080端口发起访问请求，即可验证由nginx-config-files资源提供的配置信息是否生效，例如，通过/nginx-status访问其内建的stubstatus：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~]$POD_IP=$(kubectlgetpodsconfigmap-volume-demo-ogo-template=&#123;&#123;.status.podIP&#125;&#125;)</span><br><span class="line">~]$curlhttp://$&#123;POD_IP&#125;:8080/nginx-status</span><br><span class="line">Activeconnections:1</span><br><span class="line">serveracceptshandledrequests</span><br><span class="line">333</span><br><span class="line">Reading:0Writing:1Waiting:0</span><br></pre></td></tr></table></figure></p>
<p>当然，我们也可以直接于Pod资源的相应容器上执行命令来确认文件是否存在于挂载点目录中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~]$kubectlexecconfigmap-volume-demols/etc/nginx/conf.d/</span><br><span class="line">myserver-gzip.cfg</span><br><span class="line">myserver-status.cfg</span><br><span class="line">myserver.conf</span><br></pre></td></tr></table></figure></p>
<p>进一步地，还可以于容器中运行Nginx的配置测试及打印命令，确认由ConfigMap资源提供的配置信息已然生效：</p>
<p>由上面两个命令的结果可见，nginx-config-files中的三个文件都被添加到了容器中，并且实现了由容器应用Nginx加载并生效。<br>2.挂载存储卷中的部分键值<br>有时候，用户很可能不期望在容器中挂载某ConfigMap存储卷后于挂载点目录导出所有的文件，这在通过一个ConfigMap对象为单个Pod资源中的多个容器分别提供配置时尤其常见。例如前面的示例中，用户可能只期望在容器中挂载ConfigMap存储卷后只“导出”其中的myserver.conf和myserver-gzip.cfg，只提供页面传输压缩功能，而不输出nginxstubstatus信息，此时将其volumes配置段改为如下所示的内容即可。为了以示区别并在后文中便于引用及说明问题，这里将其保存于单独的配置文件configmap-volume-demo-2.yam1中，并将Pod资源命名为configmap-volume-demo-2：</p>
<p>configMap存储卷的items字段的值是一个对象列表，可嵌套使用的字段有三个，具体如下。<br>口<code>key&lt;string&gt;</code>：要引用的键名称，必选字段。<br><code>path&lt;string&gt;</code>：对应的键于挂载点目录中生成的文件的相对路径，可以不同于键名称，必选字段。<br>口<code>mode&lt;integer&gt;</code>：文件的权限模型，可用范围为0到0777。<br>上面的配置示例中，myserver-gzip.cfg映射成了myserver-compression.cfg文件，而myserver.conf则保持了与键名同名，并明确指定使用0644的权限，从而达成了仅装载部分文件至容器之目的。<br>3.独立挂载存储卷中的键值<br>前述方式中，无论是装载所有文件还是部分文件，挂载点目录下原有的文件都会被隐藏。对于期望将ConfigMap对象提供的配置文件补充于挂载点目录下的需求来说，这种方式显然难以如愿。例如，/etc/nginx/conf.d目录中原本就存在一些文件（如default.conf），用户期望将nginx-config-files中的全部或部分文件装载进此目录中而不影响其原有的文件。<br>事实上，此种需求可以通过此前第7章中曾经于容器的volumeMounts字段中使用的subPath字段来解决，它可以支持用户从存储卷挂载单个文件或单个目录而非整个存储卷。例如，下面的示例就于/etc/nginx/conf.d目录中单独挂载了两个文件，而保留于了目录下原有的文件。为了以示区别并在后文中便于引用及说明问题，这里将其保存于单独的配置文件configmap-volume-demo-3.yaml中，并将Pod资源命名为configmap-volume-demo-3：</p>
<p>基于上述配置创建了Pod资源之后，即可通过命令验证/etc/nginx/conf.d目录中的原有文件确实能够得以保留，如下面的命令及其结果所示：<br>~]$kubectlexecconfigmap-volume-demo-3ls/etc/nginx/conf.d<br>default.conf<br>myserver-gzip.cfg<br>mvsarvar.canf<br>8.4.4容器应用重载新配置<br>相较于环境变量来说，使用ConfigMap资源为容器应用提供配置的优势之一在于其支持容器应用动态更新其配置：用户直接更新ConfigMap对象，而后由容器应用重载其配置文件即可。<br>细心的读者或许已经发现，挂载ConfigMap存储卷的挂载点目录中的文件都是符号链接，它们指向了当前目录中的“..data”，而“..data”也是符号链接，它指向了名字形如“..201803_17.144141.256460087”的目录，这个目录才是存储卷的真正挂载点。例如，查看8.4.3节下第1小节中创建的Pod资源容器中的挂载点中的文件列表，它将显示出类似如下结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~]$kubectlexec-itconfigmap-volume-demo--ls-/etc/nginx/conf.d</span><br><span class="line">~JPRu</span><br><span class="line">total0</span><br><span class="line">arwxr-xr-x2rootroot79Mar1714:41..2018._03.17-14.41._41.256460087</span><br><span class="line">lrwxrwxrwx1rootroot31Mar1714:41..data-&gt;..2018__03_17__14_.41_.41.256460087</span><br><span class="line">lrwxrwxrwx1rootroot24Mar1710:19myserver-gzip.cfg-&gt;..data/n</span><br><span class="line">,corvor..</span><br><span class="line">lTWxrWxTwX-rootrootgzip.cfg</span><br><span class="line">yserv</span><br><span class="line">yserver-</span><br><span class="line">lrwxrwxrwx1rootroot26Mar1710:19myserver-status.cfg-&gt;..data/myserver-status.cfg</span><br><span class="line">rwxrwx1rlrwxrwxrwx1rootroot20Mar1710:19myserver.conf-&gt;..data/myserver.conf</span><br></pre></td></tr></table></figure></p>
<p>这样两级符号链接设定的好处在于，在引用的ConfigMap对象中的数据发生改变时，它将被重新挂载至一个新的临时目录下，而后“..data”将指向此新的挂载点，便达到了同时更新存储卷上所有文件数据之目的。例如，使用kubectledit命令直接在ConfigMap对象nginx-config-files中的myserver-status.cfg配置段中增加“allow127.0.0.0/8；”和“denyal；，”两行，而后再次查看configmap-volume-demo中的容器的挂载点目录中的文件列表，结果是其挂载点已经指向了新的位置，例如下面的命令及其结果所示：</p>
<p>此时，若要使容器中应用程序的新配置生效，则需要于Pod资源的相应容器上执行配置重载操作。例如，Nginx可通过其“nginx-sreload”命令完成配置文件重载，如下面的命令所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]$kubectlexecconfigmap-volume-demo--nginx-Sreload</span><br><span class="line">2018/08/1715:18:19[notice]222#222:signalprocessstarted</span><br></pre></td></tr></table></figure></p>
<p>此时，如果于此容器之外的位置访问/nginx-status页面的请求是被拒绝的，则表明新配置已然生效，如下面的命令及其结果所示：</p>
<p>然而，需要注意的是，对于不支持配置文件重载操作的容器应用来说，只有那些在ConfigMap对象更新后创建的Pod资源中的容器会应用到新配置，此时如果不重启旧有的容器，则会导致配置不一致的问题。即使对于支持重载操作的应用来说，由于新的配置信息并非同步推送进所有容器中，而且各容器的重载操作也未必能同时进行，因此在更新时，短时间内仍然会存在配置不一致的现象。<br>另外，使用8.4.3下第3小节中的方式独立挂载存储卷中的文件的容器，其挂载配置文件的方式并非是以两级链接的方式进行的，因此存储卷无法确保所有挂载的文件可以被同时更新至容器中，因此为了确保配置信息的一致性，目前这种类型的挂载不支持文件更新操作。读者可对此自行进行验证。<br>8.4.5使用ConfigMap资源的注意事项<br>在Pod资源中调用ConfigMap对象时需要注意以下几个问题。<br>口以存储卷方式引用的ConfigMap必须先于Pod存在，除非在Pod中将它们全部标记为“optional”，否则将会导致Pod无法正常启动的错误；同样，即使存在ConfigMap，在引用的键不存在时，也会导致一样的错误。<br>口当以环境变量方式注人的ConfigMap中的键不存在时会被忽略，Pod可以正常启动，但错误引用的信息会以“InvalidVariableNames”事件记录于日志中。<br>DConfigMap是名称空间级的资源，因此，引用它的Pod必须处于同一名称空间中。Okubelet不支持引用KubernetesAPIServer上不存的ConfigMap，这包括那些通过kubelet的“—manifest-url”或“—config”选项，以及kubeletRESTAPI创建的Pod。</p>
<p>8.5Secret资源<br>Secret资源的功能类似于ConfigMap，但它专用于存放敏感数据，例如密码、数字证书、私钥、令牌和SSHkey等。<br>8.5.1Secret概述<br>Secret对象存储数据的方式及使用方式类似于ConfigMap对象，以键值方式存储数据，在Pod资源中通过环境变量或存储卷进行数据访问。不同的是，Secret对象仅会被分发至调用了此对象的Pod资源所在的工作节点，且只能由节点将其存储于内存中。另外，Secret对象的数据的存储及打印格式为Base64编码的字符串，因此用户在创建Secret对象时也要提供此种编码格式的数据。不过，在容器中以环境变量或存储卷的方式访问时，它们会被自动解码为明文格式。<br>需要注意的是，在Master节点上，Secret对象以非加密的格式存储于etcd中，因此管理员必须加以精心管控以确保敏感数据的机密性，必须确保etcd集群节点间以及与APIServer的安全通信，etcd服务的访问授权，还包括用户访问APIServer时的授权，因为拥有创建Pod资源的用户都可以使用Secret资源并能够通过Pod中的容器访问其数据。<br>Secret对象主要有两种用途，一是作为存储卷注人到Pod上由容器应用程序所使用，二是用于kubelet为Pod里的容器拉取镜像时向私有仓库提供认证信息。不过，后面使用ServiceAccount资源自建的Secret对象是一种更具安全性的方式。通过ConfigMap和Secret配置容器的方式如图8-3所示。</p>
<p>图8-3通过ConfigMap和Secret配置容器<br>Secret资源主要由四种类型组成，具体如下。<br>口Opaque：自定义数据内容；base64编码，用来存储密码、密钥、信息、证书等数据，</p>
<p>类型标识符为generic。<br>Okubernetes.io/service-account-token：ServiceAccount的认证信息，可在创建ServiceAccout时由Kubernetes自动创建。<br>Dkubernetes.io/dockerconfigjson：用来存储Docker镜像仓库的认证信息，类型标识为docker-registry。<br>Okubernetes.io/tls：用于为SSL通信模式存储证书和私钥文件，命令式创建时类型标识为tls。<br>洼base64编码并非加密机制，其编码的数据可使用“base64—decode”一类的命令进意行解码。<br>8.5.2创建Secret资源<br>手动创建Secret对象的方式有两种：通过kubectlcreate命令和使用Secret配置文件。1.命令式创建<br>不少场景中，Pod中的应用需要通过用户名和密码访问其他服务，例如访问数据库系统等。创建此类的Secret对象，可以使用<code>“kubectlcreatesecretgeneric&lt;SECRETNAME&gt;-from-literal=key=value”</code>命令直接进行创建，不过为用户认证之需进行创建时，其使用的键名通常是username和password。例如下面的命令，以“root/ikubernetes”分别为用户名和密码创建了一个名为mysql-auth的Secret对象：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]$kubectlcreatesecretgenericmysql-auth--from-literal=username=root\--from-literal=password=ikubernetes</span><br></pre></td></tr></table></figure></p>
<p>而后即可查看新建资源的属性信息，由下面的命令及其输出结果可以看出，以generic标识符创建的Secret对象是为Opaque类型，其键值数据会以Base64的编码格式进行保存和打印：</p>
<p>不过，Kubernetes系统的Secret对象的Base64编码的数据并非加密格式，许多相关的工具程序均可轻松完成解码，如下面所示的Base64命令：</p>
<p>对于本身业己存储于文件中的数据，也可以在创建generic格式Secret对象时使用—from-file”选项从文件中直接进行加载，例如创建用于SSH认证的Secret对象时，如果尚且没有认证信息文件，则需要首先使用命令生成一对认证文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~]$ssh-keygen-七rsa-P&apos;-f$&#123;HOME&#125;/.ssh/id_rsa</span><br><span class="line">而后使用“kubectlcreatesecretgeneric&lt;SECRET_NAME&gt;--from-file[=KEY1]=/PATH/TO/FILE”命令加载文件内容并生成为Secret对象：</span><br><span class="line">~]$kubectlcreatesecretgenericssh-key-secret--from-file=ssh-privatekey=$&#123;HOME&#125;/.</span><br><span class="line">ssh/id_.rsa--from-file=ssh-publickey=$&#123;HOME&#125;/.ssh/id__rsa.pub</span><br></pre></td></tr></table></figure></p>
<p>另外，若要基于私钥和数字证书文件创建用于SSL/TLS通信的Secret对象，则需要使用<code>“kubectlcreatesecrettls&lt;SECRET_NAME&gt;--cert=--key=&quot;</code>命令来进行，注意其类型标识符为TLS。例如，假设需要为Nginx测试创建SSL虚拟主机，用户首先使用了类似如下的命令生成了私钥和自签证书：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">]$(umask077;opensslgenrsa-outnginx.key2048)</span><br><span class="line">uiasr.nioen</span><br><span class="line">~]$opensslreq-new-x509-keynginx.key-outnginx.crt\</span><br><span class="line">-subj/C=CN/ST=Beijing/L=Beijing/0=DevOps/CN=www.ilinux.io</span><br></pre></td></tr></table></figure></p>
<p>而后即可使用如下命令将这两个文件创建为Secret对象。需要注意的是，无论用户提供的证书和私钥文件使用的是什么名称，它们一律会被转换为分别以tls.key（私钥）和tls.crt（证书）为其键名：<br>~]$kubectlcreatesecrettlsnginx-ssl—key=./nginx.key—cert=./nginx.crtsecret”nginx-ssl”created<br>注意其类型应该为“kubernetes.io/tls”，例如下面命令结果中的显示：.<br>~]$kubectlgetsecretsnginx-ssl<br>NAMETYPE<br>DATAAGE<br>nginx-ssluber<br>kubernetes.io/tls<br>sn.<br>由.上述操作过程可见，命令式创建Secret对象与ConfigMap对象的方式几乎没有明显区别。<br>2.清单式创建<br>Secret资源是标准的KubernetesAPI对象，除了标准的apiVersion、kind和metadata字段，它可用的其他字段具体如下。<br>口<code>data&lt;map[string]string&gt;</code>：“key：value”格式的数据，通常是敏感信息，数据格式需是以Base64格式编码的字符串，因此需要用户事先完成编码。</p>
<p>口<code>stringData&lt;map[string]string&gt;</code>：以明文格式（非Base64编码）定义的“key：value”数据；无须用户事先对数据进行Base64编码，而是在创建为Secret对象时自动进行编码并保存于data字段中；stringData字段中的明文不会被APIServer输出，不过若是使用“kubectlapply”命令进行的创建，那么注解信息中还是可能会直接输出这些信息的。<br>口<code>type&lt;string&gt;</code>：仅是为了便于编程方式处理Secret数据而提供的类型标识。<br>下面是保存于配置文件secret-demo.yaml中的ecret资源定义示例，其使用stringData提供了明文格式的键值数据，从而免去了事先进行手动编码的麻烦：<br>apiversion:v<br>kind:secret<br>metadata.t<br>metadata:<br>name:secret-demo<br>stringData:<br>username:redis<br>type:Opaque<br>Secret对象也是Kubernetes系统的“一等公民”，因此，使用标准资源创建命令即可完成其创建。相比较来说，基于清单文件将保存于文件中的敏感信息创建Secret对象时，用户首先需要将敏感信息读出，转为Base64编码格式，而后再将其创建为清单文件，过程烦琐，反不如命令式创建来得便捷。不过，如果存在多次创建或重构之需，那么将其保存为配置清单也是情势所需。<br>8.5.3Secret存储卷<br>类似于Pod消费ConfigMap对象的方式，Secret对象可以注人为环境变量，也可以存储为卷形式挂载使用。不过，容器应用通常会在发生错误时将所有环境变量保存于日志信息中，甚至有些应用在启动时即会将运行环境打印到日志中；另外，容器应用调用第三方程序为子进程时，这些子进程能够继承并使用父进程的所有环境变量。有鉴于此，使用环境变量引用Secret对象中的敏感信息实在算不上明智之举。<br>在Pod中使用Secret存储卷的方式，除了其类型及引用标识要替换为Secret及secretName之外，几乎完全类似于ConfigMap存储卷，包括支持使用挂载整个存储卷、只挂载存储卷中的指定键值以及独立挂载存储卷中的键等使用方式。<br>下面是定义在配置文件secret-volume-pod.yaml中的Secret资源使用示例，它将nginx-ssl关联为Pod资源的名为nginxcert的Secret存储卷，而后由容器web-servrer挂载至/etc/nginx/ssl目录下：</p>
<p>将上面资源清单文件中定义的资源创建于Kubernetes系统上，而后再查看容器挂载点目录中的文件，以确认其挂载是否成功完成。下面命令的结果显示，私钥文件tIs.key和证书文件tls.crt已经成功保存于挂载点路径之下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]$kubectlexecsecret-volume-demols/etc/nginx/ss1/</span><br><span class="line">tls.crt</span><br><span class="line">tls.key</span><br></pre></td></tr></table></figure></p>
<p>此时，通过ConfigMap对象为容器应用Nginx提供HTTPS虚拟主机配置，它只要使用由Secret对象生成的私钥和证书文件，即可定义出容器化运行的Nginx服务。<br>8.5.4imagePullSecret资源对象<br>imagePullSecret资源可用于辅助kubelet从需要认证的私有镜像仓库获取镜像，它通过将Secret提供的密码传递给kubelet从而在拉取镜像前完成必要的认证过程。<br>使用imagePullSecret的方式有两种：一是创建docker-registry类型的Secret对象，并在定义Pod资源时明确通过“imagePullSecrets”字段给出；另一个是创建docker-registry类型的Secret对象，将其添加到某特定的ServiceAccount对象中，那些使用该ServiceAccount资源创建的Pod对象，以及默认使用该ServiceAccount的Pod对象都将会直接使用imagePullSecrets中的认证信息。由于尚未介绍到ServiceAccount资源，因此这里先介绍第一种方式的用法。<br>创建docker-registry类型的Secret对象时，要使用<code>“kubectlcreatesecretdocker-registry&lt;SECRET_NAME&gt;--docker-user=&lt;USERNAME&gt;--docker-password=&lt;PASSWORD&gt;--docker-email=&lt;DOCKER__USER_EMAIL&gt;”</code>的命令格式，其中的用户名、密码及邮件信息是在使用dockerlogin命令登录时使用的认证信息。例如，下面的命令创建了名为local-registry的imagepullsecret对象：</p>
<p>此类Secret对象打印的类型信息为“kubernetes.io/dockerconfigjson”，如下面的命令结果所示：<br>~]$kubectlgetsecretslocal-registry<br>NAME<br>TYPE<br>DATA<br>AGE<br>local-registrykubernetes.io/dockerconfigjson<br>1<br>7s<br>而后，使用相应的私有registry中镜像的Pod资源的定义，即可通过imagePullSecrets字段使用此Secret对象，使用示例如下面的配置清单所示：<br>apiVersion:v1<br>kind:Pod<br>metadata:<br>name:secret-imagepull-demo<br>namespace:default<br>spec:<br>imagePullSecrets:<br>-name:local-registry<br>containers:<br>-image:registry.ilinux.io/dev/myimage<br>name:myapp<br>上面的配置清单仅是一个示例，付诸运行时，需要由读者将其Secret中的内容及清单资源的镜像等信息的定义修改为实际可用的信息。<br>试想，正在运行的多数容器的镜像均来自于私有仓库时，为每个Pod资源显式定义imagePullSecrets实在不是一个好主意。好在还有基于ServiceAccount的imagepullsecret可用。<br>8.6本章小结<br>本章的核心目标在于为读者说明配置容器应用的常用方式，这在将同一Pod资源分别以不同的配置运行于不同的环境中时特别有用。本章主要描述了如下几种配置容器化应用的方式。<br>口自定义命令行选项，为容器化应用传递特定参数。<br>口通过环境变量向容器注入自定义数据。<br>口基于ConfigMap对象，以环境变量或存储卷的形式向容器提供配置信息。<br>借助Secret对象，以存储卷的形式向容器应用提供敏感信息。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Kubernetes进阶实战/" rel="tag"># Kubernetes进阶实战</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/10/06/第7章-存储卷与数据持久化/" rel="next" title="第7章 存储卷与数据持久化">
                <i class="fa fa-chevron-left"></i> 第7章 存储卷与数据持久化
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/10/06/第9章-StatefulSet控制器/" rel="prev" title="第9章 StatefulSet控制器">
                第9章 StatefulSet控制器 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="CheBin">
            
              <p class="site-author-name" itemprop="name">CheBin</p>
              <div class="site-description motion-element" itemprop="description">什么是强迫自己？就是不想去干什么，就去干什么</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">1017</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">72</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          


          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/2023/04/04/结束语｜秒杀系统之上的业务协同思考/" title="结束语｜秒杀系统之上的业务协同思考" target="_blank">结束语｜秒杀系统之上的业务协同思考</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/14｜百万级流量秒杀系统的关键总结/" title="14｜百万级流量秒杀系统的关键总结" target="_blank">14｜百万级流量秒杀系统的关键总结</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/13｜优化番外篇：Vertx介绍及快速入门/" title="13｜优化番外篇：Vertx介绍及快速入门" target="_blank">13｜优化番外篇：Vertx介绍及快速入门</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/12｜高性能优化：单机Java极致优化/" title="12｜高性能优化：单机Java极致优化" target="_blank">12｜高性能优化：单机Java极致优化</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/11｜高性能优化：物理机极致优化/" title="11｜高性能优化：物理机极致优化" target="_blank">11｜高性能优化：物理机极致优化</a>
                  </li>
                
              </ul>
            </div>
        

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CheBin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">8.2m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">124:32</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
