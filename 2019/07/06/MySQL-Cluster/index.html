<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="思考并回答以下问题：">
<meta name="keywords" content="MySQL核心技术与最佳实践">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL Cluster">
<meta property="og:url" content="http://yoursite.com/2019/07/06/MySQL-Cluster/index.html">
<meta property="og:site_name" content="车斌的技术博客">
<meta property="og:description" content="思考并回答以下问题：">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/2019/07/06/MySQL-Cluster/1.jpg">
<meta property="og:image" content="http://yoursite.com/2019/07/06/MySQL-Cluster/2.jpg">
<meta property="og:image" content="http://yoursite.com/2019/07/06/MySQL-Cluster/4.jpg">
<meta property="og:updated_time" content="2020-07-06T10:20:04.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MySQL Cluster">
<meta name="twitter:description" content="思考并回答以下问题：">
<meta name="twitter:image" content="http://yoursite.com/2019/07/06/MySQL-Cluster/1.jpg">






  <link rel="canonical" href="http://yoursite.com/2019/07/06/MySQL-Cluster/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>MySQL Cluster | 车斌的技术博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">专注</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/06/MySQL-Cluster/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CheBin">
      <meta itemprop="description" content="绝知此事要躬行，不动手就是懒。一篇文章看10遍，而不是10篇文章看1遍。">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">MySQL Cluster

              
            
          </h1>
        

        <div class="post-meta">

          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-06 15:26:48" itemprop="dateCreated datePublished" datetime="2019-07-06T15:26:48+08:00">2019-07-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-07-06 18:20:04" itemprop="dateModified" datetime="2020-07-06T18:20:04+08:00">2020-07-06</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">9.6k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">9 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考并回答以下问题：</p>
<a id="more"></a>
<p>MySQL Cluster也称为MySQL集群或者MySQL簇，是一种允许在无共享架构（SNA，share nothing architecture）系统中部署“内存”数据库集群的技术。通过无共享架构，可以使系统使用廉价的硬件获取持续的高可用性。本章首先介绍了MySQL集群的基础知识，重点介绍了MySQL集群的环境搭建方法。</p>
<h1 id="MySQL-Cluster简介"><a href="#MySQL-Cluster简介" class="headerlink" title="MySQL Cluster简介"></a>MySQL Cluster简介</h1><p>MySQL Cluster是一个高性能、可扩展、集群化的数据库技术。MySQL集群是一种分布式架构，通常由一组计算机构成，每台计算机运行至少一个MySQL集群进程，每个MySQL集群进程对应一个“节点”（node）。通过节点间的切换，可以确保集群出现节点故障或者网络故障时的持续高可用性。</p>
<blockquote>
<p>说明<br>在很多情况下，一个“节点”对应一台计算机。但在讨论MySQL集群时，一个“节点”表示的是一个“集群进程”。如果在单台计算机开启了多个集群进程，那么这台计算机上存在了多个节点。</p>
</blockquote>
<h2 id="MySQL集群的组成"><a href="#MySQL集群的组成" class="headerlink" title="MySQL集群的组成"></a>MySQL集群的组成</h2><p>MySQL集群由4类节点组成：SQL节点、数据节点、管理节点以及客户机节点。</p>
<p><strong>1．客户机节点</strong></p>
<p>为了实现MySQL集群中数据的增、删、改、查，需要通过MySQL客户机编辑、提交SQL语句（这里将MySQL客户机简称为客户机节点）。MySQL集群中最简单的客户机节点是打开CMD命令提示符窗口，然后输入“mysql -h localhost -u root -p”命令，接着连接MySQL 服务器。</p>
<p><strong>2．SQL节点</strong></p>
<p>SQL节点主要用于提供MySQL服务，提供了访问MySQL集群中数据节点中数据的“接口”。在MySQL集群体系中，客户机节点通过SQL节点访问数据节点中的数据，任意一个数据节点都是连接到所有的SQL节点的。当任意一个SQL节点出现故障时，客户机节点都可以将请求转移到其他SQL节点。当然，数据库开发人员应该提供一种当一个SQL节点出现故障时，客户机节点能够自行切换到其他SQL节点的机制。</p>
<p>事实上，MySQL集群主要是通过将NDB Cluster内存集群存储引擎与MySQL服务器集成实现的，因此SQL节点的MySQL服务必须支持NDB存储引擎才能实现MySQL集群。而传统的MySQL服务默认情况下仅支持8种存储引擎（不支持NDB Cluster存储引擎），为了实现MySQL集群，需下载、安装支持MySQL集群的MySQL服务软件。</p>
<p>通常，SQL节点使用命令“mysqld–ndbcluster”启动，或在my.ini配置文件的[mysqld]选项组中添加“ndbcluster”参数，使得SQL节点支持NDB Cluster 存储引擎。每个SQL节点对应一个mysqld.exe进程。</p>
<blockquote>
<p>说明<br>NDB是网络数据库（network database）的缩写。NDB存储引擎支持所有通常的MySQL数据类型和SQL语句，该存储引擎还提供了完整的事务支持，而且是ACID兼容的。</p>
</blockquote>
<p><strong>3．数据节点</strong></p>
<p>数据节点用于存储所有属于MySQL集群的数据，这些数据在数据节点之间被复制，以保证在一个或多个数据节点出现故障时，MySQL集群仍然持续可用。可以这样理解：在MySQL集群体系中，客户机节点通过SQL节点访问数据节点中的数据，任意一个SQL节点都是连接到所有的数据节点的，当任意一个数据节点出现故障时，SQL节点都可以将请求转移到另一个数据节点。</p>
<p>数据节点是通过命令“ndbd”启动的，每个数据节点对应一个ndbd.exe进程。</p>
<p>MySQL集群中的事务安全是由数据节点保证的，任意一个事务产生的数据变化会同时反映到所有数据节点中；某个事务在执行过程中，某个数据节点数据更新的失败会导致整个事务的回滚。说明</p>
<p>每个数据节点中都有两个检查点，即本地检查点以及全局检查点。本地检查点的目的是将内存中的数据和硬盘上的数据进行同步。全局检查点是在各节点中进行通信，以保证事务的一致性。</p>
<p><strong>4．管理节点</strong></p>
<p>管理节点用于控制MySQL集群启动时的初始配置，管理MySQL集群内的其他节点。管理节点的初始配置由集群配置文件决定，集群配置文件默认的文件名为config.ini，该配置文件提供了数据节点和SQL节点的全局配置信息，包括数据、索引所占用内存大小、各个节点的IP地址信息、数据存放的目录信息等。</p>
<p>MySQL集群期间，管理节点会获取其他节点的状态和错误信息，并将这些信息写入集群日志，反馈给集群中的其他所有节点。例如，当数据节点出现新的事件时，数据节点将关于该事件的信息传输到管理节点，然后由管理节点将事件信息写入集群日志，并反馈给其他节点。由于管理节点担任了集群中各个节点的沟通工作，因此在启动其他节点之前，应该首先启动管理节点。管理节点是通过命令“ndb_mgmd”启动的，每个管理节点对应一个ndb_mgmd.exe进程。</p>
<blockquote>
<p>说明<br>管理节点只在集群启动和发生配置变化的时候起作用，集群正常运行期间停止管理节点，整个集群都将保持在线和可用状态。通常只需配置一个管理节点，然而为了排除单点故障需要，可能需要增加管理节点的数量。</p>
</blockquote>
<h2 id="MySQL集群架构"><a href="#MySQL集群架构" class="headerlink" title="MySQL集群架构"></a>MySQL集群架构</h2><p>可以看出：MySQL集群架构可以简单地分为4个区域，客户机节点、SQL节点、数据节点、管理节点，如图1所示。</p>
<blockquote>
<p>图1 MySQL集群架构</p>
</blockquote>
<img src="/2019/07/06/MySQL-Cluster/1.jpg">
<p>MySQL集群中的数据保存在NDB存储引擎的表中（数据节点中），MySQL集群中的表结构保存在MySQL服务器中（SQL节点中）。数据库用户通过客户机节点连接SQL节点访问集群数据，为了保证每个数据节点中的数据均匀分布，在进行数据插入时，SQL节点采用分片的策略将数据均匀分配到不同的数据节点上。管理节点通过管理工具（ndb_mgmd）管理数据节点与SQL节点，MySQL Cluster所有的这些节点构成一个完整的MySQL集群体系。</p>
<h1 id="MySQL-Cluster环境搭建"><a href="#MySQL-Cluster环境搭建" class="headerlink" title="MySQL Cluster环境搭建"></a>MySQL Cluster环境搭建</h1><p>目前支持MySQL Cluster的操作系统有Linux、Mac OS X和Solaris，最新版本的MySQL Cluster支持更多的操作系统，包括Windows操作系统。本章以Windows操作系统为例，讲解MySQL Cluster配置的最简单方法。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>MySQL集群的准备工作包括下载MySQL集群软件、准备主机以及网络环境。</p>
<p>主机：对于实验目的的MySQL集群主机而言，MySQL集群可以在一台单独的计算机上成功部署，每个数据节点、SQL节点设置不同的目录以及端口号，即可进行MySQL集群实验。为了让读者更好地理解MySQL集群，本书以5台主机为例部署MySQL集群环境。</p>
<p>网络环境：集群内的主机必须可以通过IP地址相互通信（读者可以通过ping命令判断集群内的主机是否连通）。为了提升MySQL集群的性能以及高可用性，MySQL集群通常在单独的子网中部署（不建议跨越公网部署MySQL集群）。除此之外，还要确保集群内所有主机的防火墙关闭，否者可能导致SQL节点与管理节点无法连接。</p>
<p>MySQL集群软件：所需的MySQL集群软件可以在 MySQL Cluster 官网<http： dev.mysql.com downloads cluster>免费下载，最新的MySQL集群软件提供了两种安装程序：图形化安装包msi与zip免安装压缩文件。本章以最新版本的免安装压缩文件mysql-cluster-gpl-7.3.2-win32.zip为例，讲解MySQL集群的配置过程（对于64 位Windows操作系统而言，读者可以下载mysql- cluster-gpl-7.3.2- winx64.zip）。</http：></p>
<blockquote>
<p>说明<br>为了便于学习，读者也可以到本书指定的网址下载MySQL集群软件mysql-cluster-gpl-7.3.2-win32.zip。</p>
</blockquote>
<p>假设当前的网络环境存在M、S1、S2、D1、D2五台主机，五台主机的IP 地址如表15-1所示，这些主机可以通过IP地址相互通信，并且它们的防火墙已经关闭。五台主机中，M主机是管理节点，D1和D2主机是数据节点，S1和S2是SQL节点。</p>
<blockquote>
<p>表1 MySQL集群环境</p>
</blockquote>
<img src="/2019/07/06/MySQL-Cluster/2.jpg">
<p>对于免安装压缩文件mysql-cluster-gpl-7.3.2-win32.zip，将该文件分别拷贝到M、S1、S2、D1 与D2 五台主机的C盘，接着解压缩至当前文件夹，然后重命名为mysql-cluster，如图2所示。</p>
<p>为了便于启动管理节点、数据节点以及 SQL 节点，将图 15-2 中 bin 目录所在的路径（即C：\mysql-cluster\bin）添加到Path系统环境变量中（方法为：鼠标右键单击我的电脑高级环境变量系统变量Path），如图3所示。</p>
<blockquote>
<p>图3 配置MySQL Cluster环境变量说明</p>
</blockquote>
<img src="/2019/07/06/MySQL-Cluster/4.jpg">
<p>如果当前主机存在其他MySQL服务，并且这些MySQL服务bin目录所在的路径已经配置到了 PATH 环境变量，建议删除这些环境变量的配置，或者将图2中bin目录所在的路径配置到Path环境变量最开始处。</p>
<h2 id="数据节点的配置"><a href="#数据节点的配置" class="headerlink" title="数据节点的配置"></a>数据节点的配置</h2><p>数据节点的配置较为简单，分别将D1与D2主机中mysql-cluster目录中的my-default.ini配置文件重命名为my.ini，然后分别在两个my.ini配置文件中添加[mysql_cluster]选项组，并在该选项组中添加下列参数信息，如下所示。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysql_cluster]</span><br><span class="line">ndb-connectstring = 192.168.4.15</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>说明<br>[mysql_cluster]选项组的 ndb-connectstring 参数用于指定当前的数据节点连接哪一台管理节点主机（IP地址为192.168.4.15的M主机提供了管理节点服务）。<br>至此，MySQL集群中的数据节点已经配置完毕。接下来讲解管理节点的配置方法。</p>
</blockquote>
<h2 id="SQL节点的配置"><a href="#SQL节点的配置" class="headerlink" title="SQL节点的配置"></a>SQL节点的配置</h2><p>步骤1：在S1、S2主机上注册MySQL服务。<br>为了方便管理MySQL服务，便于启动、停止SQL节点，分别在S1、S2主机的CMD命令提示符窗口中运行下列命令，注册MySQL服务，执行结果如图15-4所示。<br>cd C：\mysql-cluster\bin<br>mysqld.exe -install mysqlcluster<br>▲图15-4 安装MySQL服务说明<br>同一台主机的服务名不能重名，否则将提示如图15-4所示的“The service already exists！”错误信息。出现重名问题后，如果不想修改服务名，可以在CMD命令提示符窗口中运行“sc delete mysqlcluster”命令，删除指定的服务（如果该服务正在运行，删除服务时将失败）。<br>成功注册MySQL服务后，右键单击“我的电脑”，在弹出的菜单中单击“管理”，在弹出的“计算机管理”窗口中双击“服务和应用程序”，然后单击“服务”选项，即可找到刚刚注册的MySQL服务（服务名为“mysqlcluster”），如图15-5所示（建议将MySQL服务的启动类型由自动修改为手动，再进行其他配置工作）。由于名字为“mysqlcluster”的MySQL服务缺失my.ini配置文件，mysqlcluster服务尚不能启动。</p>
<p>步骤2：启动MySQL服务。<br>分别将S1与S2主机中mysql-cluster目录中的my-default.ini配置文件重命名为“my.ini”，然后单击图15-5 中的“启动”链接，或者在CMD 命令提示符窗口输入命令“net start mysqlcluster”启动MySQL服务，接着在CMD命令提示符窗口输入下面的命令，开启MySQL客户机，并连接MySQL服务器，如图15-6所示（默认情况下，初始密码为空字符串）。<br>mysql -h localhost -u root -p<br>▲图15-6 启动MySQL服务<br>执行MySQL命令“show engines;”，执行结果如图15-7所示。从图15-7中可以看到，当前的MySQL服务默认的存储引擎为InnoDB，并且不支持NDB存储引擎。<br>▲图15-7 查看MySQL服务存储引擎</p>
<p>▲图15-7 查看MySQL服务存储引擎<br>步骤3：开启S1、S2 主机MySQL服务的NDB Cluster 存储引擎支持。<br>单击图15-8中的“停止”链接，或者在CMD命令提示符窗口输入命令“net stop mysqlcluster”，停止S1与S2主机的MySQL服务。分别在S1与S2主机my.ini配置文件的[mysqld]选项组中添加下列参数信息，该参数用于开启MySQL 服务的NDB Cluster 存储引擎支持。<br>ndbcluster<br>步骤4：指定管理节点。<br>分别在S1与S2主机my.ini配置文件的[mysqld]选项组中添加下列参数信息，该参数用于指定当前的SQL节点连接哪一台管理节点主机（IP地址为192.168.4.15的A主机提供了管理节点服务）。<br>ndb-connectstring = 192.168.4.15<br>至此，MySQL集群中的数据节点以及SQL节点已经配置完毕，接下来讲解管理节点的配置方法。由于MySQL集群中SQL节点、数据节点以及管理节点的启动顺序有特殊要求，配置管理节点前，暂且不能启动数据节点与SQL节点。<br>▲图15-8 MySQL服务管理</p>
<h2 id="管理节点的配置"><a href="#管理节点的配置" class="headerlink" title="管理节点的配置"></a>管理节点的配置</h2><p>管理节点负责管理MySQL集群内所有其他节点，管理节点的配置比较复杂。管理节点的初始配置由集群配置文件决定，该文件配置了所有管理节点、所有数据节点以及所有SQL节点的基本信息。这里将IP地址为192.168.4.15的M主机作为“管理节点”，在M主机C盘根目录创建conf目录，在该目录下创建config.ini文件作为集群配置文件，并输入如下内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[NDBD DEFAULT]</span><br><span class="line">NoOfReplicas=2</span><br><span class="line">DataDir=C：/data</span><br><span class="line">[NDB_MGMD]</span><br><span class="line">HostName=192.168.4.15</span><br><span class="line">DataDir=C：/logs</span><br><span class="line">#数据节点</span><br><span class="line">[NDBD]</span><br><span class="line">HostName=192.168.4.11</span><br><span class="line">[NDBD]</span><br><span class="line">HostName=192.168.4.12</span><br><span class="line">#SQL节点</span><br><span class="line">[MYSQLD]</span><br><span class="line">HostName=192.168.4.13</span><br><span class="line">[MYSQLD]</span><br><span class="line">HostName=192.168.4.14</span><br></pre></td></tr></table></figure></p>
<p>接着在M主机的C盘创建logs目录，在D1与D2主机的C盘创建data目录。需要注意的是：创建config.ini文件时，一定不能隐藏已知文件类型的扩展名。说明<br>集群配置文件 config.ini 中共有 6 种选项组，分别是[NDB_MGMD DEFAULT]、[NDB_MGMD]、[MYSQLD DEFAULT]、[MYSQLD]、[NDBD DEFAULT]以及[NDBD]。其中，名字中包含有“DEFAULT”的选项组最多出现一次，分别用于配置管理节点、SQL 节点以及数据节点参数的默认值。[NDB_MGMD]、[MYSQLD]以及[NDBD]选项组分别用于单个管理节点、单个 SQL 节点以及单个数据节点的个性化配置。例如，[NDBD DEFAULT]选项组的 DataDir 参数定义了所有数据节点日志信息默认存放的路径；[NDB_MGMD]选项组的 DataDir 参数定义了当前管理节点日志信息存放的路径。每个节点都有各自的个性化配置，例如，每个节点的主机 IP 地址需要使用 HostName参数进行单独的配置。说明<br>NoOfReplicas=2：表示在集群环境中，定义两个数据节点为一个节点组，同组存储的数据是相同的，继而避免了单点故障。可以看出，该参数定义了相同数据的份数，即数据的冗余次数。NoOfReplicas参数只能设置在[NDBDDEFAULT]选项组中，该参数对所有数据节点有效。NoOfReplicas参数的默认值为2，原因在于：假设当前MySQL集群环境存在两个数据节点D1和D2，需要存储两个数据A和B。如果将NoOfReplicas的值设为1，则数据A存储在节点D1上，数据B存储在节点D2上，此时，节点D1与节点D2中只要有一个节点宕机，数据将不再完整。但如果将NoOfReplicas的值设为2，则数据A存储在节点D1上，数据A的“副本”也将存储在节点D2上；数据B存储在节点D2上，数据B的“副本”也将存储在节点D1上，此时，即便节点D1与节点D2中有一个节点宕机，数据依然完整。</p>
<h2 id="MySQL集群的启动"><a href="#MySQL集群的启动" class="headerlink" title="MySQL集群的启动"></a>MySQL集群的启动</h2><p>MySQL集群的启动包括管理节点的启动、数据节点的启动以及SQL节点的启动，启动顺序依次是：先启动管理节点，接着是数据节点，最后是SQL节点。</p>
<p>步骤1：启动管理节点。</p>
<p>在M主机的CMD命令行窗口中运行如下命令，即可启动管理节点，如图15-9所示。<br>ndb_mgmd ——configdir=c：/conf -f c：/conf/config.ini - initial<br>▲图15-9 管理节点的启动<br>管理节点成功启动后，M主机的C：/logs目录中将自动创建ndb_1.pid文件、ndb_1_cluster.log文件以及ndb_1_out.log文件，如图15-10所示。其中，ndb_1_cluster.log文件以及ndb_1_out.log文件用于记录管理节点的日志信息，ndb_1.pid用于记录管理节点的进程ID。</p>
<p>▲图15-10 管理节点的日志<br>同时，M主机的C：/conf目录中将自动创建ndb_1_config.bin.1文件，如图15-11所示。该文件是config.ini 集群配置文件的二进制缓存文件“副本”，以后每次重新启动管理节点时，管理节点将直接加载二进制缓存文件ndb_1_config.bin.1的配置信息。如果config.ini集群配置文件的内容发生了变动，需要删除ndb_1_config.bin.1文件后，再启动管理节点。<br>步骤2：查看管理节点的状态。<br>管理节点一旦启动，即可通过管理节点客户机了解管理节点当前的状态信息。打开 M 主机新的CMD命令行窗口，输入ndb_mgm命令，接着输入show命令，即可查看管理节点当前的状态信息，如图15-12所示。<br>▲图15-11 管理节点的二进制缓存文件<br>▲图15-12 查看管理节点的状态<br>图15-12中状态信息的含义依次如下：<br>① 连接本地主机的管理节点，管理节点默认情况下占用的端口号为1186。<br>② 管理节点的配置如下：<br>[ndbd(NDB)] 2 node(s)：两个数据节点。<br>③ id=2 的数据节点主机 IP 地址为 192.168.4.11，该数据节点没有连接管理节点。集群中的每个节点都有唯一的标识。<br>④ id=3的数据节点主机IP 地址为192.168.4.12，该数据节点没有连接管理节点。<br>⑤ [ndb_mgmd(MGM)] 1 node(s)：一个管理节点。<br>⑥ id=1的管理节点主机IP 地址为192.168.4.15。<br>⑦ [mysqld(API)] 2 node(s)：两个SQL节点。<br>⑦ [mysqld(API)] 2 node(s)：两个SQL节点。<br>⑧ id=4的SQL 节点主机IP 地址为192.168.4.13，该SQL节点没有连接管理节点。<br>⑨ id=5的SQL 节点主机IP 地址为192.168.4.14，该SQL节点没有连接管理节点。<br>步骤3：启动D1、D2主机的数据节点。<br>在D1主机的CMD命令行窗口中运行如下命令，执行结果如图15-13所示，此时D1主机的数据节点服务成功启动。从图15-13中可以看出，管理节点默认情况下占用的是1186端口号。<br>Ndbd – initial<br>▲图15-13 启动D1主机的数据节点<br>D1主机的数据节点服务成功启动后，D1主机的C：/data目录中将自动创建如图15-14所示的文件（或者目录）。<br>▲图15-14 D1数据节点的文件<br>在D2主机的CMD命令行窗口中运行如下命令，执行结果如图15-15所示，此时D2主机的数据节点服务成功启动。<br>Ndbd – initial<br>▲图15-15 启动D2主机的数据节点<br>D2主机的数据节点服务成功启动后，D2主机的C：/data目录中将自动创建如图15-16所示的文件（或者目录）。<br>▲图15-16 D2数据节点的文件说明<br>第一次启动数据节点时，或者config.ini配置文件改动后，在ndbd命令后建议添加“– initial”参数，以便进行数据节点的初始化工作。以后再次启动数据节点时，无需添加该参数，否则该参数将会使数据节点删除由早期ndbd进程创建的、用于恢复的任何文件，包括恢复用途的日志文件。</p>
<p>步骤4：启动S1、S2主机的MySQL服务。</p>
<p>重新启动S1、S2主机的MySQL服务，重新执行MySQL命令“show engines;”，</p>
<p>重新启动 S1、S2 主机的MySQL服务，重新执行MySQL命令“show engines;”，执行结果如图15-17所示。从图15-17中可以看到，当前的MySQL 服务已经支持NDB Cluster存储引擎。</p>
<p>步骤5：查看管理节点的状态。</p>
<p>打开M主机新的CMD命令行窗口，输入“ndb_mgm”命令，接着输入“show”命令，查看管理节点当前的状态信息，如图15-18所示。从图15-18可以看出：MySQL集群的所有节点已经成功启动。<br>▲图15-17 查看S1、S2主机的存储引擎<br>▲图15-18 查看管理节点的状态<br>15.2.6 集群测试<br>在S1 主机上打开CMD 命令提示符窗口，并输入“mysql -h localhost -u root -p”命令连接S1 主机的MySQL服务。接着依次输入下面的SQL语句，执行结果如图15-19所示。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> student;</span><br><span class="line"><span class="keyword">use</span> student;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> teacher(teacher_no <span class="built_in">int</span> primary <span class="keyword">key</span>) <span class="keyword">engine</span>=ndb;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> teacher <span class="keyword">values</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure></p>
<p>▲图15-19 添加测试数据<br>由于 teacher 表的存储引擎是 NDB Cluster，teacher 表对应的表结构文件存放在 S1 主机C：\mysql-clusterdata\student目录下，如图15-20所示。<br>▲图15-20 NDB存储引擎的表结构文件<br>在另一台S2主机上打开CMD 命令提示符窗口，并输入“mysql -h localhost -u root -p”命令连接S2主机的MySQL服务。接着依次输入下面的SQL语句，执行结果如图15-21所示。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">databases</span>;</span><br><span class="line"><span class="keyword">use</span> student;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> teacher;</span><br></pre></td></tr></table></figure></p>
<p>▲图15-21 集群测试</p>
<p>可以看到：针对S1主机NDB Cluster存储引擎teacher表的数据更新同步到了S2主机。至此MySQL集群的环境搭建工作已经完毕。鉴于目前MySQL Cluster的成熟案例并不太多，为了便于读者快速地部署 MySQL Cluster 环境，上述 MySQL Cluster 环境搭建方法仅仅是集群的最简化配置方法。有关MySQL Cluster 的复杂配置，读者可以登录MySQL Cluster官网查看具体资料。</p>
<blockquote>
<p>说明<br>SQL节点和数据节点在启动的时候需要连接到管理节点读取MySQL集群的配置信息，SQL节点和数据节点启动完成后，管理节点是可以停止工作的。因此MySQL集群过程中，即便管理节点宕机，也不会影响整个集群服务，所以管理节点一般只需要一台主机即可满足应用要求。</p>
</blockquote>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/MySQL核心技术与最佳实践/" rel="tag"># MySQL核心技术与最佳实践</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/07/06/SQL语句优化/" rel="next" title="SQL语句优化">
                <i class="fa fa-chevron-left"></i> SQL语句优化
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/07/17/［设计模式］唠唠依赖注入/" rel="prev" title="［设计模式］唠唠依赖注入">
                ［设计模式］唠唠依赖注入 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="CheBin">
            
              <p class="site-author-name" itemprop="name">CheBin</p>
              <div class="site-description motion-element" itemprop="description">绝知此事要躬行，不动手就是懒。一篇文章看10遍，而不是10篇文章看1遍。</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">446</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">15</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">44</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          


          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/2022/03/04/2022-03-04/" title="2022-03-04" target="_blank">2022-03-04</a>
                  </li>
                
                  <li>
                    <a href="/2022/02/08/第八章-立即生效的影响力/" title="第八章 立即生效的影响力" target="_blank">第八章 立即生效的影响力</a>
                  </li>
                
                  <li>
                    <a href="/2022/02/08/第七章-短缺/" title="第七章 短缺" target="_blank">第七章 短缺</a>
                  </li>
                
                  <li>
                    <a href="/2022/02/08/第六章-权威/" title="第六章 权威" target="_blank">第六章 权威</a>
                  </li>
                
                  <li>
                    <a href="/2022/02/08/第五章-喜好/" title="第五章 喜好" target="_blank">第五章 喜好</a>
                  </li>
                
              </ul>
            </div>
        

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#MySQL-Cluster简介"><span class="nav-number">1.</span> <span class="nav-text">MySQL Cluster简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL集群的组成"><span class="nav-number">1.1.</span> <span class="nav-text">MySQL集群的组成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL集群架构"><span class="nav-number">1.2.</span> <span class="nav-text">MySQL集群架构</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MySQL-Cluster环境搭建"><span class="nav-number">2.</span> <span class="nav-text">MySQL Cluster环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#准备工作"><span class="nav-number">2.1.</span> <span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据节点的配置"><span class="nav-number">2.2.</span> <span class="nav-text">数据节点的配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SQL节点的配置"><span class="nav-number">2.3.</span> <span class="nav-text">SQL节点的配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#管理节点的配置"><span class="nav-number">2.4.</span> <span class="nav-text">管理节点的配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL集群的启动"><span class="nav-number">2.5.</span> <span class="nav-text">MySQL集群的启动</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2022</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CheBin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">4.2m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">64:01</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
