<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">
<meta name="keywords" content="海龟交易法则">
<meta property="og:type" content="article">
<meta property="og:title" content="第七章 如何衡量风险">
<meta property="og:url" content="http://yoursite.com/2021/06/09/第七章-如何衡量风险/index.html">
<meta property="og:site_name" content="车斌的技术博客">
<meta property="og:description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/2021/06/09/第七章-如何衡量风险/3.jpg">
<meta property="og:updated_time" content="2021-11-05T07:54:07.244Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第七章 如何衡量风险">
<meta name="twitter:description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">
<meta name="twitter:image" content="http://yoursite.com/2021/06/09/第七章-如何衡量风险/3.jpg">






  <link rel="canonical" href="http://yoursite.com/2021/06/09/第七章-如何衡量风险/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>第七章 如何衡量风险 | 车斌的技术博客</title><meta name="robots" content="noindex">
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">专注</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/06/09/第七章-如何衡量风险/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CheBin">
      <meta itemprop="description" content="放弃会成为一种习惯">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">第七章 如何衡量风险

              
            
          </h1>
        

        <div class="post-meta">

          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-06-09 11:42:13" itemprop="dateCreated datePublished" datetime="2021-06-09T11:42:13+08:00">2021-06-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-11-05 15:54:07" itemprop="dateModified" datetime="2021-11-05T15:54:07+08:00">2021-11-05</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/期货/" itemprop="url" rel="index"><span itemprop="name">期货</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">8.5k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">8 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考并回答以下问题：</p>
<ul>
<li>总结一下，这章作者最主要想表达什么观点？</li>
</ul>
<a id="more"></a>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a><span style="color:#339AFF;">前言</span></h1><blockquote>
<p>序言<br>理解风险，尊重风险，这就是顶尖交易者们的标志。他们知道，如果你不去注意风险，风险就会找上门来。</p>
</blockquote>
<p>当你考虑一个以机械性交易系统为基础的交易策略，或者寻找一个使用这类策略的投资顾问时，你要问的一个关键问题（或许是唯一的问题）就是：“怎么才能知道一个系统或一个经理是好还是坏？”一般来说，业内给出的答案虽然五花八门，但本质上大同小异：谁的风险回报率最高，谁就是最好的。</p>
<p>每一个人都想在特定的风险水平下赚到尽可能多的钱，或者在特定的期望回报水平下承受尽可能小的风险。在这一点上，几乎所有的人都一致，无论是交易者、投资者、基金经理还是其他人。遗憾的是，对于风险回报率中的风险和回报这两个因子，关于什么是最佳的衡量标准仍存在诸多不同观点。有些时候，金融业对风险的定义太过狭窄，以至于对某些特定的风险完全视而不见，但这些风险的破坏力丝毫不亚于他们所关心的那些风险。</p>
<p>说到这些不在传统衡量范围内的风险，LTCMD（长期资本管理公司）的崩溃就是一个很好的例证。本章将探讨这些风险和它们的衡量方法，然后根据历史数据提出一些评估交易系统的风险和回报水平的一般技巧。</p>
<p>里奇和比尔对我们的头寸规模非常关心，因为他们知道，如果我们在一个不利的趋势中持有太大的头寸，他们甚至有倾家荡产的危险。在海龟计划开始前的几年，他们曾经历过白银市场设定跌停板的时期。纽约商品交易所对白银的每日最大变动幅度设定了限制，这意味着，如果没有交易者愿意在限价范围内买入，那卖家们根本没有退出的机会。这是期货交易者们最大的噩梦。你的损失一天又一天地扩大，但你无能为力。</p>
<p>幸运的是，里奇在噩梦发生之前就削减了他的头寸，这可能为他挽回了数千万美元之多的损失。如果他行动得不够快，他就可能失去一切。我相信，在海龟计划进行期间，这可怕的记忆一直徘徊在他的脑海中。</p>
<p>里奇一直在关注着海龟们的头寸，如果他感到总体风险太大，他还会削减他自己的头寸。人们普遍以为里奇是个胆大包天的赌徒，但在我看来，事实正相反，他非常注意他的风险水平。</p>
<h1 id="风险重重的世界"><a href="#风险重重的世界" class="headerlink" title="风险重重的世界"></a><span style="color:#339AFF;">风险重重的世界</span></h1><p>风险有很多种，因此衡量风险的方法也有很多种。有些大风险产生于相对罕见的事件，10年内也碰不到几次；也有的风险较为常见，一年内总会出现几次。大多数交易者都担心4种主要风险：</p>
<ul>
<li>衰落：一连串损失使你的账户缩水。</li>
<li>低回报：回报太低，你赚到的钱微不足道。</li>
<li>价格动荡：一个或多个市场中出现价格的骤然变动，导致无可挽回的重大损失。</li>
<li>系统死亡：市场状态改变，致使曾经有效的系统突然失效。</li>
</ul>
<p>让我们逐一看看这4种风险，然后考虑一下它们的衡量方法——要评估交易者和交易系统的风险回报比，我们可以结合这些方法。</p>
<h2 id="衰落"><a href="#衰落" class="headerlink" title="衰落"></a>衰落</h2><p>衰落风险可能就是交易者们放弃交易或是以失败收场的主要原因。请看图7-1中的净值曲线，它代表一个使用唐奇安趋势系统的10万美元的账户从1996年1月到2006年5月的交易结果。</p>
<p>图中可见，这个账户的净值在十年多的测试期内以年均43.7%的复利增长，但期间也有一段衰落38%的时期。</p>
<p>许多新手会被这类表现优异的系统所吸引，心想：“赢利这么多，我当然可以承受那38%的损失。”遗憾的是，现实已经一次又一次地证明，人们对自己承受这类损失的能力并不是那么了解。如果你看到的只是图7-1这样的图，那就更不用说了，因为这张图用的对数刻度，衰落幅度看起来要比在标准刻度下小得多。</p>
<p>新手约翰对这个系统充满信心，而且相信自己有能力熬过那种衰落期，于是他在6月1日投入10万美元开始交易。图7-2包含了图7-1的内容，只是更新到了2006年10月末，而且用一个线性刻度展示了历史上的衰落期。</p>
<p>就在约翰入市后不久，系统进入了一个衰落期，而且这一次的降幅比之前的任何一次都要高一点：42%。这时候，约翰会想些什么？</p>
<p>“万一这个系统不再管用了怎么办？”</p>
<p>“万一这只是一个大滑坡的开端怎么办？”</p>
<p>“万一我之前的测试方法有问题怎么办？”</p>
<p>“万一….怎么办？”</p>
<p>这些疑虑往往会促使一个新手放弃这个系统，或者开始有选择地交易，以期“降低风险”。这经常导致交易者错失本来可以赚钱的机会。在沮丧的情绪下，在看到初始账户遭受了1/2甚至更多的损失之后，交易者终于忍无可忍地退出了。这就是新手们即使使用有效的策略也无法赚钱的原因：他们高估了自己在高风险水平下承受巨大波动的能力。</p>
<p>根据我的观察，大多数人都承受不住这样的衰落。一个对自己的交易能力、系统和测试结果充满信心的成功交易者或许可以承受一次巨大的衰落，但是一个谨小慎微的新手应该相应地调整一下风险水平，降低衰落的幅度。当然，这也意味着降低系统的回报水平。这是一种明智的妥协。</p>
<p>海龟们是幸运的，因为我们的老板理查德·丹尼斯知道，市场回调中的衰落与一连串的败笔所造成的衰落不是一回事。他知道，对趋势跟踪者们来说，返还一些利润只是游戏的一个部分。</p>
<p>正因为如此，替这个老板管理资金是件轻松惬意的事。我们有时候所经历的某些大衰落足以让大多数投资者心惊胆战。有些海龟现在已经是募集外部资金的高手，但如果你看看他们的表现，你会发现他们的胆魄已经远不及海龟时代。如果你想募集机构投资，谨慎实际上是个前提条件。</p>
<p>遗憾的是，如果你想像海龟们那样获得100%以上的回报率，你也必须作好承受这类大衰落的准备。我估计我最大的一次衰落在70%左右，能承受这种波折的人恐怕不多。对大多数人的心理世界来说，这都是很难熬过的一关。</p>
<h1 id="低回报-lt-span-gt"><a href="#低回报-lt-span-gt" class="headerlink" title=" 低回报&lt;/span&gt;"></a><span style="color:#339AFF;"> </span>低回报&lt;/span&gt;</h1><p>如果一个交易者想获得年均30%的回报率，他可以采用两种方式：或者使用一个可以稳定地获得30%的年回报率的系统，或者使用另外一个不太稳定的系统—第一年赚5%，第二年赚5%，第三年赚100%。三年之后，两个系统的平均复合增长率（CAGR）都是30%。但是，大多数交易者都更喜欢每年赚30%的那个系统，因为这会让净值曲线更加平滑。</p>
<p>我们发现，在其他条件相同的情况下，一个能够稳定创造高回报的系统在未来任何一段时期内都更容易创造理想的回报。因此，在任何一年中，这样一个系统表现失常的风险都要低于那些历史记录不够稳定的系统。</p>
<h1 id="价格动荡-lt-span-gt"><a href="#价格动荡-lt-span-gt" class="headerlink" title=" 价格动荡&lt;/span&gt;"></a><span style="color:#339AFF;"> </span>价格动荡&lt;/span&gt;</h1><p>价格动荡是指价格突然之间发生了快速的变化，一般来说，这是由自然灾害、出人意料的政治事件或是经济灾难造成的。从我进入交易世界算起，美国共经历了两次严重的价格动荡，一次是1987年的股崩和随后的反弹，另一次是2001年9月11日纽约世贸中心遭受恐怖袭击之后。</p>
<p>第一次动荡爆发时，我正在为理查德·丹尼斯用一个2000万美元的账户进行交易。我对这次灾难记忆犹新。我在崩溃的当天其实还赚了一点，但第二天，情况就完全不同了。</p>
<p>1987年10月19日，也就是黑色星期一，欧洲美元收在90.64美元，接近两天前创下的90.15美元的低点。当天早上，这个低点还曾经受考验，市场一度跌到了90.18美元。我持有空头，大约有1200份12月份欧洲美元合约和600份短期国债合约。同时，我还在黄金、白银和几种外汇上重仓持有多头。</p>
<p>次日一早，欧洲美元以92.85美元高开，跳高了两个点还多，相当于每份合约5500美元左右。我根本没有机会退出，这是8个月以来的最高价。另一边，黄金开在25美元以下，白银开在1美元以下。图7-3展示了欧洲美元市场在这个动荡日的巨变。</p>
<blockquote>
<p>图7-3 1987年价格动荡中的欧洲美元</p>
</blockquote>
<img src="/2021/06/09/第七章-如何衡量风险/3.jpg">
<p>算起来，我为理查德·丹尼斯交易的那个2000万美元的账户损失了大约1100万美元。基本上，我全年的利润已经在一夜之间烟消云散。</p>
<p>令我哭笑不得的是，我在股崩的当天其实是小有收获的。是政府在一夜之间不加警告突然降息的疯狂举动害惨了我。价格动荡不期而至了。</p>
<p>请看图7-4，这是一个使用唐奇安趋势系统的10万美元账户从1984年海龟们开始实战到1987年末的情况。</p>
<p>你可以清楚地看到那个代表着65%跌幅的巨大缺口。请务必记住这个衰落是在一夜之间发生的。没有丝毫机会退出市场。还请注意，这一天内的跌幅比这个系统的任何一次历史检验结果都要大一倍。换句话说，系统的历史检验会把衰落风险低估一倍。</p>
<p>在为自己的账户设定风险水平的时候，所有想生存下去的交易者都会谨慎地考虑价格动荡的现实。任何一个想获得高回报的人都要承受同样高的衰落风险—甚至有可能在一次巨大的价格动荡中输个一干二净。</p>
<h1 id="系统死亡-lt-span-gt"><a href="#系统死亡-lt-span-gt" class="headerlink" title=" 系统死亡&lt;/span&gt;"></a><span style="color:#339AFF;"> </span>系统死亡&lt;/span&gt;</h1><p>所谓系统死亡，是指一个曾经有效或在历史检验中看似有效的系统突然之间不再有效，开始赔钱。这种风险并不是来自市场本身，而是由蹩脚的测试方式造成的。对那些根据近期价格波动进行最优化的短期系统来说，这个风险更大。</p>
<p>一个表现不佳的系统究竟只是处于一个正常的衰落期，还是真的不再有效？这对一个新手来说通常很难判断。我敢说，这可能是最令新手们头疼的一件事。当他们碰上一次衰落时，他们会开始怀疑自己的方法：“我的测试是不是有问题？”“是不是市场发生了某些变化，使我的方法变得无效了？”“这种情况还会持续下去吗？”</p>
<p>我们将在以后的章节讨论降低系统死亡风险的方法。不过，现实是无奈的。由于市场是动态的，还包含其他许许多多的参与者，市场会变化是个无法改变的现实，而这会影响到曾经有效的系统和方法。有时候，这些变化是永久性的。伟大交易者与普通交易者的区别之一就在于他们有能力坚持其他人已经厌倦和放弃的方法，并且靠这些方法获得成功。</p>
<p>某些交易者会因为怀疑某种方法而停止使用它，这对趋势跟踪者们也有一种有趣的副作用。每过几年，趋势跟踪者们就会经历一个亏损期，而每到这个时候，必然有专家跳出来宣称趋势跟踪策略已经走到末日。这样一来，采用趋势跟踪策略的基金通常会遭遇大规模赎回的窘境。但当越来越多的资金撤离了趋势跟踪策略的阵营后，这类策略反而开始重振雄风，大显神威。自海龟计划实施以来，我已经至少三四次听到趋势跟踪法已经失效的论调。对此，我通常一笑了之，因为我知道，这意味着遍地黄金的市场已经离我们不远了。</p>
<h1 id="衡量风险-lt-span-gt"><a href="#衡量风险-lt-span-gt" class="headerlink" title=" 衡量风险&lt;/span&gt;"></a><span style="color:#339AFF;"> </span>衡量风险&lt;/span&gt;</h1><p>使用任何一个系统都会经历痛苦的逆境时期，要把这一点考虑在内，风险的量化就是方法之一。量化风险的方法有很多，以下是几种我认为很有用的常用方法：</p>
<p>1，最大衰落：这是一个数字，代表一个测试期中从最高点到随后的最低点的下跌百分比。在图7-4中，这个数字等于65%，是1987年价格动荡的结果。<br>2，最长衰落期：从一个顶峰到下一个新顶峰的最长周期。它衡量的是恢复速度，也就是在一段损失期之后需要多长时间才能重新站上新的高点。<br>3，回报标准差：这是回报率分散状况的一个衡量指标。低标准差表明大多数时候的回报率都接近于平均值，高标准差表明不同月份之间的回报率差异较大。</p>
<p>4R平方值：这个指标衡量的是实际投资回报率与平均复合增长率的吻合程度。对带息账户这一类的固定收益投资来说，R平方值等于1.0，而如果回报率不稳定， R平方值将小于1.0</p>
<p>风险的对立面：回报</p>
<p>对一个特定的交易系统来说，回报是指你使用这个系统的期望回报。我们可以用很多种方法来量化回报，以下是我认为很有用的几种：</p>
<ul>
<li>平均复合增长率：平均复合增长率也称做几何平均回报率，是指特定投资期间内的平均化复利率：期初资产按这个复利率滚动增长，将恰好增长到期末资产的水平。对简单的带息账户来说，平均复合增长率就是利息率（复利）本身。在特定时期内，只要有一期的回报率特别高，整个平均复合增长率指标就会受到重大影响。</li>
<li>滚动平均一年期回报率：这是指连续滚动计算的一年期平均回报率。这个指标能更好地反映任何一个特定一年期内的典型回报水平。对跨度在几年以上的测试来说，这个指标对某个回报率特别高的期间相对不是那么敏感。</li>
<li>平均月度回报率：这是指测试期内各个月份的回报率平均值。</li>
</ul>
<p>除了这些数字形式的指标，我还发现了几个有用的工具。一是净值曲线图本身，另一个是能突出月度回报分布状况的图表，就像是第四章中的图4-4那样。我还喜欢检验一段时期内各个月份的回报情况，就像图7-5一样。这个图给出了唐奇安趋势系统从1996年1月到2006年6月的月度回报率。</p>
<p>我发现，像图7-5这样的图能很好地反映风险与收益的权衡，比单纯的一个或一组数据要生动得多。</p>
<p>风险与回报的衡量</p>
<p>要比较不同的交易系统或使用交易系统的基金经理，有几种常见的综合指标可用。最常用的两个指标是夏普比率和MAR比率。</p>
<p>夏普比率</p>
<p>夏普比率可能是退休基金和大投资者们在比较潜在投资目标时最常用的指标。夏普比率由诺贝尔奖获得者威廉.F.夏普于1966年发明，用于比较共同基金的业绩。这个指标最初被称做回报-波动性比率，后来被冠以创始人的名字，简单地称做夏普比率。</p>
<p>夏普比率是这样得出的：首先计算考察期内的超额回报率（也就是这段时期的月度或年度平均复合增长率减去所谓的无风险回报率，或者减去短期国债之类的无风险债券的利息率），然后把它除以期间回报率（一般是月度或年度回报率）的标准差。请记住，夏普比率是为比较共同基金的表现而发明的，并不是一个一般性的风险回报率指标。共同基金是一种非常特殊的投资工具，主要做股票组合的非杠杆投资。</p>
<p>夏普比率是用于比较共同基金的，这个原始定位也对不在它涵盖范围内的风险提供了重要的提示。夏普比率是1966年提出的，当时的共同基金只做美国股票组合的非杠杆投资。因此，比较共同基金比的是相同市场上的投资，而且是投资策略基本相同的投资。</p>
<p>另外，当时的共同基金普遍从事股票组合的长期性投资。由于不存在时机选择和交易方式的因素，不同基金之间的区别仅在于组合选择和分散化策略的不同。因此，在衡量共同基金的表现时，夏普比率能很好地代表风险水平，因为它正确地反映了一个事实：对同时期内的比较来说，风险水平与回报的波动性直接相关。在其他条件相同的前提下，波动性较低的共同基金更不容易偏离它的历史平均回报水平。</p>
<p>但是，尽管夏普比率是比较股票组合管理策略的一个绝好的风险回报率指标，它对期货对冲基金这一类的另类投资基金来说也并不是一个足够好的比较指标。之所以这么说，是因为这些另类投资基金在几个重要的风险层面上与无杠杆的股票组合并不相同：</p>
<ul>
<li>管理策略风险：期货系统和期货基金往往会使用短期性的交易策略，这些策略与传统投资基金的长期持有策略有天壤之别。在使用这种需要频繁买入和卖出的交易策略时，损失的速度可能会快得多。</li>
<li>分散化策略风险：许多期货基金和交易系统的内在分散化程度达不到传统投资基金那样高的水平，往往把相当大的一部分资产集中在少量工具上。 </li>
<li>潜在风险：期货交易的杠杆水平要高于股票，这在无形之中使期货交易者承受了更大的市场波动风险。</li>
<li>信心风险：许多期货基金经理并没有太详细的历史履历。在缺乏履历参考的情况下，投资者得不到期望回报的风险就会提高。</li>
</ul>
<p>遗憾的是，夏普比率的流行似乎加剧了我在这个行业中所发现的一个问题：把回报的稳定性当成风险水平的唯一衡量标准。对那些不懂交易、不明白交易策略与传统股票投资的持有策略有何不同的人来说，这个问题尤其严重。</p>
<p>我必须强调一点：稳定性并不等于低风险!风险非常高的投资也有可能在有限的时期内创造稳定的回报。投资者们很容易相信，能在几年的时间内一直保持正回报率的投资或投资经理就是安全的选择。他们只是盲目地怀有这种信念，往往并不知道这些回报是怎么得来的。</p>
<p>我相信，在很多情况下，回报的稳定性越高，实际风险水平就越大。我可以给出两个例子：一个是LTCM，它所使用的策略在最初的几年中相当成功，但随后就彻底失效，制造了一场灾难;另一个是许多基金至今仍在使用的策略，它的表现非常出色，但同样有瞬间崩溃的风险。</p>
<p>天才的失败</p>
<p>LTCM的策略有两个基础：一个是非常高的杠杆率，另一个是固定收益债券的价格在特定情况下的统一化趋势。极高的杠杆率使它的头寸规模鹤立鸡群，庞大之极，因此当遭受损失时，它很难全身而退。这个策略曾在几年内十分顺利，但当俄罗斯债券违约事件所制造的金融危机引发了一次不利的波动时，LTCM的规模反而害了它。因为市场上的其他阵营都知道，他们可以让价格继续向不利于LTCM的方向变化，到头来，LTCM早晚要被迫逆转他们的头寸。最终，LTCM几乎把家底赔了个精光，而在崩溃之前，它的价值曾是47亿美元。</p>
<p>在危机之前，LTCM的年均回报率几乎达到了40%，而且表现相当稳定。换句话说，它的夏普比率很出众。你可以在罗杰·洛温斯坦的《营救华尔街》书中了解到LTCM陨落故事的更多细节。</p>
<p>夏普陷阱</p>
<p>最近，对冲基金Amaranth的天然气交易也出了类似的问题。同LTCM一样，Amaranth的头寸相比其他交易者来说过于庞大了。Amaranth的90亿美元在短短两个月之内就损失了65%。在此之前，它的夏普比率也很不错。</p>
<p>山雨欲来？</p>
<p>现在，有很多对冲基金靠货币期权交易赚钱，这意味着它们赌的是价格的剧变。如果风险能得到有效的管理，这可以是一种非常有效的策略，能提供非常稳定的回报。</p>
<p>问题是，这些基金所面临的实际风险对外行人来说是很难理解的。它们有可能一边创造着丰厚而又稳定的回报，一边又严重暴露在各种各样的价格动荡风险中。例如， 1987年欧洲美元期权的任何一个卖方都有可能倾家荡产。价格动荡中的损失，再加上期权履约的风险，完全可能令一天内的损失超过整个基金的价值。</p>
<p>谨慎的基金经理会控制这些风险。遗憾的是，许多投资者并不知情，等他们意识到这些风险的存在时，往往为时已晚，他们已经失去了一切。他们是被基金的稳定回报率和多年来的良好表现诱惑而来的，殊不知，这些基金还没有经历过真正的艰险时期。</p>
<p>MAR比率</p>
<p>MAR比率是Managed Accounts Reports有限公司发明的一个指标，这个公司专门提供对冲基金的业绩报告。MAR比率等于年均回报率除以最大的衰落幅度，衰落是根据月末数据计算的。这个比率是风险回报比率的一个相当快捷而又直接的衡量指标，我发现用它来别除表现不佳的策略是非常有效的。对粗略的分析来说，它是一个绝好的工具。以唐奇安趋势系统为例，在上文所说的1996年1月至2006年6月的测试期中，系统的MAR比率是1.22，其中，平均复合回报率为27.38%，用月末数据计算出的最大衰落幅度是22.35%。</p>
<p>我发现用月末数据计算衰落幅度有点缺乏根据，它经常会低估实际衰落程度。因此，我在我自己的测试中使用的是从最高点到最低点的跌幅，没有考虑这些高点和低点是一个月中的哪一天。要想知道这种方法与单纯使用月末数据有什么区别，看看我的计算结果就行了:包括非月末日在内的实际衰落不是22.35%，而是27.58%，因此实际MAR比率是0.99，而不是刚才的1.22</p>
<h1 id="系统死亡风险"><a href="#系统死亡风险" class="headerlink" title="系统死亡风险"></a>系统死亡风险</h1><p>说到交易的系统、策略和表现，我所观察到的最有趣的现象之一就是模仿效应:在风险回报比率上拥有傲人记录的那些策略往往都是最容易被整个行业群起模仿的策略。它们刚刚崭露头角，立即就被数十亿美元竞相追随，结果反而自毁长城，因为它们的规模已经超出了市场的承受能力。到头来，它们早早就成了系统死亡的牺牲品。</p>
<p>在这一点上，套利策略可能是最好的例子。最纯粹的套利实际上是一种没有风险的交易。你在一个地方买入某个东西，在另一个地方把它高价卖掉，扣掉运输或仓储成本，剩下的都是你的利润。大多数套利策略都不会完全没有风险，但有很多接近于没有风险。问题是，靠这样的策略赚钱是有前提条件的，那就是不同地方的同一种工具存在价格差，或者一种工具和另一种类似工具之间存在价格差。</p>
<p>使用某一种特定策略的人越多，价格差就消失得越快，因为这些交易者本质上都在争夺同样的机会。长此以往，这种效应会毁掉这种策略，因为它会变得越来越无利可图。</p>
<p>相反，对一般投资者没有吸引力的系统和策略反而有更长的生命期。趋势跟踪就是个很好的例子。大多数大投资者都很难忍受对趋势跟踪策略来说司空见惯的大衰落和价值波动。正因为这样，趋势跟踪策略在长期内始终有效。</p>
<p>不过，趋势跟踪策略的回报水平是带有周期性的。每当有大量资金在一段相对稳定的回报期后跟风涌入，通常会出现几个相对艰苦的年头，因为有太多的投资者在同样的市场中使用同样的策略，市场无法轻松消化这么多的资金。相反，当投资者们在一段相对艰苦的时期后纷纷撤走他们的资金时，好时期通常又会再度来临。</p>
<p>切忌要求过高:如果你在检验一种策略的时候太过贪婪，你更有可能得不到你想要的结果。历史记录看似高人一筹的策略也最有可能引来新的追随者，当新来者们纷纷加入时，这些策略往往很快就变得不再神奇。</p>
<h1 id="每个人都不同"><a href="#每个人都不同" class="headerlink" title="每个人都不同"></a><span style="color:#339AFF;">每个人都不同</span></h1><p>我们每个人都有不同的风险承受能力和回报期望。因此，世界上不存在对所有人都有吸引力的万能指标。我曾经结合使用MAR比率、衰落和总体回报这三个指标，同时还通过观察夏普比率和R平方值来判断回报稳定性。最近我又设计了一些新指标，可以说是这些常用指标的更稳定的版本。我将在第十二章介绍这些指标。</p>
<p>我也会尽力避免被某些特殊数据迷惑，因为我知道，未来不等于现在，一种策略现在有1.5的MAR比率并不意味着它能在未来保持这样的水平。</p>
<!-- flag of hidden posts -->
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/海龟交易法则/" rel="tag"># 海龟交易法则</a>
          
        </div>
      

      
      
      

      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="CheBin">
            
              <p class="site-author-name" itemprop="name">CheBin</p>
              <div class="site-description motion-element" itemprop="description">放弃会成为一种习惯</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">439</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">15</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">44</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          


          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/2021/12/21/34｜业务开发（下）：问答业务开发/" title="34｜业务开发（下）：问答业务开发" target="_blank">34｜业务开发（下）：问答业务开发</a>
                  </li>
                
                  <li>
                    <a href="/2021/12/21/33｜业务开发（上）：问答业务开发/" title="33｜业务开发（上）：问答业务开发" target="_blank">33｜业务开发（上）：问答业务开发</a>
                  </li>
                
                  <li>
                    <a href="/2021/12/21/32｜通用模块（下）：用户模块开发/" title="32｜通用模块（下）：用户模块开发" target="_blank">32｜通用模块（下）：用户模块开发</a>
                  </li>
                
                  <li>
                    <a href="/2021/12/21/31｜通用模块（上）：用户模块开发/" title="31｜通用模块（上）：用户模块开发" target="_blank">31｜通用模块（上）：用户模块开发</a>
                  </li>
                
                  <li>
                    <a href="/2021/12/21/30｜设计先于实战：需求设计和框架搭建/" title="30｜设计先于实战：需求设计和框架搭建" target="_blank">30｜设计先于实战：需求设计和框架搭建</a>
                  </li>
                
              </ul>
            </div>
        

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#风险重重的世界"><span class="nav-number">2.</span> <span class="nav-text">风险重重的世界</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#衰落"><span class="nav-number">2.1.</span> <span class="nav-text">衰落</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#低回报-lt-span-gt"><span class="nav-number">3.</span> <span class="nav-text"> 低回报&lt;/span&gt;</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#价格动荡-lt-span-gt"><span class="nav-number">4.</span> <span class="nav-text"> 价格动荡&lt;/span&gt;</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#系统死亡-lt-span-gt"><span class="nav-number">5.</span> <span class="nav-text"> 系统死亡&lt;/span&gt;</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#衡量风险-lt-span-gt"><span class="nav-number">6.</span> <span class="nav-text"> 衡量风险&lt;/span&gt;</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#系统死亡风险"><span class="nav-number">7.</span> <span class="nav-text">系统死亡风险</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#每个人都不同"><span class="nav-number">8.</span> <span class="nav-text">每个人都不同</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2022</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CheBin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">4.1m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">61:25</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
