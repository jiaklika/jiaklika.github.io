<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">
<meta name="keywords" content="Go语言并发之道">
<meta property="og:type" content="article">
<meta property="og:title" content="第2章 对你的代码建模：通信顺序进程">
<meta property="og:url" content="http://yoursite.com/2021/09/09/第2章-对你的代码建模：通信顺序进程/index.html">
<meta property="og:site_name" content="车斌的技术博客">
<meta property="og:description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/2021/09/09/第2章-对你的代码建模：通信顺序进程/t-1.png">
<meta property="og:updated_time" content="2021-11-01T03:59:03.647Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第2章 对你的代码建模：通信顺序进程">
<meta name="twitter:description" content="思考并回答以下问题：  总结一下，这章作者最主要想表达什么观点？">
<meta name="twitter:image" content="http://yoursite.com/2021/09/09/第2章-对你的代码建模：通信顺序进程/t-1.png">






  <link rel="canonical" href="http://yoursite.com/2021/09/09/第2章-对你的代码建模：通信顺序进程/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>第2章 对你的代码建模：通信顺序进程 | 车斌的技术博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">放弃会成为一种习惯</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/09/第2章-对你的代码建模：通信顺序进程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CheBin">
      <meta itemprop="description" content="看视频才能学会，看文字学不会的">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">第2章 对你的代码建模：通信顺序进程

              
            
          </h1>
        

        <div class="post-meta">

          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-09-09 14:47:20" itemprop="dateCreated datePublished" datetime="2021-09-09T14:47:20+08:00">2021-09-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-11-01 11:59:03" itemprop="dateModified" datetime="2021-11-01T11:59:03+08:00">2021-11-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Go/" itemprop="url" rel="index"><span itemprop="name">Go</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">9.8k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">9 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考并回答以下问题：</p>
<ul>
<li>总结一下，这章作者最主要想表达什么观点？</li>
</ul>
<a id="more"></a>
<h1 id="并发与并行的区别"><a href="#并发与并行的区别" class="headerlink" title="并发与并行的区别"></a>并发与并行的区别</h1><p>事实上，并发与并行的区别经常被忽视或者误解。当和开发者进行交流的时候，这两种模式总是被混用来表达“某种和其他事物同时运行的事物”。有些时候在某些环境中使用“并行”是正确的，但是，当开发者们讨论代码的时候，他们真的应该使用“并发”这个词。</p>
<p>如何区分这两个概念显得过于卖弄学问。并发与并行的区别在你对代码进行建模的时候是一个非常强力的抽象，而Go语言则充分利用了这一点。让我们来了解一下这两个概念的不同点，来理解原本抽象的力量。让我们从一个很简单的陈述开始：</p>
<p>并发属于代码；并行属于一个运行中的程序。</p>
<p>这是一个有趣的区别。我们不是经常把这两种事物认为是相同的吗？我们为了可以并行执行才写的代码，难道不是吗？</p>
<p>好吧，让我们稍微考虑一下。假设我故意写了两部分可以并行运行的程序，我可以保证在程序实际运行的时候并行执行么？我在只有一个核心的机器上运行会发生什么？你们中某些人会认为程序会并行运行，但事实并不是这样的！</p>
<p>代码块可能表现的像是在并发的执行，但是事实上，它们在用不可被辨别的速度进行顺序执行。CPU的上下文在一个时间颗粒度之内一直在不同的程序之间进行切换分享CPU时间使得任务好像是在并行执行。如果在有两个CPU核心的机器上执行相同的二进制文件，代码块可能真的是在并行执行！</p>
<p>这揭示了一些很有趣且重要的事情。首先，我们并没有编写并行的代码，只有我们希望可以并行执行的并发代码。另外，并行是我们程序运行时的属性，而不是我们的代码。</p>
<p>其次，就是可能（或者这么做是可取的）对我们所写的并发代码是否真的并行执行，保持不知情。这只有在我们程序模型之下的抽象层实现：并发原语、程序的运行时、操作系统，操作系统所运行的平台（运行在hypervisor，容器和虚拟机时），以及最终的CPU，这些抽象给予我们区分并发与并行的能力，最终，给了我们灵活而有力的表达。我们回到这个问题本身。</p>
<p>第三个也是最后一个有意思的事情是并行是一个时间或者上下文的函数。还记得我们在第1章“原子性”中所讨论的上下文的概念吗？在那里，上下文被定义成一个操作被认为是原子性的界限。这里，上下文定义为两个或者以上的操作被认为是并行的界限。</p>
<p>例如，如果我们的上下文是一段5s的时长，我们执行了两个分别消耗1s钟执行的操作，我们应该认为这些操作是并行执行的。如果我们的上下文是1s，我们应该认为操作是分别运行的。</p>
<p>对于我们来说，用不同的时间对上下文的概念进行重定义并不是一件好事，但是请记住上下文和时间并没有关系。我们可以把上下文定义成我们程序所在运行的进程，一个操作系统的线程，或者是一台机器。这很重要，因为你所定义的上下文是和并发性以及正确性密切相关。就像原子操作可以按照你所定义的上下文来定义是否为原子性，并发操作也依据你所定义的上下文来确定正确性。一切都是相关的。</p>
<p>这里介绍的内容可能有些抽象，所以我们来看一个例子。我们假设所讨论的上下文是你的计算机。把物理上的理论放在一边，我们可以合理地认为在我的计算机上执行的一个进程，不会影响你的计算机上执行的一个进程的逻辑。如果我们都开启一个计算器进程来做一些简单的数学运算，我所操作的计算器不应该影响你所操作的计算器。</p>
<p>这是一个很笨的例子，但是如果我们拆分它，就能看到所有的片段我们的计算机就是上下文，整个过程就是并发操作。在这种情况下，我们选择用独立的计算机、操作系统和进程来考虑问题，从而对并发操作进行建模。这些抽象概念让我们自信地断言正确性。</p>
<p>这真的是一个很笨的示例吗？</p>
<p>使用独立的个人计算机作为例子像是一种人为的观点，但是个人计算机并不是一直都这么随处可见的！直到20世纪70年代末，大型主机还是标准，而开发者们在思考关于并发的问题的时候的上下文经常是一个程序的进程。</p>
<p>现在很多开发者都在从事分布式系统相关工作，而且正在向另一个方向发展！我们现在开始从hypervisor、容器，以及虚拟机的角度来思考我们的并发上下文。</p>
<p>我们可以理所当然的期待一台计算机上的一个进程不被其他计算机上的进程影响（假设它们不是同一个分布式系统的组成部分），但是，我们能期待在相同的计算机上运行的两个进程不影响另一个进程的逻辑么？进程A可能会覆盖某些进程B正在读取的文件，或者，在一个不可靠的操作系统上，进程A甚至可能会损坏进程B正在读取的内存。这么做的后果是会导致更多的漏洞被利用。</p>
<p>然而，在进程的角度，事情考虑起来保持着相对简单的方式。如果我们回到我们计算器的例子，也可以合理地期待两个用户在相同的机器上运行的两个计算器的进程，也应该可以认为它们对于逻辑的操作也应该是彼此独立的。</p>
<p>幸运的是，进程的边界线以及操作系统帮助我们按照一个符合逻辑的方式来思考这些问题。但是，我们仍然可以见到开始对并发担心的开发者，而且这个问题只会变得更加严重。</p>
<p>如果我们向操作系统线程的界限再前进一步的话会发生什么？所有在第1章“为什么并发很难”中列举的问题都开始出现：条件竞争、死锁、活锁，以及饥饿。如果我们有一个所有计算机上的用户都可见的计算器进程，就会使并发逻辑变的很难正确。我们应该已经开始担心对于内存访问同步以及给正确的用户取回正确的结果。</p>
<p>事实上随着我们对于抽象栈的进一步深入，如何正确的对事物进行建模变得越来越难理解，对我们来说越来越重要。相反地，抽象对于我们来说越来越重要啦。换言之，编写正确的并发逻辑越难，越需要我们将很简单的并发原语组合起来使用。不幸的是，我们行业中的大部分并发逻辑都是写在最高等级之一的操作系统线程抽象之上的。</p>
<p>在Go语言将之公开于众之前，大部分的主流编程语言都有一系列的抽象层。如果你想写并发代码，你需要对你的程序按照线程以及对于内存访问之间使用同步来建模。如果你有一大堆需要并发建模的东西，而你的计算机又不能处理那么多的线程，就需要创建一个线程池并将你的操作在线程池中复用。</p>
<p>Go语言在这个链条中加人了新的一环：goroutine。另外，Go语言从著名的计算机科学家Tony Hoare那里借用了不少概念，并且给我们提供了新的原语来使用，即channel.<br>如果继续按照线索推理，假设在操作系统的线程下提供新的抽象层会带来更多的复杂性，但有趣的是并没有。事实上，channel使事情变得简单化。这是因为我们并没有真的在操作系统的线程之上增加了另一层的抽象层，我们取代了这些事物。</p>
<p>当然，线程依旧存在，但是我们发现几乎不在操作系统的线程层面考虑我们的问题了。取而代之的是，我们对于事物站在goroutine以及channel的角度来进行思考，偶尔站在共享内存的角度来思考。这就引出了一些在本章后面的“如何帮助你”中探讨的有趣的特性。但是首先让我们更进一步看一下Go语言在哪里获得这些想法一Go语言并发原语的根基论文：Tony Hoare开创性的论文“Communicating Sequential Processes”</p>
<h1 id="什么是CSP"><a href="#什么是CSP" class="headerlink" title="什么是CSP"></a>什么是CSP</h1><p>当进行和Go语言有关讨论的时候，你会经常听到人们抛出CSP这个缩写。在某些环境下CSP经常被赞美成Go语言成功的原因以及并发编程的“万能钥匙”。它让不知道CSP的人开始认为计算机科学已经发现了一些可以像变魔术一样的方法让编写一个并发程序像编写一个串行程序一样简单。虽然CSP确实使这些变得更加简单，让程序变得更加健壮，但不幸的是它并不是一个奇迹。所以，CSP到底是什么？为什么把大家都弄的如此兴奋？</p>
<p>CSP即“Communicating Sequential Processes”（通信顺序进程），既是一个技术名词，也是介绍这种技术的论文的名字。在1978年，Charles Antony Richard Hoare 在Association for Computing Machinery（一般被称作ACM） 中发表的论文。<br>在这篇论文里，Hoare认为输人与输出是两个被忽略的编程原语，尤其是在并发代码中。在Hoare写作这篇论文的同时，关于如何架构程序的相关研究还在进行中，但是大部分的研究都是针对编写顺序代码的方法：goto语句的使用正在被讨论，面向对象范型正在成为编程的基石。并发操作并没有被给予过多的思考。Hoare开始纠正这个现象，所以，关于CSP的这篇论文就横空出世了。</p>
<p>在1978年的论文中，CSP仅是一个完全用来展示通信顺序进程的能力的一个简单的编程语言。事实上，他甚至在论文中写道：<br>因此，本文介绍的概念和符号应该.-. …不被认为适合作为一种编程语言，无论是抽象的还是具体的编程。</p>
<p>Hoare深深的忧虑所展示的技术对未来的关于并发编程的研究没有任何作用，这种技术也许没有语言会真的按照他的想法来实现。在接下来的6年里，关于CSP的想法被提炼成了一个叫做“进程微积分”的正式名称来将CSP的想法投人到并发编程的实践。进程微积分是一种对并发系统进行数学化建模的方式，并且提供了代数法则来进行这些系统的变换来分析它们不同的属性，例如：并发与效率。尽管进程微积分是一个很有趣的主题，但是超出了本书的范围。而且正是因为CSP的原始论文以及从论文中进化而来的原语正是Go语言并发模型的主要灵感，而这正是我们接下来所要聚焦的。</p>
<p>用来支撑他关于输人与输出需要被按照语言的原语来考虑，Hoare的CSP编程语言包含用来建模输人与输出，或者说“在进程间正确通信”（这就是论文名字的由来）的原语。Hoare将进程这个术语运用到任何包含需要输人来运行且产生其他进程将会消费的输出的逻辑片段。Hoare可能应该使用“函数”这个词汇，而不是在他写论文时在社区中关于如何构建程序的辩论。</p>
<p>为了在进程之间进行通信，Hoare创造了输人与输出的命令：！代表发送输入到一个进程，？代表读取一个进程的输出。每一个指令都需要指定具体是一个输出变量（从一个进程中读取一个变量的情况），还是一个目的地（将输人发送到一个进程的情况）。有时，这两种方法会引用相同的东西，在这种情况下，这两个过程会被认为是相对应的。换言之，一个进程的输出应该直接流向另一个进程的输入。表2-1给我们展示了论文中的部分示例。</p>
<blockquote>
<p>表2-1：Hoare的CSP论文中-些例子的摘录</p>
</blockquote>
<img src="/2021/09/09/第2章-对你的代码建模：通信顺序进程/t-1.png">
<p>示例与Go语言的channel的相似性是显而易见的。注意最后一个示例中west的输出被送到一个变量c，然后east的输人也是从相同的变量中接收的。这两个过程是相同的。在Hoare关于CSP的第一篇论文中，进程只能通过命名的源与目的进行通信。他承认这会让代码像一个函数库一样被嵌入到逻辑中，因为这段代码的消费者必须知道输人与输出的命名。他随意地提出将输入输出的名字注册成他称作“端口名”的可能性，也就是说，在并行命令的头部，需要声明名字，也就是我们大概可以认为是命名的参数与命名的返回值。</p>
<p>这种语言同时利用了一个所谓的守护命令，也就是Edgar Dijkstra在一篇之前在1974年所写的论文中介绍的，“Guarded commands，nondeterminacy andformal derivation of programs”。一个有守护的命令仅仅是一个带有左和右倾向的语句，由一来分割。左侧服务是有运行条件的，或者是守护右侧服务，如果左侧服务运行失败，或者在一个命令执行后，返回false或者退出，右侧服务永远不会被执行。将这些与Hoare的I/O命令组合起来，为Hoare的通信过程奠定了基础，从而实现了channel。</p>
<p>使用这些原语，Hoare运行了几个示例，并演示了如何以最佳的方式支持建模通信，从而使解决问题变得更简单、更容易理解。他使用的一些符号是简短的（Perl程序员可能不同意），并且提出的问题有非常清晰的解决方案。类似的解决方案比较长一些，但也很清晰。</p>
<p>经验判断Hoare的建议是正确的，然而，有趣的是，在Go语言发布之前，很少有语言能够真正地为这些原语提供支持。大多数流行的语言都支持共享和内存访问同步到CSP的消息传递样式。当然也有例外，但不幸的是，这些都局限于没有广泛采用的语言。Go语言是最早将CSP的原则纳入其核心的语言之一，并将这种并发编程风格引入到大众中。它的成功也使得其他语言尝试添加这些原语。</p>
<p>内存访问同步并不是天生就不好。我们将在本章后面“Go语言的并发哲学”介绍，在Go语言中，甚至有时共享内存在某些情况下是合适的。但是，共享内存模型很难正确地使用，特别是在大型或复杂的程序中。正是由于这个原因，</p>
<p>并发被认为是Go语言的优势之一，它从一开始就建立在CSP的原则之上，因此很容易阅读、编写和推理。</p>
<h1 id="如何帮助你"><a href="#如何帮助你" class="headerlink" title="如何帮助你"></a>如何帮助你</h1><p>你或许不认为上述的内容都很迷人，但是，当你在读这本书的时候，你有可能有问题需要解决，以及在好奇为什么这些很重要，为什么Go语言相比于其他热门的语言，在并发上这么多的不同？</p>
<p>就像我们在本章前面的“并发与并行的区别”中讨论的对并发问题进行建模一样。通常来说，一种语言会将它们的抽象链结束在系统线程和内存访问同步的层级。Go语言采用了一个不同的路线，并使用goroutine和channel来代替这些概念。</p>
<p>如果要画一个关于这两种并发代码的抽象画，我们很可能将goruntine类比成线程，把一个channel类比成一个mutex（这些原语只是有相似之处，但愿这些对比可以帮助你找对方向）。这些不同的抽象可以为我们做什么呢？</p>
<p>goroutine把我们从必须按照并行的方式思考中解放出来，作为替代，它允许我们按照更为自然的等级对问题进行建模。虽然我们已经复习了关于并发与并行的区别，而这些区别如何影响我们建模解决方案可能并不明确，让我们来开始一个示例。</p>
<p>比如说我需要构建一个端上请求字段的Web服务器。暂时先不用考虑架构，在一个仅提供线程抽象的语言中，很有可能思考下面的问题：</p>
<ul>
<li>我的语言原生支持线程么，还是我需要选择一个类库？</li>
<li>我的进程限制边界应该是什么？</li>
<li>线程在操作系统中有多重量级？</li>
<li>我的程序需要运行的操作系统处理这些线程的时候有什么不同？</li>
<li>我需要创建一个工作线程池来承载创建的线程，该如何找到最佳的线程池大小？</li>
</ul>
<p>这些都是需要考虑的很重要的事情，但是没有一个直接关系到你要解决的问题。你马上就被灌输如何解决并行问题的技术细节。</p>
<p>如果后退一步然后思考一下普通的问题，我们能做出如下陈述：独立的用户们链接到我的服务端并且打开一个会话。这个会话应该处理用户的请求并提供一个返回值。在Go语言中，可以立刻把这个问题的描述编写成代码我们需要为每一个接人的链接创建一个goroutine，在goroutine中处理请求（很有可能需要和其他的goroutine或者数据/服务进行交互），然后从goroutine的函数体中返回。我们对问题进行思考自然地直接映射为如何使用Go语言进行编码。</p>
<p>这是由一个Go语言给我们的保证所达成的：goroutine是很轻量级的，我们通常情况下并不需要为创建新的goroutine的代价而担心。会有合适的机会让你去思考系统中有多少运行中的goroutine，但是过早考虑的话，则是完完全全地过早优化。把这个和线程对比一下，你会发现提前考虑这些事情很明智。</p>
<p>某个语言有一个可以把并行抽象出来的框架，但并不意味着这种自然的方式对并发问题建模不重要！总有人必须去写这些框架，而你的代码就需要编写在开发者所构建的复杂的基础之上。复杂性在你编写代码的时候被隐藏了，并不意味着复杂性本身不存在，而复杂性正是滋生bug的温床。在Go语言下，这个语言就是围绕着并发进行设计的，所以说Go语言与它所提供的并发原语并无不一致的情况。这就意味着更少的阻力和更少的bug！</p>
<p>一个更加自然的对于问题空间的映射有非常巨大的好处，不仅如此，它还有一些其他的有益的副作用。Go语言的运行时自动地将goroutine映射到系统的线程上，并为我们管理它们之间的调度。这也就意味着对于运行时的优化可以在不改动我们如何对问题建模方式的情况下进行。随着并行技术的发展，Go语言的运行时也会改进，程序的性能也会进步，所有的这些都是自然而然的。留意Go语言的发布版本通知，然后你有时会看到像这样的事情：<br>在Go1.5中，goroutine的调度顺序发生了改变。<br>Go语言的开发者在幕后进行改进来使你的程序运行得更快。</p>
<p>并发与并行的解耦还有另一个好处：因为Go语言的运行时为你管理goroutine映射的调度，它可以在像goroutine阻塞等待I/0之类的事情上进行内省，从而智能地把OS的线程重新分配给没有被阻塞的goroutine。这也提高了你的代码性能。我们将在第6章讨论更多有关Go语言运行时的问题。</p>
<p>问题空间与Go语言代码之间的自然映射带来的另一个好处就是将问题空间建模为并发方式的数量增加了。因为我们作为开发者去解决问题，经常自然而然地按照并发的方式去处理。相比于我们可能使用的其他语言，在使用Go语言的时候我们会在更细的颗粒度级别编写并发代码。例如，如果回到网络服务器的例子上，现在在处理用户请求的时候都有一个独立的goroutine，而不是将链接绑定到一个线程池。更精细的粒度级别使我们的程序可以在运行到主机可能承载的并行数量的时候，可以动态地缩放，Amdahl法则的实践！这是非常惊人的。</p>
<p>goroutine仅仅是这个拼图的一部分。而其他来自CSP的概念，channel与select语句也增加了它的价值。</p>
<p>比如说，channel可以天然地和其他channel进行组合。这就使得编写大规模系统变得更加简单。因为你可以通过轻松地组合输出来协调多个子系统的输人。你可以将输入的channel与超时、取消或者消息组合到其他的子系统。而协调互斥体则是一个更加艰难的命题。</p>
<p>Go语言的select语句是对channel的一个补充，并且使多个通道组合的所有难点得以实现。select语句使你可以高效的等待事件，从一个竞争的channel中均匀、随机地选择一个消息，并在没有消息的时候继续等待等。</p>
<p>这个由CSP以及支撑运行时所启发的“漂亮挂毯”就是驱动Go语言的动力所在。我们将在这本书的剩余部分来探索这些东西是如何运转的，以及如何和为何使用它们来编写令人震惊的代码。</p>
<h1 id="Go语言的并发哲学"><a href="#Go语言的并发哲学" class="headerlink" title="Go语言的并发哲学"></a>Go语言的并发哲学</h1><p>CSP一直都是Go语言设计的重要组成部分。然而，Go语言还支持通过内存访问同步和遵循该技术的原语来编写并发代码的传统方式。sync与其他包中的结构体与方法可以让你执行锁，创建资源池取代goroutine等。</p>
<p>能够在CSP原语和内存访问同步之间选择对于你来说很棒，因为它让你去编写解决问题的并发代码上有了更多选择，但这可能显得有些莫名其妙。Go语言的初学者总是认为CSP样式编写并发代码是Go语言编写并发代码的唯一方式。比如说，在sync包的文档中，有如下描述：<br>sync包提供了基本的同步基元，如互斥锁。除了Once类型和WaitGroup类型，大部分都是适用低水平程序线程，高水平的同步使用channel通信更好一些。</p>
<p>在Go语言的FAQ中，有如下陈述：<br>为了尊重mutex，sync包实现了mutex，但是我们希望Go语言的编程风格将会激励人们尝试更高等级的技巧。尤其是考虑构建你的程序，以便一次只有一个goroutine负责某个特定的数据。</p>
<p>不要通过共享内存进行通信。相反，通过通信来共享内存。有数不清的关于Go语言核心团队的文章、讲座和访谈，相对于使用像sync.Mutex这样的原语，他们更加拥护CSP。</p>
<p>因此，Go语言团队为什么选择公开内存访问同步原语会感到困惑是完全可以理解的。更令人困惑的是，你通常会在外面看到出现的同步原语。见到人们抱怨过度使用channel，也会听到一些Go语言团队成员说使用它们是“OK”的。Go语言的维基上有一个关于此的引用：<br>Go语言的一个座右铭是，“使用通信来共享内存，而不是通过共享内存来通信。”</p>
<p>这就是说，Go语言确实在sync包中提供了传统的锁机制。大多数的锁问题都可以通过channel或者传统的锁两者之一来解决。</p>
<p>所以说，我该用哪个？<br>使用最好描述和最简单的那个方式<br>这是很好的建议，也是你在使用Go语言时经常看到的准则，但它有点含糊。我们如何理解什么更具表现力、更简单？我们应该使用什么标准？幸运的是，我们可以使用一些标准来帮助我们做正确的事情。正如我们将看到的那样，我们主要的区分方式来自于试图管理并发的地方，主观地想象一个狭窄的范围，或者在我们的系统外部。图2-1展示了这些用来创建决策树的准则。<br>这是一个对性能要求很高的临界区吗？<br>否<br>你想要转让数据的<br>所有权吗？<br>否<br>否<br>你是否试图在保护某个<br>结构的内部状态？<br>舌<br>你是否试图协调多个逻辑<br>片段？<br>使用传统的锁<br>使用channel<br>图2-1：决策树<br>让我们逐步来介绍这些决策：<br>你想要转让数据的所有权么？<br>如果你有一块产生计算结果并想共享这个结果给其他代码块的代码，你所实际做的事情是传递了数据的所有权。如果你对内存所有制且不支持<br>44|第2章</p>
<p>GC的语言很熟悉的话，对于这个概念你应该是很熟悉的：数据拥有所有者，并发程序安全就是保证同时只有一个并发上下文拥有数据的所有权。 channel通过将这个意图编写进channel类型本身来帮助我们表达这个意图。这么做的一个很大的好处就是可以创建一个带缓存的channel来实现一个低成本的在内存中的队列来解耦你的生产者与消费者，另一个好处就是通过使用channel确保你的并发代码可以和其他的并发代码进行组合。<br>你是否试图在保护某个结构的内部状态？<br>这时候内存访问同步原语的一个很好的选择，也是一个你不应该使用channel的很好的示例。通过使用内存访问同步原语，可以为你的调用者隐藏关于重要代码块的实现细节。这是一个线程安全类型的小例子，且不会给调用者带来复杂性：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Counter <span class="keyword">struct</span>&#123;</span><br><span class="line">mu sync.Mutex</span><br><span class="line">value <span class="keyword">int</span></span><br><span class="line">uc (e conter) Icement)o(</span><br><span class="line">c.mu.Lock()</span><br><span class="line"><span class="keyword">defer</span> c.mu.Unlock()</span><br><span class="line">c.value+</span><br></pre></td></tr></table></figure></p>
<p>如果你能回想起关于原子性的细节，可以说我们在这里所做的就是定义了Counter类型的原子性范围。调用增量可被认为是原子的。</p>
<p>记住这里的关键词是“内部的”。如果你发现自己正在将锁暴露在一个类型之外，这时候你应该注意了。试着将你的锁放在一个小的字典范围内。你是否试图协调多个逻辑片段？</p>
<p>请记住，channel本质上比内存访问同步原语更具可组合性。将锁分散在整个对象图中听起来像是一场噩梦，但是，将channe1编写的随处可见是被鼓励以及期待的！我可以组合channel，但是我不能轻易的组合锁或者有返回值的方法。</p>
<p>你会发现，因为Go语言的select语句，以及channel可以当作队列使用和被安全的随意传递。所以，当在使用channel的时候，你可以更简单的控制你软件中出现的激增的复杂性。如果你发现正在挣扎着理解你的并发</p>
<p>代码是如何工作的，为什么会出现死锁以及竞争，而你正在只用原语，这是一个你应该切换到channel的好示例。</p>
<p>这是一个对性能要求很高的临界区吗？</p>
<p>这绝对不意味着“我想让我的程序拥有高性能，因此，我应该只是用 mutex”。当然，如果你程序中的某部分，事实证明是一个主要的性能瓶颈，比程序的其他部分慢几个数量级，使用内存访问同步原语可能会帮助这个重要的部分在负载下执行。这是因为channel使用内存访问同步来操作，因此它们只能更慢。然而，在我们考虑这一点之前，性能至关重要的程序部分可能暗示着需要重新规划我们的程序。</p>
<p>希望这可以清楚地说明是否利用CSP风格的并发或内存访问同步。还有其他一些模式和做法在使用操作系统线程作为并发抽象方式的语言中很有用。在使用操作系统线程作为主要并发抽象的语言中还有其他的方式以及实践。比如说，像是线程池之类的东西经常出现。因为这些抽象大多数都是为了利用操作系统线程的优点与缺点。</p>
<p>Go语言的并发性哲学可以这样总结：追求简洁，尽量使用channel，并且认为goroutine的使用是没有成本的。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Go语言并发之道/" rel="tag"># Go语言并发之道</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/09/09/第1章-并发概述/" rel="next" title="第1章 并发概述">
                <i class="fa fa-chevron-left"></i> 第1章 并发概述
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/09/09/第3章-Go语言并发组件/" rel="prev" title="第3章 Go语言并发组件">
                第3章 Go语言并发组件 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="CheBin">
            
              <p class="site-author-name" itemprop="name">CheBin</p>
              <div class="site-description motion-element" itemprop="description">看视频才能学会，看文字学不会的</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">1017</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">72</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          


          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/2023/04/04/结束语｜秒杀系统之上的业务协同思考/" title="结束语｜秒杀系统之上的业务协同思考" target="_blank">结束语｜秒杀系统之上的业务协同思考</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/14｜百万级流量秒杀系统的关键总结/" title="14｜百万级流量秒杀系统的关键总结" target="_blank">14｜百万级流量秒杀系统的关键总结</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/13｜优化番外篇：Vertx介绍及快速入门/" title="13｜优化番外篇：Vertx介绍及快速入门" target="_blank">13｜优化番外篇：Vertx介绍及快速入门</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/12｜高性能优化：单机Java极致优化/" title="12｜高性能优化：单机Java极致优化" target="_blank">12｜高性能优化：单机Java极致优化</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/11｜高性能优化：物理机极致优化/" title="11｜高性能优化：物理机极致优化" target="_blank">11｜高性能优化：物理机极致优化</a>
                  </li>
                
              </ul>
            </div>
        

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#并发与并行的区别"><span class="nav-number">1.</span> <span class="nav-text">并发与并行的区别</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#什么是CSP"><span class="nav-number">2.</span> <span class="nav-text">什么是CSP</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#如何帮助你"><span class="nav-number">3.</span> <span class="nav-text">如何帮助你</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Go语言的并发哲学"><span class="nav-number">4.</span> <span class="nav-text">Go语言的并发哲学</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CheBin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">8.2m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">124:48</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
