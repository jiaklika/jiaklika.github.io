<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="思考并回答以下问题：">
<meta name="keywords" content="Go程序设计语言">
<meta property="og:type" content="article">
<meta property="og:title" content="第10章 包和go工具">
<meta property="og:url" content="http://yoursite.com/2021/09/14/第10章-包和go工具/index.html">
<meta property="og:site_name" content="车斌的技术博客">
<meta property="og:description" content="思考并回答以下问题：">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2022-01-20T09:39:29.713Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第10章 包和go工具">
<meta name="twitter:description" content="思考并回答以下问题：">






  <link rel="canonical" href="http://yoursite.com/2021/09/14/第10章-包和go工具/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>第10章 包和go工具 | 车斌的技术博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">车斌的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">放弃会成为一种习惯</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/14/第10章-包和go工具/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CheBin">
      <meta itemprop="description" content="看视频才能学会，看文字学不会的">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="车斌的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">第10章 包和go工具

              
            
          </h1>
        

        <div class="post-meta">

          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-09-14 10:50:58" itemprop="dateCreated datePublished" datetime="2021-09-14T10:50:58+08:00">2021-09-14</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2022-01-20 17:39:29" itemprop="dateModified" datetime="2022-01-20T17:39:29+08:00">2022-01-20</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Go/" itemprop="url" rel="index"><span itemprop="name">Go</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">15k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">14 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>思考并回答以下问题：</p>
<a id="more"></a>
<p>今天一个中等规模的程序可能包含10000个函数。但是作者只须思考它们其中的一部分，甚至不需要设计函数，因为绝大部分都是其他人来写的，然后通过包来复用。</p>
<p>Go自带100多个包，可以为大多数应用程序提供基础。Go社区是一个茁壮成长的生态环境，其中鼓励包设计、共享、重用以及改进，已经发布了很多的包，可以在<a href="https://godoc.org" target="_blank" rel="noopener">https://godoc.org</a>找到可以搜索的索引。本章展示如何使用已有的包和创建新包。</p>
<p>Go还有配套的go工具，一个复杂但是容易使用的命令行工具，用来管理Go包的工作空间。本书开篇展示了如何使用go工具来下载、构建、运行样例程序。本章讨论这个工具所隐含的概念，展示它更多的功能，其中包括输出文档和在包的工作空间中查询包的元数据。下一章探索它的测试特性。</p>
<h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a><span style="color:#339AFF;">引言</span></h1><p>任何包管理系统的目的都是通过对关联的特性进行分类，组织成便于理解和修改的单元，使其与程序的其他包保持独立，从而有助于设计和维护大型的程序。模块化允许包在不同的项目中共享、复用，在组织中发布，或者在全世界范围内使用。</p>
<p>每个包定义了一个不同的命名空间作为它的标识符。每个名字关联一个具体的包，它让我们在为类型、函数等选取短小而且清晰的名字的同时，不与程序的其他部分冲突。</p>
<p>包通过控制名字是否导出使其对包外可见来提供封装能力。限制包成员的可见性，从而隐藏API后面的辅助函数和类型，允许包的维护者修改包的实现而不影响包外部的代码。限制变量的可见性也可以隐藏变量，这样使用者仅可以通过导出函数来对其访问和更新，他们可以保留自己的不变量以及在并发程序中实现互斥的访问。</p>
<p>当我们修改一个文件时，我们必须重新编译文件所在的包和所有潜在依赖它的包。众所周知，Go程序的编译比其他语言要快，即便从零开始编译也如此。这里有三个主要原因。第一，所有的导入都必须在每一个源文件的开头进行显式列出，这样编译器在确定依赖性的时候就不需要读取和处理整个文件；第二，包的依赖性形成有向无环图，因为没有环，所以包可以独立甚至并行编译。第三，Go包编译输出的目标文件不仅记录它自己的导出信息，还记录它所依赖包的导出信息。当编译一个包时，编译器必须从每一个导入中读取一个目标文件，但是不会超出这些文件。</p>
<h1 id="导入路径"><a href="#导入路径" class="headerlink" title="导入路径"></a><span style="color:#339AFF;">导入路径</span></h1><p>每一个包都通过一个唯一的字符串进行标识，它称为导入路径，它们用在import声明中。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span>,</span><br><span class="line">    <span class="string">"math/rand"</span>,</span><br><span class="line">    <span class="string">"encoding/json"</span>,</span><br><span class="line">    <span class="string">"golang.org/x/net/html"</span>,</span><br><span class="line">    <span class="string">"github.com/go-sql-driver/mysql"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>如2.6.1节所述，Go语言的规范没有定义字符串的含义或如何确定一个包的导入路径，它通过工具来解决这些问题。本章详细讨论go工具如何理解它们，go工具也是Go程序员用来构建、测试程序的主要工具，尽管还有其他工具存在。例如，Go程序员使用Google内部的多语言构建系统，遵循不同的命名和包定位规则，具体化的测试案例等，这更加匹配那个系统的惯例。</p>
<p>对于准备共享或公开的包，导入路径需要全局唯一。为了避免冲突，除了标准库中的包之外，其他包的导入路径应该以互联网域名（组织机构拥有的域名或用于存放包的域名）作为路径开始，这样也方便查找包。例如上面例子导入Go团队维护的一个HTML解析器和一个流行的第三方MySQL数据库驱动程序。</p>
<h1 id="包的声明"><a href="#包的声明" class="headerlink" title="包的声明"></a><span style="color:#339AFF;">包的声明</span></h1><p>在每一个Go源文件的开头都需要进行包声明。主要的目的是当该包被其他包引入的时候作为其默认的标识符（称为包名）。</p>
<p>例如，<code>math/rand</code>包中每一个文件的开头都是<code>package rand</code>，这样当你导入这个包时，可以访问它的成员，比如<code>rand.Int</code>、<code>rand.Float64</code>等。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span>(</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"math/rand"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    fmt.Println(rand.Int())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通常，包名是导入路径的最后一段，于是，即使导入路径不同的两个包，二者也可以拥有同样的名字。例如，两个包的导入路径分别是<code>math/rand</code>和<code>crypto/rand</code>，而包的名字都是rand。我们将看到如何在同一个程序中同时使用它们。</p>
<p>关于“最后一段”的惯例，这个有三个例外。第一个例外是：不管包的导入路径是什么，如果该包定义一条命令（可执行的Go程序），那么它总是使用名称main。这是告诉<code>go build</code>（见10.7.3节）的信号，它必须调用连接器生成可执行文件。</p>
<p>第二个例外是：目录中可能有一些文件名字以<code>_test.go</code>结尾，包名中会出现以<code>_test</code>结尾。这样一个目录中有两个包：一个普通的，加上一个外部测试包。<code>_test</code>后缀告诉<code>go test</code>两个包都需要构建，并且指明文件属于哪个包。外部测试包用来避免测试所依赖的导入图中的循环依赖。11.2.4节会进行更细致的讲述。</p>
<p>第三个例外是：有一些依赖管理工具会在包导入路径的尾部追加版本号后缀，如“gopkg.in/yaml.v2”。包名不包含后缀，因此这个情况下包名为yaml。</p>
<h1 id="导入声明"><a href="#导入声明" class="headerlink" title="导入声明"></a><span style="color:#339AFF;">导入声明</span></h1><p>一个Go源文件可以在package声明的后面和第一个非导入声明语句前面紧接着包含零个或多个import声明。每一个导入可以单独指定一条导入路径，也可以通过圆括号括起来的列表一次导入多个包。下面两种形式是等价的，但第二种形式更常见。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"os"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>导入的包可以通过空行进行分组；这类分组通常表示不同领域和方面的包。导入顺序不重要，但按照惯例每一组都按照字母进行排序。（gofmt和goimports工具都会自动进行分组并排序。）<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"html/template"</span></span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line">    <span class="string">"golang.org/x/net/html"</span></span><br><span class="line">    <span class="string">"golang.org/x/net/ipv4"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>如果需要把两个名字一样的包（如<code>math/rand</code>和<code>crypto/rand</code>）导入到第三个包中，导入声明就必须至少为其中的一个指定一个替代名字来避免冲突。这叫作重命名导入。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>(</span><br><span class="line">    <span class="string">"crypto/rand"</span></span><br><span class="line">    mrand <span class="string">"math/rand"</span> <span class="comment">// 通过指定一个不同的名称mrand就避免了冲突</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>替代名字仅影响当前文件。其他文件（即便是同一个包中的文件）可以使用默认名字来导入包，或者一个替代名字也可以。</p>
<p>重命名导入在没有冲突时也是非常有用的。如果有时用到自动生成的代码，导入的包名字非常冗长，使用一个替代名字可能更方便。同样的缩写名字要一直用下去，以避免产生混淆。使用一个替代名字有助于规避常见的局部变量冲突。例如，如果一个文件可以包含许多以path命名的变量，我们就可以使用pathpkg这个名字导入一个标准的“path”包。</p>
<p>每个导入声明从当前包向导入的包建立一个依赖。如果这些依赖形成一个循环，<code>go build</code>工具会报错。</p>
<h1 id="空导入"><a href="#空导入" class="headerlink" title="空导入"></a><span style="color:#339AFF;">空导入</span></h1><p>如果导入的包的名字没有在文件中引用，就会产生一个编译错误。但是，有时候，我们必须导入一个包，这仅仅是为了利用其副作用：对包级别的变量执行初始化表达式求值，并执行它的init函数（见2.6.2节）。为了防止“未使用的导入”错误，我们必须使用一个重命名导入，它使用一个替代的名字<code>_</code>，这表示导入的内容为空白标识符。通常情况下，空白标识不可能被引用。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="string">"image/png"</span> <span class="comment">// 注册PNG解码器</span></span><br></pre></td></tr></table></figure></p>
<p>这称为空白导入。多数情况下，它用来实现一个编译时的机制，使用空白引用导入额外的包，来开启主程序中可选的特性。首先我们来看如何使用它，然后看它是如何工作的。</p>
<p>标准库的image包导出了Decode函数，它从io.Reader读取数据，并且识别使用哪一种图像格式来编码数据，调用适当的解码器，返回<code>image.Image</code>对象作为结果。使用<code>image.Decode</code>可以构建一个简单的图像转换器，读取某一种格式的图像，然后输出为另外一个格式：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gopl.io/ch10/jpeg</span></span><br><span class="line"><span class="comment">// jpeg命令从标准输入读取PNG图像</span></span><br><span class="line"><span class="comment">// 并把它作为JPEG图像写到标准输出</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"image"</span></span><br><span class="line">    <span class="string">"image/jpeg"</span></span><br><span class="line">    _ <span class="string">"image/png"</span> <span class="comment">// 注册PNG解码器</span></span><br><span class="line">    <span class="string">"io"</span></span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := toJPEG(os.Stdin, os.Stdout); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Fprintf(os.Stderr, <span class="string">"jpeg: %v\n"</span>, err)</span><br><span class="line">        os.Exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">toJPEG</span><span class="params">(in io.Reader, out io.Writer)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    img, kind, err := image.Decode(in)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Fprintln(os.Stderr, <span class="string">"Input format ="</span>, kind)</span><br><span class="line">    <span class="keyword">return</span> jpeg.Encode(out, img, &amp;jpeg.Options&#123;Quality: <span class="number">95</span>&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果将gopl.io/ch3/mandelbrot（参考3.3节）的输出作为这个转换程序的输入，它检测PNG个数的输入，然后输出JPEG格式的图3-3。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ go build gopl.io/ch3/mandelbrot</span><br><span class="line">$ go build gopl.io/ch10/jpeg</span><br><span class="line">$ ./mandelbrot | ./jpeg &gt;mandelbrot.jpg</span><br><span class="line">Input format = png</span><br></pre></td></tr></table></figure></p>
<p>注意空白导入<code>image/png</code>。没有这一行，程序可以正常编译和链接，但是不能识别和解码PNG格式的输入：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ go build gopl.io/ch10/jpeg</span><br><span class="line">$ ./mandelbrot | ./jpeg &gt;mandelbrot.jpg</span><br><span class="line">jpeg: image: unknown format</span><br></pre></td></tr></table></figure></p>
<p>这里解释它是如何工作的。标准库提供GIF、PNG、JPEG等格式的解码库，用户自己可以提供其他格式的，但是为了使可执行程序简短，除非明确需要，否则解码器不会被包含进应用程序。image.Decode函数查阅一个关于支持格式的表格。每一个表项由4个部分组成：格式的名字；某种格式中所使用的相同的前缀字符串，用来识别编码格式；一个用来解码被编码图像的函数Decode；以及另一个函数DecodeConfig，它仅仅解码图像的元数据，比如尺寸和色域。对于每一种格式，通常通过在其支持的包的初始化函数中来调用image.RegisterFormat来向表格添加项，例如image/png中的实现如下：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>这个效果就是，一个应用只需要空白导入格式化所需的包，就可以让image.Decode函数具备应对格式的解码能力。</p>
<p>database/sql包使用类似的机制让用户按需加人想要的数据库驱动程序。例如：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>(</span><br><span class="line"><span class="string">"database/sql"</span></span><br><span class="line"><span class="string">"github.com/lib/pq"</span></span><br><span class="line"><span class="comment">//添加Postgres支持</span></span><br><span class="line">_<span class="string">"github.com/go-sql-driver/mysql"</span><span class="comment">//添加MySQL支持</span></span><br><span class="line">)</span><br><span class="line">db, err = sq1.open(<span class="string">"postgres"</span>, dbname) <span class="comment">// oK</span></span><br><span class="line">db, err = sql.open(<span class="string">"mysql"</span>, dbname) <span class="comment">// OK</span></span><br><span class="line">db，err = sql.open（<span class="string">"sqlite3"</span>，dbname）<span class="comment">//返回错误消息：unknown driver "sqlite3"</span></span><br></pre></td></tr></table></figure></p>
<p>练习10.1：扩展jpeg程序，使其可以把任意支持的输入格式转换为任意输出格式，使用image.Decode来检测输入格式，并且添加一个标记来选择输出格式。</p>
<p>练习10.2：定义一个通用的归档文件读取函数，它可以读取ZIP（archive/zip）文件和POSIX tar （archive/tar）文件。使用一个类似前面描述的注册机制，使用空白导入以插件方式支持各种文件格式。</p>
<h1 id="包及其命名"><a href="#包及其命名" class="headerlink" title="包及其命名"></a>包及其命名</h1><p>本节将提供一些建议，指出如何遵从Go的习惯来给包和它的成员进行命名。</p>
<p>当创建一个包时，使用简短的名字，但是不要短到像加了密一样。在标准库中最常用的包包括：bufio、 bytes、flag、fmt、http、io、json、os、sort、sync和time等。<br>尽可能保持可读性和无歧义。例如，不要把一个辅助工具包命名为util，使用imageutil或ioutil等名称更具体和清晰。避免选择经常用于相关的局部变量的包名，或者迫使使用者使用重命名导入，例如使用以path命名的包。</p>
<p>包名通常使用统一的形式。标准包bytes、errors和strings使用复数来避免覆盖响应的预声明类型，使用go/types这个形式，来避免和关键字的冲突。</p>
<p>避免使用有其他含义的包名。例如，我们一开始在2.5节中使用temp作为温度转换包的名字，但是它没有继续这么用。这是一个非常糟糕的主意，因为“temp”大多数情况下代表“temporary”（临时性的）。我们在一小段时间里面使用temperature作为包名，但是它太长了，并且不能说明它究竟可以做什么。最后，它变成了tempconv，它更短并且和strconv等类似。</p>
<p>现在讨论包成员的命名。因为对其他包成员的每一个引用使用一个具体的标识符，例如fmt.Println，描述包的成员和描述包名与成员名同样繁杂。我们不需要在Println中引用格式化的概念，因为包名fmt还没有准备好。当设计一个包时，要考虑两个有意义的部分如何一起工作，而不只是成员名。这里有一些具体的例子：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bytes.Equal</span><br><span class="line">flag.Int</span><br><span class="line">http.Get</span><br><span class="line">json.Marshal</span><br></pre></td></tr></table></figure></p>
<p>我们可以识别出一些通用的命名模式。strings包提供一系列操作字符串的独立函数：</p>
<p>string这个词不会出现在任何名字中。客户通过strings.Index、strings.Replacer等引用它们。<br>其他的一些包可以描述为单一类型包，例如html/template和math/rand，这些包导出一个数据类型及其方法，通常有一个New函数用来创建实例。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> rand II <span class="string">"math/rand"</span></span><br><span class="line"><span class="keyword">type</span> Rand <span class="keyword">struct</span>&#123;/\*...\*/&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(source Source)</span>\*<span class="title">Rand</span></span></span><br></pre></td></tr></table></figure></p>
<p>这可能造成重复，例如在template.Template或rand.Rand中，这也是为什么这类包名通常都比较短。</p>
<p>在其他极端情况下，像net/http这样的包有很多的名字，但是没有很多的结构，因为它们执行复杂的任务。尽管有超过20种类型和更多的函数，但是包中最重要的成员使用最简单的命名：Get、Post、Handle、Error、Client、Server。</p>
<h1 id="go工具"><a href="#go工具" class="headerlink" title="go工具"></a>go工具</h1><p>下面的章节主要讨论go工具（gotool），它用来下载、查询、格式化、构建、测试以及安装Go代码包。</p>
<p>go工具将不同种类的工具集合并为一个命名集。它是一个包管理器（类似于apt或rpm），它可以查询包的作者，计算它们的依赖关系，从远程版本控制系统下载它们。它是一个构建系统，可计算文件依赖，调用编译器、汇编器和链接器，尽管它没有标准的UNIXmake命令完备。它还是一个测试驱动程序，第11章将介绍它。</p>
<p>它的命令行接口使用“瑞士军刀”风格，有十几个子命令，其中有一些我们已经见过，例如get、run、build和fmt。可以运行gohelp来查看内置文档的索引。仅仅为了引用，我们已经列出了最常用的命令：</p>
<p>为了让配置操作最小化，go工具非常依赖惯例。例如，给定一个Go源文件，该工具可以找到它所在的包，因为每一个目录包含一个包，并且包的导入路径对应于工作空间的目录结构。给定一个包的导入路径，该工具可以找到存放目标文件的对应目录。它也可以找到存储源代码仓库的服务器的URL。</p>
<h2 id="工作空间的组织"><a href="#工作空间的组织" class="headerlink" title="工作空间的组织"></a>工作空间的组织</h2><p>大部分用户必须进行的唯一的配置是GOPATH环境变量，它指定工作空间的根。当需要切换到不同的工作空间时，更新GOPATH变量的值即可。例如，当写这本书的时候，我们设置GOPATH为$HOME/gobook：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> GOPATH=<span class="variable">$HOME</span>/gobook</span><br><span class="line">$ go get gopl.io/.</span><br></pre></td></tr></table></figure></p>
<p>在你使用上面的命令下载了本书所有的程序之后，你的工作空间将包含如下一个层次结构：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GOPATH/</span><br><span class="line">src/</span><br><span class="line">gopl.io/</span><br><span class="line">.git/</span><br><span class="line">ch1/</span><br><span class="line">helloworld/</span><br><span class="line">main.go dup/</span><br><span class="line">main.go</span><br><span class="line">golang.org/x/net/ .git/</span><br><span class="line">html/</span><br><span class="line">parse.go node.go</span><br><span class="line">bin/</span><br><span class="line">helloworld dup</span><br><span class="line">pkg/</span><br><span class="line">darwin amd64/</span><br></pre></td></tr></table></figure></p>
<p>GOPATH有三个子目录。src子目录包含源文件。每一个包放在一个目录中，该目录相对于$GOPATH/src的名字是包的导入路径，如gopl.io/ch1/helloworld。注意，一个GOPATH工作空间在src下包含多个源代码版本控制仓库，例如gopl.io或golang.org。pkg子目录是构建工具存储编译后的包的位置，bin子目录放置像helloworld这样的可执行程序。</p>
<p>第二个环境变量是GOROOT，它指定Go发行版的根目录，其中提供所有标准库的包。GOROOT下面的目录结构类似于GOPATH，这样fmt包的源代码放在$G0R00T/src/fmt目录中。用户无须设置GOROOT，因为默认情况下go工具使用它的安装路径。</p>
<p>goenv命令输出与工具链相关的已经设置有效值的环境变量及其所设置值，还会输出未设置有效值的环境变量及其默认值。G00s指定目标操作系统（例如，android、linux、darwin或者windows），GOARCH指定目标处理器架构，比如amd64、386或arm。尽管GOPATH是为一个必须设置的变量，但是其他的变量也会偶尔在我们的解释中出现。</p>
<h2 id="包的下载"><a href="#包的下载" class="headerlink" title="包的下载"></a>包的下载</h2><p>如果使用go工具，包的导入路径不仅指示了如何在本地工作空间中找到它的位置，还指明了通过互联网使用goget来获取和更新它的位置。</p>
<p>go get命令可以下载单一的包，也可以使用…符号来下载子树或仓库，像前一节提到的那样。该工具也计算并下载初始包所有的依赖性，这也是为什么前一个例子中golang.org/x/net/html包会出现在工作空间中。</p>
<p>在goget完成包的下载之后，它会构建它们，然后安装库和相应的命令。这些内容会在下一节详细讨论，一个例子将展示整个流程是如何进行的。下面的第一条命令获取golint工具，它用来检查Go源码中的风格问题。第二条命令执行golint来检查2.6.2节中的gopl.io/ch2/popcount代码。它会报告我们忘了给这个包写文档注释：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ go get github.com/golang/lint/golint</span><br><span class="line">$ <span class="variable">$G0PATH</span>/bin/golint<span class="string">'gopl.io/ch2/popcount</span></span><br><span class="line"><span class="string">src/gopl.io/ch2/popcount/main.go:1:1</span></span><br><span class="line"><span class="string">package comment should be of the form "Package popcount</span></span><br></pre></td></tr></table></figure></p>
<p>goget命令已经支持多个流行的代码托管站点，如GitHub、Bitbucket和Launchpad，并且可以向版本控制系统发出合适的请求。对于不知名的网站，你也许需要指出导入路径使用的是哪种版本控制协议，比如Git或Mercurial。执行go help importpath来获取更多细节。</p>
<p>goget创建的目录是远程仓库的真实客户端，而不仅仅是文件的副本，这样可以使用版本控制命令来查看本地编辑的差异或者更新到不同的版本。例如，golang.org/x/net目录是一个Git客户端：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span><span class="variable">$G0PATH</span>/src/golang.org/x/net</span><br><span class="line">$ git remote -v</span><br><span class="line">originhttps://go.googlesource.com/net(fetch)</span><br><span class="line">originhttps://go.googlesource.com/net(push)</span><br></pre></td></tr></table></figure></p>
<p>注意，包导入路径中明显的域名（golang.org）不同于Git服务器的实际域名 （go.googlesource.com）。这是go工具的一个特性，如果位置由诸如googlesource.com或github. com之类通用服务托管，包可以在其导入路径中使用自定义域名。在<a href="https://golang.org/x/" target="_blank" rel="noopener">https://golang.org/x/</a> net/htm1下面的HTML网页包含如下元数据，它重定向go工具到实际托管地址的Git仓库：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ go build gopl.io/ch1/fetch</span><br><span class="line">$./fetchhttps://golang.org/x/net/htmlIgrepgo-import</span><br><span class="line">&lt;meta name=<span class="string">"go-import'</span></span><br><span class="line"><span class="string">content="</span>golang.org/x/netgithttps://go.googlesource.com/net<span class="string">"&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>如果你指定-u开关，goget将确保它访问的所有包（包括它们的依赖性）更新到最新版本，然后再构建和按照。如果没有这个标记，已经存在于本地的包不会更新。</p>
<p>goget-u命令通常获取每个包的最新版本，它在你刚刚开始的时候很方便；但是在需要部署的项目中（其中，发布版本需要精准的版本控制），就不太适合使用它。通常的解决方案是加一层vendor目录，构建一个关于所有必需依赖的本地副本，然后非常小心地更新这个副本。在Go1.5之前，这需要改变包的导入路径，这样golang.org/x/net/html的副本会变成gopl.io/vendor/golang.org/x/net/html。几乎所有最近版本的go工具都支持加vendor目录，但这里不允许我们展开所有的细节了。请使用go help gopath来查看vendor目录的详细信息。</p>
<p>练习10.3:使用fetch<a href="http://gopl.io/ch1/helloworld?go-get=1" target="_blank" rel="noopener">http://gopl.io/ch1/helloworld?go-get=1</a>，找到本书的示例代码是由那个服务托管的（goget发出的HTTP请求包含go-get参数，这样服务器可以区分出普通的浏览器请求。）</p>
<h2 id="包的构建"><a href="#包的构建" class="headerlink" title="包的构建"></a>包的构建</h2><p>go build命令编译每一个命令行参数中的包。如果包是一个库，结果会被舍弃对于没有编译错误的包几乎不做检查。如果包的名字是main，go build调用链接器在当前目录中创建可执行程序，可执行程序的名字取自包的导入路径的最后一段。</p>
<p>每一个目录包含一个包，每一个可执行程序或者UNIX命令都需要自己的目录。这些目录可能是cmd目录的子目录，比如golang.org/x/tools/cmd/godoc命令，为Go包的文档提供Web访问接口（参考10.7.4节）。</p>
<p>如前所述，包可以指定通过目录来指定，可以使用导入路径或者一个相对目录名，目录必须以.或.开头，即使这不经常需要。如果没有提供参数，会使用当前目录作为参数。所以，以下命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/gopl.io/ch1/helloworld</span><br><span class="line">$ go build</span><br></pre></td></tr></table></figure></p>
<p>和以下命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> anywhere</span><br><span class="line">$ go build gopl.io/ch1/helloworld</span><br></pre></td></tr></table></figure></p>
<p>以及以下命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="variable">$GOPATH</span></span><br><span class="line">$ go build ./src/gopl.io/ch1/helloworld</span><br></pre></td></tr></table></figure></p>
<p>构建同样的包（尽管每次写人的目录是gobuild命令运行时所在的目录）。但以下命令编译不同的包：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="variable">$GOPATH</span></span><br><span class="line">$ go build src/gopl.io/ch1/helloworld</span><br><span class="line">Error: cannot find package <span class="string">"src/gopl.io/ch1/helloworld"</span>.</span><br></pre></td></tr></table></figure></p>
<p>包也可以使用一个文件列表来指定（尽管这只是针对小型的程序和一次性的实验）。如果包名是main，可执行程序的名字来自第一个.go文件名的主体部分。</p>
<p>特别是对于这类即用即抛型的程序，我们需要在构建之后尽快运行。gorun命令将这两步合并起来：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go run quoteargs.go one <span class="string">"two three"</span> four\ five</span><br><span class="line">[<span class="string">"one"</span> , <span class="string">"two three"</span> <span class="string">"four five"</span>]</span><br></pre></td></tr></table></figure></p>
<p>第一个不是以.go文件结尾的参数会作为Go可执行程序的参数列表的开始。</p>
<p>默认情况下，go build命令构建所有需要的包以及它们所有的依赖性，然后丢弃除了最终可执行程序之外的所有编译后的代码。依赖性分析和编译本身都非常快，但是当项目增长到数十个包和数十万行代码的时候，重新编译依赖性的时间明显变慢，也许数秒钟的时间，即使依赖的部分根本没有改变过。</p>
<p>go install命令和gobuild非常相似，区别是它会保存每一个包的编译代码和命令，而不是把它们丢弃。编译后的包保存在$GOPATH/pkg目录中，它对应于存放源文件的src目录，可执行的命令保存在$GOPATH/bin目录中。（许多用户将$GOPATH/bin加人他们的可执行搜索路径中。）这样，gobuild和go install对于没有改变的包和命令不需要重新编译，从而使后续的构建更加快速。惯例上，gobuild-i可以将包安装在独立于构建目标的地方。</p>
<p>因为编译包根据操作系统平台和CPU体系结构不同而不同，所以go instal1将保存它们的目录命名为与G00S和GOARCH变量的值相关。例如，在Mac上面golang.org/x/net/html编译后的文件golang.org/x/net/html.a放在$GOPATH/pkg/darwin_amd64目录下面。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gop1.io/ch10/cross</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">fmt.<span class="built_in">println</span>(runtime.Goos,runtime.GOARCH)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面的命令分别生成64位和32位的可执行程序：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ go build gopl.io/ch1e/cross</span><br><span class="line">$ ./cross</span><br><span class="line">darwin amd64</span><br><span class="line">$ G0ARCH=386 go build gopl.io/ch10/cross</span><br><span class="line">$ ./cross</span><br><span class="line">darwin 386</span><br></pre></td></tr></table></figure></p>
<p>例如，为了处理底层的可移植性问题或为重要的例程提供优化版本，有一些包需要为特定的平台或者处理器编译不同版本的代码。如果一个文件名包含操作系统或处理器体系结构名字 （如net_linux.go或asm_amd64.s），go工具只会在构建指定规格的目标文件的时候才进行编译。 叫作构建标签的特殊注释，提供更细粒度的控制。例如，如果一个文件包含下面的注释：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// +build linux darwin</span><br></pre></td></tr></table></figure></p>
<p>注释在包的声明之前（它是文档注释），gobuild只会在构建Linux或MacOSX系统应用的时候才会对它进行编译，下面的注释指出任何时候都不要编译这个文件：</p>
<p>更多的细节可以在go/build包的文档中的Build Constraints节找到：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ go doc go/build</span><br></pre></td></tr></table></figure></p>
<h2 id="包的文档化"><a href="#包的文档化" class="headerlink" title="包的文档化"></a>包的文档化</h2><p>Go风格强烈鼓励有良好的包API文档。每一个导出的包成员的声明以及包声明自身应该立刻使用注释来描述它的目的和用途。</p>
<p>Go文档注释总是完整的语句，使用声明的包名作为开头的第一句注释通常是总结。函数参数和其他的标识符无须括起来或者特别标注。例如，fmt.Fprintf的文档注释如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//Fprintf根据格式说明符格式化并写入w</span><br><span class="line">//返回写入的字节数及可能遇到的错误</span><br><span class="line">func Fprintf(w io.Writer, format string, a ...interface&#123;&#125;)(int, error)</span><br></pre></td></tr></table></figure></p>
<p>Fprintf的格式化细节在fmt包自身的文档注释中进行解释。包声明的前面的文档注释被认为是整个包的文档注释。尽管它可以出现在任何文件中，但是必须只有一个。比较长的包注释可以使用一个单独的注释文件，fmt的注释超过300行，文件名通常叫doc.go</p>
<p>好的文档不一定是洋洋洒洒的，而简明是文档一个不可替代的优点。事实上，Go在文档保持简练和简单方面的惯例和其他所有的东西一样，因为文档像代码一样也需要维护。许多声明可以在一个通顺的句子中解释清楚，并且如果这个行为非常明确，就不需要注释。</p>
<p>在全书中篇幅允许时，就会使用doc注释来进行前置声明，但是在你浏览标准库时你会发现更好的示例。如果你想这样做，有两个工具可以给你提供更多方便。</p>
<p>go doc工具输出在命令行上指定的内容的声明和整个文档注释，这也许是一个包<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> s <span class="keyword">go</span> doc tim</span><br><span class="line"><span class="keyword">package</span> time/导入<span class="string">"time</span></span><br><span class="line"><span class="string">Package time provides functionality for measuring and displaying time const Nanosecond Duration =1 func After(d Duration)&lt;-chan Time func Sleep(d Duration) func Since(t Time ) Duration func Now() Time type Duration int64 type Time struct</span></span><br></pre></td></tr></table></figure></p>
<p>更多<br>或者是一个包成员<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s <span class="keyword">go</span> doc time. Since</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Since</span><span class="params">(t Time)</span> <span class="title">Duration</span></span></span><br><span class="line"><span class="function"><span class="title">Since</span> <span class="title">returns</span> <span class="title">the</span> <span class="title">time</span> <span class="title">elapsed</span> <span class="title">since</span> <span class="title">t</span></span></span><br><span class="line"><span class="function"><span class="title">It</span> <span class="title">is</span> <span class="title">shorthand</span> <span class="title">for</span> <span class="title">time</span>. <span class="title">Now</span><span class="params">()</span>.<span class="title">Sub</span><span class="params">(t)</span></span></span><br></pre></td></tr></table></figure></p>
<p>或者是一个方法：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s <span class="keyword">go</span> doc time Duration. Seconds <span class="function"><span class="keyword">func</span> <span class="params">(d Duration )</span><span class="title">Seconds</span><span class="params">()</span> <span class="title">float64</span></span></span><br><span class="line"><span class="function"><span class="title">Seconds</span> <span class="title">returns</span> <span class="title">the</span> <span class="title">duration</span> <span class="title">as</span> <span class="title">a</span> <span class="title">floating</span>-<span class="title">point</span> <span class="title">number</span> <span class="title">of</span> <span class="title">seconds</span></span></span><br></pre></td></tr></table></figure></p>
<p>该工具不需要完整的导人路径或者正确的标识符。这个命令输出来自 encoding/json包的<code>（*json. Decoder）. Decode</code>的文档：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s <span class="keyword">go</span> doc json. decode</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dec *Decoder )</span><span class="title">Decode</span><span class="params">(v interfacet)</span>) <span class="title">error</span></span></span><br><span class="line"><span class="function"><span class="title">Decode</span> <span class="title">reads</span> <span class="title">the</span> <span class="title">next</span> <span class="title">Json</span>-<span class="title">encoded</span> <span class="title">value</span> <span class="title">from</span> <span class="title">its</span> <span class="title">input</span> <span class="title">and</span> <span class="title">stores</span> <span class="title">it</span> <span class="title">in</span> <span class="title">the</span> <span class="title">value</span> <span class="title">pointed</span> <span class="title">to</span> <span class="title">b</span></span></span><br></pre></td></tr></table></figure></p>
<p>有点迷惑的是，第二个工具名字叫 godot，它提供相互链接的HTML页面服务，进而提供不少于 go doc命令的信息。在 https / / golang . org / pkg的 godot服务器覆盖了标准库。图10-1展示了tine包的文档，在11.6节中，我们将看到 godot中交互式显示的程序示例。在 https / / godoc . org的 godot服务器提供数千个可索的开源包索引。</p>
<p>图10-1 godot中的time包<br>如果你想浏览你自己的包，你也可以在你的工作空间中运行一个 godot实例。在执行下面的命令后,在浏览器中访问<a href="http://localhost:8000/pkg" target="_blank" rel="noopener">http://localhost:8000/pkg</a><br>s godoc-http: 8 0 0 0<br>加上- analysistype和- analysis= pointer标记使文档内容丰富，同时提供源代码的高级静态分析结果。<br>10.7.5内部包<br>这是包用来封装Go程序最重要的机制。没有导出的标识符只能在同一个包内访问，导出的标识符可以在世界任何地方访问。<br>有时，有一个中间地带是很有帮助的，这种方式定义标识符可以被一个小的可信任的包集合访问，但不是所有人可以访问。例如，当我们将一个大包分解为多个可托管的小包时，我们不想对其他的包显露这些包之间的关系。或者我们想在不进行导出的情况下，在项目的<br>一些包中间共享一些工具函数。或者我们只是想试验一个新的包，而不是永久地提交给它的</p>
<p>API，可以通过加上一个允许访问的有限客户列表来实现。<br>为了解决这些需求， go build工具会特殊对待导入路径中包含路径片段 internal的情况。这些包叫内部包。内部包只能被另一个包导入，这个包位于以 internal目录的父目录为根目录的树中。例如，给定下面的包 net/http/internal/chunked可以从 net/http/httputil或 net/http导入，但是不能从 net/url进行导入。然而 net/url可以导入 net/http/httputil<br>net/http<br>net/http/internal/chunked let/http/httputil<br>net/url<br>10.7.6包的查询<br>go1ist工具上报可用包的信息。通过最简单的形式，go1ist判断一个包是否存在于工作空间中，如果存在输出它的导路径<br>s go list github. com/go-sq1-driver/mysql github. com/go-sql-driver/mysql<br>go1ist命令的参数可以包含“，”通配符，它用来匹配包的导入路径中的任意子串。可以使用它枚举一个Go工作空间中的所有包：<br>s go list . archive/t<br>archive/zip<br>bufo<br>bytes<br>cmd/addr2line<br>cmd/api<br>更多其他的包，，，<br>或者一个指定的子树中的所有包 s go list gopl. io/ch3, gop. io/ch3/basenamel</p>
<ol>
<li>io/ch3/basename2 1o/ch3/ comma gopl. io/ch3/mandelbrot gop. io/ch3/netflag gop. io/ch3/printint gopl. io/ch3/surface或者一个具体的主题 s go list..xml. encoding/xml<br>gopl. io/ch7/xmiselect<br>go1ist命令获取每一个包的完整元数据，而不仅仅是导路径，并且提供各种对于用户或者其他工具可访问的格式。-json标记使go1ist以JSON格式输出每一个包的完整记录：<br>s go list -json hash<br>Dir”: /home/gopher/go/src/hash”,<br>Importpath”: “ hash<br>hash<br>Package hash provides interfaces for hash functions t”: “/home/gopher/go/pkg/darwin amd64/hash. a”,</li>
</ol>
<p>Goroot: true<br>Standard”: true<br>Root”: /home/gopher/go<br>Gofiles”:<br>hash. go<br>Imports”:<br>errors<br>io”,<br>runtime<br>sync<br>sync/atomic”,<br>unsafe<br>标记可以让用户通过text template包提供的模板语言来定制输出格式（参考4.6节）。这个命令输出 strconv包的依赖过渡关系记录，记录之间由空格分割 s go list-f((Join.Deps”))’ strconv errors math runtime unicode/utf8 unsafe<br>这条命令输出标准库的 compress子树中每个包的直接导入记录 s go list-f((. Importpath))-&gt; ((join.Imports””)compress/ compress/bzip2 -&gt; bufo io sort<br>compress/flate -&gt; bufo fmt io math sort strcon<br>compress/gzip - bufo compress/flate errors fmt hash hash/crc32 io time compress/lzw-&gt; bufo errors fmt io<br>compress/zlib -&gt; bufo compress/flate errors fmt hash hash/adler32 io<br>go1ist对于一次性的交互询和构建、测试脚本都非常有用。我们将在11.2.4节再次使用它。更多的参数以及它们的含义等信息，可以通过执行 go help1ist来获取。<br>本章讨论了go工具中几乎所有重要的子命令（除了一个子命令外）。下一章讲述如何使用 go test命令测试Go程序。<br>练习10.4：构建一个工具，它可以汇报工作空间中所有包的过度依赖中，是否含有参数中指定的包。提示：你将需要执行两次go1ist，一次是针对初始包，一次是针对所有包。你也许想使用 encoding/json包（参考4.5节）来解析它的JSON格式输出内容。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Go程序设计语言/" rel="tag"># Go程序设计语言</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/09/14/第9章-使用共享变量实现并发/" rel="next" title="第9章 使用共享变量实现并发">
                <i class="fa fa-chevron-left"></i> 第9章 使用共享变量实现并发
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/09/14/第11章-测试/" rel="prev" title="第11章 测试">
                第11章 测试 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="CheBin">
            
              <p class="site-author-name" itemprop="name">CheBin</p>
              <div class="site-description motion-element" itemprop="description">看视频才能学会，看文字学不会的</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">1017</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">72</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          


          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <!-- modify icon to fire by szw -->
                <i class="fa fa-history fa-" aria-hidden="true"></i>
                近期文章
              </div>
              <ul class="links-of-blogroll-list">
                
                
                  <li>
                    <a href="/2023/04/04/结束语｜秒杀系统之上的业务协同思考/" title="结束语｜秒杀系统之上的业务协同思考" target="_blank">结束语｜秒杀系统之上的业务协同思考</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/14｜百万级流量秒杀系统的关键总结/" title="14｜百万级流量秒杀系统的关键总结" target="_blank">14｜百万级流量秒杀系统的关键总结</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/13｜优化番外篇：Vertx介绍及快速入门/" title="13｜优化番外篇：Vertx介绍及快速入门" target="_blank">13｜优化番外篇：Vertx介绍及快速入门</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/12｜高性能优化：单机Java极致优化/" title="12｜高性能优化：单机Java极致优化" target="_blank">12｜高性能优化：单机Java极致优化</a>
                  </li>
                
                  <li>
                    <a href="/2023/04/04/11｜高性能优化：物理机极致优化/" title="11｜高性能优化：物理机极致优化" target="_blank">11｜高性能优化：物理机极致优化</a>
                  </li>
                
              </ul>
            </div>
        

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#引言"><span class="nav-number">1.</span> <span class="nav-text">引言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#导入路径"><span class="nav-number">2.</span> <span class="nav-text">导入路径</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#包的声明"><span class="nav-number">3.</span> <span class="nav-text">包的声明</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#导入声明"><span class="nav-number">4.</span> <span class="nav-text">导入声明</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#空导入"><span class="nav-number">5.</span> <span class="nav-text">空导入</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#包及其命名"><span class="nav-number">6.</span> <span class="nav-text">包及其命名</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#go工具"><span class="nav-number">7.</span> <span class="nav-text">go工具</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#工作空间的组织"><span class="nav-number">7.1.</span> <span class="nav-text">工作空间的组织</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#包的下载"><span class="nav-number">7.2.</span> <span class="nav-text">包的下载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#包的构建"><span class="nav-number">7.3.</span> <span class="nav-text">包的构建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#包的文档化"><span class="nav-number">7.4.</span> <span class="nav-text">包的文档化</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CheBin</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">8.2m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">124:48</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
